<!-- Negotiation result streaming container -->
<div class="card" id="result-card">
    <div class="card-header">
        <h2 class="card-title">Negotiation Results</h2>
        <span class="badge badge-running" id="status-badge">
            <div class="spinner" style="width: 14px; height: 14px; margin-right: 0.5rem;"></div>
            Running
        </span>
    </div>
    <div class="card-body">
        <div class="terminal" id="terminal-output"
             hx-ext="sse"
             sse-connect="/negotiation/stream/{{ job_id }}"
             sse-swap="output"
             hx-swap="beforeend">
        </div>
    </div>
</div>

<script>
(function() {
    const terminal = document.getElementById('terminal-output');
    const statusBadge = document.getElementById('status-badge');
    const eventSource = new EventSource('/negotiation/stream/{{ job_id }}');
    
    eventSource.addEventListener('status', function(e) {
        const data = JSON.parse(e.data);
        const cmdLine = document.createElement('div');
        cmdLine.className = 'line';
        cmdLine.innerHTML = '<span style="color: #569cd6;">$</span> ' + data.command;
        terminal.appendChild(cmdLine);
        terminal.appendChild(document.createElement('br'));
    });
    
    eventSource.addEventListener('output', function(e) {
        const data = JSON.parse(e.data);
        const line = document.createElement('span');
        line.className = 'line';
        line.textContent = data.line;
        terminal.appendChild(line);
        terminal.scrollTop = terminal.scrollHeight;
    });
    
    eventSource.addEventListener('complete', function(e) {
        const data = JSON.parse(e.data);
        eventSource.close();
        
        statusBadge.className = 'badge ' + (data.status === 'completed' ? 'badge-completed' : 'badge-failed');
        statusBadge.innerHTML = data.status === 'completed' ? 'Completed' : 'Failed';
        
        const completeLine = document.createElement('div');
        completeLine.className = 'line ' + (data.status === 'completed' ? 'success' : 'error');
        completeLine.textContent = '\n--- Negotiation ' + data.status + ' (exit code: ' + data.return_code + ') ---';
        terminal.appendChild(completeLine);
        terminal.scrollTop = terminal.scrollHeight;
    });
    
    eventSource.addEventListener('error', function(e) {
        const data = JSON.parse(e.data);
        eventSource.close();
        
        statusBadge.className = 'badge badge-failed';
        statusBadge.innerHTML = 'Error';
        
        const errorLine = document.createElement('div');
        errorLine.className = 'line error';
        errorLine.textContent = 'Error: ' + data.message;
        terminal.appendChild(errorLine);
    });
})();
</script>
