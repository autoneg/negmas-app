<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}NegMAS App{% endblock %}</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="/static/css/styles.css">
    
    <!-- Apply dark mode immediately to prevent flash -->
    <script>
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark-mode');
        }
        if (localStorage.getItem('colorBlindMode') === 'true') {
            document.documentElement.classList.add('color-blind-mode');
        }
    </script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>
    
    <!-- Alpine.js Collapse Plugin -->
    <script defer src="https://unpkg.com/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- SortableJS for drag-reorder -->
    <script src="https://unpkg.com/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <!-- Plotly.js for real-time plotting -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
    
    <!-- Tabulator for data tables -->
    <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator_midnight.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
    
    <!-- Layout System -->
    <link rel="stylesheet" href="/static/css/layout.css">
    <script src="/static/js/panel-registry.js"></script>
    <script src="/static/js/layout-manager.js"></script>
    <script src="/static/js/layout-renderer.js"></script>
    
    {% block head %}{% endblock %}
</head>
<body x-data="app()" x-init="init()">
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <span>NegMAS App</span>
            </div>
            
            <nav class="header-nav">
                <button class="header-nav-btn" :class="{ active: currentPage === 'negotiations' }" @click="currentPage = 'negotiations'">Negotiations</button>
                <button class="header-nav-btn" :class="{ active: currentPage === 'tournaments' }" @click="currentPage = 'tournaments'; loadTournamentSessions()">Tournaments</button>
                <button class="header-nav-btn" :class="{ active: currentPage === 'scenarios' }" @click="currentPage = 'scenarios'; loadScenariosForExplorer()">Scenarios</button>
                <button class="header-nav-btn" @click="showSettings = true">Settings</button>
            </nav>
            
            <div class="header-spacer"></div>
            
            <!-- Layout Switcher -->
            <div class="layout-switcher-container" x-data="{ open: false }" x-show="currentPage === 'negotiations' && currentNegotiation" x-cloak>
                <button class="header-btn layout-switcher-trigger" @click="open = !open" title="Change layout">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    <span class="layout-name" x-text="LayoutManager?.getActiveLayout()?.name || 'Layout'"></span>
                    <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
                <div class="layout-switcher-dropdown" x-show="open" @click.away="open = false" x-transition>
                    <div class="layout-switcher-section">
                        <div class="layout-switcher-title">Layouts</div>
                        <template x-for="layout in (LayoutManager?.getAvailableLayouts() || [])" :key="layout.id">
                            <button class="layout-option" 
                                    :class="{ active: LayoutManager?.getActiveLayout()?.id === layout.id }"
                                    @click="LayoutManager?.switchLayout(layout.id); open = false; $dispatch('layout-changed')">
                                <span class="layout-option-name" x-text="layout.name"></span>
                                <svg x-show="LayoutManager?.getActiveLayout()?.id === layout.id" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </button>
                        </template>
                    </div>
                    <div class="layout-switcher-divider"></div>
                    <div class="layout-switcher-section">
                        <button class="layout-option" @click="LayoutManager?.resetCurrentLayout(); open = false; $dispatch('layout-changed')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                                <path d="M3 3v5h5"></path>
                            </svg>
                            <span>Reset Layout</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Genius Bridge Status -->
            <div class="header-status genius-bridge-status" 
                 @click="toggleGeniusBridge()"
                 :title="geniusBridge.running ? 'Click to stop Genius Bridge' : 'Click to start Genius Bridge'">
                <span class="status-dot" :class="{ 'running': geniusBridge.running, 'stopped': !geniusBridge.running }"></span>
                <span x-text="geniusBridge.running ? 'Genius Bridge' : 'Genius Bridge (Off)'"></span>
                <span class="bridge-action-icon" x-show="geniusBridge.loading">
                    <svg class="spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                        <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="12"></circle>
                    </svg>
                </span>
            </div>
            
            <div class="header-status">
                <span class="status-dot" :class="{ 'disconnected': !connected }"></span>
                <span x-text="connected ? 'Connected' : 'Disconnected'"></span>
            </div>
            
            <div class="header-actions">
                <button class="btn btn-primary" @click="openNewNegotiation()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Negotiation
                </button>
            </div>
        </header>
        
        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Sidebar -->
            <aside class="sidebar" :class="{ collapsed: sidebarCollapsed }">
                <button class="sidebar-toggle" @click="sidebarCollapsed = !sidebarCollapsed" :title="sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <polyline :points="sidebarCollapsed ? '9 18 15 12 9 6' : '15 18 9 12 15 6'"></polyline>
                    </svg>
                </button>
                <div class="sidebar-section">
                    <div class="sidebar-section-title" x-show="!sidebarCollapsed">Quick Actions</div>
                    <button class="sidebar-btn primary" @click="openNewNegotiation()" :title="sidebarCollapsed ? 'Start Negotiation' : ''">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        <span x-show="!sidebarCollapsed">Start Negotiation</span>
                    </button>
                    <button class="sidebar-btn" @click="showNewTournament = true; currentPage = 'tournaments'; loadTournamentSessions()" :title="sidebarCollapsed ? 'Start Tournament' : ''">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="8" r="5"></circle>
                            <path d="M12 13v7"></path>
                            <path d="M9 20h6"></path>
                        </svg>
                        <span x-show="!sidebarCollapsed">Start Tournament</span>
                    </button>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title" x-show="!sidebarCollapsed">
                        Running
                        <span class="sidebar-badge" x-show="runningNegotiations.length > 0" x-text="runningNegotiations.length"></span>
                    </div>
                    <div class="negotiation-list" x-show="!sidebarCollapsed">
                        <template x-if="runningNegotiations.length === 0">
                            <p class="text-muted" style="font-size: 12px; padding: 8px;">No active negotiations</p>
                        </template>
                        <template x-for="neg in runningNegotiations" :key="neg.id">
                            <div class="negotiation-item" :class="{ active: currentNegotiation?.id === neg.id }" @click="selectNegotiation(neg)">
                                <div class="negotiation-item-title" x-text="neg.scenario"></div>
                                <div class="negotiation-item-meta">
                                    <span class="badge badge-primary">Running</span>
                                    <span x-text="'Step ' + neg.step"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title" x-show="!sidebarCollapsed">
                        Completed
                        <span class="sidebar-badge" x-show="completedNegotiations.length > 0" x-text="completedNegotiations.length"></span>
                    </div>
                    <div class="negotiation-list" x-show="!sidebarCollapsed">
                        <template x-if="completedNegotiations.length === 0">
                            <p class="text-muted" style="font-size: 12px; padding: 8px;">No completed negotiations</p>
                        </template>
                        <template x-for="neg in completedNegotiations" :key="neg.id">
                            <div class="negotiation-item" :class="{ active: currentNegotiation?.id === neg.id }" @click="selectNegotiation(neg)">
                                <div class="negotiation-item-title" x-text="neg.scenario"></div>
                                <div class="negotiation-item-meta">
                                    <span class="badge" :class="neg.agreement ? 'badge-success' : 'badge-warning'" x-text="neg.agreement ? 'Agreement' : 'No Agreement'"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Tournament Sections -->
                <div class="sidebar-section" x-show="tournamentSessions.some(t => t.status === 'running')">
                    <div class="sidebar-section-title" x-show="!sidebarCollapsed">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12" style="margin-right: 4px;">
                            <circle cx="12" cy="8" r="5"></circle>
                            <path d="M12 13v7"></path>
                            <path d="M9 20h6"></path>
                        </svg>
                        Running Tournaments
                        <span class="sidebar-badge" x-text="tournamentSessions.filter(t => t.status === 'running').length"></span>
                    </div>
                    <div class="negotiation-list" x-show="!sidebarCollapsed">
                        <template x-for="session in tournamentSessions.filter(t => t.status === 'running')" :key="session.id">
                            <div class="negotiation-item" :class="{ active: selectedTournament?.id === session.id && currentPage === 'tournaments' }" 
                                 @click="currentPage = 'tournaments'; selectTournament(session)">
                                <div class="negotiation-item-title" x-text="'Tournament #' + session.id"></div>
                                <div class="negotiation-item-meta">
                                    <span class="badge badge-primary">Running</span>
                                    <span x-text="Math.round(session.progress?.percent || 0) + '%'"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="sidebar-section" x-show="tournamentSessions.some(t => t.status !== 'running')">
                    <div class="sidebar-section-title" x-show="!sidebarCollapsed">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12" style="margin-right: 4px;">
                            <circle cx="12" cy="8" r="5"></circle>
                            <path d="M12 13v7"></path>
                            <path d="M9 20h6"></path>
                        </svg>
                        Past Tournaments
                        <span class="sidebar-badge" x-text="tournamentSessions.filter(t => t.status !== 'running').length"></span>
                    </div>
                    <div class="negotiation-list" x-show="!sidebarCollapsed">
                        <template x-for="session in tournamentSessions.filter(t => t.status !== 'running').slice(0, 5)" :key="session.id">
                            <div class="negotiation-item" :class="{ active: selectedTournament?.id === session.id && currentPage === 'tournaments' }" 
                                 @click="currentPage = 'tournaments'; selectTournament(session)">
                                <div class="negotiation-item-title" x-text="'Tournament #' + session.id"></div>
                                <div class="negotiation-item-meta">
                                    <span class="badge" 
                                          :class="{
                                              'badge-success': session.status === 'completed',
                                              'badge-danger': session.status === 'failed',
                                              'badge-warning': session.status === 'cancelled'
                                          }" 
                                          x-text="session.status"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Saved Tournaments Section -->
                <div class="sidebar-section" x-show="savedTournaments.length > 0">
                    <div class="sidebar-section-title" x-show="!sidebarCollapsed">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12" style="margin-right: 4px;">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                        </svg>
                        Saved Tournaments
                        <span class="sidebar-badge" x-text="savedTournaments.length"></span>
                    </div>
                    <div class="negotiation-list" x-show="!sidebarCollapsed">
                        <template x-for="t in savedTournaments.slice(0, 5)" :key="t.id">
                            <div class="negotiation-item" :class="{ active: selectedTournament?.id === t.id && currentPage === 'tournaments' }" 
                                 @click="currentPage = 'tournaments'; loadAndSelectSavedTournament(t.id)">
                                <div class="negotiation-item-title" x-text="t.name || t.id"></div>
                                <div class="negotiation-item-meta">
                                    <span x-text="t.n_negotiations + ' negs'"></span>
                                    <span x-text="Math.round((t.agreement_rate || 0) * 100) + '%'"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </aside>
            
            <!-- Content Area - Negotiations -->
            <main class="content-area" x-show="currentPage === 'negotiations'">
                {% block content %}{% endblock %}
            </main>
            
            <!-- Content Area - Scenario Explorer -->
            <div class="content-area scenario-explorer" x-show="currentPage === 'scenarios'" x-cloak>
                <div class="scenario-explorer-layout">
                    <!-- Left Panel: Filters & List -->
                    <div class="scenario-explorer-list">
                        <div class="scenario-explorer-header">
                            <h2>Scenario Explorer</h2>
                        </div>
                        
                        <div class="scenario-explorer-filters">
                            <div class="form-group">
                                <input type="text" class="form-input" placeholder="Search scenarios..." 
                                       x-model="explorerSearch" @input.debounce.300ms="filterExplorerScenarios()">
                            </div>
                            <div class="form-group">
                                <select class="form-select" x-model="explorerSourceFilter" @change="filterExplorerScenarios()">
                                    <option value="">All Sources</option>
                                    <template x-for="(source, idx) in (sources || [])" :key="source?.id || idx">
                                        <option :value="source.id" x-text="source.name + ' (' + source.count + ')'"></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                        
                        <div class="scenario-explorer-results">
                            <div class="text-muted" style="padding: 12px; font-size: 13px;" x-show="explorerLoading">
                                Loading scenarios...
                            </div>
                            <div class="text-muted" style="padding: 12px; font-size: 13px;" x-show="!explorerLoading && filteredExplorerScenarios.length === 0">
                                No scenarios found
                            </div>
                            <template x-for="scenario in filteredExplorerScenarios" :key="scenario.path">
                                <div class="scenario-explorer-item" 
                                     :class="{ selected: selectedScenario?.path === scenario.path }"
                                     @click="selectScenarioForExplorer(scenario)">
                                    <div class="scenario-explorer-item-name" x-text="scenario.name"></div>
                                    <div class="scenario-explorer-item-meta">
                                        <span class="badge badge-secondary" x-text="scenario.source"></span>
                                        <span x-text="scenario.n_negotiators + ' parties'"></span>
                                        <span x-text="(scenario.issues?.length || scenario.n_issues || '?') + ' issues'"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Right Panel: Scenario Details -->
                    <div class="scenario-explorer-details">
                        <template x-if="!selectedScenario">
                            <div class="scenario-explorer-empty">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="64" height="64" style="opacity: 0.3;">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10 9 9 9 8 9"></polyline>
                                </svg>
                                <p>Select a scenario to view details</p>
                            </div>
                        </template>
                        <template x-if="selectedScenario">
                            <div class="scenario-detail-view">
                                <div class="scenario-detail-header">
                                    <h2 x-text="selectedScenario.name"></h2>
                                    <div class="scenario-detail-actions">
                                        <button class="btn btn-primary btn-sm" @click="useScenarioInNegotiation(selectedScenario)">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                            </svg>
                                            Use in Negotiation
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="scenario-detail-content">
                                    <div class="scenario-detail-section">
                                        <h3>Overview</h3>
                                        <div class="scenario-detail-grid">
                                            <div class="scenario-detail-stat">
                                                <span class="stat-label">Source</span>
                                                <span class="stat-value" x-text="selectedScenario.source"></span>
                                            </div>
                                            <div class="scenario-detail-stat">
                                                <span class="stat-label">Parties</span>
                                                <span class="stat-value" x-text="selectedScenario.n_negotiators"></span>
                                            </div>
                                            <div class="scenario-detail-stat">
                                                <span class="stat-label">Issues</span>
                                                <span class="stat-value" x-text="selectedScenario.issues?.length || selectedScenario.n_issues || '?'"></span>
                                            </div>
                                            <div class="scenario-detail-stat">
                                                <span class="stat-label">Outcomes</span>
                                                <span class="stat-value" x-text="selectedScenario.n_outcomes || '?'"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="scenario-detail-section">
                                        <h3>Issues</h3>
                                        <div class="scenario-issues-list">
                                            <template x-for="issue in (selectedScenario.issues || [])" :key="issue.name">
                                                <div class="scenario-issue-item">
                                                    <div class="issue-name" x-text="issue.name"></div>
                                                    <div class="issue-type">
                                                        <span class="badge badge-neutral" x-text="issue.type"></span>
                                                    </div>
                                                    <div class="issue-values" x-show="issue.values">
                                                        <template x-if="issue.values && issue.values.length <= 10">
                                                            <span class="text-muted" x-text="issue.values.join(', ')"></span>
                                                        </template>
                                                        <template x-if="issue.values && issue.values.length > 10">
                                                            <span class="text-muted" x-text="issue.values.slice(0, 10).join(', ') + '... (' + issue.values.length + ' total)'"></span>
                                                        </template>
                                                    </div>
                                                    <div class="issue-range" x-show="issue.min !== undefined">
                                                        <span class="text-muted" x-text="'Range: ' + issue.min + ' - ' + issue.max"></span>
                                                    </div>
                                                </div>
                                            </template>
                                            <div class="text-muted" x-show="!selectedScenario.issues || selectedScenario.issues.length === 0" style="padding: 8px 0;">
                                                Issue details not available
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="scenario-detail-section">
                                        <h3>Path</h3>
                                        <div class="scenario-path">
                                            <code x-text="selectedScenario.path"></code>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            
            <!-- Content Area - Tournaments -->
            <div class="content-area tournament-page" x-show="currentPage === 'tournaments'" x-cloak>
                <!-- Header with actions -->
                <div class="table-header" style="margin-bottom: 16px;">
                    <h2>Tournaments</h2>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button class="btn btn-secondary btn-sm" @click="loadSavedTournaments()" :disabled="savedTournamentsLoading">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            <span x-text="savedTournamentsLoading ? 'Loading...' : 'Load Saved'"></span>
                        </button>
                        <button class="btn btn-primary" @click="showNewTournament = true; loadScenarios(); loadNegotiatorTypes()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Start Tournament
                        </button>
                    </div>
                </div>
                
                <div class="tournament-layout" style="display: flex; gap: 16px; height: calc(100% - 60px);">
                    <!-- Left: Tournament Lists -->
                    <div class="tournament-lists" style="width: 400px; display: flex; flex-direction: column; gap: 16px; overflow: hidden;">
                        <!-- Running Tournaments -->
                        <div class="table-section" x-show="tournamentSessions.some(t => t.status === 'running')" style="flex-shrink: 0;">
                            <h3>
                                <span class="status-dot running"></span>
                                Running (<span x-text="tournamentSessions.filter(t => t.status === 'running').length"></span>)
                            </h3>
                            <div class="tournament-list">
                                <template x-for="session in tournamentSessions.filter(t => t.status === 'running')" :key="session.id">
                                    <div class="tournament-list-item" 
                                         :class="{ active: selectedTournament?.id === session.id }"
                                         @click="selectTournament(session)">
                                        <div class="tournament-list-item-header">
                                            <span class="tournament-id">Tournament #<span x-text="session.id"></span></span>
                                            <span class="badge badge-primary">Running</span>
                                        </div>
                                        <div class="progress" style="height: 4px; margin-top: 4px;">
                                            <div class="progress-bar" :style="'width: ' + (session.progress?.percent || 0) + '%'"></div>
                                        </div>
                                        <div class="text-muted" style="font-size: 11px; margin-top: 4px;" x-text="Math.round(session.progress?.percent || 0) + '% complete'"></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Completed Tournaments (this session) -->
                        <div class="table-section" x-show="tournamentSessions.some(t => t.status !== 'running')" style="flex-shrink: 0;">
                            <h3>
                                <span class="status-dot" style="background: var(--success);"></span>
                                This Session (<span x-text="tournamentSessions.filter(t => t.status !== 'running').length"></span>)
                            </h3>
                            <div class="tournament-list">
                                <template x-for="session in tournamentSessions.filter(t => t.status !== 'running')" :key="session.id">
                                    <div class="tournament-list-item" 
                                         :class="{ active: selectedTournament?.id === session.id }"
                                         @click="selectTournament(session)">
                                        <div class="tournament-list-item-header">
                                            <span class="tournament-id">Tournament #<span x-text="session.id"></span></span>
                                            <span class="badge" 
                                                  :class="{'badge-success': session.status === 'completed', 'badge-danger': session.status === 'failed', 'badge-warning': session.status === 'cancelled'}"
                                                  x-text="session.status"></span>
                                        </div>
                                        <div class="text-muted" style="font-size: 11px; margin-top: 4px;">
                                            <span x-text="(session.results?.total_negotiations || 0) + ' negotiations'"></span>
                                            <span x-show="session.results?.overall_agreement_rate !== undefined" x-text="' • ' + Math.round((session.results?.overall_agreement_rate || 0) * 100) + '% agreements'"></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Saved Tournaments -->
                        <div class="table-section saved-tournaments-section" x-show="savedTournaments.length > 0" style="flex: 1; min-height: 0; display: flex; flex-direction: column;">
                            <h3 style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="display: flex; align-items: center; gap: 8px;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                                    </svg>
                                    Saved (<span x-text="savedTournaments.length"></span>)
                                </span>
                                <button class="btn btn-ghost btn-xs" @click="clearSavedTournaments()" title="Clear all saved">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </h3>
                            <div class="tournament-list" style="flex: 1; overflow-y: auto;">
                                <template x-for="t in savedTournaments" :key="t.id">
                                    <div class="tournament-list-item" 
                                         :class="{ active: selectedTournament?.id === t.id }"
                                         @click="loadAndSelectSavedTournament(t.id)">
                                        <div class="tournament-list-item-header">
                                            <span class="tournament-id" x-text="t.name || t.id"></span>
                                            <button class="btn btn-ghost btn-xs delete-btn" @click.stop="deleteSavedTournament(t.id)" title="Delete">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="text-muted" style="font-size: 11px; margin-top: 4px;">
                                            <span x-text="t.n_negotiations + ' negotiations'"></span>
                                            <span x-text="' • ' + Math.round((t.agreement_rate || 0) * 100) + '% agreements'"></span>
                                        </div>
                                        <div class="text-muted" style="font-size: 10px; margin-top: 2px;" x-text="t.created_at ? new Date(t.created_at).toLocaleString() : ''"></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Empty state when no tournaments -->
                        <div class="empty-state" x-show="tournamentSessions.length === 0 && savedTournaments.length === 0" style="flex: 1;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="opacity: 0.3;">
                                <circle cx="12" cy="8" r="5"></circle>
                                <path d="M12 13v7"></path>
                                <path d="M9 20h6"></path>
                            </svg>
                            <div class="empty-state-title">No Tournaments</div>
                            <div class="empty-state-text">Start a new tournament or load saved ones.</div>
                        </div>
                    </div>
                    
                    <!-- Right: Tournament Details -->
                    <div class="tournament-details" style="flex: 1; overflow-y: auto;">
                        <template x-if="!selectedTournament">
                            <div class="tournament-empty">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="64" height="64" style="opacity: 0.3;">
                                    <circle cx="12" cy="8" r="6"></circle>
                                    <path d="M12 14v8"></path>
                                    <path d="M8 22h8"></path>
                                    <path d="M6 8l-4 4"></path>
                                    <path d="M18 8l4 4"></path>
                                </svg>
                                <p>Select a tournament to view details</p>
                                <p class="text-muted">or click "Start Tournament" to create one</p>
                            </div>
                        </template>
                        <template x-if="selectedTournament">
                            <div class="tournament-detail-content">
                                <div class="tournament-detail-header">
                                    <h3>
                                        <span x-text="selectedTournament._fromSaved ? selectedTournament.id : 'Tournament #' + selectedTournament.id"></span>
                                        <span class="badge" style="margin-left: 8px;"
                                              :class="{'badge-primary': selectedTournament.status === 'running', 'badge-success': selectedTournament.status === 'completed', 'badge-danger': selectedTournament.status === 'failed'}"
                                              x-text="selectedTournament.status"></span>
                                    </h3>
                                    <div class="tournament-actions">
                                        <button class="btn btn-sm btn-secondary" x-show="selectedTournament" @click="selectedTournament = null">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                            Close
                                        </button>
                                        <button class="btn btn-sm btn-danger" 
                                                x-show="selectedTournament.status === 'running'"
                                                @click="cancelTournament(selectedTournament.id)">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Progress Section (for running tournaments) -->
                                <div class="tournament-progress-section" x-show="selectedTournament.status === 'running'">
                                    <div class="progress-info">
                                        <span x-text="'Progress: ' + (selectedTournament.progress?.completed || 0) + ' / ' + (selectedTournament.progress?.total || 0)"></span>
                                        <span x-text="Math.round(selectedTournament.progress?.percent || 0) + '%'"></span>
                                    </div>
                                    <div class="progress-bar large">
                                        <div class="progress-fill" :style="'width: ' + (selectedTournament.progress?.percent || 0) + '%'"></div>
                                    </div>
                                    <div class="progress-current" x-show="selectedTournament.progress?.current_scenario">
                                        <span class="text-muted">Current: </span>
                                        <span x-text="selectedTournament.progress?.current_scenario"></span>
                                        <span x-text="selectedTournament.progress?.current_partners?.join(' vs ') || ''"></span>
                                    </div>
                                </div>
                                
                                <!-- Results Section (for completed tournaments) -->
                                <div class="tournament-results-section" x-show="selectedTournament.status === 'completed' && selectedTournament.results">
                                    <!-- Summary Stats -->
                                    <div class="tournament-summary">
                                        <div class="stat-card">
                                            <div class="stat-value" x-text="selectedTournament.results?.total_negotiations || 0"></div>
                                            <div class="stat-label">Negotiations</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-value" x-text="selectedTournament.results?.total_agreements || 0"></div>
                                            <div class="stat-label">Agreements</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-value" x-text="Math.round((selectedTournament.results?.overall_agreement_rate || 0) * 100) + '%'"></div>
                                            <div class="stat-label">Agreement Rate</div>
                                        </div>
                                        <div class="stat-card" x-show="selectedTournament.results?.execution_time">
                                            <div class="stat-value" x-text="(selectedTournament.results?.execution_time || 0).toFixed(1) + 's'"></div>
                                            <div class="stat-label">Duration</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Rankings Table -->
                                    <h4>Final Rankings</h4>
                                    <table class="tournament-table">
                                        <thead>
                                            <tr>
                                                <th>Rank</th>
                                                <th>Competitor</th>
                                                <th>Score</th>
                                                <th>Utility</th>
                                                <th>Agreements</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="score in (selectedTournament.results?.final_scores || [])" :key="score.name">
                                                <tr :class="{ 'winner': score.rank === 1 }">
                                                    <td>
                                                        <span class="rank-badge" :class="'rank-' + score.rank" x-text="'#' + score.rank"></span>
                                                    </td>
                                                    <td>
                                                        <div class="competitor-name" x-text="score.name"></div>
                                                        <div class="competitor-type text-muted" x-text="score.type_name" style="font-size: 11px;"></div>
                                                    </td>
                                                    <td x-text="score.score?.toFixed(4) || '-'"></td>
                                                    <td x-text="score.mean_utility?.toFixed(4) || '-'"></td>
                                                    <td x-text="(score.n_agreements || '-') + '/' + (score.n_negotiations || '-')"></td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                    
                                    <!-- Negotiations List -->
                                    <div x-show="selectedTournament.results?.negotiations?.length > 0" style="margin-top: 24px;">
                                        <h4>Negotiations (<span x-text="selectedTournament.results?.negotiations?.length || 0"></span>)</h4>
                                        <div class="tournament-negotiations-list" style="max-height: 400px; overflow-y: auto;">
                                            <table class="tournament-table tournament-negotiations-table">
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Scenario</th>
                                                        <th>Partners</th>
                                                        <th>Result</th>
                                                        <th>Utilities</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <template x-for="neg in (selectedTournament.results?.negotiations || [])" :key="neg.index">
                                                        <tr>
                                                            <td x-text="neg.index + 1"></td>
                                                            <td x-text="neg.scenario"></td>
                                                            <td x-text="(neg.partners || []).join(' vs ')"></td>
                                                            <td>
                                                                <span class="badge" :class="neg.has_agreement ? 'badge-success' : 'badge-warning'"
                                                                      x-text="neg.has_agreement ? 'Agreement' : 'No Agreement'"></span>
                                                            </td>
                                                            <td x-text="neg.utilities ? neg.utilities.map(u => u.toFixed(2)).join(', ') : '-'"></td>
                                                        </tr>
                                                    </template>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Error Section (for failed tournaments) -->
                                <div class="tournament-error-section" x-show="selectedTournament.status === 'failed'">
                                    <div class="error-message">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="12" y1="8" x2="12" y2="12"></line>
                                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                        </svg>
                                        <span x-text="selectedTournament.error || 'Unknown error'"></span>
                                    </div>
                                </div>
                                
                                <!-- Config Section -->
                                <div class="tournament-config-section" x-show="selectedTournament.config && selectedTournament.config.competitor_types?.length > 0">
                                    <h4>Configuration</h4>
                                    <div class="config-grid">
                                        <div class="config-item">
                                            <span class="config-label">Competitors:</span>
                                            <span x-text="selectedTournament.config?.competitor_types?.join(', ') || '-'"></span>
                                        </div>
                                        <div class="config-item">
                                            <span class="config-label">Scenarios:</span>
                                            <span x-text="(selectedTournament.config?.scenario_paths?.length || 0) + ' selected'"></span>
                                        </div>
                                        <div class="config-item">
                                            <span class="config-label">Repetitions:</span>
                                            <span x-text="selectedTournament.config?.n_repetitions || 1"></span>
                                        </div>
                                        <div class="config-item">
                                            <span class="config-label">Mechanism:</span>
                                            <span x-text="selectedTournament.config?.mechanism_type || 'SAOMechanism'"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Start Negotiation Modal -->
    <div class="modal-overlay" :class="{ active: showNewNegotiation }" @click.self="showNewNegotiation = false">
        <div class="modal large">
            <div class="modal-header">
                <h2 class="modal-title">Start New Negotiation</h2>
                <div class="modal-header-actions">
                    <!-- Recent Sessions Dropdown -->
                    <div class="dropdown" x-data="{ open: false }">
                        <button class="btn btn-sm btn-secondary" @click="open = !open; loadRecentSessions()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            Recent
                        </button>
                        <div class="dropdown-menu" x-show="open" @click.away="open = false" style="right: 0; min-width: 280px;">
                            <template x-if="recentSessions.length === 0">
                                <div class="dropdown-item text-muted">No recent sessions</div>
                            </template>
                            <template x-for="session in recentSessions" :key="session.name + session.last_used_at">
                                <div class="dropdown-item" @click="loadFullSession(session); open = false">
                                    <div class="font-medium" x-text="session.scenario_name"></div>
                                    <div class="text-muted" style="font-size: 11px;" x-text="session.negotiators.map(n => n.name).join(' vs ')"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                    <!-- Saved Sessions Dropdown -->
                    <div class="dropdown" x-data="{ open: false }">
                        <button class="btn btn-sm btn-secondary" @click="open = !open; loadSessionPresets()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                            Load
                        </button>
                        <div class="dropdown-menu" x-show="open" @click.away="open = false" style="right: 0; min-width: 280px;">
                            <template x-if="sessionPresets.length === 0">
                                <div class="dropdown-item text-muted">No saved sessions</div>
                            </template>
                            <template x-for="preset in sessionPresets" :key="preset.name">
                                <div class="dropdown-item" style="display: flex; justify-content: space-between; align-items: center;">
                                    <div @click="loadFullSession(preset); open = false" style="flex: 1; cursor: pointer;">
                                        <div class="font-medium" x-text="preset.name"></div>
                                        <div class="text-muted" style="font-size: 11px;" x-text="preset.scenario_name"></div>
                                    </div>
                                    <button class="btn-icon-sm" @click.stop="deleteSessionPreset(preset.name)" title="Delete">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>
                    <!-- Save Session Button -->
                    <button class="btn btn-sm btn-primary" @click="showSaveSessionModal = true" :disabled="!newNeg.scenario">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        Save
                    </button>
                </div>
                <button class="modal-close" @click="showNewNegotiation = false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body" style="padding: 0;">
                <!-- Wizard Layout with Vertical Tabs -->
                <div class="wizard-layout">
                    <!-- Vertical Sidebar Tabs -->
                    <div class="wizard-sidebar">
                        <button class="wizard-tab" :class="{ active: negotiationTab === 'scenario', completed: newNeg.scenario }" @click="negotiationTab = 'scenario'" title="Scenario">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                            <span class="wizard-tab-label">Scenario</span>
                        </button>
                        <button class="wizard-tab" :class="{ active: negotiationTab === 'negotiators', completed: newNeg.negotiators.length >= (newNeg.scenario?.n_negotiators || 2) }" @click="negotiationTab = 'negotiators'" title="Negotiators">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            <span class="wizard-tab-label">Negotiators</span>
                        </button>
                        <button class="wizard-tab" :class="{ active: negotiationTab === 'parameters' }" @click="negotiationTab = 'parameters'" title="Parameters">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                            </svg>
                            <span class="wizard-tab-label">Params</span>
                        </button>
                        <button class="wizard-tab" :class="{ active: negotiationTab === 'panels' }" @click="negotiationTab = 'panels'" title="Panels">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                            <span class="wizard-tab-label">Panels</span>
                        </button>
                        <button class="wizard-tab" :class="{ active: negotiationTab === 'display' }" @click="negotiationTab = 'display'" title="Display & Run">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                            <span class="wizard-tab-label">Run</span>
                        </button>
                    </div>
                    
                    <!-- Tab Content -->
                    <div class="wizard-content">
                
                <!-- Tab: Scenario Selection -->
                <div x-show="negotiationTab === 'scenario'">
                    <div class="form-group">
                        <label class="form-label">Search Scenarios</label>
                        <input type="text" class="form-input" placeholder="Type to search all scenarios..." x-model="scenarioSearch" @input="searchScenarios()">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Filter by Source <span class="text-muted">(optional)</span></label>
                        <select class="form-select" x-model="newNeg.source" @change="filterBySource()">
                            <option value="">All sources</option>
                            <template x-for="(source, idx) in (sources || [])" :key="source?.id || idx">
                                <option :value="source.id" x-text="source.name"></option>
                            </template>
                        </select>
                    </div>
                    
                    <div class="form-group" x-show="filteredScenarios.length > 0 || scenarioSearch || newNeg.source">
                        <label class="form-label">
                            Select Scenario 
                            <span class="text-muted" x-text="'(' + filteredScenarios.length + ' found)'"></span>
                        </label>
                        <div class="scenario-grid" style="max-height: 300px; overflow-y: auto;">
                            <template x-for="scenario in filteredScenarios" :key="scenario.path">
                                <div class="scenario-card" 
                                     :class="{ selected: newNeg.scenario?.path === scenario.path }"
                                     @click="selectScenario(scenario)">
                                    <div class="scenario-card-title" x-text="scenario.name"></div>
                                    <div class="scenario-card-meta">
                                        <span class="badge badge-neutral" x-text="scenario.source"></span>
                                        <span x-text="scenario.n_negotiators + ' parties'"></span>
                                        <span x-text="scenario.issues?.length + ' issues'"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <template x-if="filteredScenarios.length === 0 && (scenarioSearch || newNeg.source)">
                            <p class="text-muted" style="padding: 16px; text-align: center;">No scenarios found</p>
                        </template>
                    </div>
                    
                    <div class="form-group" x-show="!scenarioSearch && !newNeg.source && filteredScenarios.length === 0">
                        <p class="text-muted" style="padding: 16px; text-align: center;">Start typing to search scenarios, or select a source to browse</p>
                    </div>
                    
                    <!-- Selected Scenario Details -->
                    <div class="form-group" x-show="newNeg.scenario">
                        <label class="form-label">Scenario Details</label>
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                            <div class="font-semibold mb-2" x-text="newNeg.scenario?.name"></div>
                            <div class="text-secondary" style="font-size: 13px;">
                                <div><strong>Issues:</strong></div>
                                <template x-for="issue in newNeg.scenario?.issues || []" :key="issue.name">
                                    <div style="margin-left: 12px; margin-top: 4px;">
                                        <span x-text="issue.name"></span>
                                        <span class="text-muted" x-text="'(' + issue.type + ')'"></span>
                                        <template x-if="issue.values">
                                            <span class="text-muted" x-text="': ' + issue.values.slice(0, 5).join(', ') + (issue.values.length > 5 ? '...' : '')"></span>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scenario Loading Options -->
                    <div class="form-group" x-show="newNeg.scenario">
                        <label class="form-label">Utility Function Options</label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label class="checkbox-label">
                                <input type="checkbox" x-model="newNeg.ignore_discount">
                                <span>Ignore discount factors</span>
                                <span class="text-muted" style="font-size: 12px; margin-left: 4px;">(use stationary utilities)</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" x-model="newNeg.ignore_reserved">
                                <span>Ignore reserved values</span>
                                <span class="text-muted" style="font-size: 12px; margin-left: 4px;">(set to -infinity)</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Negotiators -->
                <div x-show="negotiationTab === 'negotiators'">
                    <!-- Sub-tabs for negotiator selection mode -->
                    <div class="tabs" style="margin-bottom: 16px;">
                        <button class="tab" :class="{ active: negotiatorSubTab === 'preset' }" @click="negotiatorSubTab = 'preset'">Preset Agents</button>
                        <button class="tab" :class="{ active: negotiatorSubTab === 'boa' }" @click="negotiatorSubTab = 'boa'; loadBOAComponents()">Build Custom (BOA)</button>
                    </div>
                    
                    <!-- Assigned Negotiators (shown in both modes) -->
                    <div class="form-group">
                        <label class="form-label">
                            Assigned Negotiators 
                            <span class="text-muted" x-text="'(' + newNeg.negotiators.length + '/' + (newNeg.scenario?.n_negotiators || 2) + ' required)'"></span>
                        </label>
                        
                        <div class="negotiator-list" x-ref="negotiatorList">
                            <template x-for="(neg, index) in newNeg.negotiators" :key="index">
                                <div class="negotiator-item" 
                                     :data-index="index"
                                     :class="{ 'selected': selectedNegotiatorSlot === index }"
                                     @click="selectedNegotiatorSlot = index"
                                     :style="selectedNegotiatorSlot === index ? 'border-color: var(--primary); background: var(--bg-tertiary);' : ''">
                                    <div class="drag-handle">
                                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                            <circle cx="9" cy="6" r="1.5"/>
                                            <circle cx="15" cy="6" r="1.5"/>
                                            <circle cx="9" cy="12" r="1.5"/>
                                            <circle cx="15" cy="12" r="1.5"/>
                                            <circle cx="9" cy="18" r="1.5"/>
                                            <circle cx="15" cy="18" r="1.5"/>
                                        </svg>
                                    </div>
                                    <div class="negotiator-item-content">
                                        <input type="text" class="negotiator-name-input" x-model="neg.name" @click.stop placeholder="Agent name">
                                        <div class="negotiator-type" x-text="getNegotiatorDisplayName(neg.type_name)"></div>
                                        <span class="badge" :class="getSourceBadgeClass(neg.source)" x-text="neg.source" style="font-size: 10px;"></span>
                                    </div>
                                    <button class="btn btn-icon btn-sm" @click.stop="openNegotiatorConfig(index)" title="Configure parameters" style="margin-right: 4px;" :class="{ 'has-config': neg.params && Object.keys(neg.params).length > 0 }">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <circle cx="12" cy="12" r="3"></circle>
                                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                        </svg>
                                    </button>
                                    <button class="btn btn-icon btn-sm" @click.stop="removeNegotiator(index)" :disabled="newNeg.negotiators.length <= 2" title="Remove">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>
                        <div class="text-muted" style="font-size: 12px; margin-top: 8px;">
                            Click a slot to select it, then choose a negotiator below
                        </div>
                    </div>
                    
                    <!-- Sub-tab: Preset Negotiators -->
                    <div x-show="negotiatorSubTab === 'preset'">
                        <div class="form-group">
                            <label class="form-label">Search Negotiators</label>
                            <input type="text" class="form-input" placeholder="Type to search all negotiators..." x-model="negotiatorSearch" @input="searchNegotiators()">
                        </div>
                        
                        <div class="form-row" style="gap: 12px;">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Filter by Source <span class="text-muted">(optional)</span></label>
                                <select class="form-select" x-model="negotiatorSourceFilter" @change="filterNegotiators()">
                                    <option value="">All sources</option>
                                    <template x-for="source in negotiatorSources" :key="source.id">
                                        <option :value="source.id" x-text="source.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;" x-show="negotiatorSourceFilter === 'genius'">
                                <label class="form-label">Filter by Year <span class="text-muted">(optional)</span></label>
                                <select class="form-select" x-model="negotiatorGroupFilter" @change="filterNegotiators()">
                                    <option value="">All years</option>
                                    <option value="y2019">ANAC 2019</option>
                                    <option value="y2018">ANAC 2018</option>
                                    <option value="y2017">ANAC 2017</option>
                                    <option value="y2016">ANAC 2016</option>
                                    <option value="y2015">ANAC 2015</option>
                                    <option value="y2014">ANAC 2014</option>
                                    <option value="y2013">ANAC 2013</option>
                                    <option value="y2012">ANAC 2012</option>
                                    <option value="y2011">ANAC 2011</option>
                                    <option value="y2010">ANAC 2010</option>
                                    <option value="basic">Basic</option>
                                    <option value="others">Others</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Available Negotiators <span class="text-muted" x-text="'(' + filteredNegotiators.length + ' found)'"></span></label>
                            <div class="negotiator-grid" style="max-height: 250px; overflow-y: auto;">
                                <template x-for="neg in filteredNegotiators" :key="neg.type_name">
                                    <div class="negotiator-card" @click="selectNegotiatorForSlot(neg)">
                                        <div class="negotiator-card-name" x-text="neg.name"></div>
                                        <div class="negotiator-card-meta">
                                            <span class="badge" :class="getSourceBadgeClass(neg.source)" x-text="neg.source"></span>
                                        </div>
                                        <div class="negotiator-card-desc" x-text="neg.description" x-show="neg.description"></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sub-tab: BOA (Build Custom) Negotiators -->
                    <div x-show="negotiatorSubTab === 'boa'">
                        <div class="boa-builder" style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                            <div class="form-group">
                                <label class="form-label">Acceptance Policy <span class="text-danger">*</span></label>
                                <select class="form-select" x-model="boaConfig.acceptance_policy">
                                    <option value="">Select acceptance policy...</option>
                                    <template x-for="c in boaComponents.acceptance" :key="c.name">
                                        <option :value="c.name" x-text="c.name"></option>
                                    </template>
                                </select>
                                <div class="form-hint" x-text="getBoaComponentDescription('acceptance', boaConfig.acceptance_policy)"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Offering Policy <span class="text-danger">*</span></label>
                                <select class="form-select" x-model="boaConfig.offering_policy">
                                    <option value="">Select offering policy...</option>
                                    <template x-for="c in boaComponents.offering" :key="c.name">
                                        <option :value="c.name" x-text="c.name"></option>
                                    </template>
                                </select>
                                <div class="form-hint" x-text="getBoaComponentDescription('offering', boaConfig.offering_policy)"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Opponent Model <span class="text-muted">(optional)</span></label>
                                <select class="form-select" x-model="boaConfig.opponent_model">
                                    <option value="">None (no opponent modeling)</option>
                                    <template x-for="c in boaComponents.model" :key="c.name">
                                        <option :value="c.name" x-text="c.name"></option>
                                    </template>
                                </select>
                                <div class="form-hint" x-text="getBoaComponentDescription('model', boaConfig.opponent_model)"></div>
                            </div>
                            
                            <button class="btn btn-primary" 
                                    @click="applyBOAToSlot()" 
                                    :disabled="!boaConfig.acceptance_policy || !boaConfig.offering_policy">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                Apply to Selected Slot
                            </button>
                        </div>
                        
                        <div class="text-muted" style="font-size: 12px; margin-top: 12px;">
                            <strong>BOA Architecture:</strong> Build modular negotiators by combining acceptance, offering, and opponent modeling components.
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Parameters -->
                <div x-show="negotiationTab === 'parameters'">
                    <!-- Mechanism Type Selector -->
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label class="form-label">Mechanism Protocol</label>
                        <div class="card-selector">
                            <template x-for="mech in (mechanisms || [])" :key="mech?.class_name || Math.random()">
                                <button type="button" class="card-selector-option" 
                                        :class="{ selected: newNeg.mechanism_type === mech?.class_name }"
                                        @click="selectMechanism(mech?.class_name)">
                                    <div class="card-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <g x-show="mech?.class_name === 'SAOMechanism'">
                                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                                <circle cx="9" cy="7" r="4"></circle>
                                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                            </g>
                                            <g x-show="mech?.class_name === 'TAUMechanism'">
                                                <line x1="8" y1="6" x2="21" y2="6"></line>
                                                <line x1="8" y1="12" x2="21" y2="12"></line>
                                                <line x1="8" y1="18" x2="21" y2="18"></line>
                                                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                                                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                                                <line x1="3" y1="18" x2="3.01" y2="18"></line>
                                            </g>
                                            <g x-show="mech?.class_name === 'GBMechanism'">
                                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                <line x1="3" y1="9" x2="21" y2="9"></line>
                                                <line x1="9" y1="21" x2="9" y2="9"></line>
                                            </g>
                                            <g x-show="mech?.class_name?.includes('ST')">
                                                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                                <path d="M2 17l10 5 10-5"></path>
                                                <path d="M2 12l10 5 10-5"></path>
                                            </g>
                                            <!-- Default icon for unknown mechanisms -->
                                            <g x-show="!['SAOMechanism', 'TAUMechanism', 'GBMechanism'].includes(mech?.class_name) && !mech?.class_name?.includes('ST')">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <path d="M12 16v-4"></path>
                                                <path d="M12 8h.01"></path>
                                            </g>
                                        </svg>
                                    </div>
                                    <span class="card-title" x-text="mech?.class_name?.replace('Mechanism', '') || ''"></span>
                                    <span class="card-desc" x-text="(mech?.name || '').split('(')[0].trim()"></span>
                                </button>
                            </template>
                        </div>
                        <div class="form-hint mt-2" x-text="selectedMechanism?.description || ''"></div>
                    </div>
                    
                    <!-- Information Sharing -->
                    <div class="form-group">
                        <label class="form-checkbox"><input type="checkbox" x-model="newNeg.share_ufuns"><span>Share utility functions</span></label>
                        <div class="form-inline-hint">Give each negotiator access to opponent's utility function</div>
                    </div>
                    
                    <!-- Dynamic Parameter Groups -->
                    <template x-if="selectedMechanism">
                        <div>
                            <template x-for="group in selectedMechanism.param_groups" :key="group.id">
                                <div class="param-group" x-data="{ collapsed: group.order > 2 }">
                                    <div class="param-group-header" @click="collapsed = !collapsed">
                                        <span class="param-group-title" x-text="group.label"></span>
                                        <svg class="param-group-chevron" :class="{ collapsed }" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                    </div>
                                    <div class="param-group-content" x-show="!collapsed" x-collapse>
                                        <template x-for="param in group.params" :key="param.name">
                                            <div class="form-group">
                                                <!-- Boolean parameters -->
                                                <template x-if="param.type === 'bool'">
                                                    <div>
                                                        <label class="form-checkbox">
                                                            <input type="checkbox" 
                                                                   :checked="newNeg.mechanism_params[param.name]"
                                                                   @change="newNeg.mechanism_params[param.name] = $event.target.checked">
                                                            <span x-text="param.name.replace(/_/g, ' ')"></span>
                                                        </label>
                                                        <div class="form-inline-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- Integer parameters -->
                                                <template x-if="param.type === 'int'">
                                                    <div>
                                                        <label class="form-label" x-text="param.name.replace(/_/g, ' ')"></label>
                                                        <input type="number" class="form-input" style="max-width: 150px;"
                                                               :value="newNeg.mechanism_params[param.name]"
                                                               @input="newNeg.mechanism_params[param.name] = $event.target.value ? parseInt($event.target.value) : null"
                                                               :min="param.min_value"
                                                               :max="param.max_value"
                                                               :placeholder="param.default ?? 'None'">
                                                        <div class="form-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- Optional integer parameters -->
                                                <template x-if="param.type === 'optional_int'">
                                                    <div>
                                                        <label class="form-label" x-text="param.name.replace(/_/g, ' ')"></label>
                                                        <input type="number" class="form-input" style="max-width: 150px;"
                                                               :value="newNeg.mechanism_params[param.name]"
                                                               @input="newNeg.mechanism_params[param.name] = $event.target.value ? parseInt($event.target.value) : null"
                                                               :min="param.min_value"
                                                               :max="param.max_value"
                                                               placeholder="None">
                                                        <div class="form-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- Float parameters -->
                                                <template x-if="param.type === 'float'">
                                                    <div>
                                                        <label class="form-label" x-text="param.name.replace(/_/g, ' ')"></label>
                                                        <input type="number" class="form-input" style="max-width: 150px;" step="0.01"
                                                               :value="newNeg.mechanism_params[param.name]"
                                                               @input="newNeg.mechanism_params[param.name] = $event.target.value ? parseFloat($event.target.value) : null"
                                                               :min="param.min_value"
                                                               :max="param.max_value"
                                                               :placeholder="param.default ?? 'None'">
                                                        <div class="form-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- Optional float parameters -->
                                                <template x-if="param.type === 'optional_float'">
                                                    <div>
                                                        <label class="form-label" x-text="param.name.replace(/_/g, ' ')"></label>
                                                        <input type="number" class="form-input" style="max-width: 150px;" step="0.1"
                                                               :value="newNeg.mechanism_params[param.name]"
                                                               @input="newNeg.mechanism_params[param.name] = $event.target.value ? parseFloat($event.target.value) : null"
                                                               :min="param.min_value"
                                                               :max="param.max_value"
                                                               placeholder="None">
                                                        <div class="form-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- String parameters -->
                                                <template x-if="param.type === 'string' || param.type === 'optional_string'">
                                                    <div>
                                                        <label class="form-label" x-text="param.name.replace(/_/g, ' ')"></label>
                                                        <input type="text" class="form-input" style="max-width: 300px;"
                                                               :value="newNeg.mechanism_params[param.name]"
                                                               @input="newNeg.mechanism_params[param.name] = $event.target.value || null"
                                                               placeholder="None">
                                                        <div class="form-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- Choice parameters -->
                                                <template x-if="param.type === 'choice'">
                                                    <div>
                                                        <label class="form-label" x-text="param.name.replace(/_/g, ' ')"></label>
                                                        <select class="form-select" style="max-width: 200px;"
                                                                :value="newNeg.mechanism_params[param.name]"
                                                                @change="newNeg.mechanism_params[param.name] = $event.target.value">
                                                            <template x-for="choice in param.choices" :key="choice">
                                                                <option :value="choice" x-text="choice"></option>
                                                            </template>
                                                        </select>
                                                        <div class="form-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
                
                <!-- Tab: Panels -->
                <div x-show="negotiationTab === 'panels'">
                    <div class="form-group">
                        <label class="form-label">Panel Configuration</label>
                        <div class="form-hint">Configure which panels to display during the negotiation</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-checkbox">
                            <input type="checkbox" x-model="newNeg.panels.adjustable">
                            <span>Adjustable panels</span>
                        </label>
                        <div class="form-inline-hint">Allow resizing panels during negotiation</div>
                    </div>
                    
                    <div class="param-group">
                        <div class="param-group-header">
                            <span class="param-group-title">Utility Space View</span>
                        </div>
                        <div class="param-group-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">X-Axis (Negotiator)</label>
                                    <select class="form-select" x-model.number="newNeg.panels.utilityView.xAxis">
                                        <template x-for="(neg, idx) in newNeg.negotiators" :key="idx">
                                            <option :value="idx" x-text="neg.name || ('Agent ' + (idx + 1))"></option>
                                        </template>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Y-Axis (Negotiator)</label>
                                    <select class="form-select" x-model.number="newNeg.panels.utilityView.yAxis">
                                        <template x-for="(neg, idx) in newNeg.negotiators" :key="idx">
                                            <option :value="idx" x-text="neg.name || ('Agent ' + (idx + 1))"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="param-group">
                        <div class="param-group-header">
                            <span class="param-group-title">Timeline View</span>
                        </div>
                        <div class="param-group-content">
                            <div class="form-group">
                                <label class="form-label">X-Axis</label>
                                <select class="form-select" x-model="newNeg.panels.timeline.xAxis" style="max-width: 200px;">
                                    <option value="step">Step</option>
                                    <option value="time">Time</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Display & Run -->
                <div x-show="negotiationTab === 'display'">
                    <div class="form-group">
                        <label class="form-label">Summary</label>
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                            <div><strong>Scenario:</strong> <span x-text="newNeg.scenario?.name || 'Not selected'"></span></div>
                            <div><strong>Negotiators:</strong> <span x-text="newNeg.negotiators.map(n => getNegotiatorDisplayName(n.type_name)).join(' vs ')"></span></div>
                            <div><strong>Mechanism:</strong> <span x-text="newNeg.mechanism_type.replace('Mechanism', '')"></span></div>
                            <div><strong>Deadline:</strong> <span x-text="getDeadlineSummary()"></span></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Run Mode</label>
                        <div class="card-selector compact">
                            <button type="button" class="card-selector-option" :class="{ selected: newNeg.mode === 'realtime' }" @click="newNeg.mode = 'realtime'">
                                <div class="card-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                    </svg>
                                </div>
                                <div class="card-content">
                                    <span class="card-title">Real-time</span>
                                    <span class="card-desc">Watch step-by-step with live updates</span>
                                </div>
                            </button>
                            <button type="button" class="card-selector-option" :class="{ selected: newNeg.mode === 'batch' }" @click="newNeg.mode = 'batch'">
                                <div class="card-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="13 17 18 12 13 7"></polyline>
                                        <polyline points="6 17 11 12 6 7"></polyline>
                                    </svg>
                                </div>
                                <div class="card-content">
                                    <span class="card-title">Batch</span>
                                    <span class="card-desc">Run instantly and show results</span>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group" x-show="newNeg.mode === 'realtime'">
                        <label class="form-label">Step Delay: <span x-text="newNeg.step_delay + 'ms'"></span></label>
                        <input type="range" class="form-range" x-model.number="newNeg.step_delay" min="0" max="1000" step="50">
                        <div class="form-hint">Delay between steps for visualization</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-checkbox"><input type="checkbox" x-model="newNeg.show_plot"><span>Show live utility plot</span></label>
                        </div>
                        <div class="form-group">
                            <label class="form-checkbox"><input type="checkbox" x-model="newNeg.show_offers"><span>Show offer history</span></label>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                        <label class="form-checkbox">
                            <input type="checkbox" x-model="newNeg.auto_save">
                            <span>Auto-save negotiation</span>
                        </label>
                        <div class="form-inline-hint">Save results to disk when negotiation completes</div>
                    </div>
                </div>
                    </div><!-- end wizard-content -->
                </div><!-- end wizard-layout -->
            </div><!-- end modal-body -->
            
            <div class="modal-footer">
                <button class="btn btn-secondary" @click="showNewNegotiation = false">Cancel</button>
                <template x-if="negotiationTab !== 'scenario'">
                    <button class="btn btn-secondary" @click="prevNegotiationTab()">Back</button>
                </template>
                <template x-if="negotiationTab !== 'display'">
                    <button class="btn btn-primary" @click="nextNegotiationTab()" :disabled="!canProceed">
                        Next
                    </button>
                </template>
                <template x-if="negotiationTab === 'display'">
                    <button class="btn btn-primary" @click="startNegotiation()" :disabled="!canStart">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        <span x-text="newNeg.auto_start ? 'Start Negotiation' : 'Open Negotiation'"></span>
                    </button>
                </template>
            </div>
        </div>
    </div>
    
    <!-- Negotiator Configuration Modal -->
    <div class="modal-overlay" :class="{ active: showNegotiatorConfig }" @click.self="showNegotiatorConfig = false">
        <div class="modal medium">
            <div class="modal-header">
                <h2 class="modal-title">
                    Configure Negotiator
                    <span class="text-muted" style="font-size: 14px; font-weight: normal;" x-text="configNegotiatorIndex !== null ? (' - ' + (newNeg.negotiators[configNegotiatorIndex]?.name || 'Agent')) : ''"></span>
                </h2>
                <button class="modal-close" @click="showNegotiatorConfig = false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- Loading state -->
                <div x-show="configNegotiatorLoading" class="text-center" style="padding: 40px;">
                    <div class="spinner"></div>
                    <div class="text-muted" style="margin-top: 12px;">Loading parameters...</div>
                </div>
                
                <!-- No parameters -->
                <div x-show="!configNegotiatorLoading && configNegotiatorParams.length === 0" class="text-center" style="padding: 40px;">
                    <div class="text-muted">No configurable parameters found for this negotiator type.</div>
                </div>
                
                <!-- Parameters form -->
                <div x-show="!configNegotiatorLoading && configNegotiatorParams.length > 0">
                    <div class="form-hint" style="margin-bottom: 16px;">
                        Configure parameters for <strong x-text="configNegotiatorIndex !== null ? getNegotiatorDisplayName(newNeg.negotiators[configNegotiatorIndex]?.type_name) : ''"></strong>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        <template x-for="param in configNegotiatorParams" :key="param.name">
                            <div class="form-group" x-show="!param.is_complex" style="margin-bottom: 16px;">
                                <!-- Boolean parameters -->
                                <template x-if="param.ui_type === 'bool'">
                                    <div>
                                        <label class="form-checkbox">
                                            <input type="checkbox" 
                                                   :checked="configNegotiatorValues[param.name] ?? param.default"
                                                   @change="configNegotiatorValues[param.name] = $event.target.checked">
                                            <span x-text="param.name.replace(/_/g, ' ')"></span>
                                            <span class="text-danger" x-show="param.required">*</span>
                                        </label>
                                        <div class="form-hint" x-text="param.description" x-show="param.description"></div>
                                    </div>
                                </template>
                                
                                <!-- Integer parameters -->
                                <template x-if="param.ui_type === 'int' || param.ui_type === 'optional_int'">
                                    <div>
                                        <label class="form-label">
                                            <span x-text="param.name.replace(/_/g, ' ')"></span>
                                            <span class="text-danger" x-show="param.required">*</span>
                                            <span class="text-muted" x-show="param.ui_type === 'optional_int'">(optional)</span>
                                        </label>
                                        <input type="number" class="form-input" style="max-width: 200px;"
                                               :value="configNegotiatorValues[param.name] ?? param.default"
                                               @input="configNegotiatorValues[param.name] = $event.target.value ? parseInt($event.target.value) : null"
                                               :placeholder="param.default !== null ? param.default : 'None'">
                                        <div class="form-hint" x-text="param.description" x-show="param.description"></div>
                                    </div>
                                </template>
                                
                                <!-- Float parameters -->
                                <template x-if="param.ui_type === 'float' || param.ui_type === 'optional_float'">
                                    <div>
                                        <label class="form-label">
                                            <span x-text="param.name.replace(/_/g, ' ')"></span>
                                            <span class="text-danger" x-show="param.required">*</span>
                                            <span class="text-muted" x-show="param.ui_type === 'optional_float'">(optional)</span>
                                        </label>
                                        <input type="number" class="form-input" style="max-width: 200px;" step="0.01"
                                               :value="configNegotiatorValues[param.name] ?? param.default"
                                               @input="configNegotiatorValues[param.name] = $event.target.value ? parseFloat($event.target.value) : null"
                                               :placeholder="param.default !== null ? param.default : 'None'">
                                        <div class="form-hint" x-text="param.description" x-show="param.description"></div>
                                    </div>
                                </template>
                                
                                <!-- String parameters -->
                                <template x-if="param.ui_type === 'string' || param.ui_type === 'optional_string'">
                                    <div>
                                        <label class="form-label">
                                            <span x-text="param.name.replace(/_/g, ' ')"></span>
                                            <span class="text-danger" x-show="param.required">*</span>
                                            <span class="text-muted" x-show="param.ui_type === 'optional_string'">(optional)</span>
                                        </label>
                                        <input type="text" class="form-input" style="max-width: 300px;"
                                               :value="configNegotiatorValues[param.name] ?? param.default ?? ''"
                                               @input="configNegotiatorValues[param.name] = $event.target.value || null"
                                               :placeholder="param.default !== null ? param.default : 'None'">
                                        <div class="form-hint" x-text="param.description" x-show="param.description"></div>
                                    </div>
                                </template>
                                
                                <!-- Choice parameters -->
                                <template x-if="param.ui_type === 'choice'">
                                    <div>
                                        <label class="form-label">
                                            <span x-text="param.name.replace(/_/g, ' ')"></span>
                                            <span class="text-danger" x-show="param.required">*</span>
                                        </label>
                                        <select class="form-select" style="max-width: 200px;"
                                                :value="configNegotiatorValues[param.name] ?? param.default"
                                                @change="configNegotiatorValues[param.name] = $event.target.value">
                                            <template x-for="choice in param.choices" :key="choice">
                                                <option :value="choice" x-text="choice"></option>
                                            </template>
                                        </select>
                                        <div class="form-hint" x-text="param.description" x-show="param.description"></div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Show complex parameters as info -->
                    <template x-if="configNegotiatorParams.some(p => p.is_complex)">
                        <details style="margin-top: 16px;">
                            <summary class="text-muted" style="cursor: pointer; font-size: 13px;">
                                Advanced parameters (not editable in UI)
                            </summary>
                            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 6px; margin-top: 8px;">
                                <template x-for="param in configNegotiatorParams.filter(p => p.is_complex)" :key="param.name">
                                    <div style="margin-bottom: 8px; font-size: 13px;">
                                        <code x-text="param.name" style="background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px;"></code>
                                        <span class="text-muted" x-text="': ' + param.type"></span>
                                    </div>
                                </template>
                            </div>
                        </details>
                    </template>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" @click="showNegotiatorConfig = false">Cancel</button>
                <button class="btn btn-secondary" @click="resetNegotiatorConfig()">Reset to Defaults</button>
                <button class="btn btn-primary" @click="applyNegotiatorConfig()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Apply
                </button>
            </div>
        </div>
    </div>
    
    <!-- New Tournament Modal -->
    <div class="modal-overlay" :class="{ active: showNewTournament }" @click.self="showNewTournament = false">
        <div class="modal large">
            <div class="modal-header">
                <h2 class="modal-title">New Tournament</h2>
                <button class="modal-close" @click="showNewTournament = false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body" style="padding: 0;">
                <div class="wizard-layout">
                    <div class="wizard-sidebar">
                        <button class="wizard-tab" :class="{ active: tournamentTab === 'scenarios', completed: newTournament.scenario_paths.length > 0 }" @click="tournamentTab = 'scenarios'">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                            <span class="wizard-tab-label">Scenarios</span>
                            <span class="wizard-badge" x-show="newTournament.scenario_paths.length > 0" x-text="newTournament.scenario_paths.length"></span>
                        </button>
                        <button class="wizard-tab" :class="{ active: tournamentTab === 'competitors', completed: newTournament.competitor_types.length >= 2 }" @click="tournamentTab = 'competitors'">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            <span class="wizard-tab-label">Competitors</span>
                            <span class="wizard-badge" x-show="newTournament.competitor_types.length > 0" x-text="newTournament.competitor_types.length"></span>
                        </button>
                        <button class="wizard-tab" :class="{ active: tournamentTab === 'settings' }" @click="tournamentTab = 'settings'">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                            </svg>
                            <span class="wizard-tab-label">Settings</span>
                        </button>
                    </div>
                    
                    <div class="wizard-content">
                        <!-- Scenarios Tab -->
                        <div x-show="tournamentTab === 'scenarios'" class="wizard-panel">
                            <div class="panel-header">
                                <h3>Select Scenarios</h3>
                                <span class="text-muted" x-text="newTournament.scenario_paths.length + ' selected'"></span>
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-input" placeholder="Search scenarios..." 
                                       x-model="tournamentScenarioSearch">
                            </div>
                            <div class="selectable-list" style="max-height: 400px; overflow-y: auto;">
                                <template x-for="scenario in filteredTournamentScenarios" :key="scenario.path">
                                    <div class="selectable-item" 
                                         :class="{ selected: isTournamentScenarioSelected(scenario.path) }"
                                         @click="toggleTournamentScenario(scenario.path)">
                                        <div class="selectable-item-checkbox">
                                            <svg x-show="isTournamentScenarioSelected(scenario.path)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" width="14" height="14">
                                                <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                        </div>
                                        <div class="selectable-item-content">
                                            <div class="selectable-item-name" x-text="scenario.name"></div>
                                            <div class="selectable-item-meta">
                                                <span class="badge badge-secondary" x-text="scenario.source"></span>
                                                <span x-text="scenario.n_negotiators + ' parties'"></span>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            <div class="selection-actions" style="margin-top: 12px; display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-secondary" @click="newTournament.scenario_paths = scenarios.map(s => s.path)">Select All</button>
                                <button class="btn btn-sm btn-secondary" @click="newTournament.scenario_paths = []">Clear All</button>
                            </div>
                        </div>
                        
                        <!-- Competitors Tab -->
                        <div x-show="tournamentTab === 'competitors'" class="wizard-panel">
                            <div class="panel-header">
                                <h3>Select Competitors</h3>
                                <span class="text-muted" x-text="newTournament.competitor_types.length + ' selected (min 2)'"></span>
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-input" placeholder="Search negotiators..." 
                                       x-model="tournamentCompetitorSearch">
                            </div>
                            <div class="selectable-list" style="max-height: 400px; overflow-y: auto;">
                                <template x-for="neg in filteredTournamentCompetitors" :key="neg.type_name">
                                    <div class="selectable-item" 
                                         :class="{ selected: isTournamentCompetitorSelected(neg.type_name) }"
                                         @click="toggleTournamentCompetitor(neg.type_name)">
                                        <div class="selectable-item-checkbox">
                                            <svg x-show="isTournamentCompetitorSelected(neg.type_name)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" width="14" height="14">
                                                <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                        </div>
                                        <div class="selectable-item-content">
                                            <div class="selectable-item-name" x-text="neg.name"></div>
                                            <div class="selectable-item-meta">
                                                <span class="badge badge-secondary" x-text="neg.source"></span>
                                                <span class="text-muted" x-text="neg.description" style="font-size: 11px;"></span>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Settings Tab -->
                        <div x-show="tournamentTab === 'settings'" class="wizard-panel">
                            <div class="panel-header">
                                <h3>Tournament Settings</h3>
                            </div>
                            
                            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="form-group">
                                    <label class="form-label">Repetitions</label>
                                    <input type="number" class="form-input" x-model.number="newTournament.n_repetitions" min="1" max="100">
                                    <div class="form-hint">Run each pairing multiple times</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Max Steps</label>
                                    <input type="number" class="form-input" x-model.number="newTournament.n_steps" min="1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Mechanism</label>
                                    <select class="form-select" x-model="newTournament.mechanism_type">
                                        <option value="SAOMechanism">SAO Mechanism</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Score Metric</label>
                                    <select class="form-select" x-model="newTournament.final_score_metric">
                                        <option value="advantage">Advantage</option>
                                        <option value="utility">Utility</option>
                                        <option value="welfare">Welfare</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top: 16px;">
                                <label class="form-checkbox">
                                    <input type="checkbox" x-model="newTournament.rotate_ufuns">
                                    <span>Rotate Utility Functions</span>
                                </label>
                                <div class="form-hint">Each pair plays both positions</div>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" x-model="newTournament.self_play">
                                    <span>Allow Self-Play</span>
                                </label>
                                <div class="form-hint">Allow competitors to play against themselves</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" @click="showNewTournament = false">Cancel</button>
                <button class="btn btn-primary" 
                        @click="startTournament()"
                        :disabled="newTournament.competitor_types.length < 2 || newTournament.scenario_paths.length < 1">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    Start Tournament
                </button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-overlay" :class="{ active: showSettings }" @click.self="showSettings = false">
        <div class="modal large">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="modal-close" @click="showSettings = false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body" style="padding: 0;">
                <div class="settings-layout">
                    <div class="settings-sidebar">
                        <div class="settings-nav">
                            <button class="settings-nav-item" :class="{ active: settingsTab === 'general' }" @click="settingsTab = 'general'">General</button>
                            <button class="settings-nav-item" :class="{ active: settingsTab === 'negotiation' }" @click="settingsTab = 'negotiation'">Negotiation</button>
                            <button class="settings-nav-item" :class="{ active: settingsTab === 'sources' }" @click="settingsTab = 'sources'; loadSourceSettings()">Negotiator Sources</button>
                            <button class="settings-nav-item" :class="{ active: settingsTab === 'genius' }" @click="settingsTab = 'genius'">Genius Bridge</button>
                            <button class="settings-nav-item" :class="{ active: settingsTab === 'paths' }" @click="settingsTab = 'paths'">Custom Paths</button>
                        </div>
                    </div>
                    
                    <div class="settings-content">
                        <div x-show="settingsTab === 'general'">
                            <h3 class="font-semibold mb-4">General Settings</h3>
                            
                            <!-- Theme Section -->
                            <div class="settings-section">
                                <h4 class="settings-section-title">Theme</h4>
                                <div class="form-group">
                                    <label class="form-checkbox">
                                        <input type="checkbox" x-model="settings.darkMode" @change="toggleDarkMode()">
                                        <span>Dark Mode</span>
                                    </label>
                                    <div class="form-hint">Use dark color scheme</div>
                                </div>
                            </div>
                            
                            <!-- Accessibility Section -->
                            <div class="settings-section">
                                <h4 class="settings-section-title">Accessibility</h4>
                                <div class="form-group">
                                    <label class="form-checkbox">
                                        <input type="checkbox" x-model="settings.colorBlindMode" @change="toggleColorBlindMode()">
                                        <span>Color Blind Mode</span>
                                    </label>
                                    <div class="form-hint">Use color-blind friendly palette with distinct line styles and markers</div>
                                </div>
                                <div class="color-palette-preview" x-show="settings.colorBlindMode">
                                    <div class="palette-label">Color-blind friendly palette:</div>
                                    <div class="palette-colors">
                                        <span class="color-swatch" style="background: #0072B2;" title="Blue"></span>
                                        <span class="color-swatch" style="background: #E69F00;" title="Orange"></span>
                                        <span class="color-swatch" style="background: #009E73;" title="Bluish Green"></span>
                                        <span class="color-swatch" style="background: #CC79A7;" title="Reddish Purple"></span>
                                        <span class="color-swatch" style="background: #F0E442;" title="Yellow"></span>
                                        <span class="color-swatch" style="background: #56B4E9;" title="Sky Blue"></span>
                                        <span class="color-swatch" style="background: #D55E00;" title="Vermillion"></span>
                                        <span class="color-swatch" style="background: #000000;" title="Black"></span>
                                    </div>
                                    <div class="palette-note">Charts will also use different line styles and markers</div>
                                </div>
                            </div>
                            
                            <!-- Storage Section -->
                            <div class="settings-section">
                                <h4 class="settings-section-title">Storage</h4>
                                <div class="form-group">
                                    <label class="form-checkbox">
                                        <input type="checkbox" x-model="settings.saveNegotiations" @change="saveSettings()">
                                        <span>Save Negotiations</span>
                                    </label>
                                    <div class="form-hint">Persist completed negotiations to disk for later review</div>
                                </div>
                            </div>
                        </div>
                        
                        <div x-show="settingsTab === 'negotiation'">
                            <h3 class="font-semibold mb-4">Default Negotiation Settings</h3>
                            <div class="form-group">
                                <label class="form-label">Default Max Steps</label>
                                <input type="number" class="form-input" x-model.number="settings.defaultSteps">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default Step Delay (ms)</label>
                                <input type="number" class="form-input" x-model.number="settings.defaultDelay">
                            </div>
                        </div>
                        
                        <div x-show="settingsTab === 'sources'">
                            <h3 class="font-semibold mb-4">Negotiator Sources</h3>
                            <p class="text-secondary mb-4" style="font-size: 13px;">
                                Enable or disable negotiator sources. Disabled sources won't appear in the negotiator selection.
                            </p>
                            
                            <div class="source-toggle-list">
                                <template x-for="source in sourceSettingsList" :key="source.id">
                                    <div class="source-toggle-item">
                                        <div class="source-toggle-info">
                                            <div class="source-toggle-name" x-text="source.name"></div>
                                            <div class="source-toggle-desc" x-text="source.description"></div>
                                            <div class="source-toggle-status">
                                                <template x-if="source.available">
                                                    <span class="text-success" x-text="source.count + ' negotiators available'"></span>
                                                </template>
                                                <template x-if="!source.available">
                                                    <span class="text-muted" x-text="source.unavailable_reason || 'Not installed'"></span>
                                                </template>
                                            </div>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" 
                                                   :checked="!sourceSettings.disabled_sources.includes(source.id)" 
                                                   :disabled="!source.available"
                                                   @change="toggleSource(source.id)">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </template>
                            </div>
                            
                            <div class="mt-4">
                                <button class="btn btn-secondary" @click="refreshNegotiators()" :disabled="refreshingNegotiators">
                                    <template x-if="refreshingNegotiators">
                                        <span class="spinner" style="width: 14px; height: 14px;"></span>
                                    </template>
                                    <template x-if="!refreshingNegotiators">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <path d="M23 4v6h-6"></path>
                                            <path d="M1 20v-6h6"></path>
                                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                        </svg>
                                    </template>
                                    Refresh Sources
                                </button>
                                <span class="text-muted" style="margin-left: 12px; font-size: 12px;">Re-scan for available negotiators</span>
                            </div>
                            
                            <div class="mt-4" style="padding-top: 16px; border-top: 1px solid var(--border-color);">
                                <h4 class="font-semibold mb-2" style="font-size: 14px;">Parameter Cache</h4>
                                <p class="text-muted" style="font-size: 12px; margin-bottom: 12px;">
                                    Negotiator parameters are cached to improve performance. Clear the cache if parameters seem outdated.
                                </p>
                                <button class="btn btn-secondary" @click="clearParameterCache()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                    Clear Parameter Cache
                                </button>
                            </div>
                        </div>
                        
                        <div x-show="settingsTab === 'genius'">
                            <h3 class="font-semibold mb-4">Genius Bridge</h3>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span class="badge" :class="geniusBridge.running ? 'badge-success' : 'badge-neutral'" x-text="geniusBridge.running ? 'Running' : 'Stopped'"></span>
                                    <button class="btn btn-secondary" @click="toggleGeniusBridge()" x-text="geniusBridge.running ? 'Stop' : 'Start'"></button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" x-model="settings.autoStartGenius">
                                    <span>Auto-start when needed</span>
                                </label>
                            </div>
                        </div>
                        
                        <div x-show="settingsTab === 'paths'">
                            <h3 class="font-semibold mb-4">Custom Paths</h3>
                            <div class="form-group">
                                <label class="form-label">Additional Scenario Paths</label>
                                <textarea class="form-textarea" placeholder="One path per line..." x-model="settings.scenarioPaths"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Additional Negotiator Paths</label>
                                <textarea class="form-textarea" placeholder="One path per line..." x-model="settings.negotiatorPaths"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" @click="showSettings = false">Close</button>
                <button class="btn btn-primary" @click="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Save Session Preset Modal -->
    <div class="modal-overlay" :class="{ active: showSaveSessionModal }" @click.self="showSaveSessionModal = false">
        <div class="modal small">
            <div class="modal-header">
                <h2 class="modal-title">Save Session</h2>
                <button class="modal-close" @click="showSaveSessionModal = false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Preset Name</label>
                    <input type="text" class="form-input" placeholder="My Negotiation Setup" x-model="savePresetName" @keyup.enter="saveFullSession()">
                    <div class="form-hint">Give this configuration a memorable name</div>
                </div>
                <div class="form-group" x-show="newNeg.scenario">
                    <label class="form-label">Configuration Summary</label>
                    <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; font-size: 13px;">
                        <div><strong>Scenario:</strong> <span x-text="newNeg.scenario?.name"></span></div>
                        <div><strong>Negotiators:</strong> <span x-text="newNeg.negotiators.map(n => getNegotiatorDisplayName(n.type_name)).join(' vs ')"></span></div>
                        <div><strong>Mechanism:</strong> <span x-text="newNeg.mechanism_type"></span></div>
                        <div><strong>Steps:</strong> <span x-text="newNeg.mechanism_params?.n_steps || 'No limit'"></span></div>
                        <div x-show="newNeg.mechanism_params?.time_limit"><strong>Time Limit:</strong> <span x-text="newNeg.mechanism_params?.time_limit + 's'"></span></div>
                        <div><strong>Mode:</strong> <span x-text="newNeg.mode === 'realtime' ? 'Real-time' : 'Batch'"></span></div>
                    </div>
                </div>
                    </div><!-- end wizard-content -->
                </div><!-- end wizard-layout -->
            
            <div class="modal-footer">
                <button class="btn btn-secondary" @click="showSaveSessionModal = false">Cancel</button>
                <button class="btn btn-primary" @click="saveFullSession()" :disabled="!savePresetName.trim()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save
                </button>
            </div>
        </div>
    </div>
    
    <script>
    function app() {
        return {
            // Connection status
            connected: true,
            
            // Sidebar state - collapsed by default unless user explicitly opened it
            sidebarCollapsed: localStorage.getItem('sidebarCollapsed') !== 'false',
            
            // Modal states
            showNewNegotiation: false,
            showSettings: false,
            showNegotiatorConfig: false,
            
            // Negotiator configuration modal state
            configNegotiatorIndex: null,  // Index of negotiator being configured
            configNegotiatorParams: [],   // Parameters from API
            configNegotiatorValues: {},   // Current values being edited
            configNegotiatorLoading: false,
            
            // Page state (negotiations, scenarios, tournaments)
            currentPage: 'negotiations',
            
            // Tournament state
            showNewTournament: false,
            tournamentSessions: [],
            savedTournaments: [],
            savedTournamentsLoading: false,
            selectedTournament: null,
            tournamentEventSource: null,
            newTournament: {
                competitor_types: [],
                scenario_paths: [],
                n_repetitions: 1,
                rotate_ufuns: true,
                self_play: true,
                mechanism_type: 'SAOMechanism',
                n_steps: 100,
                time_limit: null,
                final_score_metric: 'advantage',
                final_score_stat: 'mean',
            },
            tournamentTab: 'scenarios',
            tournamentScenarioSearch: '',
            tournamentCompetitorSearch: '',
            
            // Tabs
            negotiationTab: 'scenario',
            settingsTab: 'general',
            paramSubTab: 'deadline',
            negotiatorSubTab: 'preset',
            
            // Parameter group collapse states
            showAdvancedDeadline: false,
            showCommonParams: false,
            showSAOResponse: true,
            showSAOOffers: false,
            showSAOSemantics: false,
            showSAOAdvanced: false,
            showTAUBasic: true,
            showTAUAdvanced: false,
            showGBBasic: true,
            showGBOffers: false,
            
            // Data
            sources: [],
            scenarios: [],
            scenarioSearch: '',
            negotiatorTypes: [],
            negotiatorSources: [],
            negotiatorSearch: '',
            negotiatorSourceFilter: '',
            negotiatorGroupFilter: '',
            selectedNegotiatorSlot: 0,
            
            // Mechanism data (loaded from API)
            mechanisms: [],
            selectedMechanism: null,
            
            // BOA (Build Custom) negotiator config
            boaComponents: {
                acceptance: [],
                offering: [],
                model: []
            },
            boaConfig: {
                acceptance_policy: '',
                offering_policy: '',
                opponent_model: ''
            },
            
            // Scenario Explorer state
            explorerScenarios: [],
            explorerSearch: '',
            explorerSourceFilter: '',
            selectedScenario: null,
            explorerLoading: false,
            
            // Running/completed negotiations
            runningNegotiations: [],
            completedNegotiations: [],
            currentNegotiation: null,
            
            // New negotiation form
            newNeg: {
                source: '',
                scenario: null,
                negotiators: [
                    { type_name: 'AspirationNegotiator', name: 'Agent1', params: {} },
                    { type_name: 'BoulwareTBNegotiator', name: 'Agent2', params: {} }
                ],
                // Scenario loading options
                ignore_discount: false,
                ignore_reserved: false,
                // Mechanism type (class name)
                mechanism_type: 'SAOMechanism',
                // Dynamic mechanism params (populated from API)
                mechanism_params: {},
                // Information sharing
                share_ufuns: false,
                // Display params
                mode: 'realtime',
                step_delay: 100,
                show_plot: true,
                show_offers: true,
                auto_save: true,  // Default from settings.saveNegotiations
                // Panel settings
                panels: {
                    adjustable: true,
                    utilityView: { xAxis: 0, yAxis: 1 },
                    timeline: { xAxis: 'relative_time' }
                }
            },
            
            // Settings
            settings: {
                darkMode: localStorage.getItem('darkMode') === 'true',
                colorBlindMode: localStorage.getItem('colorBlindMode') === 'true',
                saveNegotiations: localStorage.getItem('saveNegotiations') !== 'false',  // Default true
                defaultSteps: 100,
                defaultDelay: 100,
                autoStartGenius: true,
                scenarioPaths: '',
                negotiatorPaths: ''
            },
            
            // Genius bridge
            geniusBridge: {
                installed: false,
                running: false,
                loading: false,
                port: 25337
            },
            
            // Negotiator source settings
            sourceSettings: {
                disabled_sources: [],
                custom_sources: []
            },
            sourceSettingsList: [],
            refreshingNegotiators: false,
            
            // Preset management
            recentSessions: [],
            sessionPresets: [],
            showSaveSessionModal: false,
            savePresetName: '',
            
            // Computed
            get filteredScenarios() {
                let results = this.scenarios;
                
                // Filter by source if selected
                if (this.newNeg.source) {
                    results = results.filter(s => s.source === this.newNeg.source);
                }
                
                // Filter by search term
                if (this.scenarioSearch) {
                    const search = this.scenarioSearch.toLowerCase();
                    results = results.filter(s => 
                        s.name.toLowerCase().includes(search) ||
                        s.source.toLowerCase().includes(search)
                    );
                }
                
                return results;
            },
            
            get filteredNegotiators() {
                let results = this.negotiatorTypes;
                
                // Filter by source if selected
                if (this.negotiatorSourceFilter) {
                    results = results.filter(n => n.source === this.negotiatorSourceFilter);
                }
                
                // Filter by group if selected (for genius)
                if (this.negotiatorGroupFilter) {
                    results = results.filter(n => n.group === this.negotiatorGroupFilter);
                }
                
                // Filter by search term
                if (this.negotiatorSearch) {
                    const search = this.negotiatorSearch.toLowerCase();
                    results = results.filter(n => 
                        n.name.toLowerCase().includes(search) ||
                        n.type_name.toLowerCase().includes(search) ||
                        (n.description && n.description.toLowerCase().includes(search))
                    );
                }
                
                return results;
            },
            
            get filteredExplorerScenarios() {
                let results = this.explorerScenarios;
                
                // Filter by source if selected
                if (this.explorerSourceFilter) {
                    results = results.filter(s => s.source === this.explorerSourceFilter);
                }
                
                // Filter by search term
                if (this.explorerSearch) {
                    const search = this.explorerSearch.toLowerCase();
                    results = results.filter(s => 
                        s.name.toLowerCase().includes(search) ||
                        s.source.toLowerCase().includes(search)
                    );
                }
                
                return results;
            },
            
            get canProceed() {
                if (this.negotiationTab === 'scenario') {
                    return this.newNeg.scenario !== null;
                }
                if (this.negotiationTab === 'negotiators') {
                    return this.newNeg.negotiators.length >= (this.newNeg.scenario?.n_negotiators || 2);
                }
                return true;
            },
            
            get canStart() {
                if (this.newNeg.scenario === null) return false;
                if (this.newNeg.negotiators.length < (this.newNeg.scenario?.n_negotiators || 2)) return false;
                // Check deadline requirement - most mechanisms need some form of limit
                if (!this.hasDeadline()) return false;
                return true;
            },
            
            // Helper methods
            hasDeadline() {
                const params = this.newNeg.mechanism_params || {};
                return (params.n_steps && params.n_steps > 0) ||
                       (params.time_limit && params.time_limit > 0) ||
                       (params.pend && params.pend > 0) ||
                       (params.pend_per_second && params.pend_per_second > 0) ||
                       (params.hidden_time_limit && params.hidden_time_limit > 0 && params.hidden_time_limit !== 'inf');
            },
            
            getDeadlineSummary() {
                const params = this.newNeg.mechanism_params || {};
                const parts = [];
                if (params.n_steps && params.n_steps > 0) {
                    parts.push(params.n_steps + ' steps');
                }
                if (params.time_limit && params.time_limit > 0) {
                    parts.push(params.time_limit + 's time');
                }
                if (params.pend && params.pend > 0) {
                    parts.push('pend=' + params.pend);
                }
                if (params.pend_per_second && params.pend_per_second > 0) {
                    parts.push('pend/s=' + params.pend_per_second);
                }
                if (params.hidden_time_limit && params.hidden_time_limit > 0 && params.hidden_time_limit !== 'inf') {
                    parts.push('hidden=' + params.hidden_time_limit + 's');
                }
                return parts.length > 0 ? parts.join(', ') : 'None';
            },
            
            getMechanismDescription(type) {
                const descriptions = {
                    sao: 'Sequential offers with acceptance/rejection. Most common protocol.',
                    tau: 'Parallel offers in multiple threads. Can run without deadline.',
                    gb: 'General game-based mechanism with configurable evaluators.'
                };
                return descriptions[type] || '';
            },
            
            // Init
            async init() {
                // Watch sidebar state
                this.$watch('sidebarCollapsed', (val) => {
                    localStorage.setItem('sidebarCollapsed', val);
                });
                
                // Load settings from backend first
                await this.loadSettings();
                
                // Apply dark mode to body (html already has it from inline script)
                if (this.settings.darkMode) {
                    document.body.classList.add('dark-mode');
                }
                await this.loadSources();
                await this.loadNegotiatorSources();
                await this.loadNegotiatorTypes();
                await this.loadMechanisms();
                // Pre-load all scenarios so search is instant
                await this.loadAllScenarios();
                this.initSortable();
                
                // Check Genius Bridge status
                await this.checkGeniusBridgeStatus();
                // Periodically check status (every 60 seconds)
                setInterval(() => this.checkGeniusBridgeStatus(), 60000);
            },
            
            initSortable() {
                this.$watch('showNewNegotiation', (show) => {
                    if (show) {
                        this.$nextTick(() => {
                            const list = this.$refs.negotiatorList;
                            if (list && !list._sortable) {
                                list._sortable = new Sortable(list, {
                                    handle: '.drag-handle',
                                    animation: 150,
                                    onEnd: (evt) => {
                                        const item = this.newNeg.negotiators.splice(evt.oldIndex, 1)[0];
                                        this.newNeg.negotiators.splice(evt.newIndex, 0, item);
                                    }
                                });
                            }
                        });
                    }
                });
            },
            
            // API calls
            async loadSources() {
                try {
                    const res = await fetch('/api/scenarios/sources');
                    const data = await res.json();
                    this.sources = data.sources;
                } catch (e) {
                    console.error('Failed to load sources:', e);
                }
            },
            
            async loadAllScenarios() {
                if (this.scenarios.length > 0) return; // Already loaded
                try {
                    const res = await fetch('/api/scenarios');
                    const data = await res.json();
                    this.scenarios = data.scenarios;
                } catch (e) {
                    console.error('Failed to load scenarios:', e);
                }
            },
            
            async searchScenarios() {
                // Load all scenarios on first search
                await this.loadAllScenarios();
            },
            
            async filterBySource() {
                // Load all scenarios when filtering
                await this.loadAllScenarios();
            },
            
            // Scenario Explorer methods
            async loadScenariosForExplorer() {
                if (this.explorerScenarios.length > 0) return; // Already loaded
                this.explorerLoading = true;
                try {
                    const res = await fetch('/api/scenarios');
                    const data = await res.json();
                    this.explorerScenarios = data.scenarios;
                } catch (e) {
                    console.error('Failed to load scenarios for explorer:', e);
                } finally {
                    this.explorerLoading = false;
                }
            },
            
            selectScenarioForExplorer(scenario) {
                this.selectedScenario = scenario;
            },
            
            useScenarioInNegotiation(scenario) {
                this.currentPage = 'negotiations';
                this.openNewNegotiation();
                this.newNeg.scenario = scenario;
                this.newNeg.source = scenario.source;
                this.negotiationTab = 'negotiators';
            },
            
            filterExplorerScenarios() {
                // Reactivity handles filtering via computed property
            },
            
            async loadNegotiatorTypes() {
                try {
                    const res = await fetch('/api/negotiators');
                    const data = await res.json();
                    this.negotiatorTypes = data.negotiators;
                } catch (e) {
                    console.error('Failed to load negotiator types:', e);
                }
            },
            
            async loadNegotiatorSources() {
                try {
                    const res = await fetch('/api/negotiators/sources');
                    const data = await res.json();
                    this.negotiatorSources = data.sources;
                } catch (e) {
                    console.error('Failed to load negotiator sources:', e);
                }
            },
            
            async loadMechanisms() {
                try {
                    const res = await fetch('/api/mechanisms');
                    const data = await res.json();
                    this.mechanisms = data.mechanisms;
                    // Select SAOMechanism by default
                    this.selectMechanism('SAOMechanism');
                } catch (e) {
                    console.error('Failed to load mechanisms:', e);
                }
            },
            
            selectMechanism(className) {
                this.selectedMechanism = this.mechanisms.find(m => m.class_name === className);
                if (this.selectedMechanism) {
                    this.newNeg.mechanism_type = className;
                    // Initialize mechanism params with defaults
                    this.initMechanismParams();
                }
            },
            
            initMechanismParams() {
                if (!this.selectedMechanism) return;
                
                // Reset mechanism_params to defaults
                this.newNeg.mechanism_params = {};
                
                for (const group of this.selectedMechanism.param_groups) {
                    for (const param of group.params) {
                        // Set default value
                        let defaultVal = param.default;
                        if (defaultVal === 'inf') defaultVal = null;
                        if (defaultVal === '-inf') defaultVal = null;
                        this.newNeg.mechanism_params[param.name] = defaultVal;
                    }
                }
            },
            
            getMechanismParamValue(paramName) {
                return this.newNeg.mechanism_params?.[paramName];
            },
            
            setMechanismParamValue(paramName, value) {
                if (!this.newNeg.mechanism_params) {
                    this.newNeg.mechanism_params = {};
                }
                this.newNeg.mechanism_params[paramName] = value;
            },
            
            async loadSourceSettings() {
                try {
                    // Load source settings from backend
                    const res = await fetch('/api/settings/negotiator_sources');
                    if (res.ok) {
                        const data = await res.json();
                        this.sourceSettings = data;
                    }
                    
                    // Build the list with availability info from negotiatorSources
                    this.sourceSettingsList = this.negotiatorSources.map(source => {
                        const count = this.negotiatorTypes.filter(n => n.source === source.id).length;
                        return {
                            ...source,
                            count: count,
                            available: source.available !== false,
                            unavailable_reason: source.unavailable_reason
                        };
                    });
                } catch (e) {
                    console.error('Failed to load source settings:', e);
                }
            },
            
            // Genius Bridge methods
            async checkGeniusBridgeStatus() {
                try {
                    const res = await fetch('/api/genius/status');
                    if (res.ok) {
                        const data = await res.json();
                        this.geniusBridge.installed = data.installed;
                        this.geniusBridge.running = data.running;
                        this.geniusBridge.port = data.port;
                    }
                } catch (e) {
                    console.error('Failed to check Genius Bridge status:', e);
                }
            },
            
            async startGeniusBridge() {
                if (this.geniusBridge.loading) return;
                this.geniusBridge.loading = true;
                try {
                    const res = await fetch('/api/genius/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ port: this.geniusBridge.port })
                    });
                    if (res.ok) {
                        const data = await res.json();
                        if (data.success) {
                            this.geniusBridge.running = true;
                            this.geniusBridge.port = data.port;
                        } else {
                            console.error('Failed to start Genius Bridge:', data.message);
                            alert('Failed to start Genius Bridge: ' + data.message);
                        }
                    }
                } catch (e) {
                    console.error('Failed to start Genius Bridge:', e);
                } finally {
                    this.geniusBridge.loading = false;
                }
            },
            
            async stopGeniusBridge() {
                if (this.geniusBridge.loading) return;
                this.geniusBridge.loading = true;
                try {
                    const res = await fetch('/api/genius/stop?port=' + this.geniusBridge.port, {
                        method: 'POST'
                    });
                    if (res.ok) {
                        const data = await res.json();
                        if (data.success) {
                            this.geniusBridge.running = false;
                        }
                    }
                } catch (e) {
                    console.error('Failed to stop Genius Bridge:', e);
                } finally {
                    this.geniusBridge.loading = false;
                }
            },
            
            async toggleGeniusBridge() {
                if (this.geniusBridge.running) {
                    await this.stopGeniusBridge();
                } else {
                    await this.startGeniusBridge();
                }
            },
            
            async ensureGeniusBridgeRunning() {
                if (!this.geniusBridge.running) {
                    await this.startGeniusBridge();
                }
                return this.geniusBridge.running;
            },
            
            toggleSource(sourceId) {
                const idx = this.sourceSettings.disabled_sources.indexOf(sourceId);
                if (idx >= 0) {
                    this.sourceSettings.disabled_sources.splice(idx, 1);
                } else {
                    this.sourceSettings.disabled_sources.push(sourceId);
                }
            },
            
            async refreshNegotiators() {
                this.refreshingNegotiators = true;
                try {
                    await fetch('/api/negotiators/refresh', { method: 'POST' });
                    await this.loadNegotiatorTypes();
                    await this.loadNegotiatorSources();
                    await this.loadSourceSettings();
                } catch (e) {
                    console.error('Failed to refresh negotiators:', e);
                } finally {
                    this.refreshingNegotiators = false;
                }
            },
            
            async clearParameterCache() {
                try {
                    const res = await fetch('/api/negotiators/cache/clear', { method: 'POST' });
                    const data = await res.json();
                    alert(data.message || 'Parameter cache cleared');
                } catch (e) {
                    console.error('Failed to clear parameter cache:', e);
                    alert('Failed to clear parameter cache');
                }
            },
            
            async searchNegotiators() {
                // Negotiators already loaded at init, just triggers reactivity
            },
            
            async filterNegotiators() {
                // Reset group filter if source changed
                if (this.negotiatorSourceFilter !== 'genius') {
                    this.negotiatorGroupFilter = '';
                }
            },
            
            // Modal actions
            openNewNegotiation() {
                this.showNewNegotiation = true;
                this.negotiationTab = 'scenario';
                this.paramSubTab = 'deadline';
                this.scenarioSearch = '';
                this.negotiatorSearch = '';
                this.negotiatorSourceFilter = '';
                this.negotiatorGroupFilter = '';
                this.showAdvancedDeadline = false;
                this.showSAOResponse = true;
                this.showSAOOffers = false;
                this.showSAOSemantics = false;
                this.showInfoSharing = true;
                this.newNeg = {
                    source: '',
                    scenario: null,
                    negotiators: [
                        { type_name: 'negmas.sao.AspirationNegotiator', name: 'Aspiration1', source: 'native', params: {} },
                        { type_name: 'negmas.sao.BoulwareTBNegotiator', name: 'Boulware2', source: 'native', params: {} }
                    ],
                    mechanism_type: 'SAOMechanism',
                    mechanism_params: {},
                    share_ufuns: false,
                    mode: 'realtime',
                    step_delay: this.settings.defaultDelay,
                    show_plot: true,
                    show_offers: true,
                    auto_save: this.settings.saveNegotiations,
                    auto_start: true,
                    panels: {
                        adjustable: true,
                        utilityView: {
                            xAxis: 0,
                            yAxis: 1
                        },
                        timeline: {
                            xAxis: 'step'
                        }
                    }
                };
                // Initialize mechanism params with defaults
                this.selectMechanism('SAOMechanism');
            },
            
            selectScenario(scenario) {
                this.newNeg.scenario = scenario;
                // Adjust negotiator count if needed
                while (this.newNeg.negotiators.length < scenario.n_negotiators) {
                    this.addNegotiator();
                }
                while (this.newNeg.negotiators.length > scenario.n_negotiators) {
                    this.newNeg.negotiators.pop();
                }
            },
            
            nextNegotiationTab() {
                if (this.negotiationTab === 'scenario') this.negotiationTab = 'negotiators';
                else if (this.negotiationTab === 'negotiators') this.negotiationTab = 'parameters';
                else if (this.negotiationTab === 'parameters') this.negotiationTab = 'panels';
                else if (this.negotiationTab === 'panels') this.negotiationTab = 'display';
            },
            
            prevNegotiationTab() {
                if (this.negotiationTab === 'display') this.negotiationTab = 'panels';
                else if (this.negotiationTab === 'panels') this.negotiationTab = 'parameters';
                else if (this.negotiationTab === 'parameters') this.negotiationTab = 'negotiators';
                else if (this.negotiationTab === 'negotiators') this.negotiationTab = 'scenario';
            },
            
            // Negotiator management
            addNegotiator() {
                const idx = this.newNeg.negotiators.length;
                this.newNeg.negotiators.push({
                    type_name: 'negmas.sao.AspirationNegotiator',
                    name: `Aspiration${idx + 1}`,
                    source: 'native',
                    params: {}
                });
            },
            
            removeNegotiator(index) {
                if (this.newNeg.negotiators.length > 2) {
                    this.newNeg.negotiators.splice(index, 1);
                }
            },
            
            selectNegotiatorForSlot(negInfo) {
                // Use the currently selected slot
                const slotIndex = this.selectedNegotiatorSlot;
                const existingName = this.newNeg.negotiators[slotIndex]?.name;
                
                // Generate default name from type name + index if user hasn't set a custom name
                // Check if existing name is a generic "AgentN" or empty
                const isGenericName = !existingName || /^Agent\d+$/.test(existingName);
                const shortTypeName = negInfo.name || negInfo.type_name.split('.').pop();
                const defaultName = isGenericName ? `${shortTypeName}${slotIndex + 1}` : existingName;
                
                const newNeg = {
                    type_name: negInfo.type_name,
                    name: defaultName,
                    source: negInfo.source,
                    requires_bridge: negInfo.requires_bridge,
                    params: {}  // Initialize empty params
                };
                
                if (slotIndex < this.newNeg.negotiators.length) {
                    this.newNeg.negotiators[slotIndex] = newNeg;
                } else {
                    this.newNeg.negotiators.push(newNeg);
                }
                
                // Auto-start Genius Bridge if needed
                if (negInfo.requires_bridge && this.settings.autoStartGenius && !this.geniusBridge.running) {
                    this.startGeniusBridge();
                }
                
                // Auto-advance to next slot if there's room
                const requiredCount = this.newNeg.scenario?.n_negotiators || 2;
                if (slotIndex + 1 < requiredCount && slotIndex + 1 < this.newNeg.negotiators.length) {
                    this.selectedNegotiatorSlot = slotIndex + 1;
                }
            },
            
            async openNegotiatorConfig(index) {
                this.configNegotiatorIndex = index;
                this.configNegotiatorLoading = true;
                this.configNegotiatorParams = [];
                this.configNegotiatorValues = {};
                this.showNegotiatorConfig = true;
                
                const negotiator = this.newNeg.negotiators[index];
                if (!negotiator) return;
                
                try {
                    const res = await fetch(`/api/negotiators/${encodeURIComponent(negotiator.type_name)}/parameters`);
                    const data = await res.json();
                    
                    // Filter out 'name' parameter since we handle it separately
                    this.configNegotiatorParams = (data.parameters || []).filter(p => p.name !== 'name');
                    
                    // Initialize values from existing params or defaults
                    const existingParams = negotiator.params || {};
                    this.configNegotiatorValues = {};
                    
                    for (const param of this.configNegotiatorParams) {
                        if (param.name in existingParams) {
                            this.configNegotiatorValues[param.name] = existingParams[param.name];
                        }
                        // Otherwise leave undefined to use default
                    }
                } catch (e) {
                    console.error('Failed to load negotiator parameters:', e);
                } finally {
                    this.configNegotiatorLoading = false;
                }
            },
            
            applyNegotiatorConfig() {
                if (this.configNegotiatorIndex === null) return;
                
                // Build params object with only non-default values
                const params = {};
                for (const param of this.configNegotiatorParams) {
                    const value = this.configNegotiatorValues[param.name];
                    // Only include if value was explicitly set and differs from default
                    if (value !== undefined && value !== null && value !== param.default) {
                        params[param.name] = value;
                    }
                }
                
                // Update negotiator params
                this.newNeg.negotiators[this.configNegotiatorIndex].params = params;
                this.showNegotiatorConfig = false;
            },
            
            resetNegotiatorConfig() {
                // Reset all values to undefined (will use defaults)
                this.configNegotiatorValues = {};
            },
            
            getNegotiatorDisplayName(typeName) {
                // Handle BOA negotiators (type_name format: "BOA:AcceptPolicy/OfferPolicy")
                if (typeName && typeName.startsWith('BOA:')) {
                    const parts = typeName.substring(4).split('/');
                    if (parts.length >= 2) {
                        const acc = parts[0].replace(/Policy$|^G|^AC/, '');
                        const off = parts[1].replace(/Policy$|Offering$|^G/, '');
                        return `${acc}+${off}`;
                    }
                    return 'Custom BOA';
                }
                const neg = this.negotiatorTypes.find(n => n.type_name === typeName);
                return neg?.name || typeName.split('.').pop();
            },
            
            getNegotiatorDescription(typeName) {
                const neg = this.negotiatorTypes.find(n => n.type_name === typeName);
                return neg?.description || '';
            },
            
            getSourceBadgeClass(source) {
                const classes = {
                    'native': 'badge-primary',
                    'genius': 'badge-warning',
                    'genius-reimplemented': 'badge-success',
                    'llm': 'badge-info',
                    'rl': 'badge-info',
                    'negolog': 'badge-secondary',
                    'boa': 'badge-info'
                };
                return classes[source] || 'badge-neutral';
            },
            
            // BOA Component methods
            async loadBOAComponents() {
                if (this.boaComponents.acceptance.length > 0) return; // Already loaded
                try {
                    const res = await fetch('/api/negotiators/boa/components');
                    const data = await res.json();
                    this.boaComponents = data.components;
                } catch (e) {
                    console.error('Failed to load BOA components:', e);
                }
            },
            
            getBoaComponentDescription(type, name) {
                if (!name) return '';
                const components = this.boaComponents[type] || [];
                const c = components.find(c => c.name === name);
                return c?.description || '';
            },
            
            applyBOAToSlot() {
                if (!this.boaConfig.acceptance_policy || !this.boaConfig.offering_policy) return;
                
                const slotIndex = this.selectedNegotiatorSlot;
                const existingName = this.newNeg.negotiators[slotIndex]?.name;
                
                // Create a display name based on selected components
                const displayParts = [];
                displayParts.push(this.boaConfig.acceptance_policy.replace(/Policy$|^G/, ''));
                displayParts.push(this.boaConfig.offering_policy.replace(/Policy$|Offering$|^G/, ''));
                const displayName = displayParts.join('+');
                
                const boaNeg = {
                    type_name: `BOA:${this.boaConfig.acceptance_policy}/${this.boaConfig.offering_policy}`,
                    name: existingName || `Agent${slotIndex + 1}`,
                    source: 'boa',
                    is_boa: true,
                    boa_config: {
                        acceptance_policy: this.boaConfig.acceptance_policy,
                        offering_policy: this.boaConfig.offering_policy,
                        opponent_model: this.boaConfig.opponent_model || null
                    }
                };
                
                if (slotIndex < this.newNeg.negotiators.length) {
                    this.newNeg.negotiators[slotIndex] = boaNeg;
                } else {
                    this.newNeg.negotiators.push(boaNeg);
                }
                
                // Auto-advance to next slot if there's room
                const requiredCount = this.newNeg.scenario?.n_negotiators || 2;
                if (slotIndex + 1 < requiredCount && slotIndex + 1 < this.newNeg.negotiators.length) {
                    this.selectedNegotiatorSlot = slotIndex + 1;
                }
            },
            
            // Start negotiation
            async startNegotiation() {
                if (!this.canStart) return;
                
                // Check if any negotiator requires the Genius Bridge
                const needsBridge = this.newNeg.negotiators.some(n => n.requires_bridge);
                if (needsBridge) {
                    // Refresh Genius Bridge status before checking
                    await this.checkGeniusBridgeStatus();
                    if (!this.geniusBridge.running) {
                        // Try to start the bridge
                        await this.startGeniusBridge();
                        if (!this.geniusBridge.running) {
                            alert('Cannot start negotiation: Genius Bridge is required but failed to start.');
                            return;
                        }
                    }
                }
                
                // Save to recent sessions
                await this.addToRecentSessions();
                
                // Build request with mechanism params
                const params = this.newNeg.mechanism_params || {};
                
                try {
                    const res = await fetch('/api/negotiation/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            scenario_path: this.newNeg.scenario.path,
                            negotiators: this.newNeg.negotiators,
                            mechanism_type: this.newNeg.mechanism_type,
                            mechanism_params: params,
                            step_delay: this.newNeg.step_delay / 1000,
                            share_ufuns: this.newNeg.share_ufuns,
                            ignore_discount: this.newNeg.ignore_discount,
                            ignore_reserved: this.newNeg.ignore_reserved,
                            auto_save: this.newNeg.auto_save
                        })
                    });
                    
                    const data = await res.json();
                    
                    // Add to running negotiations with panel settings
                    this.runningNegotiations.push({
                        id: data.session_id,
                        scenario: this.newNeg.scenario.name,
                        step: 0,
                        mechanism_type: this.newNeg.mechanism_type,
                        stream_url: data.stream_url,
                        // Store display settings with the negotiation
                        panelSettings: {
                            adjustable: this.newNeg.panels.adjustable,
                            utilityView: { ...this.newNeg.panels.utilityView },
                            timeline: { ...this.newNeg.panels.timeline }
                        },
                        mode: this.newNeg.mode,
                        show_plot: this.newNeg.show_plot,
                        show_offers: this.newNeg.show_offers
                    });
                    
                    this.showNewNegotiation = false;
                    
                    // Start streaming
                    this.connectToStream(data.session_id, data.stream_url);
                    
                } catch (e) {
                    console.error('Failed to start negotiation:', e);
                }
            },
            
            connectToStream(sessionId, url) {
                const eventSource = new EventSource(url);
                
                eventSource.addEventListener('offer', (event) => {
                    const offer = JSON.parse(event.data);
                    const neg = this.runningNegotiations.find(n => n.id === sessionId);
                    if (neg) {
                        neg.step = offer.step;
                        neg.lastOffer = offer;
                    }
                });
                
                eventSource.addEventListener('complete', (event) => {
                    const result = JSON.parse(event.data);
                    const idx = this.runningNegotiations.findIndex(n => n.id === sessionId);
                    if (idx >= 0) {
                        const neg = this.runningNegotiations.splice(idx, 1)[0];
                        neg.agreement = result.agreement;
                        neg.final_utilities = result.final_utilities;
                        // Always set end_reason for completed negotiations
                        neg.end_reason = result.end_reason || (result.error ? 'error' : (result.agreement ? 'agreement' : 'completed'));
                        neg.error = result.error;
                        this.completedNegotiations.unshift(neg);
                    }
                    eventSource.close();
                });
                
                eventSource.addEventListener('error', () => {
                    eventSource.close();
                });
            },
            
            selectNegotiation(neg) {
                this.currentNegotiation = neg;
            },
            
            // Tournament methods
            async loadTournamentSessions() {
                try {
                    const res = await fetch('/api/tournament/sessions/list');
                    const data = await res.json();
                    this.tournamentSessions = data.sessions || [];
                } catch (e) {
                    console.error('Failed to load tournament sessions:', e);
                }
            },
            
            selectTournament(session) {
                this.selectedTournament = session;
                // If running, connect to stream
                if (session.status === 'running') {
                    this.connectToTournamentStream(session.id);
                }
            },
            
            async startTournament() {
                if (this.newTournament.competitor_types.length < 2) {
                    alert('Please select at least 2 competitors');
                    return;
                }
                if (this.newTournament.scenario_paths.length < 1) {
                    alert('Please select at least 1 scenario');
                    return;
                }
                
                try {
                    const res = await fetch('/api/tournament/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.newTournament)
                    });
                    
                    const data = await res.json();
                    this.showNewTournament = false;
                    
                    // Add to sessions list
                    const newSession = {
                        id: data.session_id,
                        status: 'running',
                        config: { ...this.newTournament },
                        progress: { completed: 0, total: 0, percent: 0 }
                    };
                    this.tournamentSessions.unshift(newSession);
                    this.selectedTournament = newSession;
                    
                    // Connect to stream
                    this.connectToTournamentStream(data.session_id);
                    
                    // Reset form
                    this.resetTournamentForm();
                } catch (e) {
                    console.error('Failed to start tournament:', e);
                    alert('Failed to start tournament: ' + e.message);
                }
            },
            
            connectToTournamentStream(sessionId) {
                // Close existing connection
                if (this.tournamentEventSource) {
                    this.tournamentEventSource.close();
                }
                
                this.tournamentEventSource = new EventSource(`/api/tournament/${sessionId}/stream`);
                
                this.tournamentEventSource.addEventListener('progress', (event) => {
                    const progress = JSON.parse(event.data);
                    const session = this.tournamentSessions.find(s => s.id === sessionId);
                    if (session) {
                        session.progress = progress;
                        session.status = 'running';
                    }
                    if (this.selectedTournament?.id === sessionId) {
                        this.selectedTournament.progress = progress;
                        this.selectedTournament.status = 'running';
                    }
                });
                
                this.tournamentEventSource.addEventListener('complete', (event) => {
                    const result = JSON.parse(event.data);
                    const session = this.tournamentSessions.find(s => s.id === sessionId);
                    if (session) {
                        session.status = result.status;
                        session.results = result.results;
                        session.error = result.error;
                    }
                    if (this.selectedTournament?.id === sessionId) {
                        this.selectedTournament.status = result.status;
                        this.selectedTournament.results = result.results;
                        this.selectedTournament.error = result.error;
                    }
                    this.tournamentEventSource.close();
                    this.tournamentEventSource = null;
                });
                
                this.tournamentEventSource.addEventListener('error', () => {
                    this.tournamentEventSource.close();
                    this.tournamentEventSource = null;
                });
            },
            
            async cancelTournament(sessionId) {
                try {
                    await fetch(`/api/tournament/${sessionId}/cancel`, { method: 'POST' });
                    const session = this.tournamentSessions.find(s => s.id === sessionId);
                    if (session) {
                        session.status = 'cancelled';
                    }
                    if (this.selectedTournament?.id === sessionId) {
                        this.selectedTournament.status = 'cancelled';
                    }
                } catch (e) {
                    console.error('Failed to cancel tournament:', e);
                }
            },
            
            toggleTournamentScenario(scenarioPath) {
                const idx = this.newTournament.scenario_paths.indexOf(scenarioPath);
                if (idx >= 0) {
                    this.newTournament.scenario_paths.splice(idx, 1);
                } else {
                    this.newTournament.scenario_paths.push(scenarioPath);
                }
            },
            
            toggleTournamentCompetitor(typeName) {
                const idx = this.newTournament.competitor_types.indexOf(typeName);
                if (idx >= 0) {
                    this.newTournament.competitor_types.splice(idx, 1);
                } else {
                    this.newTournament.competitor_types.push(typeName);
                }
            },
            
            isTournamentScenarioSelected(scenarioPath) {
                return this.newTournament.scenario_paths.includes(scenarioPath);
            },
            
            isTournamentCompetitorSelected(typeName) {
                return this.newTournament.competitor_types.includes(typeName);
            },
            
            resetTournamentForm() {
                this.newTournament = {
                    competitor_types: [],
                    scenario_paths: [],
                    n_repetitions: 1,
                    rotate_ufuns: true,
                    self_play: true,
                    mechanism_type: 'SAOMechanism',
                    n_steps: 100,
                    time_limit: null,
                    final_score_metric: 'advantage',
                    final_score_stat: 'mean',
                };
            },
            
            get filteredTournamentScenarios() {
                if (!this.tournamentScenarioSearch) return this.scenarios;
                const search = this.tournamentScenarioSearch.toLowerCase();
                return this.scenarios.filter(s => 
                    s.name.toLowerCase().includes(search) ||
                    s.source.toLowerCase().includes(search)
                );
            },
            
            get filteredTournamentCompetitors() {
                if (!this.tournamentCompetitorSearch) return this.negotiatorTypes;
                const search = this.tournamentCompetitorSearch.toLowerCase();
                return this.negotiatorTypes.filter(n => 
                    n.name.toLowerCase().includes(search) ||
                    n.type_name.toLowerCase().includes(search)
                );
            },
            
            // Saved tournament methods
            async loadSavedTournaments() {
                this.savedTournamentsLoading = true;
                try {
                    const res = await fetch('/api/tournament/saved/list');
                    const data = await res.json();
                    this.savedTournaments = data.tournaments || [];
                } catch (e) {
                    console.error('Failed to load saved tournaments:', e);
                } finally {
                    this.savedTournamentsLoading = false;
                }
            },
            
            async loadAndSelectSavedTournament(tournamentId) {
                try {
                    const res = await fetch(`/api/tournament/saved/${tournamentId}`);
                    if (!res.ok) throw new Error('Failed to load tournament');
                    const data = await res.json();
                    
                    // Transform to match our tournament format
                    this.selectedTournament = {
                        id: data.id,
                        status: 'completed',
                        _fromSaved: true,
                        config: {
                            competitor_types: [],  // Not available from saved data
                            scenario_paths: []
                        },
                        results: {
                            total_negotiations: data.n_negotiations,
                            total_agreements: data.n_agreements,
                            overall_agreement_rate: data.agreement_rate,
                            execution_time: 0,  // Not available from saved data
                            final_scores: (data.scores || []).map((s, idx) => ({
                                name: s.name,
                                rank: s.rank,
                                score: s.score,
                                type_name: s.raw_data?.type || '',
                                mean_utility: s.raw_data?.utility ? parseFloat(s.raw_data.utility) : null,
                                n_agreements: s.raw_data?.n_agreements ? parseInt(s.raw_data.n_agreements) : '-',
                                n_negotiations: s.raw_data?.n_negotiations ? parseInt(s.raw_data.n_negotiations) : '-'
                            })),
                            negotiations: data.negotiations || []
                        },
                        created_at: data.created_at
                    };
                } catch (e) {
                    console.error('Failed to load saved tournament:', e);
                }
            },
            
            async deleteSavedTournament(tournamentId) {
                if (!confirm('Delete this saved tournament?')) return;
                
                try {
                    await fetch(`/api/tournament/saved/${tournamentId}`, { method: 'DELETE' });
                    this.savedTournaments = this.savedTournaments.filter(t => t.id !== tournamentId);
                    if (this.selectedTournament?.id === tournamentId) {
                        this.selectedTournament = null;
                    }
                } catch (e) {
                    console.error('Failed to delete tournament:', e);
                }
            },
            
            async clearSavedTournaments() {
                if (!confirm('Delete ALL saved tournaments? This cannot be undone.')) return;
                
                try {
                    // Delete each tournament individually
                    for (const t of this.savedTournaments) {
                        await fetch(`/api/tournament/saved/${t.id}`, { method: 'DELETE' });
                    }
                    this.savedTournaments = [];
                    if (this.selectedTournament?._fromSaved) {
                        this.selectedTournament = null;
                    }
                } catch (e) {
                    console.error('Failed to clear tournaments:', e);
                }
            },
            
            // Settings
            async loadSettings() {
                try {
                    const res = await fetch('/api/settings');
                    const data = await res.json();
                    
                    // Map backend settings to frontend model
                    this.settings.darkMode = data.general?.dark_mode ?? false;
                    this.settings.colorBlindMode = data.general?.color_blind_mode ?? false;
                    this.settings.saveNegotiations = data.general?.save_negotiations ?? true;
                    this.settings.defaultSteps = data.negotiation?.default_max_steps ?? 100;
                    this.settings.defaultDelay = data.negotiation?.default_step_delay_ms ?? 100;
                    this.settings.autoStartGenius = data.genius_bridge?.auto_start ?? true;
                    this.settings.scenarioPaths = (data.paths?.scenario_paths ?? []).join('\n');
                    this.settings.negotiatorPaths = (data.paths?.negotiator_paths ?? []).join('\n');
                    
                    // Sync localStorage with backend
                    localStorage.setItem('darkMode', this.settings.darkMode.toString());
                    localStorage.setItem('colorBlindMode', this.settings.colorBlindMode.toString());
                    localStorage.setItem('saveNegotiations', this.settings.saveNegotiations.toString());
                    
                    // Apply dark mode based on loaded settings
                    document.documentElement.classList.toggle('dark-mode', this.settings.darkMode);
                    document.body.classList.toggle('dark-mode', this.settings.darkMode);
                    
                    // Apply color-blind mode based on loaded settings
                    document.documentElement.classList.toggle('color-blind-mode', this.settings.colorBlindMode);
                    document.body.classList.toggle('color-blind-mode', this.settings.colorBlindMode);
                } catch (e) {
                    console.error('Failed to load settings:', e);
                }
            },
            
            toggleDarkMode() {
                localStorage.setItem('darkMode', this.settings.darkMode);
                document.documentElement.classList.toggle('dark-mode', this.settings.darkMode);
                document.body.classList.toggle('dark-mode', this.settings.darkMode);
                // Also save to backend immediately for dark mode
                this.saveGeneralSettings();
                // Trigger chart redraws if any
                window.dispatchEvent(new CustomEvent('dark-mode-changed', { 
                    detail: { enabled: this.settings.darkMode } 
                }));
            },
            
            toggleColorBlindMode() {
                localStorage.setItem('colorBlindMode', this.settings.colorBlindMode);
                document.documentElement.classList.toggle('color-blind-mode', this.settings.colorBlindMode);
                document.body.classList.toggle('color-blind-mode', this.settings.colorBlindMode);
                // Save to backend immediately
                this.saveGeneralSettings();
                // Trigger chart redraws if any
                window.dispatchEvent(new CustomEvent('colorblind-mode-changed', { 
                    detail: { enabled: this.settings.colorBlindMode } 
                }));
            },
            
            async saveGeneralSettings() {
                try {
                    localStorage.setItem('saveNegotiations', this.settings.saveNegotiations.toString());
                    await fetch('/api/settings/general', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            dark_mode: this.settings.darkMode,
                            color_blind_mode: this.settings.colorBlindMode,
                            save_negotiations: this.settings.saveNegotiations
                        })
                    });
                } catch (e) {
                    console.error('Failed to save general settings:', e);
                }
            },
            
            async saveSettings() {
                try {
                    localStorage.setItem('saveNegotiations', this.settings.saveNegotiations.toString());
                    const settings = {
                        general: {
                            dark_mode: this.settings.darkMode,
                            color_blind_mode: this.settings.colorBlindMode,
                            save_negotiations: this.settings.saveNegotiations
                        },
                        negotiation: {
                            default_max_steps: this.settings.defaultSteps,
                            default_step_delay_ms: this.settings.defaultDelay,
                            default_time_limit: null
                        },
                        genius_bridge: {
                            auto_start: this.settings.autoStartGenius,
                            java_path: null,
                            port: 25337
                        },
                        paths: {
                            scenario_paths: this.settings.scenarioPaths.split('\n').filter(p => p.trim()),
                            negotiator_paths: this.settings.negotiatorPaths.split('\n').filter(p => p.trim())
                        }
                    };
                    
                    await fetch('/api/settings', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    });
                    
                    // Also save source settings if modified
                    if (this.sourceSettings.disabled_sources.length > 0 || this.sourceSettings.custom_sources.length > 0) {
                        await fetch('/api/settings/negotiator_sources', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.sourceSettings)
                        });
                        // Refresh negotiator list after changing sources
                        await this.refreshNegotiators();
                    }
                    
                    this.showSettings = false;
                } catch (e) {
                    console.error('Failed to save settings:', e);
                }
            },
            
            // Preset management
            async loadRecentSessions() {
                try {
                    const res = await fetch('/api/settings/presets/recent');
                    if (res.ok) {
                        const data = await res.json();
                        this.recentSessions = data.presets || [];
                    }
                } catch (e) {
                    console.error('Failed to load recent sessions:', e);
                }
            },
            
            async loadSessionPresets() {
                try {
                    const res = await fetch('/api/settings/presets/sessions');
                    if (res.ok) {
                        const data = await res.json();
                        this.sessionPresets = data.presets || [];
                    }
                } catch (e) {
                    console.error('Failed to load session presets:', e);
                }
            },
            
            loadFullSession(session) {
                // Find the scenario in the loaded scenarios
                const scenario = this.scenarios.find(s => s.path === session.scenario_path);
                const mechType = session.mechanism_type || 'SAOMechanism';
                
                // First select the mechanism to initialize defaults
                // This must happen BEFORE setting newNeg so we can override with loaded values
                this.selectMechanism(mechType);
                
                // Now set up newNeg with loaded values (this will override any defaults)
                this.newNeg = {
                    source: '',
                    scenario: scenario || { path: session.scenario_path, name: session.scenario_name },
                    negotiators: session.negotiators.map((n, i) => ({
                        type_name: n.type_name,
                        name: n.name || `Agent${i + 1}`,
                        source: n.source || 'native',
                        requires_bridge: n.requires_bridge || false,
                        is_boa: n.is_boa || false,
                        boa_config: n.boa_config || null
                    })),
                    mechanism_type: mechType,
                    mechanism_params: { ...this.newNeg.mechanism_params, ...(session.mechanism_params || {}) },
                    share_ufuns: session.share_ufuns ?? false,
                    mode: session.mode || 'realtime',
                    step_delay: session.step_delay ?? 100,
                    show_plot: session.show_plot ?? true,
                    show_offers: session.show_offers ?? true,
                    auto_start: true,
                    panels: session.panels || {
                        adjustable: true,
                        utilityView: { xAxis: 0, yAxis: 1 },
                        timeline: { xAxis: 'relative_time' }
                    }
                };
                
                // Jump directly to display tab when loading a full session
                this.negotiationTab = 'display';
            },
            
            buildSessionPreset(name) {
                return {
                    name: name,
                    scenario_path: this.newNeg.scenario?.path,
                    scenario_name: this.newNeg.scenario?.name,
                    negotiators: this.newNeg.negotiators.map(n => ({
                        type_name: n.type_name,
                        name: n.name,
                        source: n.source,
                        requires_bridge: n.requires_bridge
                    })),
                    mechanism_type: this.newNeg.mechanism_type,
                    mechanism_params: this.newNeg.mechanism_params,
                    share_ufuns: this.newNeg.share_ufuns,
                    mode: this.newNeg.mode,
                    step_delay: this.newNeg.step_delay,
                    show_plot: this.newNeg.show_plot,
                    show_offers: this.newNeg.show_offers,
                    panels: this.newNeg.panels
                };
            },
            
            async saveFullSession() {
                if (!this.savePresetName.trim() || !this.newNeg.scenario) return;
                
                try {
                    const preset = this.buildSessionPreset(this.savePresetName.trim());
                    const res = await fetch('/api/settings/presets/sessions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(preset)
                    });
                    
                    if (res.ok) {
                        this.showSaveSessionModal = false;
                        this.savePresetName = '';
                        // Refresh the list
                        await this.loadSessionPresets();
                    }
                } catch (e) {
                    console.error('Failed to save session preset:', e);
                }
            },
            
            async deleteSessionPreset(name) {
                try {
                    const res = await fetch(`/api/settings/presets/sessions/${encodeURIComponent(name)}`, {
                        method: 'DELETE'
                    });
                    if (res.ok) {
                        await this.loadSessionPresets();
                    }
                } catch (e) {
                    console.error('Failed to delete session preset:', e);
                }
            },
            
            async addToRecentSessions() {
                if (!this.newNeg.scenario) return;
                
                try {
                    const preset = this.buildSessionPreset(this.newNeg.scenario.name);
                    await fetch('/api/settings/presets/recent', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(preset)
                    });
                } catch (e) {
                    console.error('Failed to add to recent sessions:', e);
                }
            }
        };
    }
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
