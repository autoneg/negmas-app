<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}NegMAS App{% endblock %}</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="/static/css/styles.css">
    
    <!-- Apply dark mode immediately to prevent flash -->
    <script>
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark-mode');
        }
        if (localStorage.getItem('colorBlindMode') === 'true') {
            document.documentElement.classList.add('color-blind-mode');
        }
    </script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>
    
    <!-- Alpine.js Collapse Plugin -->
    <script defer src="https://unpkg.com/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- SortableJS for drag-reorder -->
    <script src="https://unpkg.com/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <!-- Plotly.js for real-time plotting -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
    
    <!-- Tabulator for data tables -->
    <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator_midnight.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
    
    <!-- Layout System -->
    <link rel="stylesheet" href="/static/css/layout.css">
    <script src="/static/js/panel-registry.js"></script>
    <script src="/static/js/layout-manager.js"></script>
    <script src="/static/js/layout-renderer.js"></script>
    
    {% block head %}{% endblock %}
</head>
<body x-data="app()" x-init="init()">
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <span>NegMAS App</span>
            </div>
            
            <nav class="header-nav">
                <button class="header-nav-btn" :class="{ active: currentPage === 'negotiations' }" @click="currentPage = 'negotiations'">Negotiations</button>
                <button class="header-nav-btn" :class="{ active: currentPage === 'tournaments' }" @click="currentPage = 'tournaments'; loadTournamentSessions()">Tournaments</button>
                <button class="header-nav-btn" :class="{ active: currentPage === 'scenarios' }" @click="currentPage = 'scenarios'; loadScenariosForExplorer()">Scenarios</button>
                <button class="header-nav-btn" @click="showSettings = true">Settings</button>
            </nav>
            
            <div class="header-spacer"></div>
            
            <!-- Layout Switcher -->
            <div class="layout-switcher-container" x-data="{ open: false }" x-show="currentPage === 'negotiations' && currentNegotiation" x-cloak>
                <button class="header-btn layout-switcher-trigger" @click="open = !open" title="Change layout">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    <span class="layout-name" x-text="LayoutManager?.getActiveLayout()?.name || 'Layout'"></span>
                    <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
                <div class="layout-switcher-dropdown" x-show="open" @click.away="open = false" x-transition>
                    <div class="layout-switcher-section">
                        <div class="layout-switcher-title">Layouts</div>
                        <template x-for="layout in (LayoutManager?.getAvailableLayouts() || [])" :key="layout.id">
                            <button class="layout-option" 
                                    :class="{ active: LayoutManager?.getActiveLayout()?.id === layout.id }"
                                    @click="LayoutManager?.switchLayout(layout.id); open = false; $dispatch('layout-changed')">
                                <span class="layout-option-name" x-text="layout.name"></span>
                                <svg x-show="LayoutManager?.getActiveLayout()?.id === layout.id" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </button>
                        </template>
                    </div>
                    <div class="layout-switcher-divider"></div>
                    <div class="layout-switcher-section">
                        <button class="layout-option" @click="LayoutManager?.resetCurrentLayout(); open = false; $dispatch('layout-changed')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                                <path d="M3 3v5h5"></path>
                            </svg>
                            <span>Reset Layout</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Genius Bridge Status -->
            <div class="header-status genius-bridge-status" 
                 @click="toggleGeniusBridge()"
                 :title="geniusBridge.running ? 'Click to stop Genius Bridge' : 'Click to start Genius Bridge'">
                <span class="status-dot" :class="{ 'running': geniusBridge.running, 'stopped': !geniusBridge.running }"></span>
                <span x-text="geniusBridge.running ? 'Genius Bridge' : 'Genius Bridge (Off)'"></span>
                <span class="bridge-action-icon" x-show="geniusBridge.loading">
                    <svg class="spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                        <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="12"></circle>
                    </svg>
                </span>
            </div>
            
            <div class="header-status">
                <span class="status-dot" :class="{ 'disconnected': !connected }"></span>
                <span x-text="connected ? 'Connected' : 'Disconnected'"></span>
            </div>
            
            <div class="header-actions">
                <button class="btn btn-primary" @click="openNewNegotiation()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Negotiation
                </button>
            </div>
        </header>
        
        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Sidebar -->
            <aside class="sidebar" :class="{ collapsed: sidebarCollapsed }">
                <button class="sidebar-toggle" @click="sidebarCollapsed = !sidebarCollapsed" :title="sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <polyline :points="sidebarCollapsed ? '9 18 15 12 9 6' : '15 18 9 12 15 6'"></polyline>
                    </svg>
                </button>
                <div class="sidebar-section">
                    <div class="sidebar-section-title" x-show="!sidebarCollapsed">Quick Actions</div>
                    <button class="sidebar-btn primary" @click="openNewNegotiation()" :title="sidebarCollapsed ? 'Start Negotiation' : ''">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        <span x-show="!sidebarCollapsed">Start Negotiation</span>
                    </button>
                    <button class="sidebar-btn" @click="showNewTournament = true; currentPage = 'tournaments'; loadTournamentSessions()" :title="sidebarCollapsed ? 'Start Tournament' : ''">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="8" r="5"></circle>
                            <path d="M12 13v7"></path>
                            <path d="M9 20h6"></path>
                        </svg>
                        <span x-show="!sidebarCollapsed">Start Tournament</span>
                    </button>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title" x-show="!sidebarCollapsed">
                        Running
                        <span class="sidebar-badge" x-show="runningNegotiations.length > 0" x-text="runningNegotiations.length"></span>
                    </div>
                    <div class="negotiation-list" x-show="!sidebarCollapsed">
                        <template x-if="runningNegotiations.length === 0">
                            <p class="text-muted" style="font-size: 12px; padding: 8px;">No active negotiations</p>
                        </template>
                        <template x-for="neg in runningNegotiations" :key="neg.id">
                            <div class="negotiation-item" :class="{ active: currentNegotiation?.id === neg.id }" @click="selectNegotiation(neg)">
                                <div class="negotiation-item-title" x-text="neg.scenario"></div>
                                <div class="negotiation-item-meta">
                                    <span class="badge badge-primary">Running</span>
                                    <span x-text="'Step ' + neg.step"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title" x-show="!sidebarCollapsed">
                        Completed
                        <span class="sidebar-badge" x-show="completedNegotiations.length > 0" x-text="completedNegotiations.length"></span>
                    </div>
                    <div class="negotiation-list" x-show="!sidebarCollapsed">
                        <template x-if="completedNegotiations.length === 0">
                            <p class="text-muted" style="font-size: 12px; padding: 8px;">No completed negotiations</p>
                        </template>
                        <template x-for="neg in completedNegotiations" :key="neg.id">
                            <div class="negotiation-item" :class="{ active: currentNegotiation?.id === neg.id }" @click="selectNegotiation(neg)">
                                <div class="negotiation-item-title" x-text="neg.scenario"></div>
                                <div class="negotiation-item-meta">
                                    <span class="badge" :class="neg.agreement ? 'badge-success' : 'badge-warning'" x-text="neg.agreement ? 'Agreement' : 'No Agreement'"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Tournament Sections -->
                <div class="sidebar-section" x-show="tournamentSessions.some(t => t.status === 'running')">
                    <div class="sidebar-section-title" x-show="!sidebarCollapsed">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12" style="margin-right: 4px;">
                            <circle cx="12" cy="8" r="5"></circle>
                            <path d="M12 13v7"></path>
                            <path d="M9 20h6"></path>
                        </svg>
                        Running Tournaments
                        <span class="sidebar-badge" x-text="tournamentSessions.filter(t => t.status === 'running').length"></span>
                    </div>
                    <div class="negotiation-list" x-show="!sidebarCollapsed">
                        <template x-for="session in tournamentSessions.filter(t => t.status === 'running')" :key="session.id">
                            <div class="negotiation-item" :class="{ active: selectedTournament?.id === session.id && currentPage === 'tournaments' }" 
                                 @click="currentPage = 'tournaments'; selectTournament(session)">
                                <div class="negotiation-item-title" x-text="'Tournament #' + session.id"></div>
                                <div class="negotiation-item-meta">
                                    <span class="badge badge-primary">Running</span>
                                    <span x-text="Math.round(session.progress?.percent || 0) + '%'"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="sidebar-section" x-show="tournamentSessions.some(t => t.status !== 'running')">
                    <div class="sidebar-section-title" x-show="!sidebarCollapsed">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12" style="margin-right: 4px;">
                            <circle cx="12" cy="8" r="5"></circle>
                            <path d="M12 13v7"></path>
                            <path d="M9 20h6"></path>
                        </svg>
                        Past Tournaments
                        <span class="sidebar-badge" x-text="tournamentSessions.filter(t => t.status !== 'running').length"></span>
                    </div>
                    <div class="negotiation-list" x-show="!sidebarCollapsed">
                        <template x-for="session in tournamentSessions.filter(t => t.status !== 'running').slice(0, 5)" :key="session.id">
                            <div class="negotiation-item" :class="{ active: selectedTournament?.id === session.id && currentPage === 'tournaments' }" 
                                 @click="currentPage = 'tournaments'; selectTournament(session)">
                                <div class="negotiation-item-title" x-text="'Tournament #' + session.id"></div>
                                <div class="negotiation-item-meta">
                                    <span class="badge" 
                                          :class="{
                                              'badge-success': session.status === 'completed',
                                              'badge-danger': session.status === 'failed',
                                              'badge-warning': session.status === 'cancelled'
                                          }" 
                                          x-text="session.status"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Saved Tournaments Section -->
                <div class="sidebar-section" x-show="savedTournaments.length > 0">
                    <div class="sidebar-section-title" x-show="!sidebarCollapsed">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12" style="margin-right: 4px;">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                        </svg>
                        Saved Tournaments
                        <span class="sidebar-badge" x-text="savedTournaments.length"></span>
                    </div>
                    <div class="negotiation-list" x-show="!sidebarCollapsed">
                        <template x-for="t in savedTournaments.slice(0, 5)" :key="t.id">
                            <div class="negotiation-item" :class="{ active: selectedTournament?.id === t.id && currentPage === 'tournaments' }" 
                                 @click="currentPage = 'tournaments'; loadAndSelectSavedTournament(t.id)">
                                <div class="negotiation-item-title" x-text="t.name || t.id"></div>
                                <div class="negotiation-item-meta">
                                    <span x-text="t.n_negotiations + ' negs'"></span>
                                    <span x-text="Math.round((t.agreement_rate || 0) * 100) + '%'"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </aside>
            
            <!-- Content Area - Negotiations -->
            <main class="content-area" x-show="currentPage === 'negotiations'">
                {% block content %}{% endblock %}
            </main>
            
            <!-- Content Area - Scenario Explorer -->
            <div class="content-area scenario-explorer" x-show="currentPage === 'scenarios'" x-cloak>
                <div class="scenario-explorer-layout">
                    <!-- Left Panel: Filters & List -->
                    <div class="scenario-explorer-list">
                        <div class="scenario-explorer-header">
                            <h2>Scenario Explorer</h2>
                        </div>
                        
                        <div class="scenario-explorer-filters">
                            <div class="form-group">
                                <input type="text" class="form-input" placeholder="Search scenarios..." 
                                       x-model="explorerSearch" @input.debounce.300ms="filterExplorerScenarios()">
                            </div>
                            <div class="form-group">
                                <select class="form-select" x-model="explorerSourceFilter" @change="filterExplorerScenarios()">
                                    <option value="">All Sources</option>
                                    <template x-for="(source, idx) in (sources || [])" :key="source?.id || idx">
                                        <option :value="source.id" x-text="source.name + ' (' + source.count + ')'"></option>
                                    </template>
                                </select>
                            </div>
                            
                            <!-- Advanced Filters Toggle -->
                            <div class="form-group">
                                <button type="button" class="btn btn-link" style="padding: 0; font-size: 12px;" 
                                        @click="explorerFilters.showAdvanced = !explorerFilters.showAdvanced">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"
                                         :style="{ transform: explorerFilters.showAdvanced ? 'rotate(90deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                    Advanced Filters
                                </button>
                            </div>
                            
                            <!-- Advanced Filters Panel -->
                            <div class="form-group" x-show="explorerFilters.showAdvanced" x-collapse style="margin-top: 0;">
                                <div style="background: var(--bg-secondary); padding: 10px; border-radius: 6px; font-size: 12px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                        <div>
                                            <label style="font-size: 11px; color: var(--text-muted);">Min Outcomes</label>
                                            <input type="number" class="form-input form-input-sm" 
                                                   placeholder="10" 
                                                   x-model="explorerFilters.minOutcomes"
                                                   min="1" style="font-size: 12px;">
                                        </div>
                                        <div>
                                            <label style="font-size: 11px; color: var(--text-muted);">Max Outcomes</label>
                                            <input type="number" class="form-input form-input-sm" 
                                                   placeholder="1000"
                                                   x-model="explorerFilters.maxOutcomes"
                                                   min="1" style="font-size: 12px;">
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                        <div>
                                            <label style="font-size: 11px; color: var(--text-muted);">Min Rational %</label>
                                            <input type="number" class="form-input form-input-sm" 
                                                   placeholder="0.5" 
                                                   x-model="explorerFilters.minRationalFraction"
                                                   min="0" max="1" step="0.1" style="font-size: 12px;">
                                        </div>
                                        <div>
                                            <label style="font-size: 11px; color: var(--text-muted);">Max Rational %</label>
                                            <input type="number" class="form-input form-input-sm" 
                                                   placeholder="1.0"
                                                   x-model="explorerFilters.maxRationalFraction"
                                                   min="0" max="1" step="0.1" style="font-size: 12px;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Calculate Stats Button -->
                            <div class="form-group" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color);">
                                <button type="button" class="btn btn-secondary btn-sm" style="width: 100%;"
                                        @click="bulkCalculateStats(false)"
                                        :disabled="bulkStatsRunning">
                                    <template x-if="!bulkStatsRunning">
                                        <span>Calculate Missing Stats</span>
                                    </template>
                                    <template x-if="bulkStatsRunning">
                                        <span>Calculating... <span x-text="bulkStatsProgress?.completed || 0"></span>/<span x-text="bulkStatsProgress?.total || 0"></span></span>
                                    </template>
                                </button>
                                <button type="button" class="btn btn-link btn-sm" style="width: 100%; margin-top: 4px; font-size: 11px;"
                                        @click="bulkCalculateStats(true)"
                                        :disabled="bulkStatsRunning">
                                    Recalculate All Stats
                                </button>
                                <template x-if="bulkStatsProgress">
                                    <div style="margin-top: 8px;">
                                        <div class="progress-bar-container" style="height: 4px; background: var(--bg-tertiary); border-radius: 2px; overflow: hidden;">
                                            <div class="progress-bar" 
                                                 :style="'width: ' + (bulkStatsProgress.total > 0 ? (bulkStatsProgress.completed / bulkStatsProgress.total * 100) : 0) + '%'">
                                            </div>
                                        </div>
                                        <div class="text-muted" style="font-size: 10px; margin-top: 4px;" x-text="bulkStatsProgress.current_path?.split('/').pop() || ''"></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <div class="scenario-explorer-results">
                            <div class="text-muted" style="padding: 12px; font-size: 13px;" x-show="explorerLoading">
                                Loading scenarios...
                            </div>
                            <div class="text-muted" style="padding: 12px; font-size: 13px;" x-show="!explorerLoading && filteredExplorerScenarios.length === 0">
                                No scenarios found
                            </div>
                            <template x-for="scenario in filteredExplorerScenarios" :key="scenario.path">
                                <div class="scenario-explorer-item" 
                                     :class="{ selected: selectedScenario?.path === scenario.path }"
                                     @click="selectScenarioForExplorer(scenario)">
                                    <div class="scenario-explorer-item-name" x-text="scenario.name"></div>
                                    <div class="scenario-explorer-item-meta">
                                        <span class="badge badge-secondary" x-text="scenario.source"></span>
                                        <span x-text="scenario.n_negotiators + ' parties'"></span>
                                        <span x-text="(scenario.issues?.length || scenario.n_issues || '?') + ' issues'"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Right Panel: Scenario Details -->
                    <div class="scenario-explorer-details">
                        <template x-if="!selectedScenario">
                            <div class="scenario-explorer-empty">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="64" height="64" style="opacity: 0.3;">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10 9 9 9 8 9"></polyline>
                                </svg>
                                <p>Select a scenario to view details</p>
                            </div>
                        </template>
                        <template x-if="selectedScenario">
                            <div class="scenario-detail-view">
                                <div class="scenario-detail-header">
                                    <h2 x-text="selectedScenario.name"></h2>
                                    <div class="scenario-detail-actions">
                                        <button class="btn btn-primary btn-sm" @click="useScenarioInNegotiation(selectedScenario)">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                            </svg>
                                            Use in Negotiation
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="scenario-detail-content">
                                    <div class="scenario-detail-section">
                                        <h3>Overview</h3>
                                        <div class="scenario-detail-grid">
                                            <div class="scenario-detail-stat">
                                                <span class="stat-label">Source</span>
                                                <span class="stat-value" x-text="selectedScenario.source"></span>
                                            </div>
                                            <div class="scenario-detail-stat">
                                                <span class="stat-label">Parties</span>
                                                <span class="stat-value" x-text="selectedScenario.n_negotiators"></span>
                                            </div>
                                            <div class="scenario-detail-stat">
                                                <span class="stat-label">Issues</span>
                                                <span class="stat-value" x-text="selectedScenario.issues?.length || selectedScenario.n_issues || '?'"></span>
                                            </div>
                                            <div class="scenario-detail-stat">
                                                <span class="stat-label">Outcomes</span>
                                                <span class="stat-value" x-text="selectedScenario.n_outcomes || '?'"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="scenario-detail-section">
                                        <h3>Issues</h3>
                                        <div class="scenario-issues-list">
                                            <template x-for="issue in (selectedScenario.issues || [])" :key="issue.name">
                                                <div class="scenario-issue-item">
                                                    <div class="issue-name" x-text="issue.name"></div>
                                                    <div class="issue-type">
                                                        <span class="badge badge-neutral" x-text="issue.type"></span>
                                                    </div>
                                                    <div class="issue-values" x-show="issue.values">
                                                        <template x-if="issue.values && issue.values.length <= 10">
                                                            <span class="text-muted" x-text="issue.values.join(', ')"></span>
                                                        </template>
                                                        <template x-if="issue.values && issue.values.length > 10">
                                                            <span class="text-muted" x-text="issue.values.slice(0, 10).join(', ') + '... (' + issue.values.length + ' total)'"></span>
                                                        </template>
                                                    </div>
                                                    <div class="issue-range" x-show="issue.min !== undefined">
                                                        <span class="text-muted" x-text="'Range: ' + issue.min + ' - ' + issue.max"></span>
                                                    </div>
                                                </div>
                                            </template>
                                            <div class="text-muted" x-show="!selectedScenario.issues || selectedScenario.issues.length === 0" style="padding: 8px 0;">
                                                Issue details not available
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Statistics Section -->
                                    <div class="scenario-detail-section">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <h3>Statistics</h3>
                                            <div style="display: flex; gap: 8px;">
                                                <button class="btn btn-secondary btn-xs" 
                                                        @click="calculateScenarioStats(selectedScenario.path, false)"
                                                        :disabled="scenarioStatsLoading"
                                                        x-show="!selectedScenario.has_stats && !scenarioStats">
                                                    <span x-text="scenarioStatsLoading ? 'Calculating...' : 'Calculate Stats'"></span>
                                                </button>
                                                <button class="btn btn-secondary btn-xs" 
                                                        @click="calculateScenarioStats(selectedScenario.path, true)"
                                                        :disabled="scenarioStatsLoading"
                                                        x-show="scenarioStats"
                                                        title="Recalculate statistics">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                                        <path d="M23 4v6h-6"></path>
                                                        <path d="M1 20v-6h6"></path>
                                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
                                                        <path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Loading state -->
                                        <div x-show="scenarioStatsLoading" class="text-muted" style="padding: 12px 0;">
                                            Loading statistics...
                                        </div>
                                        
                                        <!-- Error state -->
                                        <div x-show="scenarioStatsError" class="text-muted" style="padding: 12px 0; color: var(--danger);">
                                            <span x-text="scenarioStatsError"></span>
                                        </div>
                                        
                                        <!-- No stats available -->
                                        <div x-show="!scenarioStatsLoading && !scenarioStats && !scenarioStatsError" class="text-muted" style="padding: 12px 0;">
                                            <span x-show="selectedScenario.has_stats">Stats cached but not loaded</span>
                                            <span x-show="!selectedScenario.has_stats">Click "Calculate Stats" to compute scenario statistics</span>
                                        </div>
                                        
                                        <!-- Stats display -->
                                        <div x-show="scenarioStats && scenarioStats.has_stats" class="scenario-stats-content">
                                            <!-- Opposition -->
                                            <div class="scenario-detail-grid" style="margin-bottom: 12px;">
                                                <div class="scenario-detail-stat">
                                                    <span class="stat-label">Opposition</span>
                                                    <span class="stat-value" x-text="scenarioStats?.opposition?.toFixed(3) ?? 'N/A'"></span>
                                                </div>
                                                <div class="scenario-detail-stat">
                                                    <span class="stat-label">Pareto Outcomes</span>
                                                    <span class="stat-value" x-text="scenarioStats?.n_pareto_outcomes ?? 'N/A'"></span>
                                                </div>
                                            </div>
                                            
                                            <!-- Utility Ranges -->
                                            <template x-if="scenarioStats?.utility_ranges && scenarioStats.utility_ranges.length > 0">
                                                <div style="margin-bottom: 12px;">
                                                    <div class="text-muted" style="font-size: 11px; margin-bottom: 4px;">Utility Ranges</div>
                                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                                        <template x-for="(range, idx) in scenarioStats.utility_ranges" :key="idx">
                                                            <span class="badge badge-neutral" 
                                                                  x-text="(scenarioStats.negotiator_names?.[idx] || ('Party ' + (idx+1))) + ': [' + range[0].toFixed(2) + ', ' + range[1].toFixed(2) + ']'">
                                                            </span>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                            
                                            <!-- Special Points -->
                                            <div class="text-muted" style="font-size: 11px; margin-bottom: 4px;">Special Points</div>
                                            <div class="scenario-special-points" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                                <!-- Nash Point -->
                                                <div class="special-point-item" x-show="scenarioStats?.nash_utils?.length > 0">
                                                    <span class="point-label">Nash:</span>
                                                    <span class="point-value" x-text="scenarioStats?.nash_utils?.[0]?.map(u => u.toFixed(3)).join(', ') ?? 'N/A'"></span>
                                                </div>
                                                <!-- Kalai Point -->
                                                <div class="special-point-item" x-show="scenarioStats?.kalai_utils?.length > 0">
                                                    <span class="point-label">Kalai:</span>
                                                    <span class="point-value" x-text="scenarioStats?.kalai_utils?.[0]?.map(u => u.toFixed(3)).join(', ') ?? 'N/A'"></span>
                                                </div>
                                                <!-- Kalai-Smorodinsky Point -->
                                                <div class="special-point-item" x-show="scenarioStats?.ks_utils?.length > 0">
                                                    <span class="point-label">KS:</span>
                                                    <span class="point-value" x-text="scenarioStats?.ks_utils?.[0]?.map(u => u.toFixed(3)).join(', ') ?? 'N/A'"></span>
                                                </div>
                                                <!-- Max Welfare Point -->
                                                <div class="special-point-item" x-show="scenarioStats?.max_welfare_utils?.length > 0">
                                                    <span class="point-label">Max Welfare:</span>
                                                    <span class="point-value" x-text="scenarioStats?.max_welfare_utils?.[0]?.map(u => u.toFixed(3)).join(', ') ?? 'N/A'"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="scenario-detail-section">
                                        <h3>Path</h3>
                                        <div class="scenario-path">
                                            <code x-text="selectedScenario.path"></code>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            
            <!-- Content Area - Tournaments -->
            <div class="content-area tournament-page" x-show="currentPage === 'tournaments'" x-cloak>
                <!-- Tournament List View (when no tournament selected) -->
                <div class="tournament-list-view" x-show="!selectedTournament">
                    <!-- Header with actions -->
                    <div class="table-header" style="margin-bottom: 16px;">
                        <h2>Tournaments</h2>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button class="btn btn-secondary btn-sm" @click="loadSavedTournaments()" :disabled="savedTournamentsLoading">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                                <span x-text="savedTournamentsLoading ? 'Loading...' : 'Load Saved'"></span>
                            </button>
                            <button class="btn btn-primary" @click="showNewTournament = true; loadScenarios(); loadNegotiatorTypes()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                Start Tournament
                            </button>
                        </div>
                    </div>
                    
                    <div class="tournament-tables-layout" style="display: flex; flex-direction: column; gap: 16px; height: calc(100% - 60px); overflow: auto;">
                        <!-- Running Tournaments -->
                        <div class="table-section" x-show="tournamentSessions.some(t => t.status === 'running')">
                            <h3>
                                <span class="status-dot running"></span>
                                Running (<span x-text="tournamentSessions.filter(t => t.status === 'running').length"></span>)
                            </h3>
                            <div class="tournament-list-grid">
                                <template x-for="session in tournamentSessions.filter(t => t.status === 'running')" :key="session.id">
                                    <div class="tournament-list-item" @click="selectTournament(session)">
                                        <div class="tournament-list-item-header">
                                            <span class="tournament-id">Tournament #<span x-text="session.id"></span></span>
                                            <span class="badge badge-primary">Running</span>
                                        </div>
                                        <div class="progress" style="height: 4px; margin-top: 4px;">
                                            <div class="progress-bar" :style="'width: ' + (session.progress?.percent || 0) + '%'"></div>
                                        </div>
                                        <div class="text-muted" style="font-size: 11px; margin-top: 4px;" x-text="Math.round(session.progress?.percent || 0) + '% complete'"></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Completed Tournaments (this session) -->
                        <div class="table-section" x-show="tournamentSessions.some(t => t.status !== 'running')">
                            <h3>
                                <span class="status-dot" style="background: var(--success);"></span>
                                This Session (<span x-text="tournamentSessions.filter(t => t.status !== 'running').length"></span>)
                            </h3>
                            <div class="tournament-list-grid">
                                <template x-for="session in tournamentSessions.filter(t => t.status !== 'running')" :key="session.id">
                                    <div class="tournament-list-item" @click="selectTournament(session)">
                                        <div class="tournament-list-item-header">
                                            <span class="tournament-id">Tournament #<span x-text="session.id"></span></span>
                                            <span class="badge" 
                                                  :class="{'badge-success': session.status === 'completed', 'badge-danger': session.status === 'failed', 'badge-warning': session.status === 'cancelled'}"
                                                  x-text="session.status"></span>
                                        </div>
                                        <div class="text-muted" style="font-size: 11px; margin-top: 4px;">
                                            <span x-text="(session.results?.total_negotiations || 0) + ' negotiations'"></span>
                                            <span x-show="session.results?.overall_agreement_rate !== undefined" x-text="' â€¢ ' + Math.round((session.results?.overall_agreement_rate || 0) * 100) + '% agreements'"></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Saved Tournaments -->
                        <div class="table-section saved-tournaments-section" x-show="savedTournaments.length > 0">
                            <h3 style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="display: flex; align-items: center; gap: 8px;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                                    </svg>
                                    Saved (<span x-text="savedTournaments.length"></span>)
                                </span>
                                <button class="btn btn-ghost btn-xs" @click="clearSavedTournaments()" title="Clear all saved">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </h3>
                            <div class="tournament-list-grid">
                                <template x-for="t in savedTournaments" :key="t.id">
                                    <div class="tournament-list-item" @click="loadAndSelectSavedTournament(t.id)">
                                        <div class="tournament-list-item-header">
                                            <span class="tournament-id" x-text="t.name || t.id"></span>
                                            <button class="btn btn-ghost btn-xs delete-btn" @click.stop="deleteSavedTournament(t.id)" title="Delete">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="text-muted" style="font-size: 11px; margin-top: 4px;">
                                            <span x-text="t.n_negotiations + ' negotiations'"></span>
                                            <span x-text="' â€¢ ' + Math.round((t.agreement_rate || 0) * 100) + '% agreements'"></span>
                                        </div>
                                        <div class="text-muted" style="font-size: 10px; margin-top: 2px;" x-text="t.created_at ? new Date(t.created_at).toLocaleString() : ''"></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Empty state when no tournaments -->
                        <div class="empty-state" x-show="tournamentSessions.length === 0 && savedTournaments.length === 0" style="flex: 1;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="opacity: 0.3;">
                                <circle cx="12" cy="8" r="5"></circle>
                                <path d="M12 13v7"></path>
                                <path d="M9 20h6"></path>
                            </svg>
                            <div class="empty-state-title">No Tournaments</div>
                            <div class="empty-state-text">Start a new tournament or load saved ones.</div>
                        </div>
                    </div>
                </div>
                
                <!-- Single Tournament View (when tournament selected) -->
                <div class="tournament-single-view" x-show="selectedTournament">
                    <!-- Compact Header -->
                    <div class="table-header" style="margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <h2 style="font-size: 16px;" x-text="selectedTournament?._fromSaved ? selectedTournament?.id : 'Tournament #' + selectedTournament?.id"></h2>
                        </div>
                        <div class="tournament-actions" style="display: flex; gap: 8px;">
                            <button class="btn btn-sm btn-ghost" @click="selectedTournament = null">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                                Close
                            </button>
                            <button class="btn btn-sm btn-danger" 
                                    x-show="selectedTournament?.status === 'running'"
                                    @click="cancelTournament(selectedTournament.id)">
                                Cancel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tournament View Container -->
                    <div class="tournament-view-container" x-show="selectedTournament?.status === 'running' || selectedTournament?.status === 'completed'" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                                    <!-- Stats Bar (single line) -->
                                    <div class="tournament-stats-bar">
                                        <div class="tournament-stats-inline">
                                            <span class="stat-inline">
                                                <span class="stat-label">Negotiations:</span>
                                                <span class="stat-value" x-text="selectedTournament?.status === 'completed' ? (selectedTournament?.results?.total_negotiations || 0) : ((selectedTournament?.progress?.completed || 0) + '/' + (selectedTournament?.progress?.total || 0))"></span>
                                            </span>
                                            <span class="stat-inline" x-show="selectedTournament?.status === 'completed'">
                                                <span class="stat-label">Agreements:</span>
                                                <span class="stat-value" x-text="(selectedTournament?.results?.total_agreements || 0) + ' (' + Math.round((selectedTournament?.results?.overall_agreement_rate || 0) * 100) + '%)'"></span>
                                            </span>
                                            <span class="stat-inline" x-show="selectedTournament?.status === 'running'">
                                                <span class="stat-label">Progress:</span>
                                                <span class="stat-value" x-text="Math.round(selectedTournament?.progress?.percent || 0) + '%'"></span>
                                            </span>
                                            <span class="stat-inline" x-show="selectedTournament?.results?.execution_time">
                                                <span class="stat-label">Duration:</span>
                                                <span class="stat-value" x-text="(selectedTournament?.results?.execution_time || 0).toFixed(1) + 's'"></span>
                                            </span>
                                        </div>
                                        <!-- Progress bar for running tournaments -->
                                        <div class="tournament-progress-bar-inline" x-show="selectedTournament?.status === 'running'">
                                            <div class="tournament-progress-fill" :style="'width: ' + (selectedTournament?.progress?.percent || 0) + '%'"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Main content: Grid + Scores panels -->
                                    <div class="tournament-main-panels">
                                        <!-- Grid Pane (collapsible) -->
                                        <div class="tournament-grid-pane" :class="{ collapsed: tournamentPanelCollapsed.grid }">
                                            <div class="tournament-panel-header" @click="tournamentPanelCollapsed.grid = !tournamentPanelCollapsed.grid">
                                                <h3>
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" 
                                                         :style="{ transform: tournamentPanelCollapsed.grid ? 'rotate(-90deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }">
                                                        <polyline points="6 9 12 15 18 9"></polyline>
                                                    </svg>
                                                    Competition Grid
                                                </h3>
                                            </div>
                                            
                                            <div class="tournament-panel-content" x-show="!tournamentPanelCollapsed.grid" x-collapse>
                                                <!-- Tabs: Summary + Scenarios -->
                                                <div class="tournament-scenario-tabs">
                                                    <button class="tournament-scenario-tab" 
                                                            :class="{ active: tournamentGrid.currentTab === 'summary' }"
                                                            @click="tournamentGrid.currentTab = 'summary'">Summary</button>
                                                    <template x-for="(scenario, idx) in tournamentGrid.scenarios" :key="idx">
                                                        <button class="tournament-scenario-tab" 
                                                                :class="{ active: tournamentGrid.currentTab === idx }"
                                                                @click="tournamentGrid.currentTab = idx"
                                                                x-text="scenario"></button>
                                                    </template>
                                                </div>
                                                
                                                <div class="tournament-grid-wrapper">
                                                    <!-- Empty state when grid not initialized -->
                                                    <div class="tournament-grid-empty" x-show="tournamentGrid.competitors.length === 0">
                                                        <div class="spinner"></div>
                                                        <p>Initializing tournament...</p>
                                                    </div>
                                                    
                                                    <!-- Summary Grid (aggregated across all scenarios) -->
                                                    <div class="tournament-grid" x-show="tournamentGrid.competitors.length > 0 && tournamentGrid.currentTab === 'summary'"
                                                         :style="'grid-template-columns: auto repeat(' + tournamentGrid.opponents.length + ', 1fr)'">
                                                        <!-- Header Row -->
                                                        <div class="tournament-grid-header-cell"></div>
                                                        <template x-for="(opponent, j) in tournamentGrid.opponents" :key="'sh-'+j">
                                                            <div class="tournament-grid-header-cell" :title="opponent" x-text="opponent.slice(0, 12)"></div>
                                                        </template>
                                                        
                                                        <!-- Data Rows -->
                                                        <template x-for="(competitor, i) in tournamentGrid.competitors" :key="'sr-'+i">
                                                            <div class="tournament-grid-row" style="display: contents;">
                                                                <div class="tournament-grid-row-header" :title="competitor" x-text="competitor.slice(0, 12)"></div>
                                                                <template x-for="(opponent, j) in tournamentGrid.opponents" :key="'sc-'+i+'-'+j">
                                                                    <div class="tournament-cell summary-cell" 
                                                                         :class="{ 'self-play': i === j && !newTournament.self_play }"
                                                                         :style="getSummaryCellStyle(i, j)">
                                                                        <span class="summary-percent" x-text="getSummaryCellPercent(i, j)"></span>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </template>
                                                    </div>
                                                    
                                                    <!-- Scenario-specific Grid -->
                                                    <div class="tournament-grid" x-show="tournamentGrid.competitors.length > 0 && tournamentGrid.currentTab !== 'summary'"
                                                         :style="'grid-template-columns: auto repeat(' + tournamentGrid.opponents.length + ', 1fr)'">
                                                        <!-- Header Row -->
                                                        <div class="tournament-grid-header-cell"></div>
                                                        <template x-for="(opponent, j) in tournamentGrid.opponents" :key="'h-'+j">
                                                            <div class="tournament-grid-header-cell" :title="opponent" x-text="opponent.slice(0, 12)"></div>
                                                        </template>
                                                        
                                                        <!-- Data Rows -->
                                                        <template x-for="(competitor, i) in tournamentGrid.competitors" :key="'r-'+i">
                                                            <div class="tournament-grid-row" style="display: contents;">
                                                                <div class="tournament-grid-row-header" :title="competitor" x-text="competitor.slice(0, 12)"></div>
                                                                <template x-for="(opponent, j) in tournamentGrid.opponents" :key="'c-'+i+'-'+j">
                                                                    <div class="tournament-cell" :class="getScenarioCellClass(i, j)">
                                                                        <!-- Icon based on state -->
                                                                        <template x-if="getScenarioCellStatus(i, j) === 'running'">
                                                                            <div class="spinner spinner-xs"></div>
                                                                        </template>
                                                                        <template x-if="getScenarioCellStatus(i, j) === 'agreement'">
                                                                            <svg class="tournament-cell-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                                <polyline points="20 6 9 17 4 12"></polyline>
                                                                            </svg>
                                                                        </template>
                                                                        <template x-if="getScenarioCellStatus(i, j) === 'timeout'">
                                                                            <svg class="tournament-cell-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                                <circle cx="12" cy="12" r="10"></circle>
                                                                                <polyline points="12 6 12 12 16 14"></polyline>
                                                                            </svg>
                                                                        </template>
                                                                        <template x-if="getScenarioCellStatus(i, j) === 'error' || getScenarioCellStatus(i, j) === 'broken'">
                                                                            <svg class="tournament-cell-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                                <circle cx="12" cy="12" r="10"></circle>
                                                                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                                                                <line x1="9" y1="9" x2="15" y2="15"></line>
                                                                            </svg>
                                                                        </template>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Scores Pane (collapsible) -->
                                        <div class="tournament-scores-pane" :class="{ collapsed: tournamentPanelCollapsed.scores }">
                                            <div class="tournament-panel-header" @click="tournamentPanelCollapsed.scores = !tournamentPanelCollapsed.scores">
                                                <h3>
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" 
                                                         :style="{ transform: tournamentPanelCollapsed.scores ? 'rotate(-90deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }">
                                                        <polyline points="6 9 12 15 18 9"></polyline>
                                                    </svg>
                                                    <span x-text="selectedTournament?.status === 'completed' ? 'Final Rankings' : 'Live Leaderboard'"></span>
                                                </h3>
                                            </div>
                                            
                                            <div class="tournament-panel-content" x-show="!tournamentPanelCollapsed.scores" x-collapse>
                                                <!-- Live Leaderboard (running) -->
                                                <div class="tournament-leaderboard-content" x-show="selectedTournament?.status === 'running'">
                                                    <template x-if="tournamentLeaderboard.length === 0">
                                                        <div class="empty-state-mini">
                                                            <p>Waiting for results...</p>
                                                        </div>
                                                    </template>
                                                    <template x-for="entry in tournamentLeaderboard" :key="entry.name">
                                                        <div class="leaderboard-entry" :class="'rank-' + entry.rank">
                                                            <div class="leaderboard-rank" x-text="entry.rank"></div>
                                                            <div class="leaderboard-info">
                                                                <div class="leaderboard-name" x-text="entry.name"></div>
                                                                <div class="leaderboard-stats">
                                                                    <span x-text="entry.n_negotiations + ' games'"></span>
                                                                    <span x-text="entry.n_agreements + ' agr'"></span>
                                                                </div>
                                                            </div>
                                                            <div class="leaderboard-score" x-text="entry.score.toFixed(3)"></div>
                                                        </div>
                                                    </template>
                                                </div>
                                                
                                                <!-- Final Rankings (completed) -->
                                                <div class="tournament-final-rankings" x-show="selectedTournament?.status === 'completed'">
                                                    <template x-for="score in (selectedTournament?.results?.final_scores || [])" :key="score.name">
                                                        <div class="leaderboard-entry" :class="'rank-' + score.rank">
                                                            <div class="leaderboard-rank" x-text="score.rank"></div>
                                                            <div class="leaderboard-info">
                                                                <div class="leaderboard-name" x-text="score.name"></div>
                                                                <div class="leaderboard-stats">
                                                                    <span x-text="(score.n_agreements || 0) + '/' + (score.n_negotiations || 0) + ' agr'"></span>
                                                                    <span x-text="'u:' + (score.mean_utility?.toFixed(2) || '-')"></span>
                                                                </div>
                                                            </div>
                                                            <div class="leaderboard-score" x-text="score.score?.toFixed(3) || '-'"></div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Negotiations Panel (collapsible, for running and completed) -->
                                    <div class="tournament-negotiations-panel" 
                                         x-show="(selectedTournament?.status === 'running' && tournamentLiveNegotiations.length > 0) || (selectedTournament?.status === 'completed' && selectedTournament?.results?.negotiations?.length > 0)" 
                                         :class="{ collapsed: tournamentPanelCollapsed.negotiations }">
                                        <div class="tournament-panel-header" @click="tournamentPanelCollapsed.negotiations = !tournamentPanelCollapsed.negotiations">
                                            <h3>
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" 
                                                     :style="{ transform: tournamentPanelCollapsed.negotiations ? 'rotate(-90deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                                <span x-text="selectedTournament?.status === 'running' ? 'Live Negotiations' : 'Negotiations'"></span>
                                                (<span x-text="selectedTournament?.status === 'running' ? tournamentLiveNegotiations.length : (selectedTournament?.results?.negotiations?.length || 0)"></span>)
                                            </h3>
                                        </div>
                                        
                                        <div class="tournament-panel-content negotiations-list" x-show="!tournamentPanelCollapsed.negotiations" x-collapse>
                                            <table class="tournament-table tournament-negotiations-table">
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Scenario</th>
                                                        <th>Partners</th>
                                                        <th>Result</th>
                                                        <th>Utilities</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- Live negotiations (running tournament) - show in reverse order (newest first) -->
                                                    <template x-if="selectedTournament?.status === 'running'">
                                                        <template x-for="neg in [...tournamentLiveNegotiations].reverse()" :key="'live-' + neg.index">
                                                            <tr class="negotiation-row" @click="viewTournamentNegotiation(neg)" style="cursor: pointer;" title="Click to view details">
                                                                <td x-text="neg.index + 1"></td>
                                                                <td x-text="neg.scenario"></td>
                                                                <td x-text="(neg.partners || []).join(' vs ')"></td>
                                                                <td>
                                                                    <span class="badge badge-sm" :class="neg.has_agreement ? 'badge-success' : (neg.has_error ? 'badge-danger' : 'badge-warning')"
                                                                          x-text="neg.has_agreement ? 'Agr' : (neg.has_error ? 'Err' : 'No')"></span>
                                                                </td>
                                                                <td x-text="neg.utilities ? neg.utilities.map(u => u.toFixed(2)).join(', ') : '-'"></td>
                                                            </tr>
                                                        </template>
                                                    </template>
                                                    <!-- Final negotiations (completed tournament) -->
                                                    <template x-if="selectedTournament?.status === 'completed'">
                                                        <template x-for="neg in (selectedTournament?.results?.negotiations || [])" :key="'final-' + neg.index">
                                                            <tr class="negotiation-row" @click="viewTournamentNegotiation(neg)" style="cursor: pointer;" title="Click to view details">
                                                                <td x-text="neg.index + 1"></td>
                                                                <td x-text="neg.scenario"></td>
                                                                <td x-text="(neg.partners || []).join(' vs ')"></td>
                                                                <td>
                                                                    <span class="badge badge-sm" :class="neg.has_agreement ? 'badge-success' : (neg.has_error ? 'badge-danger' : 'badge-warning')"
                                                                          x-text="neg.has_agreement ? 'Agr' : (neg.has_error ? 'Err' : 'No')"></span>
                                                                </td>
                                                                <td x-text="neg.utilities ? neg.utilities.map(u => u.toFixed(2)).join(', ') : '-'"></td>
                                                            </tr>
                                                        </template>
                                                    </template>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                    </div>
                    
                    <!-- Error Section (for failed tournaments) -->
                    <div class="tournament-error-section" x-show="selectedTournament?.status === 'failed'">
                        <div class="error-message">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                            <span x-text="selectedTournament?.error || 'Unknown error'"></span>
                        </div>
                    </div>
                    
                    <!-- Config Section -->
                    <div class="tournament-config-section" x-show="selectedTournament?.config && selectedTournament?.config.competitor_types?.length > 0">
                        <h4>Configuration</h4>
                        <div class="config-grid">
                            <div class="config-item">
                                <span class="config-label">Competitors:</span>
                                <span x-text="selectedTournament?.config?.competitor_types?.join(', ') || '-'"></span>
                            </div>
                            <div class="config-item">
                                <span class="config-label">Scenarios:</span>
                                <span x-text="(selectedTournament?.config?.scenario_paths?.length || 0) + ' selected'"></span>
                            </div>
                            <div class="config-item">
                                <span class="config-label">Repetitions:</span>
                                <span x-text="selectedTournament?.config?.n_repetitions || 1"></span>
                            </div>
                            <div class="config-item">
                                <span class="config-label">Mechanism:</span>
                                <span x-text="selectedTournament?.config?.mechanism_type || 'SAOMechanism'"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Start Negotiation Modal -->
    <div class="modal-overlay" :class="{ active: showNewNegotiation }" @click.self="showNewNegotiation = false">
        <div class="modal large">
            <div class="modal-header">
                <h2 class="modal-title">Start New Negotiation</h2>
                <div class="modal-header-actions">
                    <!-- Recent Sessions Dropdown -->
                    <div class="dropdown" x-data="{ open: false }">
                        <button class="btn btn-sm btn-secondary" @click="open = !open; loadRecentSessions()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            Recent
                        </button>
                        <div class="dropdown-menu" x-show="open" @click.away="open = false" style="right: 0; min-width: 280px;">
                            <template x-if="recentSessions.length === 0">
                                <div class="dropdown-item text-muted">No recent sessions</div>
                            </template>
                            <template x-for="session in recentSessions" :key="session.name + session.last_used_at">
                                <div class="dropdown-item" @click="loadFullSession(session); open = false">
                                    <div class="font-medium" x-text="session.scenario_name"></div>
                                    <div class="text-muted" style="font-size: 11px;" x-text="session.negotiators.map(n => n.name).join(' vs ')"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                    <!-- Saved Sessions Dropdown -->
                    <div class="dropdown" x-data="{ open: false }">
                        <button class="btn btn-sm btn-secondary" @click="open = !open; loadSessionPresets()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                            Load
                        </button>
                        <div class="dropdown-menu" x-show="open" @click.away="open = false" style="right: 0; min-width: 280px;">
                            <template x-if="sessionPresets.length === 0">
                                <div class="dropdown-item text-muted">No saved sessions</div>
                            </template>
                            <template x-for="preset in sessionPresets" :key="preset.name">
                                <div class="dropdown-item" style="display: flex; justify-content: space-between; align-items: center;">
                                    <div @click="loadFullSession(preset); open = false" style="flex: 1; cursor: pointer;">
                                        <div class="font-medium" x-text="preset.name"></div>
                                        <div class="text-muted" style="font-size: 11px;" x-text="preset.scenario_name"></div>
                                    </div>
                                    <button class="btn-icon-sm" @click.stop="deleteSessionPreset(preset.name)" title="Delete">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>
                    <!-- Save Session Button -->
                    <button class="btn btn-sm btn-primary" @click="showSaveSessionModal = true" :disabled="!newNeg.scenario">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        Save
                    </button>
                </div>
                <button class="modal-close" @click="showNewNegotiation = false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body" style="padding: 0;">
                <!-- Wizard Layout with Vertical Tabs -->
                <div class="wizard-layout">
                    <!-- Vertical Sidebar Tabs -->
                    <div class="wizard-sidebar">
                        <button class="wizard-tab" :class="{ active: negotiationTab === 'scenario', completed: newNeg.scenario }" @click="negotiationTab = 'scenario'" title="Scenario">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                            <span class="wizard-tab-label">Scenario</span>
                        </button>
                        <button class="wizard-tab" :class="{ active: negotiationTab === 'negotiators', completed: newNeg.negotiators.length >= (newNeg.scenario?.n_negotiators || 2) }" @click="negotiationTab = 'negotiators'" title="Negotiators">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            <span class="wizard-tab-label">Negotiators</span>
                        </button>
                        <button class="wizard-tab" :class="{ active: negotiationTab === 'parameters' }" @click="negotiationTab = 'parameters'" title="Parameters">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                            </svg>
                            <span class="wizard-tab-label">Params</span>
                        </button>
                        <button class="wizard-tab" :class="{ active: negotiationTab === 'panels' }" @click="negotiationTab = 'panels'" title="Panels">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                            <span class="wizard-tab-label">Panels</span>
                        </button>
                        <button class="wizard-tab" :class="{ active: negotiationTab === 'display' }" @click="negotiationTab = 'display'" title="Display & Run">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                            <span class="wizard-tab-label">Run</span>
                        </button>
                    </div>
                    
                    <!-- Tab Content -->
                    <div class="wizard-content">
                
                <!-- Tab: Scenario Selection -->
                <div x-show="negotiationTab === 'scenario'">
                    <div class="form-group">
                        <label class="form-label">Search Scenarios</label>
                        <input type="text" class="form-input" placeholder="Type to search all scenarios..." x-model="scenarioSearch" @input="searchScenarios()">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Filter by Source <span class="text-muted">(optional)</span></label>
                        <select class="form-select" x-model="newNeg.source" @change="filterBySource()">
                            <option value="">All sources</option>
                            <template x-for="(source, idx) in (sources || [])" :key="source?.id || idx">
                                <option :value="source.id" x-text="source.name"></option>
                            </template>
                        </select>
                    </div>
                    
                    <!-- Advanced Filters Toggle -->
                    <div class="form-group">
                        <button type="button" class="btn btn-link" style="padding: 0; font-size: 13px;" 
                                @click="scenarioFilters.showAdvanced = !scenarioFilters.showAdvanced">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"
                                 :style="{ transform: scenarioFilters.showAdvanced ? 'rotate(90deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                            Advanced Filters
                        </button>
                    </div>
                    
                    <!-- Advanced Filters Panel -->
                    <div class="form-group" x-show="scenarioFilters.showAdvanced" x-collapse>
                        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <label class="form-label" style="font-size: 12px;">Min Outcomes</label>
                                    <input type="number" class="form-input form-input-sm" 
                                           placeholder="e.g. 10" 
                                           x-model="scenarioFilters.minOutcomes"
                                           min="1">
                                </div>
                                <div>
                                    <label class="form-label" style="font-size: 12px;">Max Outcomes</label>
                                    <input type="number" class="form-input form-input-sm" 
                                           placeholder="e.g. 1000"
                                           x-model="scenarioFilters.maxOutcomes"
                                           min="1">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <label class="form-label" style="font-size: 12px;">Min Rational Fraction</label>
                                    <input type="number" class="form-input form-input-sm" 
                                           placeholder="e.g. 0.5" 
                                           x-model="scenarioFilters.minRationalFraction"
                                           min="0" max="1" step="0.1">
                                </div>
                                <div>
                                    <label class="form-label" style="font-size: 12px;">Max Rational Fraction</label>
                                    <input type="number" class="form-input form-input-sm" 
                                           placeholder="e.g. 1.0"
                                           x-model="scenarioFilters.maxRationalFraction"
                                           min="0" max="1" step="0.1">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <label class="form-label" style="font-size: 12px;">Min Opposition</label>
                                    <input type="number" class="form-input form-input-sm" 
                                           placeholder="e.g. 0.0" 
                                           x-model="scenarioFilters.minOpposition"
                                           min="0" max="1" step="0.1">
                                </div>
                                <div>
                                    <label class="form-label" style="font-size: 12px;">Max Opposition</label>
                                    <input type="number" class="form-input form-input-sm" 
                                           placeholder="e.g. 1.0"
                                           x-model="scenarioFilters.maxOpposition"
                                           min="0" max="1" step="0.1">
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div class="text-muted" style="font-size: 11px;">
                                    Note: Scenarios without calculated stats will be hidden when using advanced filters.
                                </div>
                                <button type="button" class="btn btn-sm btn-secondary" style="font-size: 11px; padding: 4px 8px;"
                                        @click="scenarioFilters = {minOutcomes: null, maxOutcomes: null, minRationalFraction: null, maxRationalFraction: null, minOpposition: null, maxOpposition: null, showAdvanced: true}">
                                    Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" x-show="filteredScenarios.length > 0 || scenarioSearch || newNeg.source">
                        <label class="form-label">
                            Select Scenario 
                            <span class="text-muted" x-text="'(' + filteredScenarios.length + ' found)'"></span>
                        </label>
                        <div class="scenario-grid" style="max-height: 300px; overflow-y: auto;">
                            <template x-for="scenario in filteredScenarios" :key="scenario.path">
                                <div class="scenario-card" 
                                     :class="{ selected: newNeg.scenario?.path === scenario.path }"
                                     @click="selectScenario(scenario)">
                                    <div class="scenario-card-title" x-text="scenario.name"></div>
                                    <div class="scenario-card-meta">
                                        <span class="badge badge-neutral" x-text="scenario.source"></span>
                                        <span x-text="scenario.n_negotiators + ' parties'"></span>
                                        <span x-text="scenario.issues?.length + ' issues'"></span>
                                        <span x-show="scenario.n_outcomes" x-text="scenario.n_outcomes + ' outcomes'"></span>
                                        <span x-show="scenario.opposition !== null && scenario.opposition !== undefined" 
                                              x-text="'opp: ' + (scenario.opposition?.toFixed(2) ?? '')"
                                              :title="'Opposition: ' + scenario.opposition"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <template x-if="filteredScenarios.length === 0 && (scenarioSearch || newNeg.source)">
                            <p class="text-muted" style="padding: 16px; text-align: center;">No scenarios found</p>
                        </template>
                    </div>
                    
                    <div class="form-group" x-show="!scenarioSearch && !newNeg.source && filteredScenarios.length === 0">
                        <p class="text-muted" style="padding: 16px; text-align: center;">Start typing to search scenarios, or select a source to browse</p>
                    </div>
                    
                    <!-- Selected Scenario Details -->
                    <div class="form-group" x-show="newNeg.scenario">
                        <label class="form-label">Scenario Details</label>
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                            <div class="font-semibold mb-2" x-text="newNeg.scenario?.name"></div>
                            <div class="text-secondary" style="font-size: 13px;">
                                <div><strong>Issues:</strong></div>
                                <template x-for="issue in newNeg.scenario?.issues || []" :key="issue.name">
                                    <div style="margin-left: 12px; margin-top: 4px;">
                                        <span x-text="issue.name"></span>
                                        <span class="text-muted" x-text="'(' + issue.type + ')'"></span>
                                        <template x-if="issue.values">
                                            <span class="text-muted" x-text="': ' + issue.values.slice(0, 5).join(', ') + (issue.values.length > 5 ? '...' : '')"></span>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scenario Loading Options -->
                    <div class="form-group" x-show="newNeg.scenario">
                        <label class="form-label">Utility Function Options</label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label class="checkbox-label">
                                <input type="checkbox" x-model="newNeg.ignore_discount">
                                <span>Ignore discount factors</span>
                                <span class="text-muted" style="font-size: 12px; margin-left: 4px;">(use stationary utilities)</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" x-model="newNeg.ignore_reserved">
                                <span>Ignore reserved values</span>
                                <span class="text-muted" style="font-size: 12px; margin-left: 4px;">(set to -infinity)</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" x-model="newNeg.normalize">
                                <span>Normalize utilities</span>
                                <span class="text-muted" style="font-size: 12px; margin-left: 4px;">(scale to [0, 1] range)</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Negotiators -->
                <div x-show="negotiationTab === 'negotiators'">
                    <!-- Sub-tabs for negotiator selection mode -->
                    <div class="tabs" style="margin-bottom: 16px;">
                        <button class="tab" :class="{ active: negotiatorSubTab === 'preset' }" @click="negotiatorSubTab = 'preset'">Preset Agents</button>
                        <button class="tab" :class="{ active: negotiatorSubTab === 'boa' }" @click="negotiatorSubTab = 'boa'; loadBOAComponents()">Build Custom (BOA)</button>
                        <button class="tab" :class="{ active: negotiatorSubTab === 'map' }" @click="negotiatorSubTab = 'map'; loadBOAComponents()">Build Custom (MAP)</button>
                    </div>
                    
                    <!-- Assigned Negotiators (shown in both modes) -->
                    <div class="form-group">
                        <label class="form-label">
                            Assigned Negotiators 
                            <span class="text-muted" x-text="'(' + newNeg.negotiators.length + '/' + (newNeg.scenario?.n_negotiators || 2) + ' required)'"></span>
                        </label>
                        
                        <div class="negotiator-list" x-ref="negotiatorList">
                            <template x-for="(neg, index) in newNeg.negotiators" :key="index">
                                <div class="negotiator-item" 
                                     :data-index="index"
                                     :class="{ 'selected': selectedNegotiatorSlot === index }"
                                     @click="selectedNegotiatorSlot = index"
                                     :style="selectedNegotiatorSlot === index ? 'border-color: var(--primary); background: var(--bg-tertiary);' : ''">
                                    <div class="drag-handle">
                                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                            <circle cx="9" cy="6" r="1.5"/>
                                            <circle cx="15" cy="6" r="1.5"/>
                                            <circle cx="9" cy="12" r="1.5"/>
                                            <circle cx="15" cy="12" r="1.5"/>
                                            <circle cx="9" cy="18" r="1.5"/>
                                            <circle cx="15" cy="18" r="1.5"/>
                                        </svg>
                                    </div>
                                    <div class="negotiator-item-content">
                                        <input type="text" class="negotiator-name-input" x-model="neg.name" @click.stop placeholder="Agent name">
                                        <div class="negotiator-type" x-text="getNegotiatorDisplayName(neg.type_name)"></div>
                                        <span class="badge" :class="getSourceBadgeClass(neg.source)" x-text="neg.source" style="font-size: 10px;"></span>
                                    </div>
                                    <button class="btn btn-icon btn-sm" @click.stop="openNegotiatorConfig(index)" title="Configure parameters" style="margin-right: 4px;" :class="{ 'has-config': neg.params && Object.keys(neg.params).length > 0 }">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <circle cx="12" cy="12" r="3"></circle>
                                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                        </svg>
                                    </button>
                                    <button class="btn btn-icon btn-sm" @click.stop="removeNegotiator(index)" :disabled="newNeg.negotiators.length <= 2" title="Remove">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>
                        <div class="text-muted" style="font-size: 12px; margin-top: 8px;">
                            Click a slot to select it, then choose a negotiator below
                        </div>
                    </div>
                    
                    <!-- Sub-tab: Preset Negotiators -->
                    <div x-show="negotiatorSubTab === 'preset'">
                        <div class="form-group">
                            <label class="form-label">Search Negotiators</label>
                            <input type="text" class="form-input" placeholder="Type to search all negotiators..." x-model="negotiatorSearch" @input="searchNegotiators()">
                        </div>
                        
                        <div class="form-row" style="gap: 12px;">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Filter by Source <span class="text-muted">(optional)</span></label>
                                <select class="form-select" x-model="negotiatorSourceFilter" @change="filterNegotiators()">
                                    <option value="">All sources</option>
                                    <template x-for="source in negotiatorSources" :key="source.id">
                                        <option :value="source.id" x-text="source.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;" x-show="negotiatorSourceFilter === 'genius'">
                                <label class="form-label">Filter by Year <span class="text-muted">(optional)</span></label>
                                <select class="form-select" x-model="negotiatorGroupFilter" @change="filterNegotiators()">
                                    <option value="">All years</option>
                                    <option value="y2019">ANAC 2019</option>
                                    <option value="y2018">ANAC 2018</option>
                                    <option value="y2017">ANAC 2017</option>
                                    <option value="y2016">ANAC 2016</option>
                                    <option value="y2015">ANAC 2015</option>
                                    <option value="y2014">ANAC 2014</option>
                                    <option value="y2013">ANAC 2013</option>
                                    <option value="y2012">ANAC 2012</option>
                                    <option value="y2011">ANAC 2011</option>
                                    <option value="y2010">ANAC 2010</option>
                                    <option value="basic">Basic</option>
                                    <option value="others">Others</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Filter by Tag <span class="text-muted">(optional)</span></label>
                                <select class="form-select" x-model="negotiatorTagFilter" @change="filterNegotiators()">
                                    <option value="">All tags</option>
                                    <template x-for="tag in allNegotiatorTags" :key="tag">
                                        <option :value="tag" x-text="tag"></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Available Negotiators <span class="text-muted" x-text="'(' + filteredNegotiators.length + ' found)'"></span></label>
                            <div class="negotiator-grid" style="max-height: 250px; overflow-y: auto;">
                                <template x-for="neg in filteredNegotiators" :key="neg.type_name">
                                    <div class="negotiator-card" @click="selectNegotiatorForSlot(neg)">
                                        <div class="negotiator-card-name" x-text="neg.name"></div>
                                        <div class="negotiator-card-meta">
                                            <span class="badge" :class="getSourceBadgeClass(neg.source)" x-text="neg.source"></span>
                                        </div>
                                        <div class="negotiator-card-desc" x-text="neg.description" x-show="neg.description"></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sub-tab: BOA (Build Custom) Negotiators -->
                    <div x-show="negotiatorSubTab === 'boa'">
                        <div class="boa-builder" style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                            <div class="form-group">
                                <label class="form-label">Acceptance Policy <span class="text-danger">*</span></label>
                                <select class="form-select" x-model="boaConfig.acceptance_policy">
                                    <option value="">Select acceptance policy...</option>
                                    <template x-for="c in boaComponents.acceptance" :key="c.name">
                                        <option :value="c.name" x-text="c.name"></option>
                                    </template>
                                </select>
                                <div class="form-hint" x-text="getBoaComponentDescription('acceptance', boaConfig.acceptance_policy)"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Offering Policy <span class="text-danger">*</span></label>
                                <select class="form-select" x-model="boaConfig.offering_policy">
                                    <option value="">Select offering policy...</option>
                                    <template x-for="c in boaComponents.offering" :key="c.name">
                                        <option :value="c.name" x-text="c.name"></option>
                                    </template>
                                </select>
                                <div class="form-hint" x-text="getBoaComponentDescription('offering', boaConfig.offering_policy)"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Opponent Model <span class="text-muted">(optional)</span></label>
                                <select class="form-select" x-model="boaConfig.opponent_model">
                                    <option value="">None (no opponent modeling)</option>
                                    <template x-for="c in boaComponents.model" :key="c.name">
                                        <option :value="c.name" x-text="c.name"></option>
                                    </template>
                                </select>
                                <div class="form-hint" x-text="getBoaComponentDescription('model', boaConfig.opponent_model)"></div>
                            </div>
                            
                            <button class="btn btn-primary" 
                                    @click="applyBOAToSlot()" 
                                    :disabled="!boaConfig.acceptance_policy || !boaConfig.offering_policy">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                Apply to Selected Slot
                            </button>
                        </div>
                        
                        <div class="text-muted" style="font-size: 12px; margin-top: 12px;">
                            <strong>BOA Architecture:</strong> Build modular negotiators by combining acceptance, offering, and opponent modeling components.
                        </div>
                    </div>
                    
                    <!-- Sub-tab: MAP (Build Custom Advanced) Negotiators -->
                    <div x-show="negotiatorSubTab === 'map'">
                        <div class="map-builder" style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                            <div class="form-group">
                                <label class="form-label">Acceptance Policy <span class="text-danger">*</span></label>
                                <select class="form-select" x-model="mapConfig.acceptance_policy">
                                    <option value="">Select acceptance policy...</option>
                                    <template x-for="c in boaComponents.acceptance" :key="c.name">
                                        <option :value="c.name" x-text="c.name"></option>
                                    </template>
                                </select>
                                <div class="form-hint" x-text="getBoaComponentDescription('acceptance', mapConfig.acceptance_policy)"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Offering Policy <span class="text-danger">*</span></label>
                                <select class="form-select" x-model="mapConfig.offering_policy">
                                    <option value="">Select offering policy...</option>
                                    <template x-for="c in boaComponents.offering" :key="c.name">
                                        <option :value="c.name" x-text="c.name"></option>
                                    </template>
                                </select>
                                <div class="form-hint" x-text="getBoaComponentDescription('offering', mapConfig.offering_policy)"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Models <span class="text-muted">(multiple allowed)</span></label>
                                <div class="model-selector" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
                                    <template x-for="(model, index) in mapConfig.models" :key="index">
                                        <span class="badge" style="display: inline-flex; align-items: center; gap: 4px; background: var(--primary); color: white; padding: 4px 8px; border-radius: 4px;">
                                            <span x-text="model"></span>
                                            <button type="button" @click="mapConfig.models.splice(index, 1)" style="background: none; border: none; color: inherit; cursor: pointer; padding: 0; line-height: 1;">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                                </svg>
                                            </button>
                                        </span>
                                    </template>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <select class="form-select" x-ref="mapModelSelect" style="flex: 1;">
                                        <option value="">Add a model...</option>
                                        <template x-for="c in boaComponents.model" :key="c.name">
                                            <option :value="c.name" x-text="c.name" :disabled="mapConfig.models.includes(c.name)"></option>
                                        </template>
                                    </select>
                                    <button type="button" class="btn btn-secondary" @click="addMapModel()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                        Add
                                    </button>
                                </div>
                                <div class="form-hint">Unlike BOA, MAP supports multiple opponent models that run in sequence.</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" x-model="mapConfig.acceptance_first" style="margin-right: 8px;">
                                    Evaluate Acceptance First
                                </label>
                                <div class="form-hint">If checked, acceptance is evaluated before offering. If unchecked, offering is evaluated first.</div>
                            </div>
                            
                            <button class="btn btn-primary" 
                                    @click="applyMAPToSlot()" 
                                    :disabled="!mapConfig.acceptance_policy || !mapConfig.offering_policy">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                Apply to Selected Slot
                            </button>
                        </div>
                        
                        <div class="text-muted" style="font-size: 12px; margin-top: 12px;">
                            <strong>MAP Architecture:</strong> Advanced modular negotiators with multiple models and flexible component ordering. Use BOA for simpler configurations.
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Parameters -->
                <div x-show="negotiationTab === 'parameters'">
                    <!-- Mechanism Type Selector -->
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label class="form-label">Mechanism Protocol</label>
                        <div class="card-selector">
                            <!-- Built-in mechanisms -->
                            <template x-for="mech in (mechanisms || [])" :key="mech?.class_name || Math.random()">
                                <button type="button" class="card-selector-option" 
                                        :class="{ selected: newNeg.mechanism_type === mech?.class_name }"
                                        @click="selectMechanism(mech?.class_name)">
                                    <div class="card-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <g x-show="mech?.class_name === 'SAOMechanism'">
                                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                                <circle cx="9" cy="7" r="4"></circle>
                                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                            </g>
                                            <g x-show="mech?.class_name === 'TAUMechanism'">
                                                <line x1="8" y1="6" x2="21" y2="6"></line>
                                                <line x1="8" y1="12" x2="21" y2="12"></line>
                                                <line x1="8" y1="18" x2="21" y2="18"></line>
                                                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                                                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                                                <line x1="3" y1="18" x2="3.01" y2="18"></line>
                                            </g>
                                            <g x-show="mech?.class_name === 'GBMechanism'">
                                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                <line x1="3" y1="9" x2="21" y2="9"></line>
                                                <line x1="9" y1="21" x2="9" y2="9"></line>
                                            </g>
                                            <g x-show="mech?.class_name?.includes('ST')">
                                                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                                <path d="M2 17l10 5 10-5"></path>
                                                <path d="M2 12l10 5 10-5"></path>
                                            </g>
                                            <!-- Default icon for unknown mechanisms -->
                                            <g x-show="!['SAOMechanism', 'TAUMechanism', 'GBMechanism'].includes(mech?.class_name) && !mech?.class_name?.includes('ST')">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <path d="M12 16v-4"></path>
                                                <path d="M12 8h.01"></path>
                                            </g>
                                        </svg>
                                    </div>
                                    <span class="card-title" x-text="mech?.class_name?.replace('Mechanism', '') || ''"></span>
                                    <span class="card-desc" x-text="(mech?.name || '').split('(')[0].trim()"></span>
                                </button>
                            </template>
                            <!-- Virtual mechanisms (saved configurations) -->
                            <template x-for="vm in virtualMechanisms" :key="vm.id">
                                <button type="button" class="card-selector-option" 
                                        :class="{ selected: newNeg.mechanism_type === 'virtual:' + vm.id }"
                                        @click="selectMechanism('virtual:' + vm.id)"
                                        style="position: relative;">
                                    <div class="card-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <!-- Star icon for virtual/custom -->
                                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                        </svg>
                                    </div>
                                    <span class="card-title" x-text="vm.name"></span>
                                    <span class="card-desc" x-text="vm.base_type.toUpperCase() + ' preset'"></span>
                                    <span class="badge badge-xs badge-primary" style="position: absolute; top: 4px; right: 4px;">Virtual</span>
                                    <!-- Delete button -->
                                    <button type="button" class="btn-icon-sm" 
                                            style="position: absolute; bottom: 4px; right: 4px;"
                                            @click.stop="deleteVirtualMechanism(vm.id)"
                                            title="Delete virtual mechanism">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        </svg>
                                    </button>
                                </button>
                            </template>
                        </div>
                        <div class="form-hint mt-2">
                            <span x-text="selectedMechanism?.description || ''"></span>
                            <span x-show="isVirtualMechanism(newNeg.mechanism_type)" class="text-muted">
                                (Custom configuration based on <span x-text="getBaseTypeFromVirtualMechanism(newNeg.mechanism_type)?.replace('Mechanism', '')"></span>)
                            </span>
                        </div>
                    </div>
                    
                    <!-- Information Sharing -->
                    <div class="form-group">
                        <label class="form-checkbox"><input type="checkbox" x-model="newNeg.share_ufuns"><span>Share utility functions</span></label>
                        <div class="form-inline-hint">Give each negotiator access to opponent's utility function</div>
                    </div>
                    
                    <!-- Dynamic Parameter Groups -->
                    <template x-if="selectedMechanism">
                        <div>
                            <template x-for="group in selectedMechanism.param_groups" :key="group.id">
                                <div class="param-group" x-data="{ collapsed: group.order > 2 }">
                                    <div class="param-group-header" @click="collapsed = !collapsed">
                                        <span class="param-group-title" x-text="group.label"></span>
                                        <svg class="param-group-chevron" :class="{ collapsed }" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                    </div>
                                    <div class="param-group-content" x-show="!collapsed" x-collapse>
                                        <template x-for="param in group.params" :key="param.name">
                                            <div class="form-group">
                                                <!-- Boolean parameters -->
                                                <template x-if="param.type === 'bool'">
                                                    <div>
                                                        <label class="form-checkbox">
                                                            <input type="checkbox" 
                                                                   :checked="newNeg.mechanism_params[param.name]"
                                                                   @change="newNeg.mechanism_params[param.name] = $event.target.checked">
                                                            <span x-text="param.name.replace(/_/g, ' ')"></span>
                                                        </label>
                                                        <div class="form-inline-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- Integer parameters -->
                                                <template x-if="param.type === 'int'">
                                                    <div>
                                                        <label class="form-label" x-text="param.name.replace(/_/g, ' ')"></label>
                                                        <input type="number" class="form-input" style="max-width: 150px;"
                                                               :value="newNeg.mechanism_params[param.name]"
                                                               @input="newNeg.mechanism_params[param.name] = $event.target.value ? parseInt($event.target.value) : null"
                                                               :min="param.min_value"
                                                               :max="param.max_value"
                                                               :placeholder="param.default ?? 'None'">
                                                        <div class="form-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- Optional integer parameters -->
                                                <template x-if="param.type === 'optional_int'">
                                                    <div>
                                                        <label class="form-label" x-text="param.name.replace(/_/g, ' ')"></label>
                                                        <input type="number" class="form-input" style="max-width: 150px;"
                                                               :value="newNeg.mechanism_params[param.name]"
                                                               @input="newNeg.mechanism_params[param.name] = $event.target.value ? parseInt($event.target.value) : null"
                                                               :min="param.min_value"
                                                               :max="param.max_value"
                                                               placeholder="None">
                                                        <div class="form-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- Float parameters -->
                                                <template x-if="param.type === 'float'">
                                                    <div>
                                                        <label class="form-label" x-text="param.name.replace(/_/g, ' ')"></label>
                                                        <input type="number" class="form-input" style="max-width: 150px;" step="0.01"
                                                               :value="newNeg.mechanism_params[param.name]"
                                                               @input="newNeg.mechanism_params[param.name] = $event.target.value ? parseFloat($event.target.value) : null"
                                                               :min="param.min_value"
                                                               :max="param.max_value"
                                                               :placeholder="param.default ?? 'None'">
                                                        <div class="form-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- Optional float parameters -->
                                                <template x-if="param.type === 'optional_float'">
                                                    <div>
                                                        <label class="form-label" x-text="param.name.replace(/_/g, ' ')"></label>
                                                        <input type="number" class="form-input" style="max-width: 150px;" step="0.1"
                                                               :value="newNeg.mechanism_params[param.name]"
                                                               @input="newNeg.mechanism_params[param.name] = $event.target.value ? parseFloat($event.target.value) : null"
                                                               :min="param.min_value"
                                                               :max="param.max_value"
                                                               placeholder="None">
                                                        <div class="form-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- String parameters -->
                                                <template x-if="param.type === 'string' || param.type === 'optional_string'">
                                                    <div>
                                                        <label class="form-label" x-text="param.name.replace(/_/g, ' ')"></label>
                                                        <input type="text" class="form-input" style="max-width: 300px;"
                                                               :value="newNeg.mechanism_params[param.name]"
                                                               @input="newNeg.mechanism_params[param.name] = $event.target.value || null"
                                                               placeholder="None">
                                                        <div class="form-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- Choice parameters -->
                                                <template x-if="param.type === 'choice'">
                                                    <div>
                                                        <label class="form-label" x-text="param.name.replace(/_/g, ' ')"></label>
                                                        <select class="form-select" style="max-width: 200px;"
                                                                :value="newNeg.mechanism_params[param.name]"
                                                                @change="newNeg.mechanism_params[param.name] = $event.target.value">
                                                            <template x-for="choice in param.choices" :key="choice">
                                                                <option :value="choice" x-text="choice"></option>
                                                            </template>
                                                        </select>
                                                        <div class="form-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                    
                    <!-- Save as Virtual Mechanism button -->
                    <div class="form-group" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                        <button type="button" class="btn btn-secondary" @click="openSaveVirtualMechanism()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                            </svg>
                            Save as Virtual Mechanism
                        </button>
                        <div class="form-hint">Save current mechanism configuration as a reusable preset</div>
                    </div>
                </div>
                
                <!-- Tab: Panels -->
                <div x-show="negotiationTab === 'panels'">
                    <div class="form-group">
                        <label class="form-label">Panel Configuration</label>
                        <div class="form-hint">Configure which panels to display during the negotiation</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-checkbox">
                            <input type="checkbox" x-model="newNeg.panels.adjustable">
                            <span>Adjustable panels</span>
                        </label>
                        <div class="form-inline-hint">Allow resizing panels during negotiation</div>
                    </div>
                    
                    <div class="param-group">
                        <div class="param-group-header">
                            <span class="param-group-title">Utility Space View</span>
                        </div>
                        <div class="param-group-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">X-Axis (Negotiator)</label>
                                    <select class="form-select" x-model.number="newNeg.panels.utilityView.xAxis">
                                        <template x-for="(neg, idx) in newNeg.negotiators" :key="idx">
                                            <option :value="idx" x-text="neg.name || ('Agent ' + (idx + 1))"></option>
                                        </template>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Y-Axis (Negotiator)</label>
                                    <select class="form-select" x-model.number="newNeg.panels.utilityView.yAxis">
                                        <template x-for="(neg, idx) in newNeg.negotiators" :key="idx">
                                            <option :value="idx" x-text="neg.name || ('Agent ' + (idx + 1))"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="param-group">
                        <div class="param-group-header">
                            <span class="param-group-title">Timeline View</span>
                        </div>
                        <div class="param-group-content">
                            <div class="form-group">
                                <label class="form-label">X-Axis</label>
                                <select class="form-select" x-model="newNeg.panels.timeline.xAxis" style="max-width: 200px;">
                                    <option value="step">Step</option>
                                    <option value="time">Time</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Display & Run -->
                <div x-show="negotiationTab === 'display'">
                    <div class="form-group">
                        <label class="form-label">Summary</label>
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                            <div><strong>Scenario:</strong> <span x-text="newNeg.scenario?.name || 'Not selected'"></span></div>
                            <div><strong>Negotiators:</strong> <span x-text="newNeg.negotiators.map(n => getNegotiatorDisplayName(n.type_name)).join(' vs ')"></span></div>
                            <div><strong>Mechanism:</strong> <span x-text="newNeg.mechanism_type.replace('Mechanism', '')"></span></div>
                            <div><strong>Deadline:</strong> <span x-text="getDeadlineSummary()"></span></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Run Mode</label>
                        <div class="card-selector compact">
                            <button type="button" class="card-selector-option" :class="{ selected: newNeg.mode === 'realtime' }" @click="newNeg.mode = 'realtime'">
                                <div class="card-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                    </svg>
                                </div>
                                <div class="card-content">
                                    <span class="card-title">Real-time</span>
                                    <span class="card-desc">Watch step-by-step with live updates</span>
                                </div>
                            </button>
                            <button type="button" class="card-selector-option" :class="{ selected: newNeg.mode === 'batch' }" @click="newNeg.mode = 'batch'">
                                <div class="card-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="13 17 18 12 13 7"></polyline>
                                        <polyline points="6 17 11 12 6 7"></polyline>
                                    </svg>
                                </div>
                                <div class="card-content">
                                    <span class="card-title">Batch</span>
                                    <span class="card-desc">Run instantly and show results</span>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group" x-show="newNeg.mode === 'realtime'">
                        <label class="form-label">Step Delay: <span x-text="newNeg.step_delay + 'ms'"></span></label>
                        <input type="range" class="form-range" x-model.number="newNeg.step_delay" min="0" max="1000" step="50">
                        <div class="form-hint">Delay between steps for visualization</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-checkbox"><input type="checkbox" x-model="newNeg.show_plot"><span>Show live utility plot</span></label>
                        </div>
                        <div class="form-group">
                            <label class="form-checkbox"><input type="checkbox" x-model="newNeg.show_offers"><span>Show offer history</span></label>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                        <label class="form-checkbox">
                            <input type="checkbox" x-model="newNeg.auto_save">
                            <span>Auto-save negotiation</span>
                        </label>
                        <div class="form-inline-hint">Save results to disk when negotiation completes</div>
                    </div>
                </div>
                    </div><!-- end wizard-content -->
                </div><!-- end wizard-layout -->
            </div><!-- end modal-body -->
            
            <div class="modal-footer">
                <button class="btn btn-secondary" @click="showNewNegotiation = false">Cancel</button>
                <template x-if="negotiationTab !== 'scenario'">
                    <button class="btn btn-secondary" @click="prevNegotiationTab()">Back</button>
                </template>
                <template x-if="negotiationTab !== 'display'">
                    <button class="btn btn-primary" @click="nextNegotiationTab()" :disabled="!canProceed">
                        Next
                    </button>
                </template>
                <template x-if="negotiationTab === 'display'">
                    <button class="btn btn-primary" @click="startNegotiation()" :disabled="!canStart">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        <span x-text="newNeg.auto_start ? 'Start Negotiation' : 'Open Negotiation'"></span>
                    </button>
                </template>
            </div>
        </div>
    </div>
    
    <!-- Negotiator Configuration Modal -->
    <div class="modal-overlay" :class="{ active: showNegotiatorConfig }" @click.self="showNegotiatorConfig = false">
        <div class="modal medium">
            <div class="modal-header">
                <h2 class="modal-title">
                    Configure Negotiator
                    <span class="text-muted" style="font-size: 14px; font-weight: normal;" x-text="configNegotiatorIndex !== null ? (' - ' + (newNeg.negotiators[configNegotiatorIndex]?.name || 'Agent')) : ''"></span>
                </h2>
                <button class="modal-close" @click="showNegotiatorConfig = false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- Loading state -->
                <div x-show="configNegotiatorLoading" class="text-center" style="padding: 40px;">
                    <div class="spinner"></div>
                    <div class="text-muted" style="margin-top: 12px;">Loading parameters...</div>
                </div>
                
                <!-- No parameters -->
                <div x-show="!configNegotiatorLoading && configNegotiatorParams.length === 0" class="text-center" style="padding: 40px;">
                    <div class="text-muted">No configurable parameters found for this negotiator type.</div>
                </div>
                
                <!-- Parameters form -->
                <div x-show="!configNegotiatorLoading && configNegotiatorParams.length > 0">
                    <div class="form-hint" style="margin-bottom: 16px;">
                        Configure parameters for <strong x-text="configNegotiatorIndex !== null ? getNegotiatorDisplayName(newNeg.negotiators[configNegotiatorIndex]?.type_name) : ''"></strong>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        <template x-for="param in configNegotiatorParams" :key="param.name">
                            <div class="form-group" x-show="!param.is_complex" style="margin-bottom: 16px;">
                                <!-- Boolean parameters -->
                                <template x-if="param.ui_type === 'bool'">
                                    <div>
                                        <label class="form-checkbox">
                                            <input type="checkbox" 
                                                   :checked="configNegotiatorValues[param.name] ?? param.default"
                                                   @change="configNegotiatorValues[param.name] = $event.target.checked">
                                            <span x-text="param.name.replace(/_/g, ' ')"></span>
                                            <span class="text-danger" x-show="param.required">*</span>
                                        </label>
                                        <div class="form-hint" x-text="param.description" x-show="param.description"></div>
                                    </div>
                                </template>
                                
                                <!-- Integer parameters -->
                                <template x-if="param.ui_type === 'int' || param.ui_type === 'optional_int'">
                                    <div>
                                        <label class="form-label">
                                            <span x-text="param.name.replace(/_/g, ' ')"></span>
                                            <span class="text-danger" x-show="param.required">*</span>
                                            <span class="text-muted" x-show="param.ui_type === 'optional_int'">(optional)</span>
                                        </label>
                                        <input type="number" class="form-input" style="max-width: 200px;"
                                               :value="configNegotiatorValues[param.name] ?? param.default"
                                               @input="configNegotiatorValues[param.name] = $event.target.value ? parseInt($event.target.value) : null"
                                               :placeholder="param.default !== null ? param.default : 'None'">
                                        <div class="form-hint" x-text="param.description" x-show="param.description"></div>
                                    </div>
                                </template>
                                
                                <!-- Float parameters -->
                                <template x-if="param.ui_type === 'float' || param.ui_type === 'optional_float'">
                                    <div>
                                        <label class="form-label">
                                            <span x-text="param.name.replace(/_/g, ' ')"></span>
                                            <span class="text-danger" x-show="param.required">*</span>
                                            <span class="text-muted" x-show="param.ui_type === 'optional_float'">(optional)</span>
                                        </label>
                                        <input type="number" class="form-input" style="max-width: 200px;" step="0.01"
                                               :value="configNegotiatorValues[param.name] ?? param.default"
                                               @input="configNegotiatorValues[param.name] = $event.target.value ? parseFloat($event.target.value) : null"
                                               :placeholder="param.default !== null ? param.default : 'None'">
                                        <div class="form-hint" x-text="param.description" x-show="param.description"></div>
                                    </div>
                                </template>
                                
                                <!-- String parameters -->
                                <template x-if="param.ui_type === 'string' || param.ui_type === 'optional_string'">
                                    <div>
                                        <label class="form-label">
                                            <span x-text="param.name.replace(/_/g, ' ')"></span>
                                            <span class="text-danger" x-show="param.required">*</span>
                                            <span class="text-muted" x-show="param.ui_type === 'optional_string'">(optional)</span>
                                        </label>
                                        <input type="text" class="form-input" style="max-width: 300px;"
                                               :value="configNegotiatorValues[param.name] ?? param.default ?? ''"
                                               @input="configNegotiatorValues[param.name] = $event.target.value || null"
                                               :placeholder="param.default !== null ? param.default : 'None'">
                                        <div class="form-hint" x-text="param.description" x-show="param.description"></div>
                                    </div>
                                </template>
                                
                                <!-- Choice parameters -->
                                <template x-if="param.ui_type === 'choice'">
                                    <div>
                                        <label class="form-label">
                                            <span x-text="param.name.replace(/_/g, ' ')"></span>
                                            <span class="text-danger" x-show="param.required">*</span>
                                        </label>
                                        <select class="form-select" style="max-width: 200px;"
                                                :value="configNegotiatorValues[param.name] ?? param.default"
                                                @change="configNegotiatorValues[param.name] = $event.target.value">
                                            <template x-for="choice in param.choices" :key="choice">
                                                <option :value="choice" x-text="choice"></option>
                                            </template>
                                        </select>
                                        <div class="form-hint" x-text="param.description" x-show="param.description"></div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Show complex parameters as info -->
                    <template x-if="configNegotiatorParams.some(p => p.is_complex)">
                        <details style="margin-top: 16px;">
                            <summary class="text-muted" style="cursor: pointer; font-size: 13px;">
                                Advanced parameters (not editable in UI)
                            </summary>
                            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 6px; margin-top: 8px;">
                                <template x-for="param in configNegotiatorParams.filter(p => p.is_complex)" :key="param.name">
                                    <div style="margin-bottom: 8px; font-size: 13px;">
                                        <code x-text="param.name" style="background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px;"></code>
                                        <span class="text-muted" x-text="': ' + param.type"></span>
                                    </div>
                                </template>
                            </div>
                        </details>
                    </template>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" @click="showNegotiatorConfig = false">Cancel</button>
                <button class="btn btn-secondary" @click="resetNegotiatorConfig()">Reset to Defaults</button>
                <button class="btn btn-primary" @click="applyNegotiatorConfig()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Apply
                </button>
            </div>
        </div>
    </div>
    
    <!-- Tournament Competitor Configuration Modal -->
    <div class="modal-overlay" :class="{ active: showCompetitorConfig }" @click.self="closeCompetitorConfig()">
        <div class="modal medium">
            <div class="modal-header">
                <h2 class="modal-title">
                    Configure Competitor
                    <span class="text-muted" style="font-size: 14px; font-weight: normal;" 
                          x-text="competitorConfigTypeName ? (' - ' + (negotiatorTypes.find(n => n.type_name === competitorConfigTypeName)?.name || getVirtualNegotiator(competitorConfigTypeName)?.name || 'Agent')) : ''"></span>
                </h2>
                <button class="modal-close" @click="closeCompetitorConfig()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- Loading state -->
                <div x-show="competitorConfigLoading" class="text-center" style="padding: 40px;">
                    <div class="spinner"></div>
                    <div class="text-muted" style="margin-top: 12px;">Loading parameters...</div>
                </div>
                
                <!-- No parameters -->
                <div x-show="!competitorConfigLoading && competitorConfigParams.length === 0" class="text-center" style="padding: 40px;">
                    <div class="text-muted">No configurable parameters found for this negotiator type.</div>
                </div>
                
                <!-- Parameters form -->
                <div x-show="!competitorConfigLoading && competitorConfigParams.length > 0">
                    <div class="form-hint" style="margin-bottom: 16px;">
                        Configure parameters for <strong x-text="competitorConfigTypeName ? (negotiatorTypes.find(n => n.type_name === competitorConfigTypeName)?.name || getVirtualNegotiator(competitorConfigTypeName)?.name || competitorConfigTypeName) : ''"></strong>
                    </div>
                    
                    <div style="max-height: 350px; overflow-y: auto;">
                        <template x-for="param in competitorConfigParams" :key="param.name">
                            <div class="form-group" x-show="!param.is_complex" style="margin-bottom: 16px;">
                                <!-- Boolean parameters -->
                                <template x-if="param.ui_type === 'bool'">
                                    <div>
                                        <label class="form-checkbox">
                                            <input type="checkbox" 
                                                   :checked="competitorConfigValues[param.name] ?? param.default"
                                                   @change="competitorConfigValues[param.name] = $event.target.checked">
                                            <span x-text="param.name.replace(/_/g, ' ')"></span>
                                            <span class="text-danger" x-show="param.required">*</span>
                                        </label>
                                        <div class="form-hint" x-text="param.description" x-show="param.description"></div>
                                    </div>
                                </template>
                                
                                <!-- Integer parameters -->
                                <template x-if="param.ui_type === 'int' || param.ui_type === 'optional_int'">
                                    <div>
                                        <label class="form-label">
                                            <span x-text="param.name.replace(/_/g, ' ')"></span>
                                            <span class="text-danger" x-show="param.required">*</span>
                                            <span class="text-muted" x-show="param.ui_type === 'optional_int'">(optional)</span>
                                        </label>
                                        <input type="number" class="form-input" style="max-width: 200px;"
                                               :value="competitorConfigValues[param.name] ?? param.default"
                                               @input="competitorConfigValues[param.name] = $event.target.value ? parseInt($event.target.value) : null"
                                               :placeholder="param.default !== null ? param.default : 'None'">
                                        <div class="form-hint" x-text="param.description" x-show="param.description"></div>
                                    </div>
                                </template>
                                
                                <!-- Float parameters -->
                                <template x-if="param.ui_type === 'float' || param.ui_type === 'optional_float'">
                                    <div>
                                        <label class="form-label">
                                            <span x-text="param.name.replace(/_/g, ' ')"></span>
                                            <span class="text-danger" x-show="param.required">*</span>
                                            <span class="text-muted" x-show="param.ui_type === 'optional_float'">(optional)</span>
                                        </label>
                                        <input type="number" class="form-input" style="max-width: 200px;" step="0.01"
                                               :value="competitorConfigValues[param.name] ?? param.default"
                                               @input="competitorConfigValues[param.name] = $event.target.value ? parseFloat($event.target.value) : null"
                                               :placeholder="param.default !== null ? param.default : 'None'">
                                        <div class="form-hint" x-text="param.description" x-show="param.description"></div>
                                    </div>
                                </template>
                                
                                <!-- String parameters -->
                                <template x-if="param.ui_type === 'string' || param.ui_type === 'optional_string'">
                                    <div>
                                        <label class="form-label">
                                            <span x-text="param.name.replace(/_/g, ' ')"></span>
                                            <span class="text-danger" x-show="param.required">*</span>
                                            <span class="text-muted" x-show="param.ui_type === 'optional_string'">(optional)</span>
                                        </label>
                                        <input type="text" class="form-input" style="max-width: 300px;"
                                               :value="competitorConfigValues[param.name] ?? param.default ?? ''"
                                               @input="competitorConfigValues[param.name] = $event.target.value || null"
                                               :placeholder="param.default !== null ? param.default : 'None'">
                                        <div class="form-hint" x-text="param.description" x-show="param.description"></div>
                                    </div>
                                </template>
                                
                                <!-- Choice parameters -->
                                <template x-if="param.ui_type === 'choice'">
                                    <div>
                                        <label class="form-label">
                                            <span x-text="param.name.replace(/_/g, ' ')"></span>
                                            <span class="text-danger" x-show="param.required">*</span>
                                        </label>
                                        <select class="form-select" style="max-width: 200px;"
                                                :value="competitorConfigValues[param.name] ?? param.default"
                                                @change="competitorConfigValues[param.name] = $event.target.value">
                                            <template x-for="choice in param.choices" :key="choice">
                                                <option :value="choice" x-text="choice"></option>
                                            </template>
                                        </select>
                                        <div class="form-hint" x-text="param.description" x-show="param.description"></div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Save as Virtual Negotiator option -->
                    <div style="margin-top: 20px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                        <label class="form-checkbox">
                            <input type="checkbox" x-model="competitorConfigSaveAsVirtual">
                            <span style="font-weight: 500;">Save as Virtual Negotiator</span>
                        </label>
                        <div class="form-hint" style="margin-top: 4px;">
                            Create a reusable negotiator variant with these parameters
                        </div>
                        
                        <div x-show="competitorConfigSaveAsVirtual" style="margin-top: 12px;">
                            <label class="form-label">Virtual Negotiator Name</label>
                            <input type="text" class="form-input" 
                                   x-model="competitorConfigVirtualName"
                                   placeholder="e.g., Aggressive Aspiration Agent">
                        </div>
                    </div>
                    
                    <!-- Show complex parameters as info -->
                    <template x-if="competitorConfigParams.some(p => p.is_complex)">
                        <details style="margin-top: 16px;">
                            <summary class="text-muted" style="cursor: pointer; font-size: 13px;">
                                Advanced parameters (not editable in UI)
                            </summary>
                            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 6px; margin-top: 8px;">
                                <template x-for="param in competitorConfigParams.filter(p => p.is_complex)" :key="param.name">
                                    <div style="margin-bottom: 8px; font-size: 13px;">
                                        <code x-text="param.name" style="background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px;"></code>
                                        <span class="text-muted" x-text="': ' + param.type"></span>
                                    </div>
                                </template>
                            </div>
                        </details>
                    </template>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" @click="closeCompetitorConfig()">Cancel</button>
                <button class="btn btn-primary" @click="saveCompetitorConfig()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    <span x-text="competitorConfigSaveAsVirtual ? 'Create Virtual Negotiator' : 'Close'"></span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Save as Virtual Mechanism Modal -->
    <div class="modal-overlay" :class="{ active: showSaveVirtualMechanism }" @click.self="closeSaveVirtualMechanism()">
        <div class="modal small">
            <div class="modal-header">
                <h2 class="modal-title">Save as Virtual Mechanism</h2>
                <button class="modal-close" @click="closeSaveVirtualMechanism()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="form-hint" style="margin-bottom: 16px;">
                    Save the current mechanism configuration (<strong x-text="newNeg.mechanism_type?.replace('Mechanism', '') || 'SAO'"></strong>) as a reusable preset.
                </div>
                
                <div class="form-group">
                    <label class="form-label">Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-input" 
                           x-model="saveVirtualMechanismName"
                           placeholder="e.g., Fast SAO (50 steps)">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input" rows="2"
                              x-model="saveVirtualMechanismDescription"
                              placeholder="Optional description..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tags</label>
                    <input type="text" class="form-input" 
                           x-model="saveVirtualMechanismTags"
                           placeholder="e.g., fast, testing, anac (comma-separated)">
                    <div class="form-hint">Comma-separated tags for organization</div>
                </div>
                
                <!-- Current params preview -->
                <details style="margin-top: 16px;">
                    <summary class="text-muted" style="cursor: pointer; font-size: 13px;">
                        Parameters to save
                    </summary>
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 6px; margin-top: 8px; max-height: 150px; overflow-y: auto;">
                        <template x-for="(value, key) in newNeg.mechanism_params" :key="key">
                            <div style="margin-bottom: 4px; font-size: 12px;" x-show="value !== null && value !== undefined">
                                <code x-text="key" style="background: var(--bg-secondary); padding: 1px 4px; border-radius: 3px;"></code>
                                <span class="text-muted">:</span>
                                <span x-text="JSON.stringify(value)"></span>
                            </div>
                        </template>
                    </div>
                </details>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" @click="closeSaveVirtualMechanism()">Cancel</button>
                <button class="btn btn-primary" @click="saveAsVirtualMechanism()" :disabled="!saveVirtualMechanismName.trim()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                    Save Virtual Mechanism
                </button>
            </div>
        </div>
    </div>
    
    <!-- New Tournament Modal -->
    <div class="modal-overlay" :class="{ active: showNewTournament }" @click.self="showNewTournament = false">
        <div class="modal large">
            <div class="modal-header">
                <h2 class="modal-title">New Tournament</h2>
                <button class="modal-close" @click="showNewTournament = false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body" style="padding: 0;">
                <div class="wizard-layout">
                    <div class="wizard-sidebar">
                        <!-- Preset selector at top -->
                        <div class="wizard-preset-selector" style="padding: 12px; border-bottom: 1px solid var(--border-color);">
                            <label class="form-label" style="font-size: 11px; margin-bottom: 4px;">Load Preset</label>
                            <select class="form-select" style="font-size: 12px;" 
                                    x-model="selectedTournamentPreset"
                                    @change="loadTournamentPreset()">
                                <option value="">-- Select preset --</option>
                                <template x-for="preset in tournamentPresets" :key="preset.name">
                                    <option :value="preset.name" x-text="preset.name"></option>
                                </template>
                            </select>
                        </div>
                        
                        <button class="wizard-tab" :class="{ active: tournamentTab === 'scenarios', completed: newTournament.scenario_paths.length > 0 }" @click="tournamentTab = 'scenarios'">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                            <span class="wizard-tab-label">1. Scenarios</span>
                            <span class="wizard-badge" x-show="newTournament.scenario_paths.length > 0" x-text="newTournament.scenario_paths.length"></span>
                        </button>
                        <button class="wizard-tab" :class="{ active: tournamentTab === 'competitors', completed: newTournament.competitor_types.length >= 1 }" @click="tournamentTab = 'competitors'">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            <span class="wizard-tab-label">2. Competitors</span>
                            <span class="wizard-badge" x-show="newTournament.competitor_types.length > 0" x-text="newTournament.competitor_types.length"></span>
                        </button>
                        <button class="wizard-tab" :class="{ active: tournamentTab === 'opponents', completed: newTournament.opponents_same_as_competitors || newTournament.opponent_types.length >= 1 }" @click="tournamentTab = 'opponents'">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            <span class="wizard-tab-label">3. Opponents</span>
                            <span class="wizard-badge" x-show="!newTournament.opponents_same_as_competitors && newTournament.opponent_types.length > 0" x-text="newTournament.opponent_types.length"></span>
                            <span class="wizard-badge badge-info" x-show="newTournament.opponents_same_as_competitors">=</span>
                        </button>
                        <button class="wizard-tab" :class="{ active: tournamentTab === 'settings' }" @click="tournamentTab = 'settings'">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                            </svg>
                            <span class="wizard-tab-label">4. Settings</span>
                        </button>
                        <button class="wizard-tab" :class="{ active: tournamentTab === 'review', completed: canStartTournament() }" @click="tournamentTab = 'review'">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 11l3 3L22 4"></path>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                            </svg>
                            <span class="wizard-tab-label">5. Review</span>
                        </button>
                    </div>
                    
                    <div class="wizard-content">
                        <!-- Scenarios Tab -->
                        <div x-show="tournamentTab === 'scenarios'" class="wizard-panel">
                            <div class="panel-header">
                                <h3>Select Scenarios</h3>
                            </div>
                            
                            <!-- Dual-list layout -->
                            <div class="dual-list-container" style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 12px; height: 450px;">
                                <!-- Available scenarios (left) -->
                                <div class="dual-list-panel" style="display: flex; flex-direction: column; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                                    <div class="dual-list-header" style="padding: 12px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
                                        <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px;">
                                            Available
                                            <span class="text-muted" style="font-weight: normal;" x-text="'(' + filteredTournamentScenarios.filter(s => !isTournamentScenarioSelected(s.path)).length + ')'"></span>
                                        </div>
                                        <input type="text" class="form-input" placeholder="Search scenarios..." 
                                               style="font-size: 13px; padding: 6px 10px;"
                                               x-model="tournamentScenarioSearch">
                                        <!-- Source filter -->
                                        <select class="form-select" style="margin-top: 8px; font-size: 12px; padding: 4px 8px;"
                                                x-model="tournamentScenarioSourceFilter">
                                            <option value="">All sources</option>
                                            <template x-for="src in [...new Set(scenarios.map(s => s.source))]" :key="src">
                                                <option :value="src" x-text="src"></option>
                                            </template>
                                        </select>
                                        <!-- Advanced filters toggle -->
                                        <button class="btn btn-sm" style="margin-top: 8px; width: 100%; font-size: 11px; padding: 4px 8px;"
                                                @click="tournamentScenarioFilters.showAdvanced = !tournamentScenarioFilters.showAdvanced">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12" style="margin-right: 4px;">
                                                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                                            </svg>
                                            Advanced Filters
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12" style="margin-left: 4px;"
                                                 :style="tournamentScenarioFilters.showAdvanced ? 'transform: rotate(180deg)' : ''">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </button>
                                        <!-- Advanced filters panel -->
                                        <div x-show="tournamentScenarioFilters.showAdvanced" x-collapse
                                             style="margin-top: 8px; padding: 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 11px;">
                                            <div style="display: grid; gap: 6px;">
                                                <div>
                                                    <label class="form-label" style="font-size: 10px; margin-bottom: 2px;">Outcomes</label>
                                                    <div style="display: flex; gap: 4px; align-items: center;">
                                                        <input type="number" class="form-input" placeholder="Min" style="width: 70px; font-size: 11px; padding: 3px 6px;"
                                                               x-model.number="tournamentScenarioFilters.minOutcomes" min="1">
                                                        <span>-</span>
                                                        <input type="number" class="form-input" placeholder="Max" style="width: 70px; font-size: 11px; padding: 3px 6px;"
                                                               x-model.number="tournamentScenarioFilters.maxOutcomes" min="1">
                                                    </div>
                                                </div>
                                                <div>
                                                    <label class="form-label" style="font-size: 10px; margin-bottom: 2px;">Rational Fraction</label>
                                                    <div style="display: flex; gap: 4px; align-items: center;">
                                                        <input type="number" class="form-input" placeholder="Min" style="width: 70px; font-size: 11px; padding: 3px 6px;"
                                                               x-model.number="tournamentScenarioFilters.minRationalFraction" min="0" max="1" step="0.01">
                                                        <span>-</span>
                                                        <input type="number" class="form-input" placeholder="Max" style="width: 70px; font-size: 11px; padding: 3px 6px;"
                                                               x-model.number="tournamentScenarioFilters.maxRationalFraction" min="0" max="1" step="0.01">
                                                    </div>
                                                </div>
                                                <div>
                                                    <label class="form-label" style="font-size: 10px; margin-bottom: 2px;">Opposition</label>
                                                    <div style="display: flex; gap: 4px; align-items: center;">
                                                        <input type="number" class="form-input" placeholder="Min" style="width: 70px; font-size: 11px; padding: 3px 6px;"
                                                               x-model.number="tournamentScenarioFilters.minOpposition" min="0" max="1" step="0.01">
                                                        <span>-</span>
                                                        <input type="number" class="form-input" placeholder="Max" style="width: 70px; font-size: 11px; padding: 3px 6px;"
                                                               x-model.number="tournamentScenarioFilters.maxOpposition" min="0" max="1" step="0.01">
                                                    </div>
                                                </div>
                                                <button class="btn btn-sm btn-secondary" style="font-size: 10px; padding: 3px 6px; margin-top: 4px;"
                                                        @click="tournamentScenarioFilters = {minOutcomes: null, maxOutcomes: null, minRationalFraction: null, maxRationalFraction: null, minOpposition: null, maxOpposition: null, showAdvanced: true}">
                                                    Clear Filters
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="dual-list-items" style="flex: 1; overflow-y: auto; padding: 8px;">
                                        <template x-for="scenario in filteredTournamentScenarios.filter(s => !isTournamentScenarioSelected(s.path))" :key="scenario.path">
                                            <div class="dual-list-item" 
                                                 style="padding: 8px 10px; border-radius: 6px; cursor: pointer; margin-bottom: 4px; background: var(--bg-tertiary);"
                                                 @click="addTournamentScenario(scenario.path)"
                                                 @mouseenter="$el.style.background = 'var(--bg-hover)'"
                                                 @mouseleave="$el.style.background = 'var(--bg-tertiary)'">
                                                <div style="font-size: 13px; font-weight: 500;" x-text="scenario.name"></div>
                                                <div style="font-size: 11px; color: var(--text-muted); display: flex; gap: 8px; margin-top: 2px; flex-wrap: wrap;">
                                                    <span class="badge badge-secondary" style="font-size: 10px;" x-text="scenario.source"></span>
                                                    <span x-text="scenario.n_negotiators + 'p'"></span>
                                                    <span x-show="scenario.n_outcomes" x-text="scenario.n_outcomes + ' outcomes'"></span>
                                                    <span x-show="scenario.opposition !== null && scenario.opposition !== undefined"
                                                          x-text="'opp: ' + (scenario.opposition?.toFixed(2) ?? '')"
                                                          :title="'Opposition: ' + scenario.opposition"></span>
                                                </div>
                                            </div>
                                        </template>
                                        <div x-show="filteredTournamentScenarios.filter(s => !isTournamentScenarioSelected(s.path)).length === 0" 
                                             class="text-muted" style="text-align: center; padding: 20px; font-size: 13px;">
                                            No available scenarios
                                        </div>
                                    </div>
                                    <div class="dual-list-footer" style="padding: 8px; border-top: 1px solid var(--border-color); background: var(--bg-secondary);">
                                        <button class="btn btn-sm btn-secondary" style="width: 100%;" 
                                                @click="addAllFilteredTournamentScenarios()"
                                                :disabled="filteredTournamentScenarios.filter(s => !isTournamentScenarioSelected(s.path)).length === 0">
                                            Add All Filtered
                                            <span x-text="'(' + filteredTournamentScenarios.filter(s => !isTournamentScenarioSelected(s.path)).length + ')'"></span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Transfer buttons (center) -->
                                <div style="display: flex; flex-direction: column; justify-content: center; gap: 8px;">
                                    <button class="btn btn-sm btn-secondary" style="padding: 8px;" title="Add all filtered"
                                            @click="addAllFilteredTournamentScenarios()"
                                            :disabled="filteredTournamentScenarios.filter(s => !isTournamentScenarioSelected(s.path)).length === 0">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <polyline points="13 17 18 12 13 7"></polyline>
                                            <polyline points="6 17 11 12 6 7"></polyline>
                                        </svg>
                                    </button>
                                    <button class="btn btn-sm btn-secondary" style="padding: 8px;" title="Remove all"
                                            @click="newTournament.scenario_paths = []"
                                            :disabled="newTournament.scenario_paths.length === 0">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <polyline points="11 17 6 12 11 7"></polyline>
                                            <polyline points="18 17 13 12 18 7"></polyline>
                                        </svg>
                                    </button>
                                </div>
                                
                                <!-- Selected scenarios (right) -->
                                <div class="dual-list-panel" style="display: flex; flex-direction: column; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                                    <div class="dual-list-header" style="padding: 12px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
                                        <div style="font-weight: 600; font-size: 13px;">
                                            Selected
                                            <span class="badge badge-primary" style="margin-left: 6px;" x-text="newTournament.scenario_paths.length"></span>
                                        </div>
                                    </div>
                                    <div class="dual-list-items" style="flex: 1; overflow-y: auto; padding: 8px;">
                                        <template x-for="path in newTournament.scenario_paths" :key="path">
                                            <div class="dual-list-item selected" 
                                                 style="padding: 8px 10px; border-radius: 6px; cursor: pointer; margin-bottom: 4px; background: var(--primary-bg); display: flex; align-items: center; justify-content: space-between;"
                                                 @mouseenter="$el.style.background = 'var(--bg-hover)'"
                                                 @mouseleave="$el.style.background = 'var(--primary-bg)'">
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" 
                                                         x-text="scenarios.find(s => s.path === path)?.name || path.split('/').pop()"></div>
                                                    <div style="font-size: 11px; color: var(--text-muted); display: flex; gap: 6px;" 
                                                         x-data="{ sc: scenarios.find(s => s.path === path) }">
                                                        <span x-text="sc?.source || ''"></span>
                                                        <span x-show="sc?.n_outcomes" x-text="sc?.n_outcomes + ' out'"></span>
                                                        <span x-show="sc?.opposition !== null && sc?.opposition !== undefined"
                                                              x-text="'opp: ' + (sc?.opposition?.toFixed(2) ?? '')"></span>
                                                    </div>
                                                </div>
                                                <button class="btn btn-sm" style="padding: 4px; margin-left: 8px; background: transparent; color: var(--text-muted);"
                                                        @click.stop="removeTournamentScenario(path)"
                                                        title="Remove">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                                    </svg>
                                                </button>
                                            </div>
                                        </template>
                                        <div x-show="newTournament.scenario_paths.length === 0" 
                                             class="text-muted" style="text-align: center; padding: 20px; font-size: 13px;">
                                            No scenarios selected<br>
                                            <span style="font-size: 11px;">Click items on the left or use "Add All Filtered"</span>
                                        </div>
                                    </div>
                                    <div class="dual-list-footer" style="padding: 8px; border-top: 1px solid var(--border-color); background: var(--bg-secondary);">
                                        <button class="btn btn-sm btn-secondary" style="width: 100%;" 
                                                @click="newTournament.scenario_paths = []"
                                                :disabled="newTournament.scenario_paths.length === 0">
                                            Clear All
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Competitors Tab -->
                        <div x-show="tournamentTab === 'competitors'" class="wizard-panel">
                            <div class="panel-header">
                                <h3>Select Competitors</h3>
                                <span class="text-muted">(these agents will be scored)</span>
                            </div>
                            
                            <!-- Dual-list layout -->
                            <div class="dual-list-container" style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 12px; height: 450px;">
                                <!-- Available competitors (left) -->
                                <div class="dual-list-panel" style="display: flex; flex-direction: column; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                                    <div class="dual-list-header" style="padding: 12px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
                                        <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px;">
                                            Available
                                            <span class="text-muted" style="font-weight: normal;" x-text="'(' + filteredTournamentCompetitors.filter(n => !isTournamentCompetitorSelected(n.type_name)).length + ')'"></span>
                                        </div>
                                        <input type="text" class="form-input" placeholder="Search negotiators..." 
                                               style="font-size: 13px; padding: 6px 10px;"
                                               x-model="tournamentCompetitorSearch">
                                        <!-- Source filter -->
                                        <select class="form-select" style="margin-top: 8px; font-size: 12px; padding: 4px 8px;"
                                                x-model="tournamentCompetitorSourceFilter">
                                            <option value="">All sources</option>
                                            <option value="virtual" x-show="virtualNegotiators.length > 0">Virtual (saved configs)</option>
                                            <template x-for="src in [...new Set(negotiatorTypes.map(n => n.source))]" :key="src">
                                                <option :value="src" x-text="src"></option>
                                            </template>
                                        </select>
                                        <!-- Tag filter -->
                                        <select class="form-select" style="margin-top: 8px; font-size: 12px; padding: 4px 8px;"
                                                x-model="tournamentCompetitorTagFilter">
                                            <option value="">All tags</option>
                                            <template x-for="tag in allNegotiatorTags" :key="tag">
                                                <option :value="tag" x-text="tag"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <div class="dual-list-items" style="flex: 1; overflow-y: auto; padding: 8px;">
                                        <template x-for="neg in filteredTournamentCompetitors.filter(n => !isTournamentCompetitorSelected(n.type_name))" :key="neg.type_name">
                                            <div class="dual-list-item" 
                                                 style="padding: 8px 10px; border-radius: 6px; cursor: pointer; margin-bottom: 4px; background: var(--bg-tertiary);"
                                                 @click="addTournamentCompetitor(neg.type_name)"
                                                 @mouseenter="$el.style.background = 'var(--bg-hover)'"
                                                 @mouseleave="$el.style.background = 'var(--bg-tertiary)'">
                                                <div style="font-size: 13px; font-weight: 500;" x-text="neg.name"></div>
                                                <div style="font-size: 11px; color: var(--text-muted); display: flex; gap: 8px; margin-top: 2px;">
                                                    <span class="badge badge-secondary" style="font-size: 10px;" x-text="neg.source"></span>
                                                    <span x-show="neg.description" x-text="neg.description" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
                                                </div>
                                            </div>
                                        </template>
                                        <div x-show="filteredTournamentCompetitors.filter(n => !isTournamentCompetitorSelected(n.type_name)).length === 0" 
                                             class="text-muted" style="text-align: center; padding: 20px; font-size: 13px;">
                                            No available competitors
                                        </div>
                                    </div>
                                    <div class="dual-list-footer" style="padding: 8px; border-top: 1px solid var(--border-color); background: var(--bg-secondary);">
                                        <button class="btn btn-sm btn-secondary" style="width: 100%;" 
                                                @click="addAllFilteredTournamentCompetitors()"
                                                :disabled="filteredTournamentCompetitors.filter(n => !isTournamentCompetitorSelected(n.type_name)).length === 0">
                                            Add All Filtered
                                            <span x-text="'(' + filteredTournamentCompetitors.filter(n => !isTournamentCompetitorSelected(n.type_name)).length + ')'"></span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Transfer buttons (center) -->
                                <div style="display: flex; flex-direction: column; justify-content: center; gap: 8px;">
                                    <button class="btn btn-sm btn-secondary" style="padding: 8px;" title="Add all filtered"
                                            @click="addAllFilteredTournamentCompetitors()"
                                            :disabled="filteredTournamentCompetitors.filter(n => !isTournamentCompetitorSelected(n.type_name)).length === 0">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <polyline points="13 17 18 12 13 7"></polyline>
                                            <polyline points="6 17 11 12 6 7"></polyline>
                                        </svg>
                                    </button>
                                    <button class="btn btn-sm btn-secondary" style="padding: 8px;" title="Remove all"
                                            @click="newTournament.competitor_types = []"
                                            :disabled="newTournament.competitor_types.length === 0">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <polyline points="11 17 6 12 11 7"></polyline>
                                            <polyline points="18 17 13 12 18 7"></polyline>
                                        </svg>
                                    </button>
                                </div>
                                
                                <!-- Selected competitors (right) -->
                                <div class="dual-list-panel" style="display: flex; flex-direction: column; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                                    <div class="dual-list-header" style="padding: 12px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
                                        <div style="font-weight: 600; font-size: 13px;">
                                            Selected
                                            <span class="badge" :class="newTournament.competitor_types.length >= 1 ? 'badge-primary' : 'badge-warning'" 
                                                  style="margin-left: 6px;" x-text="newTournament.competitor_types.length"></span>
                                            <span x-show="newTournament.competitor_types.length < 1" class="text-warning" style="font-size: 11px; margin-left: 6px;">(need 1+)</span>
                                        </div>
                                    </div>
                                    <div class="dual-list-items" style="flex: 1; overflow-y: auto; padding: 8px;">
                                        <template x-for="typeName in newTournament.competitor_types" :key="typeName">
                                            <div class="dual-list-item selected" 
                                                 style="padding: 8px 10px; border-radius: 6px; cursor: pointer; margin-bottom: 4px; background: var(--primary-bg); display: flex; align-items: center; justify-content: space-between;"
                                                 @mouseenter="$el.style.background = 'var(--bg-hover)'"
                                                 @mouseleave="$el.style.background = 'var(--primary-bg)'">
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" 
                                                         x-text="negotiatorTypes.find(n => n.type_name === typeName)?.name || typeName"></div>
                                                    <div style="font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 4px;">
                                                        <span x-text="negotiatorTypes.find(n => n.type_name === typeName)?.source || ''"></span>
                                                        <span x-show="isVirtualNegotiator(typeName)" class="badge badge-info" style="font-size: 9px; padding: 1px 4px;">Virtual</span>
                                                    </div>
                                                </div>
                                                <div style="display: flex; gap: 4px; align-items: center;">
                                                    <!-- Configure button - opens parameter editor modal -->
                                                    <button class="btn btn-sm" style="padding: 4px; background: transparent; color: var(--text-muted);"
                                                            @click.stop="openCompetitorConfig(typeName)"
                                                            title="Configure parameters">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                            <circle cx="12" cy="12" r="3"></circle>
                                                            <path d="M12 1v4m0 14v4m-7.07-15.07l2.83 2.83m8.48 8.48l2.83 2.83M1 12h4m14 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"></path>
                                                        </svg>
                                                    </button>
                                                    <!-- Remove button -->
                                                    <button class="btn btn-sm" style="padding: 4px; background: transparent; color: var(--text-muted);"
                                                            @click.stop="removeTournamentCompetitor(typeName)"
                                                            title="Remove">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </template>
                                        <div x-show="newTournament.competitor_types.length === 0" 
                                             class="text-muted" style="text-align: center; padding: 20px; font-size: 13px;">
                                            No competitors selected<br>
                                            <span style="font-size: 11px;">Click items on the left or use "Add All Filtered"</span>
                                        </div>
                                    </div>
                                    <div class="dual-list-footer" style="padding: 8px; border-top: 1px solid var(--border-color); background: var(--bg-secondary);">
                                        <button class="btn btn-sm btn-secondary" style="width: 100%;" 
                                                @click="newTournament.competitor_types = []"
                                                :disabled="newTournament.competitor_types.length === 0">
                                            Clear All
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Opponents Tab -->
                        <div x-show="tournamentTab === 'opponents'" class="wizard-panel">
                            <div class="panel-header">
                                <h3>Select Opponents</h3>
                                <span class="text-muted">(agents that competitors play against)</span>
                            </div>
                            
                            <!-- Same as competitors checkbox -->
                            <div class="form-group" style="margin-bottom: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" x-model="newTournament.opponents_same_as_competitors">
                                    <span style="font-weight: 500;">Same as competitors</span>
                                </label>
                                <div class="text-muted" style="font-size: 12px; margin-top: 6px; margin-left: 26px;">
                                    When checked, competitors play against each other (standard tournament mode).
                                    Uncheck to specify separate opponents - competitors will play against opponents but only competitors are scored.
                                </div>
                            </div>
                            
                            <!-- Dual-list layout (only shown when not same as competitors) -->
                            <div class="dual-list-container" x-show="!newTournament.opponents_same_as_competitors" x-transition
                                 style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 12px; height: 380px;">
                                <!-- Available opponents (left) -->
                                <div class="dual-list-panel" style="display: flex; flex-direction: column; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                                    <div class="dual-list-header" style="padding: 12px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
                                        <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px;">
                                            Available
                                            <span class="text-muted" style="font-weight: normal;" x-text="'(' + filteredTournamentOpponents.filter(n => !isTournamentOpponentSelected(n.type_name)).length + ')'"></span>
                                        </div>
                                        <input type="text" class="form-input" placeholder="Search negotiators..." 
                                               style="font-size: 13px; padding: 6px 10px;"
                                               x-model="tournamentOpponentSearch">
                                        <!-- Source filter -->
                                        <select class="form-select" style="margin-top: 8px; font-size: 12px; padding: 4px 8px;"
                                                x-model="tournamentOpponentSourceFilter">
                                            <option value="">All sources</option>
                                            <option value="virtual" x-show="virtualNegotiators.length > 0">Virtual (saved configs)</option>
                                            <template x-for="src in [...new Set(negotiatorTypes.map(n => n.source))]" :key="src">
                                                <option :value="src" x-text="src"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <div class="dual-list-items" style="flex: 1; overflow-y: auto; padding: 8px;">
                                        <template x-for="neg in filteredTournamentOpponents.filter(n => !isTournamentOpponentSelected(n.type_name))" :key="neg.type_name">
                                            <div class="dual-list-item" 
                                                 style="padding: 8px 10px; border-radius: 6px; cursor: pointer; margin-bottom: 4px; background: var(--bg-tertiary);"
                                                 @click="addTournamentOpponent(neg.type_name)"
                                                 @mouseenter="$el.style.background = 'var(--bg-hover)'"
                                                 @mouseleave="$el.style.background = 'var(--bg-tertiary)'">
                                                <div style="font-size: 13px; font-weight: 500;" x-text="neg.name"></div>
                                                <div style="font-size: 11px; color: var(--text-muted); display: flex; gap: 8px; margin-top: 2px;">
                                                    <span class="badge badge-secondary" style="font-size: 10px;" x-text="neg.source"></span>
                                                    <span x-show="neg.description" x-text="neg.description" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
                                                </div>
                                            </div>
                                        </template>
                                        <div x-show="filteredTournamentOpponents.filter(n => !isTournamentOpponentSelected(n.type_name)).length === 0" 
                                             class="text-muted" style="text-align: center; padding: 20px; font-size: 13px;">
                                            No available opponents
                                        </div>
                                    </div>
                                    <div class="dual-list-footer" style="padding: 8px; border-top: 1px solid var(--border-color); background: var(--bg-secondary);">
                                        <button class="btn btn-sm btn-secondary" style="width: 100%;" 
                                                @click="addAllFilteredTournamentOpponents()"
                                                :disabled="filteredTournamentOpponents.filter(n => !isTournamentOpponentSelected(n.type_name)).length === 0">
                                            Add All Filtered
                                            <span x-text="'(' + filteredTournamentOpponents.filter(n => !isTournamentOpponentSelected(n.type_name)).length + ')'"></span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Transfer buttons (center) -->
                                <div style="display: flex; flex-direction: column; justify-content: center; gap: 8px;">
                                    <button class="btn btn-sm btn-secondary" style="padding: 8px;" title="Add all filtered"
                                            @click="addAllFilteredTournamentOpponents()"
                                            :disabled="filteredTournamentOpponents.filter(n => !isTournamentOpponentSelected(n.type_name)).length === 0">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <polyline points="13 17 18 12 13 7"></polyline>
                                            <polyline points="6 17 11 12 6 7"></polyline>
                                        </svg>
                                    </button>
                                    <button class="btn btn-sm btn-secondary" style="padding: 8px;" title="Copy from competitors"
                                            @click="newTournament.opponent_types = [...newTournament.competitor_types]"
                                            :disabled="newTournament.competitor_types.length === 0">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                        </svg>
                                    </button>
                                    <button class="btn btn-sm btn-secondary" style="padding: 8px;" title="Remove all"
                                            @click="newTournament.opponent_types = []"
                                            :disabled="newTournament.opponent_types.length === 0">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <polyline points="11 17 6 12 11 7"></polyline>
                                            <polyline points="18 17 13 12 18 7"></polyline>
                                        </svg>
                                    </button>
                                </div>
                                
                                <!-- Selected opponents (right) -->
                                <div class="dual-list-panel" style="display: flex; flex-direction: column; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                                    <div class="dual-list-header" style="padding: 12px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
                                        <div style="font-weight: 600; font-size: 13px;">
                                            Selected Opponents
                                            <span class="badge" :class="newTournament.opponent_types.length >= 1 ? 'badge-primary' : 'badge-warning'" 
                                                  style="margin-left: 6px;" x-text="newTournament.opponent_types.length"></span>
                                            <span x-show="newTournament.opponent_types.length < 1" class="text-warning" style="font-size: 11px; margin-left: 6px;">(need 1+)</span>
                                        </div>
                                    </div>
                                    <div class="dual-list-items" style="flex: 1; overflow-y: auto; padding: 8px;">
                                        <template x-for="typeName in newTournament.opponent_types" :key="typeName">
                                            <div class="dual-list-item selected" 
                                                 style="padding: 8px 10px; border-radius: 6px; cursor: pointer; margin-bottom: 4px; background: var(--primary-bg); display: flex; align-items: center; justify-content: space-between;"
                                                 @mouseenter="$el.style.background = 'var(--bg-hover)'"
                                                 @mouseleave="$el.style.background = 'var(--primary-bg)'">
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" 
                                                         x-text="negotiatorTypes.find(n => n.type_name === typeName)?.name || typeName"></div>
                                                    <div style="font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 4px;">
                                                        <span x-text="negotiatorTypes.find(n => n.type_name === typeName)?.source || ''"></span>
                                                        <span x-show="isVirtualNegotiator(typeName)" class="badge badge-info" style="font-size: 9px; padding: 1px 4px;">Virtual</span>
                                                        <span x-show="newTournament.competitor_types.includes(typeName)" class="badge badge-success" style="font-size: 9px; padding: 1px 4px;">Also competitor</span>
                                                    </div>
                                                </div>
                                                <div style="display: flex; gap: 4px; align-items: center;">
                                                    <!-- Remove button -->
                                                    <button class="btn btn-sm" style="padding: 4px; background: transparent; color: var(--text-muted);"
                                                            @click.stop="removeTournamentOpponent(typeName)"
                                                            title="Remove">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </template>
                                        <div x-show="newTournament.opponent_types.length === 0" 
                                             class="text-muted" style="text-align: center; padding: 20px; font-size: 13px;">
                                            No opponents selected<br>
                                            <span style="font-size: 11px;">Click items on the left or use "Add All Filtered"</span>
                                        </div>
                                    </div>
                                    <div class="dual-list-footer" style="padding: 8px; border-top: 1px solid var(--border-color); background: var(--bg-secondary);">
                                        <button class="btn btn-sm btn-secondary" style="width: 100%;" 
                                                @click="newTournament.opponent_types = []"
                                                :disabled="newTournament.opponent_types.length === 0">
                                            Clear All
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Info when same as competitors -->
                            <div x-show="newTournament.opponents_same_as_competitors" x-transition
                                 style="padding: 40px; text-align: center; background: var(--bg-secondary); border-radius: 8px; border: 2px dashed var(--border-color);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48" style="color: var(--text-muted); margin-bottom: 12px;">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                <div style="font-size: 15px; font-weight: 500; margin-bottom: 8px;">Standard Tournament Mode</div>
                                <div class="text-muted" style="font-size: 13px; max-width: 400px; margin: 0 auto;">
                                    All <span x-text="newTournament.competitor_types.length"></span> competitors will play against each other.
                                    <template x-if="newTournament.self_play">
                                        <span>Self-play is enabled, so each competitor also plays against itself.</span>
                                    </template>
                                    <template x-if="!newTournament.self_play">
                                        <span>Self-play is disabled.</span>
                                    </template>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Settings Tab -->
                        <div x-show="tournamentTab === 'settings'" class="wizard-panel">
                            <div class="panel-header">
                                <h3>Tournament Settings</h3>
                            </div>
                            
                            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="form-group">
                                    <label class="form-label">Repetitions</label>
                                    <input type="number" class="form-input" x-model.number="newTournament.n_repetitions" min="1" max="100">
                                    <div class="form-hint">Run each pairing multiple times</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        Max Steps
                                        <label class="form-checkbox" style="display: inline-flex; margin-left: 8px; font-weight: normal;">
                                            <input type="checkbox" x-model="newTournament.n_steps_range_enabled">
                                            <span style="font-size: 11px;">Range</span>
                                        </label>
                                    </label>
                                    <div x-show="!newTournament.n_steps_range_enabled">
                                        <input type="number" class="form-input" x-model.number="newTournament.n_steps" min="1">
                                    </div>
                                    <div x-show="newTournament.n_steps_range_enabled" style="display: flex; gap: 8px; align-items: center;">
                                        <input type="number" class="form-input" x-model.number="newTournament.n_steps_min" min="1" placeholder="Min" style="width: 80px;">
                                        <span>-</span>
                                        <input type="number" class="form-input" x-model.number="newTournament.n_steps_max" min="1" placeholder="Max" style="width: 80px;">
                                    </div>
                                    <div class="form-hint" x-show="newTournament.n_steps_range_enabled">Random sample per negotiation</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        Time Limit (seconds)
                                        <label class="form-checkbox" style="display: inline-flex; margin-left: 8px; font-weight: normal;">
                                            <input type="checkbox" x-model="newTournament.time_limit_range_enabled">
                                            <span style="font-size: 11px;">Range</span>
                                        </label>
                                    </label>
                                    <div x-show="!newTournament.time_limit_range_enabled">
                                        <input type="number" class="form-input" x-model.number="newTournament.time_limit" min="0" step="0.1" placeholder="No limit">
                                    </div>
                                    <div x-show="newTournament.time_limit_range_enabled" style="display: flex; gap: 8px; align-items: center;">
                                        <input type="number" class="form-input" x-model.number="newTournament.time_limit_min" min="0" step="0.1" placeholder="Min" style="width: 80px;">
                                        <span>-</span>
                                        <input type="number" class="form-input" x-model.number="newTournament.time_limit_max" min="0" step="0.1" placeholder="Max" style="width: 80px;">
                                    </div>
                                    <div class="form-hint" x-show="!newTournament.time_limit_range_enabled">Max time per negotiation</div>
                                    <div class="form-hint" x-show="newTournament.time_limit_range_enabled">Random sample per negotiation</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Mechanism</label>
                                    <select class="form-select" x-model="newTournament.mechanism_type">
                                        <option value="SAOMechanism">SAO Mechanism</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Score Metric</label>
                                    <select class="form-select" x-model="newTournament.final_score_metric">
                                        <option value="advantage">Advantage</option>
                                        <option value="utility">Utility</option>
                                        <option value="welfare">Welfare</option>
                                        <option value="partner_welfare">Partner Welfare</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Score Statistic</label>
                                    <select class="form-select" x-model="newTournament.final_score_stat">
                                        <option value="mean">Mean</option>
                                        <option value="median">Median</option>
                                        <option value="min">Min</option>
                                        <option value="max">Max</option>
                                        <option value="std">Std Dev</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top: 16px;">
                                <label class="form-checkbox">
                                    <input type="checkbox" x-model="newTournament.rotate_ufuns">
                                    <span>Rotate Utility Functions</span>
                                </label>
                                <div class="form-hint">Each pair plays both positions</div>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" x-model="newTournament.self_play">
                                    <span>Allow Self-Play</span>
                                </label>
                                <div class="form-hint">Allow competitors to play against themselves</div>
                            </div>
                            
                            <!-- Normalize scenarios -->
                            <div class="form-group" style="margin-top: 16px;">
                                <label class="form-checkbox">
                                    <input type="checkbox" x-model="newTournament.normalize">
                                    <span>Normalize Utility Functions</span>
                                </label>
                                <div class="form-hint">Scale utilities to [0, 1] for fair cross-scenario comparison</div>
                                <!-- Warning when normalization is disabled -->
                                <div x-show="!newTournament.normalize" 
                                     style="margin-top: 8px; padding: 8px 12px; background: rgba(255, 193, 7, 0.15); border: 1px solid rgba(255, 193, 7, 0.5); border-radius: 6px; font-size: 12px; color: var(--text-warning);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="vertical-align: -2px; margin-right: 4px;">
                                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                        <line x1="12" y1="9" x2="12" y2="13"></line>
                                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                    </svg>
                                    <strong>Warning:</strong> Aggregating results without normalization may give disproportionate influence to scenarios with different utility scales.
                                </div>
                            </div>
                            
                            <!-- Advanced Settings (Collapsible) -->
                            <details class="advanced-settings" style="margin-top: 24px; border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
                                <summary style="cursor: pointer; font-weight: 600; color: var(--text-secondary);">Advanced Settings</summary>
                                
                                <div style="margin-top: 16px;">
                                    <h4 style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px;">Time Limits</h4>
                                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                                        <div class="form-group">
                                            <label class="form-label">Step Time Limit</label>
                                            <input type="number" class="form-input" x-model.number="newTournament.step_time_limit" min="0" step="0.1" placeholder="None">
                                            <div class="form-hint">Per-step limit (s)</div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Negotiator Time</label>
                                            <input type="number" class="form-input" x-model.number="newTournament.negotiator_time_limit" min="0" step="0.1" placeholder="None">
                                            <div class="form-hint">Total per negotiator (s)</div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Hidden Time Limit</label>
                                            <input type="number" class="form-input" x-model.number="newTournament.hidden_time_limit" min="0" step="0.1" placeholder="None">
                                            <div class="form-hint">Not revealed to agents</div>
                                        </div>
                                    </div>
                                    
                                    <h4 style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin: 16px 0 12px;">Probabilistic Ending</h4>
                                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                        <div class="form-group">
                                            <label class="form-label">End Probability (per step)</label>
                                            <input type="number" class="form-input" x-model.number="newTournament.pend" min="0" max="1" step="0.01" placeholder="0">
                                            <div class="form-hint">Prob. of ending each step</div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">End Prob. (per second)</label>
                                            <input type="number" class="form-input" x-model.number="newTournament.pend_per_second" min="0" max="1" step="0.01" placeholder="0">
                                            <div class="form-hint">Prob. of ending per second</div>
                                        </div>
                                    </div>
                                    
                                    <h4 style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin: 16px 0 12px;">Information Hiding</h4>
                                    <div class="form-group">
                                        <label class="form-checkbox">
                                            <input type="checkbox" x-model="newTournament.id_reveals_type">
                                            <span>ID Reveals Type</span>
                                        </label>
                                        <div class="form-hint">Negotiator ID reveals its type to opponents</div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-checkbox">
                                            <input type="checkbox" x-model="newTournament.name_reveals_type">
                                            <span>Name Reveals Type</span>
                                        </label>
                                        <div class="form-hint">Negotiator name reveals its type to opponents</div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-checkbox">
                                            <input type="checkbox" x-model="newTournament.mask_scenario_names">
                                            <span>Mask Scenario Names</span>
                                        </label>
                                        <div class="form-hint">Hide scenario names from negotiators</div>
                                    </div>
                                    
                                    <h4 style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin: 16px 0 12px;">Run Ordering</h4>
                                    <div class="form-group">
                                        <label class="form-checkbox">
                                            <input type="checkbox" x-model="newTournament.randomize_runs">
                                            <span>Randomize Runs</span>
                                        </label>
                                        <div class="form-hint">Randomize order of negotiations</div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-checkbox">
                                            <input type="checkbox" x-model="newTournament.sort_runs">
                                            <span>Sort Runs</span>
                                        </label>
                                        <div class="form-hint">Sort runs by scenario/competitors</div>
                                    </div>
                                    
                                    <h4 style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin: 16px 0 12px;">Self-Play Options</h4>
                                    <div class="form-group">
                                        <label class="form-checkbox">
                                            <input type="checkbox" x-model="newTournament.only_failures_on_self_play">
                                            <span>Only Failures on Self-Play</span>
                                        </label>
                                        <div class="form-hint">Only record failures for self-play negotiations</div>
                                    </div>
                                    
                                    <h4 style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin: 16px 0 12px;">Save Options</h4>
                                    <div class="form-group">
                                        <label class="form-checkbox">
                                            <input type="checkbox" x-model="newTournament.save_stats">
                                            <span>Save Statistics</span>
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-checkbox">
                                            <input type="checkbox" x-model="newTournament.save_scenario_figs">
                                            <span>Save Scenario Figures</span>
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Save Every N Negotiations</label>
                                        <input type="number" class="form-input" x-model.number="newTournament.save_every" min="0" placeholder="0 (only at end)">
                                        <div class="form-hint">0 = save only at end</div>
                                    </div>
                                </div>
                            </details>
                        </div>
                        
                        <!-- Review Tab -->
                        <div x-show="tournamentTab === 'review'" class="wizard-panel">
                            <div class="panel-header">
                                <h3>Review Tournament Configuration</h3>
                            </div>
                            
                            <div class="review-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                                <!-- Left column: Scenarios and Competitors -->
                                <div>
                                    <!-- Scenarios Summary -->
                                    <div class="review-section" style="margin-bottom: 24px;">
                                        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                <polyline points="14 2 14 8 20 8"></polyline>
                                            </svg>
                                            Scenarios
                                            <span class="badge badge-primary" x-text="newTournament.scenario_paths.length"></span>
                                        </h4>
                                        <div class="review-list" style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px; max-height: 150px; overflow-y: auto;">
                                            <template x-for="path in newTournament.scenario_paths" :key="path">
                                                <div style="font-size: 12px; padding: 4px 0; border-bottom: 1px solid var(--border-color);" 
                                                     x-text="scenarios.find(s => s.path === path)?.name || path.split('/').pop()"></div>
                                            </template>
                                            <div x-show="newTournament.scenario_paths.length === 0" class="text-warning" style="font-size: 12px;">
                                                No scenarios selected
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Competitors Summary -->
                                    <div class="review-section" style="margin-bottom: 24px;">
                                        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                                <circle cx="9" cy="7" r="4"></circle>
                                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                            </svg>
                                            Competitors
                                            <span class="badge" :class="newTournament.competitor_types.length >= 1 ? 'badge-primary' : 'badge-warning'" 
                                                  x-text="newTournament.competitor_types.length"></span>
                                            <span class="text-muted" style="font-size: 11px; font-weight: normal;">(scored)</span>
                                        </h4>
                                        <div class="review-list" style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px; max-height: 120px; overflow-y: auto;">
                                            <template x-for="typeName in newTournament.competitor_types" :key="typeName">
                                                <div style="font-size: 12px; padding: 4px 0; border-bottom: 1px solid var(--border-color);" 
                                                     x-text="negotiatorTypes.find(n => n.type_name === typeName)?.name || typeName"></div>
                                            </template>
                                            <div x-show="newTournament.competitor_types.length < 1" class="text-warning" style="font-size: 12px;">
                                                Need at least 1 competitor
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Opponents Summary -->
                                    <div class="review-section">
                                        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                                <circle cx="9" cy="7" r="4"></circle>
                                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                            </svg>
                                            Opponents
                                            <template x-if="newTournament.opponents_same_as_competitors">
                                                <span class="badge badge-info">=Competitors</span>
                                            </template>
                                            <template x-if="!newTournament.opponents_same_as_competitors">
                                                <span class="badge" :class="newTournament.opponent_types.length >= 1 ? 'badge-primary' : 'badge-warning'" 
                                                      x-text="newTournament.opponent_types.length"></span>
                                            </template>
                                        </h4>
                                        <div class="review-list" style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px; max-height: 120px; overflow-y: auto;">
                                            <template x-if="newTournament.opponents_same_as_competitors">
                                                <div style="font-size: 12px; color: var(--text-muted);">
                                                    Same as competitors (standard tournament mode)
                                                </div>
                                            </template>
                                            <template x-if="!newTournament.opponents_same_as_competitors">
                                                <div>
                                                    <template x-for="typeName in newTournament.opponent_types" :key="typeName">
                                                        <div style="font-size: 12px; padding: 4px 0; border-bottom: 1px solid var(--border-color);" 
                                                             x-text="negotiatorTypes.find(n => n.type_name === typeName)?.name || typeName"></div>
                                                    </template>
                                                    <div x-show="newTournament.opponent_types.length < 1" class="text-warning" style="font-size: 12px;">
                                                        Need at least 1 opponent
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Right column: Settings Summary -->
                                <div>
                                    <div class="review-section">
                                        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                                <circle cx="12" cy="12" r="3"></circle>
                                                <path d="M12 1v4m0 14v4m-7.07-15.07l2.83 2.83m8.48 8.48l2.83 2.83M1 12h4m14 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"></path>
                                            </svg>
                                            Settings
                                        </h4>
                                        <div class="review-settings" style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px;">
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px 16px; font-size: 12px;">
                                                <div><span class="text-muted">Repetitions:</span> <span x-text="newTournament.n_repetitions"></span></div>
                                                <div><span class="text-muted">Mechanism:</span> <span x-text="newTournament.mechanism_type"></span></div>
                                                <div>
                                                    <span class="text-muted">Max Steps:</span> 
                                                    <span x-text="newTournament.n_steps_range_enabled ? newTournament.n_steps_min + '-' + newTournament.n_steps_max : (newTournament.n_steps || 'None')"></span>
                                                </div>
                                                <div>
                                                    <span class="text-muted">Time Limit:</span> 
                                                    <span x-text="newTournament.time_limit_range_enabled ? newTournament.time_limit_min + '-' + newTournament.time_limit_max + 's' : (newTournament.time_limit ? newTournament.time_limit + 's' : 'None')"></span>
                                                </div>
                                                <div><span class="text-muted">Score Metric:</span> <span x-text="newTournament.final_score_metric"></span></div>
                                                <div><span class="text-muted">Score Stat:</span> <span x-text="newTournament.final_score_stat"></span></div>
                                                <div><span class="text-muted">Rotate Ufuns:</span> <span x-text="newTournament.rotate_ufuns ? 'Yes' : 'No'"></span></div>
                                                <div><span class="text-muted">Self-play:</span> <span x-text="newTournament.self_play ? 'Yes' : 'No'"></span></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Estimated Negotiations -->
                                    <div class="review-section" style="margin-top: 24px;">
                                        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Estimated Total Negotiations</h4>
                                        <div style="background: var(--primary-bg); border-radius: 8px; padding: 16px; text-align: center;">
                                            <div style="font-size: 24px; font-weight: 700; color: var(--primary);" x-text="estimateTournamentNegotiations()"></div>
                                            <div class="text-muted" style="font-size: 11px; margin-top: 4px;">
                                                <span x-text="newTournament.scenario_paths.length"></span> scenarios &times;
                                                <span x-text="estimateTournamentPairings()"></span> pairings &times;
                                                <span x-text="newTournament.n_repetitions"></span> repetitions
                                                <span x-show="newTournament.rotate_ufuns"> &times; 2 (rotated)</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Save Preset Section -->
                                    <div class="review-section" style="margin-top: 24px;">
                                        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Save Configuration</h4>
                                        <div style="display: flex; gap: 8px;">
                                            <input type="text" class="form-input" placeholder="Preset name..." 
                                                   x-model="tournamentPresetName" style="flex: 1;">
                                            <button class="btn btn-secondary" @click="saveTournamentPreset()" 
                                                    :disabled="!tournamentPresetName.trim() || !canStartTournament()">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                                    <polyline points="7 3 7 8 15 8"></polyline>
                                                </svg>
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer" style="display: flex; justify-content: space-between;">
                <div>
                    <button class="btn btn-secondary" @click="showNewTournament = false">Cancel</button>
                </div>
                <div style="display: flex; gap: 8px;">
                    <!-- Back button -->
                    <button class="btn btn-secondary" 
                            x-show="tournamentTab !== 'scenarios'"
                            @click="tournamentWizardBack()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        Back
                    </button>
                    <!-- Next button -->
                    <button class="btn btn-secondary" 
                            x-show="tournamentTab !== 'review'"
                            @click="tournamentWizardNext()">
                        Next
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>
                    <!-- Start Tournament button (only on review tab) -->
                    <button class="btn btn-primary" 
                            x-show="tournamentTab === 'review'"
                            @click="startTournament()"
                            :disabled="!canStartTournament()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        Start Tournament
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-overlay" :class="{ active: showSettings }" @click.self="showSettings = false">
        <div class="modal large">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="modal-close" @click="showSettings = false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body" style="padding: 0;">
                <div class="settings-layout">
                    <div class="settings-sidebar">
                        <div class="settings-nav">
                            <button class="settings-nav-item" :class="{ active: settingsTab === 'general' }" @click="settingsTab = 'general'">General</button>
                            <button class="settings-nav-item" :class="{ active: settingsTab === 'negotiation' }" @click="settingsTab = 'negotiation'">Negotiation</button>
                            <button class="settings-nav-item" :class="{ active: settingsTab === 'performance' }" @click="settingsTab = 'performance'">Performance</button>
                            <button class="settings-nav-item" :class="{ active: settingsTab === 'sources' }" @click="settingsTab = 'sources'; loadSourceSettings()">Negotiator Sources</button>
                            <button class="settings-nav-item" :class="{ active: settingsTab === 'genius' }" @click="settingsTab = 'genius'">Genius Bridge</button>
                            <button class="settings-nav-item" :class="{ active: settingsTab === 'paths' }" @click="settingsTab = 'paths'">Custom Paths</button>
                            <button class="settings-nav-item" :class="{ active: settingsTab === 'data' }" @click="settingsTab = 'data'">Export / Import</button>
                        </div>
                    </div>
                    
                    <div class="settings-content">
                        <div x-show="settingsTab === 'general'">
                            <h3 class="font-semibold mb-4">General Settings</h3>
                            
                            <!-- Theme Section -->
                            <div class="settings-section">
                                <h4 class="settings-section-title">Theme</h4>
                                <div class="form-group">
                                    <label class="form-checkbox">
                                        <input type="checkbox" x-model="settings.darkMode" @change="toggleDarkMode()">
                                        <span>Dark Mode</span>
                                    </label>
                                    <div class="form-hint">Use dark color scheme</div>
                                </div>
                            </div>
                            
                            <!-- Accessibility Section -->
                            <div class="settings-section">
                                <h4 class="settings-section-title">Accessibility</h4>
                                <div class="form-group">
                                    <label class="form-checkbox">
                                        <input type="checkbox" x-model="settings.colorBlindMode" @change="toggleColorBlindMode()">
                                        <span>Color Blind Mode</span>
                                    </label>
                                    <div class="form-hint">Use color-blind friendly palette with distinct line styles and markers</div>
                                </div>
                                <div class="color-palette-preview" x-show="settings.colorBlindMode">
                                    <div class="palette-label">Color-blind friendly palette:</div>
                                    <div class="palette-colors">
                                        <span class="color-swatch" style="background: #0072B2;" title="Blue"></span>
                                        <span class="color-swatch" style="background: #E69F00;" title="Orange"></span>
                                        <span class="color-swatch" style="background: #009E73;" title="Bluish Green"></span>
                                        <span class="color-swatch" style="background: #CC79A7;" title="Reddish Purple"></span>
                                        <span class="color-swatch" style="background: #F0E442;" title="Yellow"></span>
                                        <span class="color-swatch" style="background: #56B4E9;" title="Sky Blue"></span>
                                        <span class="color-swatch" style="background: #D55E00;" title="Vermillion"></span>
                                        <span class="color-swatch" style="background: #000000;" title="Black"></span>
                                    </div>
                                    <div class="palette-note">Charts will also use different line styles and markers</div>
                                </div>
                            </div>
                            
                            <!-- Storage Section -->
                            <div class="settings-section">
                                <h4 class="settings-section-title">Storage</h4>
                                <div class="form-group">
                                    <label class="form-checkbox">
                                        <input type="checkbox" x-model="settings.saveNegotiations" @change="saveSettings()">
                                        <span>Save Negotiations</span>
                                    </label>
                                    <div class="form-hint">Persist completed negotiations to disk for later review</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-checkbox">
                                        <input type="checkbox" x-model="settings.cacheScenarioStats" @change="saveSettings()">
                                        <span>Cache Scenario Statistics</span>
                                    </label>
                                    <div class="form-hint">Auto-save computed Pareto, Nash, Kalai, and other statistics to scenario folders</div>
                                </div>
                            </div>
                        </div>
                        
                        <div x-show="settingsTab === 'negotiation'">
                            <h3 class="font-semibold mb-4">Default Negotiation Settings</h3>
                            <div class="form-group">
                                <label class="form-label">Default Max Steps</label>
                                <input type="number" class="form-input" x-model.number="settings.defaultSteps">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default Step Delay (ms)</label>
                                <input type="number" class="form-input" x-model.number="settings.defaultDelay">
                            </div>
                        </div>
                        
                        <div x-show="settingsTab === 'performance'">
                            <h3 class="font-semibold mb-4">Performance Settings</h3>
                            <p class="text-secondary mb-4" style="font-size: 13px;">
                                Set limits on resource-intensive operations based on scenario size (number of outcomes).
                                Use 0 or leave empty for no limit.
                            </p>
                            
                            <!-- Run Limit Section -->
                            <div class="settings-section">
                                <h4 class="settings-section-title">Negotiation/Tournament Limits</h4>
                                <div class="form-group">
                                    <label class="form-label">Max Outcomes for Running</label>
                                    <input type="number" class="form-input" 
                                           x-model.number="settings.maxOutcomesRun"
                                           placeholder="No limit"
                                           min="0">
                                    <div class="form-hint">
                                        Scenarios with more outcomes will be blocked from running negotiations or included in tournaments.
                                        Leave empty or set to 0 for no limit.
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Stats Calculation Limits Section -->
                            <div class="settings-section">
                                <h4 class="settings-section-title">Statistics Calculation Limits</h4>
                                <div class="form-group">
                                    <label class="form-label">Max Outcomes for Stats Calculation</label>
                                    <input type="number" class="form-input" 
                                           x-model.number="settings.maxOutcomesStats"
                                           placeholder="1,000,000"
                                           min="0">
                                    <div class="form-hint">
                                        Scenarios exceeding this limit will skip Pareto, Nash, Kalai, KS, and welfare calculations.
                                        Basic info (n_outcomes, issues) will still be calculated. Default: 1,000,000
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Max Outcomes for Info Calculation</label>
                                    <input type="number" class="form-input" 
                                           x-model.number="settings.maxOutcomesInfo"
                                           placeholder="10,000,000"
                                           min="0">
                                    <div class="form-hint">
                                        Scenarios exceeding this limit will skip all info calculations except n_outcomes.
                                        Default: 10,000,000
                                    </div>
                                </div>
                            </div>
                            
                            <div class="settings-section" style="margin-top: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                                <div class="text-muted" style="font-size: 12px;">
                                    <strong>Current defaults:</strong>
                                    <ul style="margin: 8px 0 0 16px; padding: 0;">
                                        <li>Run limit: No limit (all scenarios can run)</li>
                                        <li>Stats calculation: 1,000,000 outcomes</li>
                                        <li>Info calculation: 10,000,000 outcomes</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div x-show="settingsTab === 'sources'">
                            <h3 class="font-semibold mb-4">Negotiator Sources</h3>
                            <p class="text-secondary mb-4" style="font-size: 13px;">
                                Enable or disable negotiator sources. Disabled sources won't appear in the negotiator selection.
                            </p>
                            
                            <div class="source-toggle-list">
                                <template x-for="source in sourceSettingsList" :key="source.id">
                                    <div class="source-toggle-item">
                                        <div class="source-toggle-info">
                                            <div class="source-toggle-name" x-text="source.name"></div>
                                            <div class="source-toggle-desc" x-text="source.description"></div>
                                            <div class="source-toggle-status">
                                                <template x-if="source.available">
                                                    <span class="text-success" x-text="source.count + ' negotiators available'"></span>
                                                </template>
                                                <template x-if="!source.available">
                                                    <span class="text-muted" x-text="source.unavailable_reason || 'Not installed'"></span>
                                                </template>
                                            </div>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" 
                                                   :checked="!sourceSettings.disabled_sources.includes(source.id)" 
                                                   :disabled="!source.available"
                                                   @change="toggleSource(source.id)">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </template>
                            </div>
                            
                            <div class="mt-4">
                                <button class="btn btn-secondary" @click="refreshNegotiators()" :disabled="refreshingNegotiators">
                                    <template x-if="refreshingNegotiators">
                                        <span class="spinner" style="width: 14px; height: 14px;"></span>
                                    </template>
                                    <template x-if="!refreshingNegotiators">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <path d="M23 4v6h-6"></path>
                                            <path d="M1 20v-6h6"></path>
                                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                        </svg>
                                    </template>
                                    Refresh Sources
                                </button>
                                <span class="text-muted" style="margin-left: 12px; font-size: 12px;">Re-scan for available negotiators</span>
                            </div>
                            
                            <div class="mt-4" style="padding-top: 16px; border-top: 1px solid var(--border-color);">
                                <h4 class="font-semibold mb-2" style="font-size: 14px;">Parameter Cache</h4>
                                <p class="text-muted" style="font-size: 12px; margin-bottom: 12px;">
                                    Negotiator parameters are cached to improve performance. Clear the cache if parameters seem outdated.
                                </p>
                                <button class="btn btn-secondary" @click="clearParameterCache()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                    Clear Parameter Cache
                                </button>
                            </div>
                        </div>
                        
                        <div x-show="settingsTab === 'genius'">
                            <h3 class="font-semibold mb-4">Genius Bridge</h3>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span class="badge" :class="geniusBridge.running ? 'badge-success' : 'badge-neutral'" x-text="geniusBridge.running ? 'Running' : 'Stopped'"></span>
                                    <button class="btn btn-secondary" @click="toggleGeniusBridge()" x-text="geniusBridge.running ? 'Stop' : 'Start'"></button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" x-model="settings.autoStartGenius">
                                    <span>Auto-start when needed</span>
                                </label>
                            </div>
                        </div>
                        
                        <div x-show="settingsTab === 'paths'">
                            <h3 class="font-semibold mb-4">Custom Sources</h3>
                            
                            <!-- Scenario Sources Section -->
                            <div class="settings-section">
                                <h4 class="settings-section-title">Scenario Sources</h4>
                                <p class="text-muted mb-3" style="font-size: 12px;">
                                    Add custom scenario files or folders. Serialized scenarios (.pkl, .json, .yaml) or directories with domain/ufun files.
                                </p>
                                
                                <!-- List of current scenario paths -->
                                <div class="source-list" style="margin-bottom: 12px;">
                                    <template x-for="(path, idx) in (settings.scenarioPaths || '').split('\\n').filter(p => p.trim())" :key="idx">
                                        <div class="source-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 6px;">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="flex-shrink: 0;">
                                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                            </svg>
                                            <span style="flex: 1; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="path"></span>
                                            <button type="button" class="btn-icon-sm" @click="removeScenarioPath(idx)" title="Remove">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                                </svg>
                                            </button>
                                        </div>
                                    </template>
                                    <div x-show="!(settings.scenarioPaths || '').trim()" class="text-muted" style="font-size: 12px; padding: 8px;">
                                        No custom scenario sources added.
                                    </div>
                                </div>
                                
                                <!-- Add buttons -->
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <input type="file" 
                                           accept=".pkl,.pickle,.json,.yaml,.yml"
                                           @change="handleScenarioFileSelect($event)"
                                           x-ref="scenarioFileInput"
                                           style="display: none;">
                                    <button type="button" class="btn btn-secondary btn-sm" @click="$refs.scenarioFileInput.click()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                        </svg>
                                        Add Scenario File
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-sm" @click="openFolderBrowser('scenario')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                        </svg>
                                        Add Scenario Folder
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Negotiator/Mechanism Module Sources Section -->
                            <div class="settings-section" style="margin-top: 24px;">
                                <h4 class="settings-section-title">Custom Negotiator/Mechanism Modules</h4>
                                <p class="text-muted mb-3" style="font-size: 12px;">
                                    Add Python modules (.py files) containing custom negotiator or mechanism classes.
                                </p>
                                
                                <!-- List of current module paths -->
                                <div class="source-list" style="margin-bottom: 12px;">
                                    <template x-for="(path, idx) in (settings.negotiatorPaths || '').split('\\n').filter(p => p.trim())" :key="idx">
                                        <div class="source-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 6px;">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="flex-shrink: 0;">
                                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                <polyline points="14 2 14 8 20 8"></polyline>
                                            </svg>
                                            <span style="flex: 1; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="path"></span>
                                            <button type="button" class="btn-icon-sm" @click="removeNegotiatorPath(idx)" title="Remove">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                                </svg>
                                            </button>
                                        </div>
                                    </template>
                                    <div x-show="!(settings.negotiatorPaths || '').trim()" class="text-muted" style="font-size: 12px; padding: 8px;">
                                        No custom module sources added.
                                    </div>
                                </div>
                                
                                <!-- Add button -->
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <input type="file" 
                                           accept=".py"
                                           @change="handleModuleFileSelect($event)"
                                           x-ref="moduleFileInput"
                                           style="display: none;">
                                    <button type="button" class="btn btn-secondary btn-sm" @click="$refs.moduleFileInput.click()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                        </svg>
                                        Add Python Module
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Manual path entry (advanced) -->
                            <details style="margin-top: 24px;">
                                <summary class="text-muted" style="cursor: pointer; font-size: 13px;">
                                    Advanced: Manual path entry
                                </summary>
                                <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 6px; margin-top: 8px;">
                                    <div class="form-group">
                                        <label class="form-label">Scenario Paths (one per line)</label>
                                        <textarea class="form-textarea" placeholder="One path per line..." x-model="settings.scenarioPaths" rows="3" style="font-size: 12px;"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Module Paths (one per line)</label>
                                        <textarea class="form-textarea" placeholder="One path per line..." x-model="settings.negotiatorPaths" rows="3" style="font-size: 12px;"></textarea>
                                    </div>
                                </div>
                            </details>
                        </div>
                        
                        <div x-show="settingsTab === 'data'">
                            <h3 class="font-semibold mb-4">Export / Import Settings</h3>
                            <p class="text-secondary mb-4" style="font-size: 13px;">
                                Export your settings and presets to a ZIP file for backup or to migrate to another machine.
                            </p>
                            
                            <!-- Export Section -->
                            <div class="settings-section">
                                <h4 class="settings-section-title">Export</h4>
                                <p class="text-muted mb-3" style="font-size: 12px;">
                                    Download all your settings, presets, and layout configuration as a ZIP file.
                                </p>
                                <button class="btn btn-primary" @click="exportSettings()" :disabled="exportingSettings">
                                    <template x-if="exportingSettings">
                                        <span class="spinner" style="width: 14px; height: 14px;"></span>
                                    </template>
                                    <template x-if="!exportingSettings">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                            <polyline points="7 10 12 15 17 10"/>
                                            <line x1="12" y1="15" x2="12" y2="3"/>
                                        </svg>
                                    </template>
                                    Export Settings
                                </button>
                            </div>
                            
                            <!-- Import Section -->
                            <div class="settings-section" style="margin-top: 24px;">
                                <h4 class="settings-section-title">Import</h4>
                                <p class="text-muted mb-3" style="font-size: 12px;">
                                    Import settings from a previously exported ZIP file. This will overwrite your current settings.
                                </p>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <input type="file" 
                                           accept=".zip" 
                                           @change="handleSettingsImport($event)" 
                                           x-ref="settingsImportInput"
                                           style="display: none;">
                                    <button class="btn btn-secondary" @click="$refs.settingsImportInput.click()" :disabled="importingSettings">
                                        <template x-if="importingSettings">
                                            <span class="spinner" style="width: 14px; height: 14px;"></span>
                                        </template>
                                        <template x-if="!importingSettings">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                                <polyline points="17 8 12 3 7 8"/>
                                                <line x1="12" y1="3" x2="12" y2="15"/>
                                            </svg>
                                        </template>
                                        Import Settings
                                    </button>
                                    <span class="text-muted" style="font-size: 12px;" x-text="importStatus"></span>
                                </div>
                            </div>
                            
                            <!-- What's Included -->
                            <div class="settings-section" style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                                <h4 class="settings-section-title">What's Included</h4>
                                <ul style="font-size: 12px; color: var(--text-secondary); margin: 0; padding-left: 20px;">
                                    <li>General, negotiation, and path settings</li>
                                    <li>Genius bridge configuration</li>
                                    <li>Negotiator source preferences</li>
                                    <li>All saved presets (scenarios, negotiators, parameters, sessions)</li>
                                    <li>Layout and panel configuration</li>
                                    <li>Recent session history</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" @click="showSettings = false">Close</button>
                <button class="btn btn-primary" @click="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Save Session Preset Modal -->
    <div class="modal-overlay" :class="{ active: showSaveSessionModal }" @click.self="showSaveSessionModal = false">
        <div class="modal small">
            <div class="modal-header">
                <h2 class="modal-title">Save Session</h2>
                <button class="modal-close" @click="showSaveSessionModal = false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Preset Name</label>
                    <input type="text" class="form-input" placeholder="My Negotiation Setup" x-model="savePresetName" @keyup.enter="saveFullSession()">
                    <div class="form-hint">Give this configuration a memorable name</div>
                </div>
                <div class="form-group" x-show="newNeg.scenario">
                    <label class="form-label">Configuration Summary</label>
                    <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; font-size: 13px;">
                        <div><strong>Scenario:</strong> <span x-text="newNeg.scenario?.name"></span></div>
                        <div><strong>Negotiators:</strong> <span x-text="newNeg.negotiators.map(n => getNegotiatorDisplayName(n.type_name)).join(' vs ')"></span></div>
                        <div><strong>Mechanism:</strong> <span x-text="newNeg.mechanism_type"></span></div>
                        <div><strong>Steps:</strong> <span x-text="newNeg.mechanism_params?.n_steps || 'No limit'"></span></div>
                        <div x-show="newNeg.mechanism_params?.time_limit"><strong>Time Limit:</strong> <span x-text="newNeg.mechanism_params?.time_limit + 's'"></span></div>
                        <div><strong>Mode:</strong> <span x-text="newNeg.mode === 'realtime' ? 'Real-time' : 'Batch'"></span></div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" @click="showSaveSessionModal = false">Cancel</button>
                <button class="btn btn-primary" @click="saveFullSession()" :disabled="!savePresetName.trim()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save
                </button>
            </div>
        </div>
    </div>
    
    <script>
    function app() {
        return {
            // Connection status
            connected: true,
            
            // Sidebar state - collapsed by default unless user explicitly opened it
            sidebarCollapsed: localStorage.getItem('sidebarCollapsed') !== 'false',
            
            // Modal states
            showNewNegotiation: false,
            showSettings: false,
            showNegotiatorConfig: false,
            
            // Negotiator configuration modal state
            configNegotiatorIndex: null,  // Index of negotiator being configured
            configNegotiatorParams: [],   // Parameters from API
            configNegotiatorValues: {},   // Current values being edited
            configNegotiatorLoading: false,
            
            // Page state (negotiations, scenarios, tournaments)
            currentPage: 'negotiations',
            
            // Tournament state
            showNewTournament: false,
            tournamentSessions: [],
            savedTournaments: [],
            savedTournamentsLoading: false,
            selectedTournament: null,
            tournamentEventSource: null,
            // Tournament panel collapse state
            tournamentPanelCollapsed: {
                grid: false,
                scores: false,
                negotiations: true,  // Start collapsed
            },
            // Tournament grid visualization state
            tournamentGrid: {
                competitors: [],
                opponents: [],
                scenarios: [],
                cells: {},  // Key: `${competitorIdx}-${opponentIdx}-${scenarioIdx}-${rep}-${rotated}` -> { status, end_reason, utilities }
                currentTab: 'summary',  // 'summary' or scenario index
                n_repetitions: 1,
                rotate_ufuns: false,
            },
            tournamentLeaderboard: [],
            tournamentLiveNegotiations: [],  // Negotiations that complete during running tournament
            newTournament: {
                competitor_types: [],
                opponent_types: [],
                opponents_same_as_competitors: true,  // When true, opponents = null (competitors play each other)
                scenario_paths: [],
                n_repetitions: 1,
                rotate_ufuns: true,
                self_play: true,
                mechanism_type: 'SAOMechanism',
                n_steps: 100,
                n_steps_range_enabled: false,
                n_steps_min: 50,
                n_steps_max: 200,
                time_limit: null,
                time_limit_range_enabled: false,
                time_limit_min: 30,
                time_limit_max: 120,
                // Time limits for negotiators
                step_time_limit: null,
                negotiator_time_limit: null,
                hidden_time_limit: null,
                // Probabilistic ending
                pend: null,
                pend_per_second: null,
                // Scoring
                final_score_metric: 'advantage',
                final_score_stat: 'mean',
                // Run ordering
                randomize_runs: false,
                sort_runs: true,
                // Information hiding
                id_reveals_type: false,
                name_reveals_type: true,
                mask_scenario_names: false,
                // Self-play options
                only_failures_on_self_play: false,
                // Save options
                save_stats: true,
                save_scenario_figs: true,
                save_every: 1,
                // Scenario options
                normalize: true,  // Normalize utility functions (recommended for tournaments)
            },
            tournamentTab: 'scenarios',
            tournamentScenarioSearch: '',
            tournamentScenarioSourceFilter: '',
            tournamentScenarioFilters: {
                minOutcomes: null,
                maxOutcomes: null,
                minRationalFraction: null,
                maxRationalFraction: null,
                minOpposition: null,
                maxOpposition: null,
                showAdvanced: false,
            },
            tournamentCompetitorSearch: '',
            tournamentCompetitorSourceFilter: '',
            tournamentCompetitorTagFilter: '',  // Tag filter for tournament competitors
            tournamentOpponentSearch: '',
            tournamentOpponentSourceFilter: '',
            
            // Tournament presets
            tournamentPresets: [],
            selectedTournamentPreset: '',
            tournamentPresetName: '',
            
            // Virtual negotiators
            virtualNegotiators: [],
            virtualNegotiatorsLoading: false,
            
            // Competitor configuration modal state
            showCompetitorConfig: false,
            competitorConfigTypeName: null,  // Type being configured
            competitorConfigParams: [],       // Parameters from API
            competitorConfigValues: {},       // Current values being edited
            competitorConfigLoading: false,
            competitorConfigSaveAsVirtual: false,  // Whether to save as virtual negotiator
            competitorConfigVirtualName: '',       // Name for new virtual negotiator
            
            // Tabs
            negotiationTab: 'scenario',
            settingsTab: 'general',
            paramSubTab: 'deadline',
            negotiatorSubTab: 'preset',
            
            // Parameter group collapse states
            showAdvancedDeadline: false,
            showCommonParams: false,
            showSAOResponse: true,
            showSAOOffers: false,
            showSAOSemantics: false,
            showSAOAdvanced: false,
            showTAUBasic: true,
            showTAUAdvanced: false,
            showGBBasic: true,
            showGBOffers: false,
            
            // Data
            sources: [],
            scenarios: [],
            scenarioSearch: '',
            negotiatorTypes: [],
            negotiatorSources: [],
            negotiatorSearch: '',
            negotiatorSourceFilter: '',
            negotiatorGroupFilter: '',
            negotiatorTagFilter: '',  // Filter by tag
            allNegotiatorTags: [],    // All available tags from negotiators
            selectedNegotiatorSlot: 0,
            
            // Advanced scenario filters (shared between dialogs)
            scenarioFilters: {
                minOutcomes: null,
                maxOutcomes: null,
                minRationalFraction: null,
                maxRationalFraction: null,
                minOpposition: null,
                maxOpposition: null,
                showAdvanced: false,
            },
            explorerFilters: {
                minOutcomes: null,
                maxOutcomes: null,
                minRationalFraction: null,
                maxRationalFraction: null,
                minOpposition: null,
                maxOpposition: null,
                showAdvanced: false,
            },
            
            // Bulk stats calculation state
            bulkStatsProgress: null,  // { completed, total, current_path, errors }
            bulkStatsRunning: false,
            
            // Mechanism data (loaded from API)
            mechanisms: [],
            selectedMechanism: null,
            
            // Virtual mechanisms
            virtualMechanisms: [],
            virtualMechanismsLoading: false,
            
            // Save as Virtual Mechanism modal state
            showSaveVirtualMechanism: false,
            saveVirtualMechanismName: '',
            saveVirtualMechanismDescription: '',
            saveVirtualMechanismTags: '',
            
            // BOA (Build Custom) negotiator config
            boaComponents: {
                acceptance: [],
                offering: [],
                model: []
            },
            boaConfig: {
                acceptance_policy: '',
                offering_policy: '',
                opponent_model: ''
            },
            
            // MAP (Modular Agent Policy) negotiator config - more flexible than BOA
            mapConfig: {
                acceptance_policy: '',
                offering_policy: '',
                models: [],  // Multiple models (unlike BOA which has just one)
                extra_components: [],  // Additional arbitrary components
                acceptance_first: true  // Whether acceptance is evaluated before offering
            },
            
            // Scenario Explorer state
            explorerScenarios: [],
            explorerSearch: '',
            explorerSourceFilter: '',
            selectedScenario: null,
            explorerLoading: false,
            scenarioStats: null,  // Stats for the selected scenario
            scenarioStatsLoading: false,
            scenarioStatsError: null,
            
            // Running/completed negotiations
            runningNegotiations: [],
            completedNegotiations: [],
            currentNegotiation: null,
            
            // New negotiation form
            newNeg: {
                source: '',
                scenario: null,
                negotiators: [
                    { type_name: 'AspirationNegotiator', name: 'Agent1', params: {} },
                    { type_name: 'BoulwareTBNegotiator', name: 'Agent2', params: {} }
                ],
                // Scenario loading options
                ignore_discount: false,
                ignore_reserved: false,
                normalize: false,  // Normalize utility functions to [0, 1]
                // Mechanism type (class name)
                mechanism_type: 'SAOMechanism',
                // Dynamic mechanism params (populated from API)
                mechanism_params: {},
                // Information sharing
                share_ufuns: false,
                // Display params
                mode: 'realtime',
                step_delay: 100,
                show_plot: true,
                show_offers: true,
                auto_save: true,  // Default from settings.saveNegotiations
                // Panel settings
                panels: {
                    adjustable: true,
                    utilityView: { xAxis: 0, yAxis: 1 },
                    timeline: { xAxis: 'relative_time' }
                }
            },
            
            // Settings
            settings: {
                darkMode: localStorage.getItem('darkMode') === 'true',
                colorBlindMode: localStorage.getItem('colorBlindMode') === 'true',
                saveNegotiations: localStorage.getItem('saveNegotiations') !== 'false',  // Default true
                cacheScenarioStats: true,  // Default true - cache scenario stats for faster loading
                defaultSteps: 100,
                defaultDelay: 100,
                autoStartGenius: true,
                scenarioPaths: '',
                negotiatorPaths: '',
                // Performance settings
                maxOutcomesRun: null,  // No limit by default
                maxOutcomesStats: 1000000,  // 1M outcomes
                maxOutcomesInfo: 10000000,  // 10M outcomes
            },
            
            // Genius bridge
            geniusBridge: {
                installed: false,
                running: false,
                loading: false,
                port: 25337
            },
            
            // Negotiator source settings
            sourceSettings: {
                disabled_sources: [],
                custom_sources: []
            },
            sourceSettingsList: [],
            refreshingNegotiators: false,
            
            // Export/Import state
            exportingSettings: false,
            importingSettings: false,
            importStatus: '',
            
            // Preset management
            recentSessions: [],
            sessionPresets: [],
            showSaveSessionModal: false,
            savePresetName: '',
            
            // Shared scenario filter function
            applyScenarioFilters(scenarios, filters, source = null, search = '') {
                let results = scenarios;
                
                // Filter by source if selected
                if (source) {
                    results = results.filter(s => s.source === source);
                }
                
                // Filter by search term
                if (search) {
                    const searchLower = search.toLowerCase();
                    results = results.filter(s => 
                        s.name.toLowerCase().includes(searchLower) ||
                        s.source.toLowerCase().includes(searchLower)
                    );
                }
                
                // Filter by n_outcomes range
                if (filters.minOutcomes !== null && filters.minOutcomes !== '') {
                    const min = parseInt(filters.minOutcomes, 10);
                    if (!isNaN(min)) {
                        results = results.filter(s => s.n_outcomes !== null && s.n_outcomes >= min);
                    }
                }
                if (filters.maxOutcomes !== null && filters.maxOutcomes !== '') {
                    const max = parseInt(filters.maxOutcomes, 10);
                    if (!isNaN(max)) {
                        results = results.filter(s => s.n_outcomes !== null && s.n_outcomes <= max);
                    }
                }
                
                // Filter by rational_fraction range
                if (filters.minRationalFraction !== null && filters.minRationalFraction !== '') {
                    const min = parseFloat(filters.minRationalFraction);
                    if (!isNaN(min)) {
                        results = results.filter(s => s.rational_fraction !== null && s.rational_fraction >= min);
                    }
                }
                if (filters.maxRationalFraction !== null && filters.maxRationalFraction !== '') {
                    const max = parseFloat(filters.maxRationalFraction);
                    if (!isNaN(max)) {
                        results = results.filter(s => s.rational_fraction !== null && s.rational_fraction <= max);
                    }
                }
                
                // Filter by opposition range
                if (filters.minOpposition !== null && filters.minOpposition !== '') {
                    const min = parseFloat(filters.minOpposition);
                    if (!isNaN(min)) {
                        results = results.filter(s => s.opposition !== null && s.opposition >= min);
                    }
                }
                if (filters.maxOpposition !== null && filters.maxOpposition !== '') {
                    const max = parseFloat(filters.maxOpposition);
                    if (!isNaN(max)) {
                        results = results.filter(s => s.opposition !== null && s.opposition <= max);
                    }
                }
                
                return results;
            },
            
            // Computed
            get filteredScenarios() {
                return this.applyScenarioFilters(
                    this.scenarios,
                    this.scenarioFilters,
                    this.newNeg.source,
                    this.scenarioSearch
                );
            },
            
            get filteredNegotiators() {
                let results = this.negotiatorTypes;
                
                // Filter by source if selected
                if (this.negotiatorSourceFilter) {
                    results = results.filter(n => n.source === this.negotiatorSourceFilter);
                }
                
                // Filter by group if selected (for genius)
                if (this.negotiatorGroupFilter) {
                    results = results.filter(n => n.group === this.negotiatorGroupFilter);
                }
                
                // Filter by tag if selected
                if (this.negotiatorTagFilter) {
                    const tag = this.negotiatorTagFilter.toLowerCase();
                    results = results.filter(n => 
                        n.tags && n.tags.some(t => t.toLowerCase() === tag)
                    );
                }
                
                // Filter by search term
                if (this.negotiatorSearch) {
                    const search = this.negotiatorSearch.toLowerCase();
                    results = results.filter(n => 
                        n.name.toLowerCase().includes(search) ||
                        n.type_name.toLowerCase().includes(search) ||
                        (n.description && n.description.toLowerCase().includes(search))
                    );
                }
                
                return results;
            },
            
            get filteredExplorerScenarios() {
                return this.applyScenarioFilters(
                    this.explorerScenarios,
                    this.explorerFilters,
                    this.explorerSourceFilter,
                    this.explorerSearch
                );
            },
            
            get canProceed() {
                if (this.negotiationTab === 'scenario') {
                    return this.newNeg.scenario !== null;
                }
                if (this.negotiationTab === 'negotiators') {
                    return this.newNeg.negotiators.length >= (this.newNeg.scenario?.n_negotiators || 2);
                }
                return true;
            },
            
            get canStart() {
                if (this.newNeg.scenario === null) return false;
                if (this.newNeg.negotiators.length < (this.newNeg.scenario?.n_negotiators || 2)) return false;
                // Check deadline requirement - most mechanisms need some form of limit
                if (!this.hasDeadline()) return false;
                return true;
            },
            
            // Helper methods
            hasDeadline() {
                const params = this.newNeg.mechanism_params || {};
                return (params.n_steps && params.n_steps > 0) ||
                       (params.time_limit && params.time_limit > 0) ||
                       (params.pend && params.pend > 0) ||
                       (params.pend_per_second && params.pend_per_second > 0) ||
                       (params.hidden_time_limit && params.hidden_time_limit > 0 && params.hidden_time_limit !== 'inf');
            },
            
            getDeadlineSummary() {
                const params = this.newNeg.mechanism_params || {};
                const parts = [];
                if (params.n_steps && params.n_steps > 0) {
                    parts.push(params.n_steps + ' steps');
                }
                if (params.time_limit && params.time_limit > 0) {
                    parts.push(params.time_limit + 's time');
                }
                if (params.pend && params.pend > 0) {
                    parts.push('pend=' + params.pend);
                }
                if (params.pend_per_second && params.pend_per_second > 0) {
                    parts.push('pend/s=' + params.pend_per_second);
                }
                if (params.hidden_time_limit && params.hidden_time_limit > 0 && params.hidden_time_limit !== 'inf') {
                    parts.push('hidden=' + params.hidden_time_limit + 's');
                }
                return parts.length > 0 ? parts.join(', ') : 'None';
            },
            
            getMechanismDescription(type) {
                const descriptions = {
                    sao: 'Sequential offers with acceptance/rejection. Most common protocol.',
                    tau: 'Parallel offers in multiple threads. Can run without deadline.',
                    gb: 'General game-based mechanism with configurable evaluators.'
                };
                return descriptions[type] || '';
            },
            
            // Init
            async init() {
                // Watch sidebar state
                this.$watch('sidebarCollapsed', (val) => {
                    localStorage.setItem('sidebarCollapsed', val);
                });
                
                // Load settings from backend first
                await this.loadSettings();
                
                // Apply dark mode to body (html already has it from inline script)
                if (this.settings.darkMode) {
                    document.body.classList.add('dark-mode');
                }
                await this.loadSources();
                await this.loadNegotiatorSources();
                await this.loadNegotiatorTypes();
                await this.loadMechanisms();
                await this.loadVirtualNegotiators();
                await this.loadVirtualMechanisms();
                // Pre-load all scenarios so search is instant
                await this.loadAllScenarios();
                // Load tournament presets
                await this.loadTournamentPresets();
                this.initSortable();
                
                // Check Genius Bridge status
                await this.checkGeniusBridgeStatus();
                // Periodically check status (every 60 seconds)
                setInterval(() => this.checkGeniusBridgeStatus(), 60000);
            },
            
            initSortable() {
                this.$watch('showNewNegotiation', (show) => {
                    if (show) {
                        this.$nextTick(() => {
                            const list = this.$refs.negotiatorList;
                            if (list && !list._sortable) {
                                list._sortable = new Sortable(list, {
                                    handle: '.drag-handle',
                                    animation: 150,
                                    onEnd: (evt) => {
                                        const item = this.newNeg.negotiators.splice(evt.oldIndex, 1)[0];
                                        this.newNeg.negotiators.splice(evt.newIndex, 0, item);
                                    }
                                });
                            }
                        });
                    }
                });
            },
            
            // API calls
            async loadSources() {
                try {
                    const res = await fetch('/api/scenarios/sources');
                    const data = await res.json();
                    this.sources = data.sources;
                } catch (e) {
                    console.error('Failed to load sources:', e);
                }
            },
            
            async loadAllScenarios() {
                if (this.scenarios.length > 0) return; // Already loaded
                try {
                    const res = await fetch('/api/scenarios');
                    const data = await res.json();
                    this.scenarios = data.scenarios;
                } catch (e) {
                    console.error('Failed to load scenarios:', e);
                }
            },
            
            async searchScenarios() {
                // Load all scenarios on first search
                await this.loadAllScenarios();
            },
            
            async filterBySource() {
                // Load all scenarios when filtering
                await this.loadAllScenarios();
            },
            
            // Scenario Explorer methods
            async loadScenariosForExplorer() {
                if (this.explorerScenarios.length > 0) return; // Already loaded
                this.explorerLoading = true;
                try {
                    const res = await fetch('/api/scenarios');
                    const data = await res.json();
                    this.explorerScenarios = data.scenarios;
                } catch (e) {
                    console.error('Failed to load scenarios for explorer:', e);
                } finally {
                    this.explorerLoading = false;
                }
            },
            
            selectScenarioForExplorer(scenario) {
                this.selectedScenario = scenario;
                // Clear previous stats
                this.scenarioStats = null;
                this.scenarioStatsError = null;
                // Auto-load stats if they're cached (fast operation)
                if (scenario.has_stats) {
                    this.loadScenarioStats(scenario.path);
                }
            },
            
            async loadScenarioStats(path) {
                this.scenarioStatsLoading = true;
                this.scenarioStatsError = null;
                try {
                    const res = await fetch(`/api/scenarios/${encodeURIComponent(path)}/stats`);
                    if (!res.ok) throw new Error('Failed to load stats');
                    this.scenarioStats = await res.json();
                } catch (e) {
                    console.error('Failed to load scenario stats:', e);
                    this.scenarioStatsError = 'Failed to load stats';
                } finally {
                    this.scenarioStatsLoading = false;
                }
            },
            
            async calculateScenarioStats(path, force = false) {
                this.scenarioStatsLoading = true;
                this.scenarioStatsError = null;
                try {
                    const res = await fetch(`/api/scenarios/${encodeURIComponent(path)}/stats/calculate?force=${force}`, {
                        method: 'POST'
                    });
                    if (!res.ok) throw new Error('Failed to calculate stats');
                    this.scenarioStats = await res.json();
                    // Update has_stats flag on the selected scenario
                    if (this.selectedScenario) {
                        this.selectedScenario.has_stats = true;
                    }
                } catch (e) {
                    console.error('Failed to calculate scenario stats:', e);
                    this.scenarioStatsError = 'Failed to calculate stats';
                } finally {
                    this.scenarioStatsLoading = false;
                }
            },
            
            async bulkCalculateStats(force = false) {
                // Get all scenarios that need stats calculation
                let paths;
                if (force) {
                    // Recalculate all scenarios
                    paths = this.explorerScenarios.map(s => s.path);
                } else {
                    // Only scenarios without stats
                    paths = this.explorerScenarios.filter(s => !s.has_stats).map(s => s.path);
                }
                
                if (paths.length === 0) {
                    console.log('No scenarios need stats calculation');
                    return;
                }
                
                this.bulkStatsRunning = true;
                this.bulkStatsProgress = { completed: 0, total: paths.length, current_path: '', errors: [] };
                
                try {
                    const res = await fetch('/api/scenarios/bulk-calculate-stats', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paths, force })
                    });
                    
                    if (!res.ok) throw new Error('Failed to start bulk calculation');
                    
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        buffer += decoder.decode(value, { stream: true });
                        
                        // Parse SSE events from buffer
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || ''; // Keep incomplete line in buffer
                        
                        for (const line of lines) {
                            if (line.startsWith('data:')) {
                                try {
                                    const data = JSON.parse(line.slice(5).trim());
                                    
                                    if (data.type === 'progress') {
                                        this.bulkStatsProgress = {
                                            completed: data.completed,
                                            total: data.total,
                                            current_path: data.current_path,
                                            errors: this.bulkStatsProgress?.errors || []
                                        };
                                        
                                        // Update the scenario's has_stats flag
                                        if (data.has_stats) {
                                            const scenario = this.explorerScenarios.find(s => s.path === data.current_path);
                                            if (scenario) {
                                                scenario.has_stats = true;
                                                if (data.rational_fraction !== undefined) {
                                                    scenario.rational_fraction = data.rational_fraction;
                                                }
                                            }
                                        }
                                        
                                        // Track errors
                                        if (data.error) {
                                            this.bulkStatsProgress.errors.push({ path: data.current_path, error: data.error });
                                        }
                                    } else if (data.type === 'complete') {
                                        this.bulkStatsProgress = {
                                            completed: data.completed,
                                            total: data.total,
                                            current_path: '',
                                            errors: data.errors || []
                                        };
                                    }
                                } catch (e) {
                                    // Ignore parse errors for incomplete JSON
                                }
                            }
                        }
                    }
                    
                    // Refresh scenarios list to get updated stats
                    await this.loadExplorerScenarios();
                    
                } catch (e) {
                    console.error('Failed to bulk calculate stats:', e);
                } finally {
                    this.bulkStatsRunning = false;
                }
            },
            
            useScenarioInNegotiation(scenario) {
                this.currentPage = 'negotiations';
                this.openNewNegotiation();
                this.newNeg.scenario = scenario;
                this.newNeg.source = scenario.source;
                this.negotiationTab = 'negotiators';
            },
            
            filterExplorerScenarios() {
                // Reactivity handles filtering via computed property
            },
            
            async loadNegotiatorTypes() {
                try {
                    const res = await fetch('/api/negotiators');
                    const data = await res.json();
                    this.negotiatorTypes = data.negotiators;
                    
                    // Extract unique tags
                    const tagSet = new Set();
                    for (const neg of data.negotiators) {
                        if (neg.tags) {
                            for (const tag of neg.tags) {
                                tagSet.add(tag);
                            }
                        }
                    }
                    this.allNegotiatorTags = Array.from(tagSet).sort();
                } catch (e) {
                    console.error('Failed to load negotiator types:', e);
                }
            },
            
            async loadNegotiatorSources() {
                try {
                    const res = await fetch('/api/negotiators/sources');
                    const data = await res.json();
                    this.negotiatorSources = data.sources;
                } catch (e) {
                    console.error('Failed to load negotiator sources:', e);
                }
            },
            
            async loadMechanisms() {
                try {
                    const res = await fetch('/api/mechanisms');
                    const data = await res.json();
                    this.mechanisms = data.mechanisms;
                    // Select SAOMechanism by default
                    this.selectMechanism('SAOMechanism');
                } catch (e) {
                    console.error('Failed to load mechanisms:', e);
                }
            },
            
            selectMechanism(className) {
                // Check if it's a virtual mechanism
                if (this.isVirtualMechanism(className)) {
                    const vm = this.getVirtualMechanism(className);
                    if (vm) {
                        // Find the base mechanism info
                        const baseClassName = this.getBaseTypeFromVirtualMechanism(className);
                        this.selectedMechanism = this.mechanisms.find(m => m.class_name === baseClassName);
                        this.newNeg.mechanism_type = className;
                        // Initialize with virtual mechanism's saved params
                        this.initMechanismParams();
                        // Override with saved params from virtual mechanism
                        for (const [key, value] of Object.entries(vm.params || {})) {
                            this.newNeg.mechanism_params[key] = value;
                        }
                    }
                } else {
                    this.selectedMechanism = this.mechanisms.find(m => m.class_name === className);
                    if (this.selectedMechanism) {
                        this.newNeg.mechanism_type = className;
                        // Initialize mechanism params with defaults
                        this.initMechanismParams();
                    }
                }
            },
            
            initMechanismParams() {
                if (!this.selectedMechanism) return;
                
                // Reset mechanism_params to defaults
                this.newNeg.mechanism_params = {};
                
                for (const group of this.selectedMechanism.param_groups) {
                    for (const param of group.params) {
                        // Set default value
                        let defaultVal = param.default;
                        if (defaultVal === 'inf') defaultVal = null;
                        if (defaultVal === '-inf') defaultVal = null;
                        this.newNeg.mechanism_params[param.name] = defaultVal;
                    }
                }
            },
            
            getMechanismParamValue(paramName) {
                return this.newNeg.mechanism_params?.[paramName];
            },
            
            setMechanismParamValue(paramName, value) {
                if (!this.newNeg.mechanism_params) {
                    this.newNeg.mechanism_params = {};
                }
                this.newNeg.mechanism_params[paramName] = value;
            },
            
            async loadSourceSettings() {
                try {
                    // Load source settings from backend
                    const res = await fetch('/api/settings/negotiator_sources');
                    if (res.ok) {
                        const data = await res.json();
                        this.sourceSettings = data;
                    }
                    
                    // Build the list with availability info from negotiatorSources
                    this.sourceSettingsList = this.negotiatorSources.map(source => {
                        const count = this.negotiatorTypes.filter(n => n.source === source.id).length;
                        return {
                            ...source,
                            count: count,
                            available: source.available !== false,
                            unavailable_reason: source.unavailable_reason
                        };
                    });
                } catch (e) {
                    console.error('Failed to load source settings:', e);
                }
            },
            
            // Genius Bridge methods
            async checkGeniusBridgeStatus() {
                try {
                    const res = await fetch('/api/genius/status');
                    if (res.ok) {
                        const data = await res.json();
                        this.geniusBridge.installed = data.installed;
                        this.geniusBridge.running = data.running;
                        this.geniusBridge.port = data.port;
                    }
                } catch (e) {
                    console.error('Failed to check Genius Bridge status:', e);
                }
            },
            
            async startGeniusBridge() {
                if (this.geniusBridge.loading) return;
                this.geniusBridge.loading = true;
                try {
                    const res = await fetch('/api/genius/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ port: this.geniusBridge.port })
                    });
                    if (res.ok) {
                        const data = await res.json();
                        if (data.success) {
                            this.geniusBridge.running = true;
                            this.geniusBridge.port = data.port;
                        } else {
                            console.error('Failed to start Genius Bridge:', data.message);
                            alert('Failed to start Genius Bridge: ' + data.message);
                        }
                    }
                } catch (e) {
                    console.error('Failed to start Genius Bridge:', e);
                } finally {
                    this.geniusBridge.loading = false;
                }
            },
            
            async stopGeniusBridge() {
                if (this.geniusBridge.loading) return;
                this.geniusBridge.loading = true;
                try {
                    const res = await fetch('/api/genius/stop?port=' + this.geniusBridge.port, {
                        method: 'POST'
                    });
                    if (res.ok) {
                        const data = await res.json();
                        if (data.success) {
                            this.geniusBridge.running = false;
                        }
                    }
                } catch (e) {
                    console.error('Failed to stop Genius Bridge:', e);
                } finally {
                    this.geniusBridge.loading = false;
                }
            },
            
            async toggleGeniusBridge() {
                if (this.geniusBridge.running) {
                    await this.stopGeniusBridge();
                } else {
                    await this.startGeniusBridge();
                }
            },
            
            async ensureGeniusBridgeRunning() {
                if (!this.geniusBridge.running) {
                    await this.startGeniusBridge();
                }
                return this.geniusBridge.running;
            },
            
            toggleSource(sourceId) {
                const idx = this.sourceSettings.disabled_sources.indexOf(sourceId);
                if (idx >= 0) {
                    this.sourceSettings.disabled_sources.splice(idx, 1);
                } else {
                    this.sourceSettings.disabled_sources.push(sourceId);
                }
            },
            
            async refreshNegotiators() {
                this.refreshingNegotiators = true;
                try {
                    await fetch('/api/negotiators/refresh', { method: 'POST' });
                    await this.loadNegotiatorTypes();
                    await this.loadNegotiatorSources();
                    await this.loadSourceSettings();
                } catch (e) {
                    console.error('Failed to refresh negotiators:', e);
                } finally {
                    this.refreshingNegotiators = false;
                }
            },
            
            async clearParameterCache() {
                try {
                    const res = await fetch('/api/negotiators/cache/clear', { method: 'POST' });
                    const data = await res.json();
                    alert(data.message || 'Parameter cache cleared');
                } catch (e) {
                    console.error('Failed to clear parameter cache:', e);
                    alert('Failed to clear parameter cache');
                }
            },
            
            async searchNegotiators() {
                // Negotiators already loaded at init, just triggers reactivity
            },
            
            async filterNegotiators() {
                // Reset group filter if source changed
                if (this.negotiatorSourceFilter !== 'genius') {
                    this.negotiatorGroupFilter = '';
                }
            },
            
            // Modal actions
            openNewNegotiation() {
                this.showNewNegotiation = true;
                this.negotiationTab = 'scenario';
                this.paramSubTab = 'deadline';
                this.scenarioSearch = '';
                this.negotiatorSearch = '';
                this.negotiatorSourceFilter = '';
                this.negotiatorGroupFilter = '';
                this.negotiatorTagFilter = '';
                this.showAdvancedDeadline = false;
                this.showSAOResponse = true;
                this.showSAOOffers = false;
                this.showSAOSemantics = false;
                this.showInfoSharing = true;
                this.newNeg = {
                    source: '',
                    scenario: null,
                    negotiators: [
                        { type_name: 'negmas.sao.AspirationNegotiator', name: 'Aspiration1', source: 'native', params: {} },
                        { type_name: 'negmas.sao.BoulwareTBNegotiator', name: 'Boulware2', source: 'native', params: {} }
                    ],
                    mechanism_type: 'SAOMechanism',
                    mechanism_params: {},
                    share_ufuns: false,
                    mode: 'realtime',
                    step_delay: this.settings.defaultDelay,
                    show_plot: true,
                    show_offers: true,
                    auto_save: this.settings.saveNegotiations,
                    auto_start: true,
                    panels: {
                        adjustable: true,
                        utilityView: {
                            xAxis: 0,
                            yAxis: 1
                        },
                        timeline: {
                            xAxis: 'step'
                        }
                    }
                };
                // Initialize mechanism params with defaults
                this.selectMechanism('SAOMechanism');
            },
            
            selectScenario(scenario) {
                this.newNeg.scenario = scenario;
                // Adjust negotiator count if needed
                while (this.newNeg.negotiators.length < scenario.n_negotiators) {
                    this.addNegotiator();
                }
                while (this.newNeg.negotiators.length > scenario.n_negotiators) {
                    this.newNeg.negotiators.pop();
                }
            },
            
            nextNegotiationTab() {
                if (this.negotiationTab === 'scenario') this.negotiationTab = 'negotiators';
                else if (this.negotiationTab === 'negotiators') this.negotiationTab = 'parameters';
                else if (this.negotiationTab === 'parameters') this.negotiationTab = 'panels';
                else if (this.negotiationTab === 'panels') this.negotiationTab = 'display';
            },
            
            prevNegotiationTab() {
                if (this.negotiationTab === 'display') this.negotiationTab = 'panels';
                else if (this.negotiationTab === 'panels') this.negotiationTab = 'parameters';
                else if (this.negotiationTab === 'parameters') this.negotiationTab = 'negotiators';
                else if (this.negotiationTab === 'negotiators') this.negotiationTab = 'scenario';
            },
            
            // Negotiator management
            addNegotiator() {
                const idx = this.newNeg.negotiators.length;
                this.newNeg.negotiators.push({
                    type_name: 'negmas.sao.AspirationNegotiator',
                    name: `Aspiration${idx + 1}`,
                    source: 'native',
                    params: {}
                });
            },
            
            removeNegotiator(index) {
                if (this.newNeg.negotiators.length > 2) {
                    this.newNeg.negotiators.splice(index, 1);
                }
            },
            
            selectNegotiatorForSlot(negInfo) {
                // Use the currently selected slot
                const slotIndex = this.selectedNegotiatorSlot;
                const existingName = this.newNeg.negotiators[slotIndex]?.name;
                
                // Generate default name from type name + index if user hasn't set a custom name
                // Check if existing name is a generic "AgentN" or empty
                const isGenericName = !existingName || /^Agent\d+$/.test(existingName);
                const shortTypeName = negInfo.name || negInfo.type_name.split('.').pop();
                const defaultName = isGenericName ? `${shortTypeName}${slotIndex + 1}` : existingName;
                
                const newNeg = {
                    type_name: negInfo.type_name,
                    name: defaultName,
                    source: negInfo.source,
                    requires_bridge: negInfo.requires_bridge,
                    params: {}  // Initialize empty params
                };
                
                if (slotIndex < this.newNeg.negotiators.length) {
                    this.newNeg.negotiators[slotIndex] = newNeg;
                } else {
                    this.newNeg.negotiators.push(newNeg);
                }
                
                // Auto-start Genius Bridge if needed
                if (negInfo.requires_bridge && this.settings.autoStartGenius && !this.geniusBridge.running) {
                    this.startGeniusBridge();
                }
                
                // Auto-advance to next slot if there's room
                const requiredCount = this.newNeg.scenario?.n_negotiators || 2;
                if (slotIndex + 1 < requiredCount && slotIndex + 1 < this.newNeg.negotiators.length) {
                    this.selectedNegotiatorSlot = slotIndex + 1;
                }
            },
            
            async openNegotiatorConfig(index) {
                this.configNegotiatorIndex = index;
                this.configNegotiatorLoading = true;
                this.configNegotiatorParams = [];
                this.configNegotiatorValues = {};
                this.showNegotiatorConfig = true;
                
                const negotiator = this.newNeg.negotiators[index];
                if (!negotiator) return;
                
                try {
                    const res = await fetch(`/api/negotiators/${encodeURIComponent(negotiator.type_name)}/parameters`);
                    const data = await res.json();
                    
                    // Filter out 'name' parameter since we handle it separately
                    this.configNegotiatorParams = (data.parameters || []).filter(p => p.name !== 'name');
                    
                    // Initialize values from existing params or defaults
                    const existingParams = negotiator.params || {};
                    this.configNegotiatorValues = {};
                    
                    for (const param of this.configNegotiatorParams) {
                        if (param.name in existingParams) {
                            this.configNegotiatorValues[param.name] = existingParams[param.name];
                        }
                        // Otherwise leave undefined to use default
                    }
                } catch (e) {
                    console.error('Failed to load negotiator parameters:', e);
                } finally {
                    this.configNegotiatorLoading = false;
                }
            },
            
            applyNegotiatorConfig() {
                if (this.configNegotiatorIndex === null) return;
                
                // Build params object with only non-default values
                const params = {};
                for (const param of this.configNegotiatorParams) {
                    const value = this.configNegotiatorValues[param.name];
                    // Only include if value was explicitly set and differs from default
                    if (value !== undefined && value !== null && value !== param.default) {
                        params[param.name] = value;
                    }
                }
                
                // Update negotiator params
                this.newNeg.negotiators[this.configNegotiatorIndex].params = params;
                this.showNegotiatorConfig = false;
            },
            
            resetNegotiatorConfig() {
                // Reset all values to undefined (will use defaults)
                this.configNegotiatorValues = {};
            },
            
            getNegotiatorDisplayName(typeName) {
                // Handle BOA negotiators (type_name format: "BOA:AcceptPolicy/OfferPolicy" or "BOA:AcceptPolicy/OfferPolicy/Model")
                if (typeName && typeName.startsWith('BOA:')) {
                    const parts = typeName.substring(4).split('/');
                    if (parts.length >= 2) {
                        const acc = parts[0].replace(/Policy$|^G|^AC/, '');
                        const off = parts[1].replace(/Policy$|Offering$|^G/, '');
                        return `${acc}+${off}`;
                    }
                    return 'Custom BOA';
                }
                // Handle MAP negotiators (type_name format: "MAP:AcceptPolicy/OfferPolicy")
                if (typeName && typeName.startsWith('MAP:')) {
                    const parts = typeName.substring(4).split('/');
                    if (parts.length >= 2) {
                        const acc = parts[0].replace(/Policy$|^G|^AC/, '');
                        const off = parts[1].replace(/Policy$|Offering$|^G/, '');
                        return `MAP:${acc}+${off}`;
                    }
                    return 'Custom MAP';
                }
                const neg = this.negotiatorTypes.find(n => n.type_name === typeName);
                return neg?.name || typeName.split('.').pop();
            },
            
            getNegotiatorDescription(typeName) {
                const neg = this.negotiatorTypes.find(n => n.type_name === typeName);
                return neg?.description || '';
            },
            
            getSourceBadgeClass(source) {
                const classes = {
                    'native': 'badge-primary',
                    'genius': 'badge-warning',
                    'genius-reimplemented': 'badge-success',
                    'llm': 'badge-info',
                    'rl': 'badge-info',
                    'negolog': 'badge-secondary',
                    'boa': 'badge-info',
                    'map': 'badge-info'
                };
                return classes[source] || 'badge-neutral';
            },
            
            // BOA Component methods
            async loadBOAComponents() {
                if (this.boaComponents.acceptance.length > 0) return; // Already loaded
                try {
                    const res = await fetch('/api/negotiators/boa/components');
                    const data = await res.json();
                    this.boaComponents = data.components;
                } catch (e) {
                    console.error('Failed to load BOA components:', e);
                }
            },
            
            getBoaComponentDescription(type, name) {
                if (!name) return '';
                const components = this.boaComponents[type] || [];
                const c = components.find(c => c.name === name);
                return c?.description || '';
            },
            
            applyBOAToSlot() {
                if (!this.boaConfig.acceptance_policy || !this.boaConfig.offering_policy) return;
                
                const slotIndex = this.selectedNegotiatorSlot;
                const existingName = this.newNeg.negotiators[slotIndex]?.name;
                
                // Create a display name based on selected components
                const displayParts = [];
                displayParts.push(this.boaConfig.acceptance_policy.replace(/Policy$|^G/, ''));
                displayParts.push(this.boaConfig.offering_policy.replace(/Policy$|Offering$|^G/, ''));
                const displayName = displayParts.join('+');
                
                // Build type_name: BOA:Accept/Offer or BOA:Accept/Offer/Model
                let typeName = `BOA:${this.boaConfig.acceptance_policy}/${this.boaConfig.offering_policy}`;
                if (this.boaConfig.opponent_model) {
                    typeName += `/${this.boaConfig.opponent_model}`;
                }
                
                const boaNeg = {
                    type_name: typeName,
                    name: existingName || `Agent${slotIndex + 1}`,
                    source: 'boa',
                    is_boa: true,
                    params: {}  // Params can be added for component configuration
                };
                
                if (slotIndex < this.newNeg.negotiators.length) {
                    this.newNeg.negotiators[slotIndex] = boaNeg;
                } else {
                    this.newNeg.negotiators.push(boaNeg);
                }
                
                // Auto-advance to next slot if there's room
                const requiredCount = this.newNeg.scenario?.n_negotiators || 2;
                if (slotIndex + 1 < requiredCount && slotIndex + 1 < this.newNeg.negotiators.length) {
                    this.selectedNegotiatorSlot = slotIndex + 1;
                }
            },
            
            addMapModel() {
                const select = this.$refs.mapModelSelect;
                if (select && select.value && !this.mapConfig.models.includes(select.value)) {
                    this.mapConfig.models.push(select.value);
                    select.value = '';  // Reset selection
                }
            },
            
            applyMAPToSlot() {
                if (!this.mapConfig.acceptance_policy || !this.mapConfig.offering_policy) return;
                
                const slotIndex = this.selectedNegotiatorSlot;
                const existingName = this.newNeg.negotiators[slotIndex]?.name;
                
                // Build type_name: MAP:Accept/Offer
                const typeName = `MAP:${this.mapConfig.acceptance_policy}/${this.mapConfig.offering_policy}`;
                
                const mapNeg = {
                    type_name: typeName,
                    name: existingName || `Agent${slotIndex + 1}`,
                    source: 'map',
                    is_map: true,
                    params: {
                        models: [...this.mapConfig.models],
                        extra_components: [...this.mapConfig.extra_components],
                        acceptance_first: this.mapConfig.acceptance_first
                    }
                };
                
                if (slotIndex < this.newNeg.negotiators.length) {
                    this.newNeg.negotiators[slotIndex] = mapNeg;
                } else {
                    this.newNeg.negotiators.push(mapNeg);
                }
                
                // Auto-advance to next slot if there's room
                const requiredCount = this.newNeg.scenario?.n_negotiators || 2;
                if (slotIndex + 1 < requiredCount && slotIndex + 1 < this.newNeg.negotiators.length) {
                    this.selectedNegotiatorSlot = slotIndex + 1;
                }
            },
            
            // Start negotiation
            async startNegotiation() {
                if (!this.canStart) return;
                
                // Check outcome limit from performance settings
                const maxOutcomes = this.settings.maxOutcomesRun;
                if (maxOutcomes && maxOutcomes > 0 && this.newNeg.scenario?.n_outcomes) {
                    if (this.newNeg.scenario.n_outcomes > maxOutcomes) {
                        alert(`Cannot start negotiation: Scenario "${this.newNeg.scenario.name}" has ${this.newNeg.scenario.n_outcomes.toLocaleString()} outcomes, which exceeds the configured limit of ${maxOutcomes.toLocaleString()}.\n\nYou can change this limit in Settings > Performance.`);
                        return;
                    }
                }
                
                // Check if any negotiator requires the Genius Bridge
                const needsBridge = this.newNeg.negotiators.some(n => n.requires_bridge);
                if (needsBridge) {
                    // Refresh Genius Bridge status before checking
                    await this.checkGeniusBridgeStatus();
                    if (!this.geniusBridge.running) {
                        // Try to start the bridge
                        await this.startGeniusBridge();
                        if (!this.geniusBridge.running) {
                            alert('Cannot start negotiation: Genius Bridge is required but failed to start.');
                            return;
                        }
                    }
                }
                
                // Save to recent sessions
                await this.addToRecentSessions();
                
                // Build request with mechanism params
                const params = this.newNeg.mechanism_params || {};
                
                try {
                    const res = await fetch('/api/negotiation/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            scenario_path: this.newNeg.scenario.path,
                            negotiators: this.newNeg.negotiators,
                            mechanism_type: this.newNeg.mechanism_type,
                            mechanism_params: params,
                            step_delay: this.newNeg.step_delay / 1000,
                            share_ufuns: this.newNeg.share_ufuns,
                            ignore_discount: this.newNeg.ignore_discount,
                            ignore_reserved: this.newNeg.ignore_reserved,
                            normalize: this.newNeg.normalize,
                            auto_save: this.newNeg.auto_save
                        })
                    });
                    
                    const data = await res.json();
                    
                    // Add to running negotiations with panel settings
                    this.runningNegotiations.push({
                        id: data.session_id,
                        scenario: this.newNeg.scenario.name,
                        step: 0,
                        mechanism_type: this.newNeg.mechanism_type,
                        stream_url: data.stream_url,
                        // Store display settings with the negotiation
                        panelSettings: {
                            adjustable: this.newNeg.panels.adjustable,
                            utilityView: { ...this.newNeg.panels.utilityView },
                            timeline: { ...this.newNeg.panels.timeline }
                        },
                        mode: this.newNeg.mode,
                        show_plot: this.newNeg.show_plot,
                        show_offers: this.newNeg.show_offers
                    });
                    
                    this.showNewNegotiation = false;
                    
                    // Switch to negotiations page to see the running negotiation
                    this.currentPage = 'negotiations';
                    
                    // Start streaming (this will also auto-select the negotiation in index.html)
                    this.connectToStream(data.session_id, data.stream_url);
                    
                } catch (e) {
                    console.error('Failed to start negotiation:', e);
                }
            },
            
            connectToStream(sessionId, url) {
                const eventSource = new EventSource(url);
                
                eventSource.addEventListener('offer', (event) => {
                    const offer = JSON.parse(event.data);
                    const neg = this.runningNegotiations.find(n => n.id === sessionId);
                    if (neg) {
                        neg.step = offer.step;
                        neg.lastOffer = offer;
                    }
                });
                
                eventSource.addEventListener('complete', (event) => {
                    const result = JSON.parse(event.data);
                    const idx = this.runningNegotiations.findIndex(n => n.id === sessionId);
                    if (idx >= 0) {
                        const neg = this.runningNegotiations.splice(idx, 1)[0];
                        neg.agreement = result.agreement;
                        neg.final_utilities = result.final_utilities;
                        // Always set end_reason for completed negotiations
                        neg.end_reason = result.end_reason || (result.error ? 'error' : (result.agreement ? 'agreement' : 'completed'));
                        neg.error = result.error;
                        this.completedNegotiations.unshift(neg);
                    }
                    eventSource.close();
                });
                
                eventSource.addEventListener('error', () => {
                    eventSource.close();
                });
            },
            
            selectNegotiation(neg) {
                // If neg is from Tabulator (plain object copy), find the actual object by ID
                // to preserve the offers array and other properties
                if (neg && neg.id) {
                    const actualNeg = this.runningNegotiations.find(n => n.id === neg.id) 
                        || this.completedNegotiations.find(n => n.id === neg.id)
                        || neg;
                    this.currentNegotiation = actualNeg;
                } else {
                    this.currentNegotiation = neg;
                }
            },
            
            // Tournament methods
            async loadTournamentSessions() {
                try {
                    const res = await fetch('/api/tournament/sessions/list');
                    const data = await res.json();
                    this.tournamentSessions = data.sessions || [];
                } catch (e) {
                    console.error('Failed to load tournament sessions:', e);
                }
            },
            
            selectTournament(session) {
                this.selectedTournament = session;
                // If running, connect to stream
                if (session.status === 'running') {
                    this.connectToTournamentStream(session.id);
                }
            },
            
            async startTournament() {
                if (this.newTournament.competitor_types.length < 1) {
                    alert('Please select at least 1 competitor');
                    return;
                }
                if (this.newTournament.scenario_paths.length < 1) {
                    alert('Please select at least 1 scenario');
                    return;
                }
                
                // Validate opponents configuration
                if (this.newTournament.opponents_same_as_competitors) {
                    if (this.newTournament.competitor_types.length < 2) {
                        alert('When opponents are same as competitors, you need at least 2 competitors');
                        return;
                    }
                } else {
                    if (this.newTournament.opponent_types.length < 1) {
                        alert('Please select at least 1 opponent or check "Same as competitors"');
                        return;
                    }
                }
                
                // Check outcome limit from performance settings and filter out over-limit scenarios
                const maxOutcomes = this.settings.maxOutcomesRun;
                if (maxOutcomes && maxOutcomes > 0) {
                    const overLimitScenarios = [];
                    const validScenarios = [];
                    
                    for (const path of this.newTournament.scenario_paths) {
                        const scenario = this.scenarios.find(s => s.path === path);
                        if (scenario && scenario.n_outcomes && scenario.n_outcomes > maxOutcomes) {
                            overLimitScenarios.push({
                                name: scenario.name,
                                n_outcomes: scenario.n_outcomes
                            });
                        } else {
                            validScenarios.push(path);
                        }
                    }
                    
                    if (overLimitScenarios.length > 0) {
                        const scenarioList = overLimitScenarios
                            .map(s => `  - ${s.name} (${s.n_outcomes.toLocaleString()} outcomes)`)
                            .join('\n');
                        
                        if (validScenarios.length === 0) {
                            alert(`Cannot start tournament: All selected scenarios exceed the outcome limit of ${maxOutcomes.toLocaleString()}.\n\nScenarios removed:\n${scenarioList}\n\nYou can change this limit in Settings > Performance.`);
                            return;
                        }
                        
                        const proceed = confirm(`Warning: ${overLimitScenarios.length} scenario(s) exceed the outcome limit of ${maxOutcomes.toLocaleString()} and will be removed from the tournament:\n\n${scenarioList}\n\nRemaining scenarios: ${validScenarios.length}\n\nDo you want to continue with the remaining scenarios?`);
                        
                        if (!proceed) {
                            return;
                        }
                        
                        // Update the scenario paths to only include valid ones
                        this.newTournament.scenario_paths = validScenarios;
                    }
                }
                
                try {
                    // Prepare config, converting range fields to arrays if enabled
                    const config = { ...this.newTournament };
                    
                    // Handle opponent_types: null means same as competitors
                    if (config.opponents_same_as_competitors) {
                        config.opponent_types = null;
                    }
                    delete config.opponents_same_as_competitors;
                    
                    // Convert n_steps to range array if enabled
                    if (config.n_steps_range_enabled && config.n_steps_min && config.n_steps_max) {
                        config.n_steps = [config.n_steps_min, config.n_steps_max];
                    }
                    delete config.n_steps_range_enabled;
                    delete config.n_steps_min;
                    delete config.n_steps_max;
                    
                    // Convert time_limit to range array if enabled
                    if (config.time_limit_range_enabled && config.time_limit_min && config.time_limit_max) {
                        config.time_limit = [config.time_limit_min, config.time_limit_max];
                    }
                    delete config.time_limit_range_enabled;
                    delete config.time_limit_min;
                    delete config.time_limit_max;
                    
                    const res = await fetch('/api/tournament/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });
                    
                    const data = await res.json();
                    this.showNewTournament = false;
                    
                    // Add to sessions list
                    const newSession = {
                        id: data.session_id,
                        status: 'running',
                        config: { ...this.newTournament },
                        progress: { completed: 0, total: 0, percent: 0 }
                    };
                    this.tournamentSessions.unshift(newSession);
                    this.selectedTournament = newSession;
                    
                    // Connect to stream
                    this.connectToTournamentStream(data.session_id);
                    
                    // Reset form
                    this.resetTournamentForm();
                } catch (e) {
                    console.error('Failed to start tournament:', e);
                    alert('Failed to start tournament: ' + e.message);
                }
            },
            
            connectToTournamentStream(sessionId) {
                // Close existing connection
                if (this.tournamentEventSource) {
                    this.tournamentEventSource.close();
                }
                
                // Reset grid state
                this.tournamentGrid = {
                    competitors: [],
                    opponents: [],
                    scenarios: [],
                    cells: {},
                    currentScenarioIdx: 0,
                    n_repetitions: 1,
                    rotate_ufuns: false,
                };
                this.tournamentLeaderboard = [];
                this.tournamentLiveNegotiations = [];  // Reset live negotiations list
                
                this.tournamentEventSource = new EventSource(`/api/tournament/${sessionId}/stream`);
                
                // Handle grid initialization
                this.tournamentEventSource.addEventListener('grid_init', (event) => {
                    const data = JSON.parse(event.data);
                    this.tournamentGrid.competitors = data.competitors;
                    this.tournamentGrid.opponents = data.opponents;
                    this.tournamentGrid.scenarios = data.scenarios;
                    this.tournamentGrid.n_repetitions = data.n_repetitions;
                    this.tournamentGrid.rotate_ufuns = data.rotate_ufuns;
                    this.tournamentGrid.cells = {};
                    // Initialize all cells as pending
                    for (let i = 0; i < data.competitors.length; i++) {
                        for (let j = 0; j < data.opponents.length; j++) {
                            for (let s = 0; s < data.scenarios.length; s++) {
                                for (let r = 0; r < data.n_repetitions; r++) {
                                    const key = `${i}-${j}-${s}-${r}-false`;
                                    this.tournamentGrid.cells[key] = { status: 'pending' };
                                    if (data.rotate_ufuns) {
                                        const keyRot = `${i}-${j}-${s}-${r}-true`;
                                        this.tournamentGrid.cells[keyRot] = { status: 'pending' };
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Handle cell start (running)
                this.tournamentEventSource.addEventListener('cell_start', (event) => {
                    const data = JSON.parse(event.data);
                    const key = `${data.competitor_idx}-${data.opponent_idx}-${data.scenario_idx}-${data.repetition}-${data.rotated}`;
                    this.tournamentGrid.cells[key] = { status: 'running' };
                });
                
                // Handle cell complete
                this.tournamentEventSource.addEventListener('cell_complete', (event) => {
                    const data = JSON.parse(event.data);
                    const key = `${data.competitor_idx}-${data.opponent_idx}-${data.scenario_idx}-${data.repetition}-${data.rotated}`;
                    this.tournamentGrid.cells[key] = {
                        status: 'complete',
                        end_reason: data.end_reason,
                        utilities: data.utilities,
                        error: data.error,
                    };
                    
                    // Add to live negotiations list
                    const competitor = this.tournamentGrid.competitors[data.competitor_idx];
                    const opponent = this.tournamentGrid.opponents[data.opponent_idx];
                    const scenario = this.tournamentGrid.scenarios[data.scenario_idx];
                    const partners = data.rotated ? [opponent, competitor] : [competitor, opponent];
                    const hasAgreement = data.end_reason === 'agreement';
                    const hasError = data.end_reason === 'error' || data.end_reason === 'broken';
                    
                    this.tournamentLiveNegotiations.push({
                        index: this.tournamentLiveNegotiations.length,
                        scenario: scenario,
                        scenario_path: data.scenario_path,
                        partners: partners,
                        has_agreement: hasAgreement,
                        has_error: hasError,
                        utilities: data.utilities,
                        end_reason: data.end_reason,
                        error_details: data.error,
                        repetition: data.repetition,
                        rotated: data.rotated,
                        competitor_idx: data.competitor_idx,
                        opponent_idx: data.opponent_idx,
                        scenario_idx: data.scenario_idx,
                        // Detailed negotiation data for viewing
                        issue_names: data.issue_names,
                        n_steps: data.n_steps,
                        agreement: data.agreement,
                        offers: data.offers || [],
                    });
                });
                
                // Handle leaderboard update
                this.tournamentEventSource.addEventListener('leaderboard', (event) => {
                    const data = JSON.parse(event.data);
                    this.tournamentLeaderboard = data;
                });
                
                this.tournamentEventSource.addEventListener('progress', (event) => {
                    const progress = JSON.parse(event.data);
                    const session = this.tournamentSessions.find(s => s.id === sessionId);
                    if (session) {
                        session.progress = progress;
                        session.status = 'running';
                    }
                    if (this.selectedTournament?.id === sessionId) {
                        this.selectedTournament.progress = progress;
                        this.selectedTournament.status = 'running';
                    }
                });
                
                this.tournamentEventSource.addEventListener('complete', (event) => {
                    const result = JSON.parse(event.data);
                    const session = this.tournamentSessions.find(s => s.id === sessionId);
                    if (session) {
                        session.status = result.status;
                        session.results = result.results;
                        session.error = result.error;
                    }
                    if (this.selectedTournament?.id === sessionId) {
                        this.selectedTournament.status = result.status;
                        this.selectedTournament.results = result.results;
                        this.selectedTournament.error = result.error;
                    }
                    this.tournamentEventSource.close();
                    this.tournamentEventSource = null;
                });
                
                this.tournamentEventSource.addEventListener('error', () => {
                    this.tournamentEventSource.close();
                    this.tournamentEventSource = null;
                });
            },
            
            async cancelTournament(sessionId) {
                try {
                    await fetch(`/api/tournament/${sessionId}/cancel`, { method: 'POST' });
                    const session = this.tournamentSessions.find(s => s.id === sessionId);
                    if (session) {
                        session.status = 'cancelled';
                    }
                    if (this.selectedTournament?.id === sessionId) {
                        this.selectedTournament.status = 'cancelled';
                    }
                } catch (e) {
                    console.error('Failed to cancel tournament:', e);
                }
            },
            
            // Tournament grid helper methods
            getCellKey(i, j, s, r, rotated) {
                return `${i}-${j}-${s}-${r || 0}-${rotated || false}`;
            },
            
            // Get status for a specific scenario's cell
            getScenarioCellStatus(i, j) {
                const s = this.tournamentGrid.currentTab;
                if (s === 'summary') return 'pending';
                
                let hasRunning = false;
                let hasComplete = false;
                let allPending = true;
                let lastEndReason = null;
                
                for (let r = 0; r < this.tournamentGrid.n_repetitions; r++) {
                    const key = this.getCellKey(i, j, s, r, false);
                    const cell = this.tournamentGrid.cells[key];
                    if (cell) {
                        if (cell.status === 'running') hasRunning = true;
                        if (cell.status === 'complete') {
                            hasComplete = true;
                            lastEndReason = cell.end_reason;
                        }
                        if (cell.status !== 'pending') allPending = false;
                    }
                    
                    if (this.tournamentGrid.rotate_ufuns) {
                        const keyRot = this.getCellKey(i, j, s, r, true);
                        const cellRot = this.tournamentGrid.cells[keyRot];
                        if (cellRot) {
                            if (cellRot.status === 'running') hasRunning = true;
                            if (cellRot.status === 'complete') {
                                hasComplete = true;
                                lastEndReason = cellRot.end_reason;
                            }
                            if (cellRot.status !== 'pending') allPending = false;
                        }
                    }
                }
                
                if (hasRunning) return 'running';
                if (hasComplete) return lastEndReason || 'complete';
                if (allPending) return 'pending';
                return 'pending';
            },
            
            getScenarioCellClass(i, j) {
                const status = this.getScenarioCellStatus(i, j);
                if (i === j && !this.newTournament.self_play) {
                    return 'self-play';
                }
                return status;
            },
            
            // Summary cell: aggregate across ALL scenarios
            getSummaryCellStats(i, j) {
                const nScenarios = this.tournamentGrid.scenarios.length;
                const nReps = this.tournamentGrid.n_repetitions;
                const rotateMultiplier = this.tournamentGrid.rotate_ufuns ? 2 : 1;
                const totalPossible = nScenarios * nReps * rotateMultiplier;
                
                let completed = 0;
                let hasError = false;
                let running = false;
                
                for (let s = 0; s < nScenarios; s++) {
                    for (let r = 0; r < nReps; r++) {
                        const key = this.getCellKey(i, j, s, r, false);
                        const cell = this.tournamentGrid.cells[key];
                        if (cell) {
                            if (cell.status === 'complete') {
                                completed++;
                                if (cell.end_reason === 'error' || cell.end_reason === 'broken') {
                                    hasError = true;
                                }
                            }
                            if (cell.status === 'running') running = true;
                        }
                        
                        if (this.tournamentGrid.rotate_ufuns) {
                            const keyRot = this.getCellKey(i, j, s, r, true);
                            const cellRot = this.tournamentGrid.cells[keyRot];
                            if (cellRot) {
                                if (cellRot.status === 'complete') {
                                    completed++;
                                    if (cellRot.end_reason === 'error' || cellRot.end_reason === 'broken') {
                                        hasError = true;
                                    }
                                }
                                if (cellRot.status === 'running') running = true;
                            }
                        }
                    }
                }
                
                return { completed, totalPossible, hasError, running };
            },
            
            getSummaryCellStyle(i, j) {
                if (i === j && !this.newTournament.self_play) {
                    return 'background: var(--bg-tertiary);';
                }
                
                const { completed, totalPossible, hasError, running } = this.getSummaryCellStats(i, j);
                const ratio = totalPossible > 0 ? completed / totalPossible : 0;
                
                if (running) {
                    // Currently running - show with a pulsing border
                    const baseColor = hasError ? 'rgba(220, 53, 69, ' : 'rgba(40, 167, 69, ';
                    const alpha = Math.max(0.1, ratio * 0.8);
                    return `background: ${baseColor}${alpha}); box-shadow: inset 0 0 0 2px var(--primary);`;
                }
                
                if (completed === 0) {
                    return 'background: var(--bg-secondary);';
                }
                
                // Color based on completion ratio: white -> green (or red if errors)
                const baseColor = hasError ? 'rgba(220, 53, 69, ' : 'rgba(40, 167, 69, ';
                const alpha = Math.max(0.15, ratio * 0.85);
                return `background: ${baseColor}${alpha});`;
            },
            
            getSummaryCellPercent(i, j) {
                if (i === j && !this.newTournament.self_play) {
                    return '-';
                }
                
                const { completed, totalPossible } = this.getSummaryCellStats(i, j);
                if (totalPossible === 0) return '0%';
                const percent = Math.round((completed / totalPossible) * 100);
                return percent + '%';
            },
            
            // Legacy methods for backward compatibility
            getCellStatus(i, j) {
                return this.getScenarioCellStatus(i, j);
            },
            
            getCellClass(i, j) {
                return this.getScenarioCellClass(i, j);
            },
            
            switchTournamentScenario(idx) {
                this.tournamentGrid.currentTab = idx;
            },
            
            toggleTournamentScenario(scenarioPath) {
                const idx = this.newTournament.scenario_paths.indexOf(scenarioPath);
                if (idx >= 0) {
                    this.newTournament.scenario_paths.splice(idx, 1);
                } else {
                    this.newTournament.scenario_paths.push(scenarioPath);
                }
            },
            
            toggleTournamentCompetitor(typeName) {
                const idx = this.newTournament.competitor_types.indexOf(typeName);
                if (idx >= 0) {
                    this.newTournament.competitor_types.splice(idx, 1);
                } else {
                    this.newTournament.competitor_types.push(typeName);
                }
            },
            
            // New dual-list helper methods for scenarios
            addTournamentScenario(scenarioPath) {
                if (!this.newTournament.scenario_paths.includes(scenarioPath)) {
                    this.newTournament.scenario_paths.push(scenarioPath);
                }
            },
            
            removeTournamentScenario(scenarioPath) {
                const idx = this.newTournament.scenario_paths.indexOf(scenarioPath);
                if (idx >= 0) {
                    this.newTournament.scenario_paths.splice(idx, 1);
                }
            },
            
            addAllFilteredTournamentScenarios() {
                const filtered = this.filteredTournamentScenarios;
                for (const s of filtered) {
                    if (!this.newTournament.scenario_paths.includes(s.path)) {
                        this.newTournament.scenario_paths.push(s.path);
                    }
                }
            },
            
            // New dual-list helper methods for competitors
            addTournamentCompetitor(typeName) {
                if (!this.newTournament.competitor_types.includes(typeName)) {
                    this.newTournament.competitor_types.push(typeName);
                }
            },
            
            removeTournamentCompetitor(typeName) {
                const idx = this.newTournament.competitor_types.indexOf(typeName);
                if (idx >= 0) {
                    this.newTournament.competitor_types.splice(idx, 1);
                }
            },
            
            // Dual-list helper methods for opponents
            addTournamentOpponent(typeName) {
                if (!this.newTournament.opponent_types.includes(typeName)) {
                    this.newTournament.opponent_types.push(typeName);
                }
            },
            
            removeTournamentOpponent(typeName) {
                const idx = this.newTournament.opponent_types.indexOf(typeName);
                if (idx >= 0) {
                    this.newTournament.opponent_types.splice(idx, 1);
                }
            },
            
            isTournamentOpponentSelected(typeName) {
                return this.newTournament.opponent_types.includes(typeName);
            },
            
            addAllFilteredTournamentOpponents() {
                const available = this.filteredTournamentOpponents.filter(
                    n => !this.isTournamentOpponentSelected(n.type_name)
                );
                for (const neg of available) {
                    this.newTournament.opponent_types.push(neg.type_name);
                }
            },
            
            // Tournament wizard navigation
            tournamentWizardNext() {
                const tabs = ['scenarios', 'competitors', 'opponents', 'settings', 'review'];
                const currentIdx = tabs.indexOf(this.tournamentTab);
                if (currentIdx < tabs.length - 1) {
                    this.tournamentTab = tabs[currentIdx + 1];
                }
            },
            
            tournamentWizardBack() {
                const tabs = ['scenarios', 'competitors', 'opponents', 'settings', 'review'];
                const currentIdx = tabs.indexOf(this.tournamentTab);
                if (currentIdx > 0) {
                    this.tournamentTab = tabs[currentIdx - 1];
                }
            },
            
            canStartTournament() {
                const hasScenarios = this.newTournament.scenario_paths.length >= 1;
                const hasCompetitors = this.newTournament.competitor_types.length >= 1;
                // If opponents same as competitors, need at least 2 competitors
                // If separate opponents, need at least 1 opponent
                const hasValidOpponents = this.newTournament.opponents_same_as_competitors
                    ? this.newTournament.competitor_types.length >= 2
                    : this.newTournament.opponent_types.length >= 1;
                return hasScenarios && hasCompetitors && hasValidOpponents;
            },
            
            estimateTournamentPairings() {
                const nCompetitors = this.newTournament.competitor_types.length;
                
                if (this.newTournament.opponents_same_as_competitors) {
                    // Standard mode: competitors play each other
                    if (nCompetitors < 2) return 0;
                    if (this.newTournament.self_play) {
                        return nCompetitors * nCompetitors;  // All combinations including self
                    } else {
                        return nCompetitors * (nCompetitors - 1);
                    }
                } else {
                    // Separate opponents mode: competitors play against opponents
                    const nOpponents = this.newTournament.opponent_types.length;
                    if (nCompetitors < 1 || nOpponents < 1) return 0;
                    return nCompetitors * nOpponents;
                }
            },
            
            estimateTournamentNegotiations() {
                const scenarios = this.newTournament.scenario_paths.length;
                const pairings = this.estimateTournamentPairings();
                const reps = this.newTournament.n_repetitions || 1;
                const rotateMultiplier = this.newTournament.rotate_ufuns ? 2 : 1;
                return scenarios * pairings * reps * rotateMultiplier;
            },
            
            // Tournament preset methods
            async loadTournamentPresets() {
                try {
                    const res = await fetch('/api/settings/presets/tournaments');
                    const data = await res.json();
                    this.tournamentPresets = data.presets || [];
                } catch (err) {
                    console.error('Error loading tournament presets:', err);
                    this.tournamentPresets = [];
                }
            },
            
            async saveTournamentPreset() {
                if (!this.tournamentPresetName.trim()) return;
                
                try {
                    const preset = {
                        name: this.tournamentPresetName.trim(),
                        scenario_paths: this.newTournament.scenario_paths,
                        competitor_types: this.newTournament.competitor_types,
                        opponent_types: this.newTournament.opponents_same_as_competitors ? null : this.newTournament.opponent_types,
                        opponents_same_as_competitors: this.newTournament.opponents_same_as_competitors,
                        n_repetitions: this.newTournament.n_repetitions,
                        rotate_ufuns: this.newTournament.rotate_ufuns,
                        self_play: this.newTournament.self_play,
                        mechanism_type: this.newTournament.mechanism_type,
                        n_steps: this.newTournament.n_steps_range_enabled ? null : this.newTournament.n_steps,
                        n_steps_min: this.newTournament.n_steps_range_enabled ? this.newTournament.n_steps_min : null,
                        n_steps_max: this.newTournament.n_steps_range_enabled ? this.newTournament.n_steps_max : null,
                        time_limit: this.newTournament.time_limit_range_enabled ? null : this.newTournament.time_limit,
                        time_limit_min: this.newTournament.time_limit_range_enabled ? this.newTournament.time_limit_min : null,
                        time_limit_max: this.newTournament.time_limit_range_enabled ? this.newTournament.time_limit_max : null,
                        step_time_limit: this.newTournament.step_time_limit,
                        negotiator_time_limit: this.newTournament.negotiator_time_limit,
                        hidden_time_limit: this.newTournament.hidden_time_limit,
                        pend: this.newTournament.pend,
                        pend_per_second: this.newTournament.pend_per_second,
                        final_score_metric: this.newTournament.final_score_metric,
                        final_score_stat: this.newTournament.final_score_stat,
                        randomize_runs: this.newTournament.randomize_runs,
                        sort_runs: this.newTournament.sort_runs,
                        id_reveals_type: this.newTournament.id_reveals_type,
                        name_reveals_type: this.newTournament.name_reveals_type,
                        mask_scenario_names: this.newTournament.mask_scenario_names,
                        only_failures_on_self_play: this.newTournament.only_failures_on_self_play,
                        save_stats: this.newTournament.save_stats,
                        save_scenario_figs: this.newTournament.save_scenario_figs,
                        save_every: this.newTournament.save_every,
                        normalize: this.newTournament.normalize,
                    };
                    
                    await fetch('/api/settings/presets/tournaments', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(preset)
                    });
                    
                    await this.loadTournamentPresets();
                    this.selectedTournamentPreset = this.tournamentPresetName.trim();
                    this.tournamentPresetName = '';
                    this.showToast('Tournament preset saved');
                } catch (err) {
                    console.error('Error saving tournament preset:', err);
                    this.showToast('Error saving preset', 'error');
                }
            },
            
            async loadTournamentPreset() {
                if (!this.selectedTournamentPreset) return;
                
                const preset = this.tournamentPresets.find(p => p.name === this.selectedTournamentPreset);
                if (!preset) return;
                
                // Load scenario paths
                this.newTournament.scenario_paths = preset.scenario_paths || [];
                
                // Load competitor types
                this.newTournament.competitor_types = preset.competitor_types || [];
                
                // Load opponent types
                this.newTournament.opponents_same_as_competitors = preset.opponents_same_as_competitors ?? true;
                this.newTournament.opponent_types = preset.opponent_types || [];
                
                // Load basic settings
                this.newTournament.n_repetitions = preset.n_repetitions || 1;
                this.newTournament.rotate_ufuns = preset.rotate_ufuns ?? true;
                this.newTournament.self_play = preset.self_play ?? true;
                this.newTournament.mechanism_type = preset.mechanism_type || 'SAOMechanism';
                
                // Load steps settings
                if (preset.n_steps_min !== null && preset.n_steps_max !== null) {
                    this.newTournament.n_steps_range_enabled = true;
                    this.newTournament.n_steps_min = preset.n_steps_min;
                    this.newTournament.n_steps_max = preset.n_steps_max;
                    this.newTournament.n_steps = 100;
                } else {
                    this.newTournament.n_steps_range_enabled = false;
                    this.newTournament.n_steps = preset.n_steps || 100;
                }
                
                // Load time limit settings
                if (preset.time_limit_min !== null && preset.time_limit_max !== null) {
                    this.newTournament.time_limit_range_enabled = true;
                    this.newTournament.time_limit_min = preset.time_limit_min;
                    this.newTournament.time_limit_max = preset.time_limit_max;
                    this.newTournament.time_limit = null;
                } else {
                    this.newTournament.time_limit_range_enabled = false;
                    this.newTournament.time_limit = preset.time_limit;
                }
                
                // Load advanced settings
                this.newTournament.step_time_limit = preset.step_time_limit;
                this.newTournament.negotiator_time_limit = preset.negotiator_time_limit;
                this.newTournament.hidden_time_limit = preset.hidden_time_limit;
                this.newTournament.pend = preset.pend;
                this.newTournament.pend_per_second = preset.pend_per_second;
                this.newTournament.final_score_metric = preset.final_score_metric || 'advantage';
                this.newTournament.final_score_stat = preset.final_score_stat || 'mean';
                this.newTournament.randomize_runs = preset.randomize_runs ?? false;
                this.newTournament.sort_runs = preset.sort_runs ?? true;
                this.newTournament.id_reveals_type = preset.id_reveals_type ?? false;
                this.newTournament.name_reveals_type = preset.name_reveals_type ?? true;
                this.newTournament.mask_scenario_names = preset.mask_scenario_names ?? false;
                this.newTournament.only_failures_on_self_play = preset.only_failures_on_self_play ?? false;
                this.newTournament.save_stats = preset.save_stats ?? true;
                this.newTournament.save_scenario_figs = preset.save_scenario_figs ?? true;
                this.newTournament.save_every = preset.save_every ?? 1;
                this.newTournament.normalize = preset.normalize ?? true;
                
                this.showToast(`Loaded preset: ${preset.name}`);
            },
            
            async deleteTournamentPreset(name) {
                if (!confirm(`Delete tournament preset "${name}"?`)) return;
                
                try {
                    await fetch(`/api/settings/presets/tournaments/${encodeURIComponent(name)}`, {
                        method: 'DELETE'
                    });
                    await this.loadTournamentPresets();
                    if (this.selectedTournamentPreset === name) {
                        this.selectedTournamentPreset = '';
                    }
                    this.showToast('Tournament preset deleted');
                } catch (err) {
                    console.error('Error deleting tournament preset:', err);
                    this.showToast('Error deleting preset', 'error');
                }
            },
            
            // Virtual negotiator methods
            async loadVirtualNegotiators() {
                this.virtualNegotiatorsLoading = true;
                try {
                    const res = await fetch('/api/negotiators/virtual');
                    const data = await res.json();
                    this.virtualNegotiators = data.virtual_negotiators || [];
                } catch (err) {
                    console.error('Error loading virtual negotiators:', err);
                    this.virtualNegotiators = [];
                } finally {
                    this.virtualNegotiatorsLoading = false;
                }
            },
            
            isVirtualNegotiator(typeName) {
                return typeName && typeName.startsWith('virtual:');
            },
            
            getVirtualNegotiator(typeName) {
                if (!typeName || !typeName.startsWith('virtual:')) return null;
                const id = typeName.replace('virtual:', '');
                return this.virtualNegotiators.find(vn => vn.id === id);
            },
            
            // Virtual mechanism methods
            async loadVirtualMechanisms() {
                this.virtualMechanismsLoading = true;
                try {
                    const res = await fetch('/api/mechanisms/virtual');
                    const data = await res.json();
                    this.virtualMechanisms = data.virtual_mechanisms || [];
                } catch (err) {
                    console.error('Error loading virtual mechanisms:', err);
                    this.virtualMechanisms = [];
                } finally {
                    this.virtualMechanismsLoading = false;
                }
            },
            
            isVirtualMechanism(className) {
                return className && className.startsWith('virtual:');
            },
            
            getVirtualMechanism(className) {
                if (!className || !className.startsWith('virtual:')) return null;
                const id = className.replace('virtual:', '');
                return this.virtualMechanisms.find(vm => vm.id === id);
            },
            
            getBaseTypeFromVirtualMechanism(className) {
                const vm = this.getVirtualMechanism(className);
                if (!vm) return className;
                return vm.base_type === 'sao' ? 'SAOMechanism' : 
                       vm.base_type === 'tau' ? 'TAUMechanism' : 
                       vm.base_type === 'gb' ? 'GBMechanism' : vm.base_type;
            },
            
            openSaveVirtualMechanism() {
                this.saveVirtualMechanismName = '';
                this.saveVirtualMechanismDescription = '';
                this.saveVirtualMechanismTags = '';
                this.showSaveVirtualMechanism = true;
            },
            
            closeSaveVirtualMechanism() {
                this.showSaveVirtualMechanism = false;
            },
            
            async saveAsVirtualMechanism() {
                if (!this.saveVirtualMechanismName.trim()) {
                    alert('Please enter a name for the virtual mechanism');
                    return;
                }
                
                // Determine base_type from current mechanism
                const baseType = this.newNeg.mechanism_type === 'SAOMechanism' ? 'sao' :
                                 this.newNeg.mechanism_type === 'TAUMechanism' ? 'tau' :
                                 this.newNeg.mechanism_type === 'GBMechanism' ? 'gb' : 'sao';
                
                // Parse tags
                const tags = this.saveVirtualMechanismTags.trim() 
                    ? this.saveVirtualMechanismTags.split(',').map(t => t.trim()).filter(t => t)
                    : [];
                
                try {
                    const res = await fetch('/api/mechanisms/virtual', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: this.saveVirtualMechanismName.trim(),
                            base_type: baseType,
                            description: this.saveVirtualMechanismDescription.trim(),
                            tags: tags,
                            params: { ...this.newNeg.mechanism_params }
                        })
                    });
                    
                    if (!res.ok) {
                        const err = await res.json();
                        alert('Error creating virtual mechanism: ' + (err.detail || 'Unknown error'));
                        return;
                    }
                    
                    const data = await res.json();
                    const newVm = data.virtual_mechanism;
                    
                    // Add to virtual mechanisms list
                    this.virtualMechanisms.push(newVm);
                    
                    // Select the new virtual mechanism
                    this.selectMechanism('virtual:' + newVm.id);
                    
                    this.closeSaveVirtualMechanism();
                } catch (err) {
                    console.error('Error creating virtual mechanism:', err);
                    alert('Error creating virtual mechanism');
                }
            },
            
            async deleteVirtualMechanism(id) {
                if (!confirm('Are you sure you want to delete this virtual mechanism?')) {
                    return;
                }
                
                try {
                    const res = await fetch(`/api/mechanisms/virtual/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (!res.ok) {
                        const err = await res.json();
                        alert('Error deleting virtual mechanism: ' + (err.detail || 'Unknown error'));
                        return;
                    }
                    
                    // Remove from list
                    this.virtualMechanisms = this.virtualMechanisms.filter(vm => vm.id !== id);
                    
                    // If this was the selected mechanism, select the first base mechanism
                    if (this.newNeg.mechanism_type === 'virtual:' + id) {
                        this.selectMechanism('SAOMechanism');
                    }
                } catch (err) {
                    console.error('Error deleting virtual mechanism:', err);
                    alert('Error deleting virtual mechanism');
                }
            },
            
            async openCompetitorConfig(typeName) {
                this.competitorConfigTypeName = typeName;
                this.competitorConfigLoading = true;
                this.competitorConfigValues = {};
                this.competitorConfigSaveAsVirtual = false;
                this.competitorConfigVirtualName = '';
                this.showCompetitorConfig = true;
                
                // Determine the base type for parameter lookup
                let baseType = typeName;
                if (this.isVirtualNegotiator(typeName)) {
                    const vn = this.getVirtualNegotiator(typeName);
                    if (vn) {
                        baseType = vn.base_type_name;
                        // Pre-fill with virtual negotiator's saved params
                        this.competitorConfigValues = { ...vn.params };
                        this.competitorConfigVirtualName = vn.name;
                    }
                }
                
                try {
                    const res = await fetch(`/api/negotiators/${encodeURIComponent(baseType)}/parameters`);
                    const data = await res.json();
                    this.competitorConfigParams = data.parameters || [];
                    
                    // Set default values for params not already set
                    for (const param of this.competitorConfigParams) {
                        if (!(param.name in this.competitorConfigValues) && param.default !== null) {
                            this.competitorConfigValues[param.name] = param.default;
                        }
                    }
                } catch (err) {
                    console.error('Error loading negotiator parameters:', err);
                    this.competitorConfigParams = [];
                } finally {
                    this.competitorConfigLoading = false;
                }
            },
            
            closeCompetitorConfig() {
                this.showCompetitorConfig = false;
                this.competitorConfigTypeName = null;
                this.competitorConfigParams = [];
                this.competitorConfigValues = {};
            },
            
            async saveCompetitorConfig() {
                if (!this.competitorConfigSaveAsVirtual) {
                    // Just close without saving - params are stored in tournament config
                    // For now, we don't persist per-competitor params in tournament
                    // This would require extending the tournament data model
                    this.closeCompetitorConfig();
                    return;
                }
                
                // Create a new virtual negotiator
                if (!this.competitorConfigVirtualName.trim()) {
                    alert('Please enter a name for the virtual negotiator');
                    return;
                }
                
                // Determine the base type
                let baseType = this.competitorConfigTypeName;
                if (this.isVirtualNegotiator(this.competitorConfigTypeName)) {
                    const vn = this.getVirtualNegotiator(this.competitorConfigTypeName);
                    if (vn) baseType = vn.base_type_name;
                }
                
                try {
                    const res = await fetch('/api/negotiators/virtual', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: this.competitorConfigVirtualName.trim(),
                            base_type_name: baseType,
                            params: this.competitorConfigValues,
                            description: '',
                            tags: []
                        })
                    });
                    
                    if (!res.ok) {
                        const err = await res.json();
                        alert('Error creating virtual negotiator: ' + (err.detail || 'Unknown error'));
                        return;
                    }
                    
                    const data = await res.json();
                    const newVn = data.virtual_negotiator;
                    
                    // Add to virtual negotiators list
                    this.virtualNegotiators.push(newVn);
                    
                    // Replace the original type with the new virtual negotiator in the selection
                    const idx = this.newTournament.competitor_types.indexOf(this.competitorConfigTypeName);
                    if (idx >= 0) {
                        this.newTournament.competitor_types[idx] = 'virtual:' + newVn.id;
                    }
                    
                    this.closeCompetitorConfig();
                } catch (err) {
                    console.error('Error creating virtual negotiator:', err);
                    alert('Error creating virtual negotiator');
                }
            },
            
            addAllFilteredTournamentCompetitors() {
                const filtered = this.filteredTournamentCompetitors;
                for (const n of filtered) {
                    if (!this.newTournament.competitor_types.includes(n.type_name)) {
                        this.newTournament.competitor_types.push(n.type_name);
                    }
                }
            },
            
            isTournamentScenarioSelected(scenarioPath) {
                return this.newTournament.scenario_paths.includes(scenarioPath);
            },
            
            isTournamentCompetitorSelected(typeName) {
                return this.newTournament.competitor_types.includes(typeName);
            },
            
            resetTournamentForm() {
                this.newTournament = {
                    competitor_types: [],
                    opponent_types: [],
                    opponents_same_as_competitors: true,
                    scenario_paths: [],
                    n_repetitions: 1,
                    rotate_ufuns: true,
                    self_play: true,
                    mechanism_type: 'SAOMechanism',
                    n_steps: 100,
                    n_steps_range_enabled: false,
                    n_steps_min: 50,
                    n_steps_max: 200,
                    time_limit: null,
                    time_limit_range_enabled: false,
                    time_limit_min: 30,
                    time_limit_max: 120,
                    // Time limits for negotiators
                    step_time_limit: null,
                    negotiator_time_limit: null,
                    hidden_time_limit: null,
                    // Probabilistic ending
                    pend: null,
                    pend_per_second: null,
                    // Scoring
                    final_score_metric: 'advantage',
                    final_score_stat: 'mean',
                    // Run ordering
                    randomize_runs: false,
                    sort_runs: true,
                    // Information hiding
                    id_reveals_type: false,
                    name_reveals_type: true,
                    mask_scenario_names: false,
                    // Self-play options
                    only_failures_on_self_play: false,
                    // Save options
                    save_stats: true,
                    save_scenario_figs: true,
                    save_every: 1,
                };
                // Also reset search/filter fields
                this.tournamentScenarioSearch = '';
                this.tournamentScenarioSourceFilter = '';
                this.tournamentCompetitorSearch = '';
                this.tournamentCompetitorSourceFilter = '';
                this.tournamentCompetitorTagFilter = '';
                this.tournamentOpponentSearch = '';
                this.tournamentOpponentSourceFilter = '';
            },
            
            get filteredTournamentScenarios() {
                return this.applyScenarioFilters(
                    this.scenarios,
                    this.tournamentScenarioFilters,
                    this.tournamentScenarioSourceFilter,
                    this.tournamentScenarioSearch
                );
            },
            
            get filteredTournamentCompetitors() {
                // Combine regular negotiators with virtual negotiators
                const virtualAsNegotiators = this.virtualNegotiators.map(vn => ({
                    type_name: 'virtual:' + vn.id,
                    name: vn.name,
                    source: 'virtual',
                    group: '',
                    description: vn.description || `Based on ${vn.base_type_name.split('.').pop()}`,
                    tags: vn.tags,
                    mechanisms: ['SAO'],  // Assume SAO for now
                    requires_bridge: false,
                    available: true,
                    isVirtual: true
                }));
                
                let filtered = [...this.negotiatorTypes, ...virtualAsNegotiators];
                
                // Apply source filter
                if (this.tournamentCompetitorSourceFilter) {
                    filtered = filtered.filter(n => n.source === this.tournamentCompetitorSourceFilter);
                }
                
                // Apply tag filter
                if (this.tournamentCompetitorTagFilter) {
                    const tag = this.tournamentCompetitorTagFilter.toLowerCase();
                    filtered = filtered.filter(n => 
                        n.tags && n.tags.some(t => t.toLowerCase() === tag)
                    );
                }
                
                // Apply search filter
                if (this.tournamentCompetitorSearch) {
                    const search = this.tournamentCompetitorSearch.toLowerCase();
                    filtered = filtered.filter(n => 
                        n.name.toLowerCase().includes(search) ||
                        n.type_name.toLowerCase().includes(search) ||
                        (n.source && n.source.toLowerCase().includes(search))
                    );
                }
                
                return filtered;
            },
            
            get filteredTournamentOpponents() {
                // Combine regular negotiators with virtual negotiators (same as competitors)
                const virtualAsNegotiators = this.virtualNegotiators.map(vn => ({
                    type_name: 'virtual:' + vn.id,
                    name: vn.name,
                    source: 'virtual',
                    group: '',
                    description: vn.description || `Based on ${vn.base_type_name.split('.').pop()}`,
                    tags: vn.tags,
                    mechanisms: ['SAO'],
                    requires_bridge: false,
                    available: true,
                    isVirtual: true
                }));
                
                let filtered = [...this.negotiatorTypes, ...virtualAsNegotiators];
                
                // Apply source filter
                if (this.tournamentOpponentSourceFilter) {
                    filtered = filtered.filter(n => n.source === this.tournamentOpponentSourceFilter);
                }
                
                // Apply search filter
                if (this.tournamentOpponentSearch) {
                    const search = this.tournamentOpponentSearch.toLowerCase();
                    filtered = filtered.filter(n => 
                        n.name.toLowerCase().includes(search) ||
                        n.type_name.toLowerCase().includes(search) ||
                        (n.source && n.source.toLowerCase().includes(search))
                    );
                }
                
                return filtered;
            },
            
            // Saved tournament methods
            async loadSavedTournaments() {
                this.savedTournamentsLoading = true;
                try {
                    const res = await fetch('/api/tournament/saved/list');
                    const data = await res.json();
                    this.savedTournaments = data.tournaments || [];
                } catch (e) {
                    console.error('Failed to load saved tournaments:', e);
                } finally {
                    this.savedTournamentsLoading = false;
                }
            },
            
            async loadAndSelectSavedTournament(tournamentId) {
                try {
                    const res = await fetch(`/api/tournament/saved/${tournamentId}`);
                    if (!res.ok) throw new Error('Failed to load tournament');
                    const data = await res.json();
                    
                    // Transform to match our tournament format
                    this.selectedTournament = {
                        id: data.id,
                        status: 'completed',
                        _fromSaved: true,
                        config: {
                            competitor_types: [],  // Not available from saved data
                            scenario_paths: []
                        },
                        results: {
                            total_negotiations: data.n_negotiations,
                            total_agreements: data.n_agreements,
                            overall_agreement_rate: data.agreement_rate,
                            execution_time: 0,  // Not available from saved data
                            final_scores: (data.scores || []).map((s, idx) => ({
                                name: s.name,
                                rank: s.rank,
                                score: s.score,
                                type_name: s.raw_data?.type || '',
                                mean_utility: s.raw_data?.utility ? parseFloat(s.raw_data.utility) : null,
                                n_agreements: s.raw_data?.n_agreements ? parseInt(s.raw_data.n_agreements) : '-',
                                n_negotiations: s.raw_data?.n_negotiations ? parseInt(s.raw_data.n_negotiations) : '-'
                            })),
                            negotiations: data.negotiations || []
                        },
                        created_at: data.created_at
                    };
                } catch (e) {
                    console.error('Failed to load saved tournament:', e);
                }
            },
            
            async deleteSavedTournament(tournamentId) {
                if (!confirm('Delete this saved tournament?')) return;
                
                try {
                    await fetch(`/api/tournament/saved/${tournamentId}`, { method: 'DELETE' });
                    this.savedTournaments = this.savedTournaments.filter(t => t.id !== tournamentId);
                    if (this.selectedTournament?.id === tournamentId) {
                        this.selectedTournament = null;
                    }
                } catch (e) {
                    console.error('Failed to delete tournament:', e);
                }
            },
            
            async clearSavedTournaments() {
                if (!confirm('Delete ALL saved tournaments? This cannot be undone.')) return;
                
                try {
                    // Delete each tournament individually
                    for (const t of this.savedTournaments) {
                        await fetch(`/api/tournament/saved/${t.id}`, { method: 'DELETE' });
                    }
                    this.savedTournaments = [];
                    if (this.selectedTournament?._fromSaved) {
                        this.selectedTournament = null;
                    }
                } catch (e) {
                    console.error('Failed to clear tournaments:', e);
                }
            },
            
            // Settings
            async loadSettings() {
                try {
                    const res = await fetch('/api/settings');
                    const data = await res.json();
                    
                    // Map backend settings to frontend model
                    this.settings.darkMode = data.general?.dark_mode ?? false;
                    this.settings.colorBlindMode = data.general?.color_blind_mode ?? false;
                    this.settings.saveNegotiations = data.general?.save_negotiations ?? true;
                    this.settings.cacheScenarioStats = data.general?.cache_scenario_stats ?? true;
                    this.settings.defaultSteps = data.negotiation?.default_max_steps ?? 100;
                    this.settings.defaultDelay = data.negotiation?.default_step_delay_ms ?? 100;
                    this.settings.autoStartGenius = data.genius_bridge?.auto_start ?? true;
                    this.settings.scenarioPaths = (data.paths?.scenario_paths ?? []).join('\n');
                    this.settings.negotiatorPaths = (data.paths?.negotiator_paths ?? []).join('\n');
                    
                    // Performance settings
                    this.settings.maxOutcomesRun = data.performance?.max_outcomes_run ?? null;
                    this.settings.maxOutcomesStats = data.performance?.max_outcomes_stats ?? 1000000;
                    this.settings.maxOutcomesInfo = data.performance?.max_outcomes_info ?? 10000000;
                    
                    // Sync localStorage with backend
                    localStorage.setItem('darkMode', this.settings.darkMode.toString());
                    localStorage.setItem('colorBlindMode', this.settings.colorBlindMode.toString());
                    localStorage.setItem('saveNegotiations', this.settings.saveNegotiations.toString());
                    
                    // Apply dark mode based on loaded settings
                    document.documentElement.classList.toggle('dark-mode', this.settings.darkMode);
                    document.body.classList.toggle('dark-mode', this.settings.darkMode);
                    
                    // Apply color-blind mode based on loaded settings
                    document.documentElement.classList.toggle('color-blind-mode', this.settings.colorBlindMode);
                    document.body.classList.toggle('color-blind-mode', this.settings.colorBlindMode);
                } catch (e) {
                    console.error('Failed to load settings:', e);
                }
            },
            
            toggleDarkMode() {
                localStorage.setItem('darkMode', this.settings.darkMode);
                document.documentElement.classList.toggle('dark-mode', this.settings.darkMode);
                document.body.classList.toggle('dark-mode', this.settings.darkMode);
                // Also save to backend immediately for dark mode
                this.saveGeneralSettings();
                // Trigger chart redraws if any
                window.dispatchEvent(new CustomEvent('dark-mode-changed', { 
                    detail: { enabled: this.settings.darkMode } 
                }));
            },
            
            toggleColorBlindMode() {
                localStorage.setItem('colorBlindMode', this.settings.colorBlindMode);
                document.documentElement.classList.toggle('color-blind-mode', this.settings.colorBlindMode);
                document.body.classList.toggle('color-blind-mode', this.settings.colorBlindMode);
                // Save to backend immediately
                this.saveGeneralSettings();
                // Trigger chart redraws if any
                window.dispatchEvent(new CustomEvent('colorblind-mode-changed', { 
                    detail: { enabled: this.settings.colorBlindMode } 
                }));
            },
            
            async saveGeneralSettings() {
                try {
                    localStorage.setItem('saveNegotiations', this.settings.saveNegotiations.toString());
                    await fetch('/api/settings/general', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            dark_mode: this.settings.darkMode,
                            color_blind_mode: this.settings.colorBlindMode,
                            save_negotiations: this.settings.saveNegotiations,
                            cache_scenario_stats: this.settings.cacheScenarioStats
                        })
                    });
                } catch (e) {
                    console.error('Failed to save general settings:', e);
                }
            },
            
            async saveSettings() {
                try {
                    localStorage.setItem('saveNegotiations', this.settings.saveNegotiations.toString());
                    const settings = {
                        general: {
                            dark_mode: this.settings.darkMode,
                            color_blind_mode: this.settings.colorBlindMode,
                            save_negotiations: this.settings.saveNegotiations,
                            cache_scenario_stats: this.settings.cacheScenarioStats
                        },
                        negotiation: {
                            default_max_steps: this.settings.defaultSteps,
                            default_step_delay_ms: this.settings.defaultDelay,
                            default_time_limit: null
                        },
                        genius_bridge: {
                            auto_start: this.settings.autoStartGenius,
                            java_path: null,
                            port: 25337
                        },
                        paths: {
                            scenario_paths: this.settings.scenarioPaths.split('\n').filter(p => p.trim()),
                            negotiator_paths: this.settings.negotiatorPaths.split('\n').filter(p => p.trim())
                        },
                        performance: {
                            max_outcomes_run: this.settings.maxOutcomesRun || null,
                            max_outcomes_stats: this.settings.maxOutcomesStats || null,
                            max_outcomes_info: this.settings.maxOutcomesInfo || null
                        }
                    };
                    
                    await fetch('/api/settings', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    });
                    
                    // Also save source settings if modified
                    if (this.sourceSettings.disabled_sources.length > 0 || this.sourceSettings.custom_sources.length > 0) {
                        await fetch('/api/settings/negotiator_sources', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.sourceSettings)
                        });
                        // Refresh negotiator list after changing sources
                        await this.refreshNegotiators();
                    }
                    
                    this.showSettings = false;
                } catch (e) {
                    console.error('Failed to save settings:', e);
                }
            },
            
            // Export/Import settings
            async exportSettings() {
                this.exportingSettings = true;
                try {
                    const res = await fetch('/api/settings/export');
                    if (res.ok) {
                        const blob = await res.blob();
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        // Get filename from Content-Disposition header or use default
                        const disposition = res.headers.get('Content-Disposition');
                        const filenameMatch = disposition?.match(/filename=([^;]+)/);
                        a.download = filenameMatch ? filenameMatch[1] : 'negmas_settings.zip';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    } else {
                        console.error('Export failed:', res.statusText);
                        alert('Failed to export settings');
                    }
                } catch (e) {
                    console.error('Failed to export settings:', e);
                    alert('Failed to export settings');
                } finally {
                    this.exportingSettings = false;
                }
            },
            
            async handleSettingsImport(event) {
                const file = event.target.files?.[0];
                if (!file) return;
                
                this.importingSettings = true;
                this.importStatus = '';
                
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const res = await fetch('/api/settings/import', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await res.json();
                    
                    if (result.status === 'success') {
                        this.importStatus = `Imported ${result.imported?.length || 0} files`;
                        // Reload settings
                        await this.loadSettings();
                        // Show success message briefly
                        setTimeout(() => {
                            this.importStatus = 'Settings imported! Refresh page to apply all changes.';
                        }, 1000);
                    } else if (result.status === 'partial') {
                        this.importStatus = `Imported ${result.imported?.length || 0} files with some errors`;
                        await this.loadSettings();
                    } else {
                        this.importStatus = result.message || 'Import failed';
                    }
                } catch (e) {
                    console.error('Failed to import settings:', e);
                    this.importStatus = 'Import failed';
                } finally {
                    this.importingSettings = false;
                    // Clear the file input
                    event.target.value = '';
                }
            },
            
            // Custom source management
            async handleScenarioFileSelect(event) {
                const file = event.target.files?.[0];
                if (!file) return;
                
                // For HTML file input, we get a File object but not the real path
                // We need to use a different approach - prompt user for path or use webkitRelativePath
                // For now, we'll show an alert explaining the limitation
                const fileName = file.name;
                const path = prompt(
                    `Enter the full path to the scenario file "${fileName}":\n\n` +
                    `(Due to browser security, we cannot automatically get the file path.\n` +
                    `Please enter the complete path, e.g., /Users/you/scenarios/${fileName})`
                );
                
                if (path && path.trim()) {
                    await this.addScenarioPath(path.trim());
                }
                
                // Clear the file input
                event.target.value = '';
            },
            
            async handleModuleFileSelect(event) {
                const file = event.target.files?.[0];
                if (!file) return;
                
                const fileName = file.name;
                const path = prompt(
                    `Enter the full path to the Python module "${fileName}":\n\n` +
                    `(Due to browser security, we cannot automatically get the file path.\n` +
                    `Please enter the complete path, e.g., /Users/you/negotiators/${fileName})`
                );
                
                if (path && path.trim()) {
                    await this.addModulePath(path.trim());
                }
                
                // Clear the file input
                event.target.value = '';
            },
            
            async addScenarioPath(path) {
                // Validate the scenario path
                try {
                    const res = await fetch('/api/sources/scenario/validate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path })
                    });
                    const result = await res.json();
                    
                    if (!result.valid) {
                        alert(`Invalid scenario path: ${result.error}`);
                        return;
                    }
                    
                    // Add to settings
                    const paths = (this.settings.scenarioPaths || '').split('\n').filter(p => p.trim());
                    if (!paths.includes(path)) {
                        paths.push(path);
                        this.settings.scenarioPaths = paths.join('\n');
                    }
                    
                    // Show success
                    alert(`Added scenario: ${result.name} (${result.format} format, ${result.n_negotiators} negotiators)`);
                } catch (e) {
                    console.error('Failed to validate scenario path:', e);
                    alert('Failed to validate scenario path');
                }
            },
            
            async addModulePath(path) {
                // Validate/inspect the module
                try {
                    const res = await fetch('/api/sources/module/inspect', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path, dynamic: false })
                    });
                    const result = await res.json();
                    
                    if (!result.success) {
                        alert(`Failed to inspect module: ${result.error}`);
                        return;
                    }
                    
                    if (result.classes.length === 0) {
                        alert('No negotiator, mechanism, or BOA component classes found in this module.');
                        return;
                    }
                    
                    // Show what was found
                    const summary = [];
                    if (result.negotiators.length > 0) {
                        summary.push(`${result.negotiators.length} negotiator(s): ${result.negotiators.map(c => c.name).join(', ')}`);
                    }
                    if (result.mechanisms.length > 0) {
                        summary.push(`${result.mechanisms.length} mechanism(s): ${result.mechanisms.map(c => c.name).join(', ')}`);
                    }
                    if (result.boa_components.length > 0) {
                        summary.push(`${result.boa_components.length} BOA component(s): ${result.boa_components.map(c => c.name).join(', ')}`);
                    }
                    
                    // Add to settings
                    const paths = (this.settings.negotiatorPaths || '').split('\n').filter(p => p.trim());
                    if (!paths.includes(path)) {
                        paths.push(path);
                        this.settings.negotiatorPaths = paths.join('\n');
                    }
                    
                    alert(`Added module "${result.module_name}":\n\n${summary.join('\n')}`);
                } catch (e) {
                    console.error('Failed to inspect module:', e);
                    alert('Failed to inspect module');
                }
            },
            
            removeScenarioPath(idx) {
                const paths = (this.settings.scenarioPaths || '').split('\n').filter(p => p.trim());
                paths.splice(idx, 1);
                this.settings.scenarioPaths = paths.join('\n');
            },
            
            removeNegotiatorPath(idx) {
                const paths = (this.settings.negotiatorPaths || '').split('\n').filter(p => p.trim());
                paths.splice(idx, 1);
                this.settings.negotiatorPaths = paths.join('\n');
            },
            
            openFolderBrowser(type) {
                // Since browsers don't support folder selection well, use a prompt
                const path = prompt(
                    `Enter the full path to the ${type === 'scenario' ? 'scenario folder' : 'folder'}:\n\n` +
                    `Example: /Users/you/scenarios/my_scenario`
                );
                
                if (path && path.trim()) {
                    if (type === 'scenario') {
                        this.addScenarioPath(path.trim());
                    }
                }
            },
            
            // Preset management
            async loadRecentSessions() {
                try {
                    const res = await fetch('/api/settings/presets/recent');
                    if (res.ok) {
                        const data = await res.json();
                        this.recentSessions = data.presets || [];
                    }
                } catch (e) {
                    console.error('Failed to load recent sessions:', e);
                }
            },
            
            async loadSessionPresets() {
                try {
                    const res = await fetch('/api/settings/presets/sessions');
                    if (res.ok) {
                        const data = await res.json();
                        this.sessionPresets = data.presets || [];
                    }
                } catch (e) {
                    console.error('Failed to load session presets:', e);
                }
            },
            
            loadFullSession(session) {
                // Find the scenario in the loaded scenarios
                const scenario = this.scenarios.find(s => s.path === session.scenario_path);
                const mechType = session.mechanism_type || 'SAOMechanism';
                
                // First select the mechanism to initialize defaults
                // This must happen BEFORE setting newNeg so we can override with loaded values
                this.selectMechanism(mechType);
                
                // Now set up newNeg with loaded values (this will override any defaults)
                this.newNeg = {
                    source: '',
                    scenario: scenario || { path: session.scenario_path, name: session.scenario_name },
                    negotiators: session.negotiators.map((n, i) => ({
                        type_name: n.type_name,
                        name: n.name || `Agent${i + 1}`,
                        source: n.source || 'native',
                        requires_bridge: n.requires_bridge || false,
                        is_boa: n.is_boa || false,
                        boa_config: n.boa_config || null
                    })),
                    mechanism_type: mechType,
                    mechanism_params: { ...this.newNeg.mechanism_params, ...(session.mechanism_params || {}) },
                    share_ufuns: session.share_ufuns ?? false,
                    mode: session.mode || 'realtime',
                    step_delay: session.step_delay ?? 100,
                    show_plot: session.show_plot ?? true,
                    show_offers: session.show_offers ?? true,
                    auto_start: true,
                    panels: session.panels || {
                        adjustable: true,
                        utilityView: { xAxis: 0, yAxis: 1 },
                        timeline: { xAxis: 'relative_time' }
                    }
                };
                
                // Jump directly to display tab when loading a full session
                this.negotiationTab = 'display';
            },
            
            buildSessionPreset(name) {
                return {
                    name: name,
                    scenario_path: this.newNeg.scenario?.path,
                    scenario_name: this.newNeg.scenario?.name,
                    negotiators: this.newNeg.negotiators.map(n => ({
                        type_name: n.type_name,
                        name: n.name,
                        source: n.source,
                        requires_bridge: n.requires_bridge
                    })),
                    mechanism_type: this.newNeg.mechanism_type,
                    mechanism_params: this.newNeg.mechanism_params,
                    share_ufuns: this.newNeg.share_ufuns,
                    mode: this.newNeg.mode,
                    step_delay: this.newNeg.step_delay,
                    show_plot: this.newNeg.show_plot,
                    show_offers: this.newNeg.show_offers,
                    panels: this.newNeg.panels
                };
            },
            
            async saveFullSession() {
                if (!this.savePresetName.trim() || !this.newNeg.scenario) return;
                
                try {
                    const preset = this.buildSessionPreset(this.savePresetName.trim());
                    const res = await fetch('/api/settings/presets/sessions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(preset)
                    });
                    
                    if (res.ok) {
                        this.showSaveSessionModal = false;
                        this.savePresetName = '';
                        // Refresh the list
                        await this.loadSessionPresets();
                    }
                } catch (e) {
                    console.error('Failed to save session preset:', e);
                }
            },
            
            async deleteSessionPreset(name) {
                try {
                    const res = await fetch(`/api/settings/presets/sessions/${encodeURIComponent(name)}`, {
                        method: 'DELETE'
                    });
                    if (res.ok) {
                        await this.loadSessionPresets();
                    }
                } catch (e) {
                    console.error('Failed to delete session preset:', e);
                }
            },
            
            async addToRecentSessions() {
                if (!this.newNeg.scenario) return;
                
                try {
                    const preset = this.buildSessionPreset(this.newNeg.scenario.name);
                    await fetch('/api/settings/presets/recent', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(preset)
                    });
                } catch (e) {
                    console.error('Failed to add to recent sessions:', e);
                }
            }
        };
    }
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
