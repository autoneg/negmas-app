<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}NegMAS App{% endblock %}</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="/static/css/styles.css">
    
    <!-- Apply dark mode immediately to prevent flash -->
    <script>
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark-mode');
        }
        if (localStorage.getItem('colorBlindMode') === 'true') {
            document.documentElement.classList.add('color-blind-mode');
        }
    </script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>
    
    <!-- Alpine.js Collapse Plugin -->
    <script defer src="https://unpkg.com/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- SortableJS for drag-reorder -->
    <script src="https://unpkg.com/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <!-- Plotly.js for real-time plotting -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
    
    {% block head %}{% endblock %}
</head>
<body x-data="app()" x-init="init()">
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <span>NegMAS App</span>
            </div>
            
            <nav class="header-nav">
                <button class="header-nav-btn" :class="{ active: currentPage === 'negotiations' }" @click="currentPage = 'negotiations'">Negotiations</button>
                <button class="header-nav-btn" :class="{ active: currentPage === 'scenarios' }" @click="currentPage = 'scenarios'; loadScenariosForExplorer()">Scenarios</button>
                <button class="header-nav-btn" @click="showSettings = true">Settings</button>
            </nav>
            
            <div class="header-spacer"></div>
            
            <!-- Genius Bridge Status -->
            <div class="header-status genius-bridge-status" 
                 @click="toggleGeniusBridge()"
                 :title="geniusBridge.running ? 'Click to stop Genius Bridge' : 'Click to start Genius Bridge'">
                <span class="status-dot" :class="{ 'running': geniusBridge.running, 'stopped': !geniusBridge.running }"></span>
                <span x-text="geniusBridge.running ? 'Genius Bridge' : 'Genius Bridge (Off)'"></span>
                <span class="bridge-action-icon" x-show="geniusBridge.loading">
                    <svg class="spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                        <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="12"></circle>
                    </svg>
                </span>
            </div>
            
            <div class="header-status">
                <span class="status-dot" :class="{ 'disconnected': !connected }"></span>
                <span x-text="connected ? 'Connected' : 'Disconnected'"></span>
            </div>
            
            <div class="header-actions">
                <button class="btn btn-primary" @click="openNewNegotiation()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Negotiation
                </button>
            </div>
        </header>
        
        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Sidebar -->
            <aside class="sidebar" :class="{ collapsed: sidebarCollapsed }">
                <button class="sidebar-toggle" @click="sidebarCollapsed = !sidebarCollapsed" :title="sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <polyline :points="sidebarCollapsed ? '9 18 15 12 9 6' : '15 18 9 12 15 6'"></polyline>
                    </svg>
                </button>
                <div class="sidebar-section">
                    <div class="sidebar-section-title" x-show="!sidebarCollapsed">Quick Actions</div>
                    <button class="sidebar-btn primary" @click="openNewNegotiation()" :title="sidebarCollapsed ? 'Start Negotiation' : ''">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        <span x-show="!sidebarCollapsed">Start Negotiation</span>
                    </button>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title" x-show="!sidebarCollapsed">Running</div>
                    <div class="negotiation-list" x-show="!sidebarCollapsed">
                        <template x-if="runningNegotiations.length === 0">
                            <p class="text-muted" style="font-size: 12px; padding: 8px;">No active negotiations</p>
                        </template>
                        <template x-for="neg in runningNegotiations" :key="neg.id">
                            <div class="negotiation-item" :class="{ active: currentNegotiation?.id === neg.id }" @click="selectNegotiation(neg)">
                                <div class="negotiation-item-title" x-text="neg.scenario"></div>
                                <div class="negotiation-item-meta">
                                    <span class="badge badge-primary">Running</span>
                                    <span x-text="'Step ' + neg.step"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title" x-show="!sidebarCollapsed">Completed</div>
                    <div class="negotiation-list" x-show="!sidebarCollapsed">
                        <template x-if="completedNegotiations.length === 0">
                            <p class="text-muted" style="font-size: 12px; padding: 8px;">No completed negotiations</p>
                        </template>
                        <template x-for="neg in completedNegotiations" :key="neg.id">
                            <div class="negotiation-item" :class="{ active: currentNegotiation?.id === neg.id }" @click="selectNegotiation(neg)">
                                <div class="negotiation-item-title" x-text="neg.scenario"></div>
                                <div class="negotiation-item-meta">
                                    <span class="badge" :class="neg.agreement ? 'badge-success' : 'badge-warning'" x-text="neg.agreement ? 'Agreement' : 'No Agreement'"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </aside>
            
            <!-- Content Area - Negotiations -->
            <main class="content-area" x-show="currentPage === 'negotiations'">
                {% block content %}{% endblock %}
            </main>
            
            <!-- Content Area - Scenario Explorer -->
            <div class="content-area scenario-explorer" x-show="currentPage === 'scenarios'" x-cloak>
                <div class="scenario-explorer-layout">
                    <!-- Left Panel: Filters & List -->
                    <div class="scenario-explorer-list">
                        <div class="scenario-explorer-header">
                            <h2>Scenario Explorer</h2>
                        </div>
                        
                        <div class="scenario-explorer-filters">
                            <div class="form-group">
                                <input type="text" class="form-input" placeholder="Search scenarios..." 
                                       x-model="explorerSearch" @input.debounce.300ms="filterExplorerScenarios()">
                            </div>
                            <div class="form-group">
                                <select class="form-select" x-model="explorerSourceFilter" @change="filterExplorerScenarios()">
                                    <option value="">All Sources</option>
                                    <template x-for="source in sources" :key="source.id">
                                        <option :value="source.id" x-text="source.name + ' (' + source.count + ')'"></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                        
                        <div class="scenario-explorer-results">
                            <div class="text-muted" style="padding: 12px; font-size: 13px;" x-show="explorerLoading">
                                Loading scenarios...
                            </div>
                            <div class="text-muted" style="padding: 12px; font-size: 13px;" x-show="!explorerLoading && filteredExplorerScenarios.length === 0">
                                No scenarios found
                            </div>
                            <template x-for="scenario in filteredExplorerScenarios" :key="scenario.path">
                                <div class="scenario-explorer-item" 
                                     :class="{ selected: selectedScenario?.path === scenario.path }"
                                     @click="selectScenarioForExplorer(scenario)">
                                    <div class="scenario-explorer-item-name" x-text="scenario.name"></div>
                                    <div class="scenario-explorer-item-meta">
                                        <span class="badge badge-secondary" x-text="scenario.source"></span>
                                        <span x-text="scenario.n_negotiators + ' parties'"></span>
                                        <span x-text="(scenario.issues?.length || scenario.n_issues || '?') + ' issues'"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Right Panel: Scenario Details -->
                    <div class="scenario-explorer-details">
                        <template x-if="!selectedScenario">
                            <div class="scenario-explorer-empty">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="64" height="64" style="opacity: 0.3;">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10 9 9 9 8 9"></polyline>
                                </svg>
                                <p>Select a scenario to view details</p>
                            </div>
                        </template>
                        <template x-if="selectedScenario">
                            <div class="scenario-detail-view">
                                <div class="scenario-detail-header">
                                    <h2 x-text="selectedScenario.name"></h2>
                                    <div class="scenario-detail-actions">
                                        <button class="btn btn-primary btn-sm" @click="useScenarioInNegotiation(selectedScenario)">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                            </svg>
                                            Use in Negotiation
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="scenario-detail-content">
                                    <div class="scenario-detail-section">
                                        <h3>Overview</h3>
                                        <div class="scenario-detail-grid">
                                            <div class="scenario-detail-stat">
                                                <span class="stat-label">Source</span>
                                                <span class="stat-value" x-text="selectedScenario.source"></span>
                                            </div>
                                            <div class="scenario-detail-stat">
                                                <span class="stat-label">Parties</span>
                                                <span class="stat-value" x-text="selectedScenario.n_negotiators"></span>
                                            </div>
                                            <div class="scenario-detail-stat">
                                                <span class="stat-label">Issues</span>
                                                <span class="stat-value" x-text="selectedScenario.issues?.length || selectedScenario.n_issues || '?'"></span>
                                            </div>
                                            <div class="scenario-detail-stat">
                                                <span class="stat-label">Outcomes</span>
                                                <span class="stat-value" x-text="selectedScenario.n_outcomes || '?'"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="scenario-detail-section">
                                        <h3>Issues</h3>
                                        <div class="scenario-issues-list">
                                            <template x-for="issue in (selectedScenario.issues || [])" :key="issue.name">
                                                <div class="scenario-issue-item">
                                                    <div class="issue-name" x-text="issue.name"></div>
                                                    <div class="issue-type">
                                                        <span class="badge badge-neutral" x-text="issue.type"></span>
                                                    </div>
                                                    <div class="issue-values" x-show="issue.values">
                                                        <template x-if="issue.values && issue.values.length <= 10">
                                                            <span class="text-muted" x-text="issue.values.join(', ')"></span>
                                                        </template>
                                                        <template x-if="issue.values && issue.values.length > 10">
                                                            <span class="text-muted" x-text="issue.values.slice(0, 10).join(', ') + '... (' + issue.values.length + ' total)'"></span>
                                                        </template>
                                                    </div>
                                                    <div class="issue-range" x-show="issue.min !== undefined">
                                                        <span class="text-muted" x-text="'Range: ' + issue.min + ' - ' + issue.max"></span>
                                                    </div>
                                                </div>
                                            </template>
                                            <div class="text-muted" x-show="!selectedScenario.issues || selectedScenario.issues.length === 0" style="padding: 8px 0;">
                                                Issue details not available
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="scenario-detail-section">
                                        <h3>Path</h3>
                                        <div class="scenario-path">
                                            <code x-text="selectedScenario.path"></code>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Start Negotiation Modal -->
    <div class="modal-overlay" :class="{ active: showNewNegotiation }" @click.self="showNewNegotiation = false">
        <div class="modal large">
            <div class="modal-header">
                <h2 class="modal-title">Start New Negotiation</h2>
                <div class="modal-header-actions">
                    <!-- Recent Sessions Dropdown -->
                    <div class="dropdown" x-data="{ open: false }">
                        <button class="btn btn-sm btn-secondary" @click="open = !open; loadRecentSessions()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            Recent
                        </button>
                        <div class="dropdown-menu" x-show="open" @click.away="open = false" style="right: 0; min-width: 280px;">
                            <template x-if="recentSessions.length === 0">
                                <div class="dropdown-item text-muted">No recent sessions</div>
                            </template>
                            <template x-for="session in recentSessions" :key="session.name + session.last_used_at">
                                <div class="dropdown-item" @click="loadFullSession(session); open = false">
                                    <div class="font-medium" x-text="session.scenario_name"></div>
                                    <div class="text-muted" style="font-size: 11px;" x-text="session.negotiators.map(n => n.name).join(' vs ')"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                    <!-- Saved Sessions Dropdown -->
                    <div class="dropdown" x-data="{ open: false }">
                        <button class="btn btn-sm btn-secondary" @click="open = !open; loadSessionPresets()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                            Load
                        </button>
                        <div class="dropdown-menu" x-show="open" @click.away="open = false" style="right: 0; min-width: 280px;">
                            <template x-if="sessionPresets.length === 0">
                                <div class="dropdown-item text-muted">No saved sessions</div>
                            </template>
                            <template x-for="preset in sessionPresets" :key="preset.name">
                                <div class="dropdown-item" style="display: flex; justify-content: space-between; align-items: center;">
                                    <div @click="loadFullSession(preset); open = false" style="flex: 1; cursor: pointer;">
                                        <div class="font-medium" x-text="preset.name"></div>
                                        <div class="text-muted" style="font-size: 11px;" x-text="preset.scenario_name"></div>
                                    </div>
                                    <button class="btn-icon-sm" @click.stop="deleteSessionPreset(preset.name)" title="Delete">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>
                    <!-- Save Session Button -->
                    <button class="btn btn-sm btn-primary" @click="showSaveSessionModal = true" :disabled="!newNeg.scenario">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        Save
                    </button>
                </div>
                <button class="modal-close" @click="showNewNegotiation = false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body" style="padding: 0;">
                <!-- Wizard Layout with Vertical Tabs -->
                <div class="wizard-layout">
                    <!-- Vertical Sidebar Tabs -->
                    <div class="wizard-sidebar">
                        <button class="wizard-tab" :class="{ active: negotiationTab === 'scenario', completed: newNeg.scenario }" @click="negotiationTab = 'scenario'" title="Scenario">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                            <span class="wizard-tab-label">Scenario</span>
                        </button>
                        <button class="wizard-tab" :class="{ active: negotiationTab === 'negotiators', completed: newNeg.negotiators.length >= (newNeg.scenario?.n_negotiators || 2) }" @click="negotiationTab = 'negotiators'" title="Negotiators">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            <span class="wizard-tab-label">Negotiators</span>
                        </button>
                        <button class="wizard-tab" :class="{ active: negotiationTab === 'parameters' }" @click="negotiationTab = 'parameters'" title="Parameters">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                            </svg>
                            <span class="wizard-tab-label">Params</span>
                        </button>
                        <button class="wizard-tab" :class="{ active: negotiationTab === 'panels' }" @click="negotiationTab = 'panels'" title="Panels">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                            <span class="wizard-tab-label">Panels</span>
                        </button>
                        <button class="wizard-tab" :class="{ active: negotiationTab === 'display' }" @click="negotiationTab = 'display'" title="Display & Run">
                            <svg class="wizard-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                            <span class="wizard-tab-label">Run</span>
                        </button>
                    </div>
                    
                    <!-- Tab Content -->
                    <div class="wizard-content">
                
                <!-- Tab: Scenario Selection -->
                <div x-show="negotiationTab === 'scenario'">
                    <div class="form-group">
                        <label class="form-label">Search Scenarios</label>
                        <input type="text" class="form-input" placeholder="Type to search all scenarios..." x-model="scenarioSearch" @input="searchScenarios()">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Filter by Source <span class="text-muted">(optional)</span></label>
                        <select class="form-select" x-model="newNeg.source" @change="filterBySource()">
                            <option value="">All sources</option>
                            <template x-for="source in sources" :key="source">
                                <option :value="source" x-text="source"></option>
                            </template>
                        </select>
                    </div>
                    
                    <div class="form-group" x-show="filteredScenarios.length > 0 || scenarioSearch || newNeg.source">
                        <label class="form-label">
                            Select Scenario 
                            <span class="text-muted" x-text="'(' + filteredScenarios.length + ' found)'"></span>
                        </label>
                        <div class="scenario-grid" style="max-height: 300px; overflow-y: auto;">
                            <template x-for="scenario in filteredScenarios" :key="scenario.path">
                                <div class="scenario-card" 
                                     :class="{ selected: newNeg.scenario?.path === scenario.path }"
                                     @click="selectScenario(scenario)">
                                    <div class="scenario-card-title" x-text="scenario.name"></div>
                                    <div class="scenario-card-meta">
                                        <span class="badge badge-neutral" x-text="scenario.source"></span>
                                        <span x-text="scenario.n_negotiators + ' parties'"></span>
                                        <span x-text="scenario.issues?.length + ' issues'"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <template x-if="filteredScenarios.length === 0 && (scenarioSearch || newNeg.source)">
                            <p class="text-muted" style="padding: 16px; text-align: center;">No scenarios found</p>
                        </template>
                    </div>
                    
                    <div class="form-group" x-show="!scenarioSearch && !newNeg.source && filteredScenarios.length === 0">
                        <p class="text-muted" style="padding: 16px; text-align: center;">Start typing to search scenarios, or select a source to browse</p>
                    </div>
                    
                    <!-- Selected Scenario Details -->
                    <div class="form-group" x-show="newNeg.scenario">
                        <label class="form-label">Scenario Details</label>
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                            <div class="font-semibold mb-2" x-text="newNeg.scenario?.name"></div>
                            <div class="text-secondary" style="font-size: 13px;">
                                <div><strong>Issues:</strong></div>
                                <template x-for="issue in newNeg.scenario?.issues || []" :key="issue.name">
                                    <div style="margin-left: 12px; margin-top: 4px;">
                                        <span x-text="issue.name"></span>
                                        <span class="text-muted" x-text="'(' + issue.type + ')'"></span>
                                        <template x-if="issue.values">
                                            <span class="text-muted" x-text="': ' + issue.values.slice(0, 5).join(', ') + (issue.values.length > 5 ? '...' : '')"></span>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scenario Loading Options -->
                    <div class="form-group" x-show="newNeg.scenario">
                        <label class="form-label">Utility Function Options</label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label class="checkbox-label">
                                <input type="checkbox" x-model="newNeg.ignore_discount">
                                <span>Ignore discount factors</span>
                                <span class="text-muted" style="font-size: 12px; margin-left: 4px;">(use stationary utilities)</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" x-model="newNeg.ignore_reserved">
                                <span>Ignore reserved values</span>
                                <span class="text-muted" style="font-size: 12px; margin-left: 4px;">(set to -infinity)</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Negotiators -->
                <div x-show="negotiationTab === 'negotiators'">
                    <!-- Sub-tabs for negotiator selection mode -->
                    <div class="tabs" style="margin-bottom: 16px;">
                        <button class="tab" :class="{ active: negotiatorSubTab === 'preset' }" @click="negotiatorSubTab = 'preset'">Preset Agents</button>
                        <button class="tab" :class="{ active: negotiatorSubTab === 'boa' }" @click="negotiatorSubTab = 'boa'; loadBOAComponents()">Build Custom (BOA)</button>
                    </div>
                    
                    <!-- Assigned Negotiators (shown in both modes) -->
                    <div class="form-group">
                        <label class="form-label">
                            Assigned Negotiators 
                            <span class="text-muted" x-text="'(' + newNeg.negotiators.length + '/' + (newNeg.scenario?.n_negotiators || 2) + ' required)'"></span>
                        </label>
                        
                        <div class="negotiator-list" x-ref="negotiatorList">
                            <template x-for="(neg, index) in newNeg.negotiators" :key="index">
                                <div class="negotiator-item" 
                                     :data-index="index"
                                     :class="{ 'selected': selectedNegotiatorSlot === index }"
                                     @click="selectedNegotiatorSlot = index"
                                     :style="selectedNegotiatorSlot === index ? 'border-color: var(--primary); background: var(--bg-tertiary);' : ''">
                                    <div class="drag-handle">
                                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                            <circle cx="9" cy="6" r="1.5"/>
                                            <circle cx="15" cy="6" r="1.5"/>
                                            <circle cx="9" cy="12" r="1.5"/>
                                            <circle cx="15" cy="12" r="1.5"/>
                                            <circle cx="9" cy="18" r="1.5"/>
                                            <circle cx="15" cy="18" r="1.5"/>
                                        </svg>
                                    </div>
                                    <div class="negotiator-item-content">
                                        <input type="text" class="negotiator-name-input" x-model="neg.name" @click.stop placeholder="Agent name">
                                        <div class="negotiator-type" x-text="getNegotiatorDisplayName(neg.type_name)"></div>
                                        <span class="badge" :class="getSourceBadgeClass(neg.source)" x-text="neg.source" style="font-size: 10px;"></span>
                                    </div>
                                    <button class="btn btn-icon btn-sm" @click.stop="removeNegotiator(index)" :disabled="newNeg.negotiators.length <= 2" title="Remove">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>
                        <div class="text-muted" style="font-size: 12px; margin-top: 8px;">
                            Click a slot to select it, then choose a negotiator below
                        </div>
                    </div>
                    
                    <!-- Sub-tab: Preset Negotiators -->
                    <div x-show="negotiatorSubTab === 'preset'">
                        <div class="form-group">
                            <label class="form-label">Search Negotiators</label>
                            <input type="text" class="form-input" placeholder="Type to search all negotiators..." x-model="negotiatorSearch" @input="searchNegotiators()">
                        </div>
                        
                        <div class="form-row" style="gap: 12px;">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Filter by Source <span class="text-muted">(optional)</span></label>
                                <select class="form-select" x-model="negotiatorSourceFilter" @change="filterNegotiators()">
                                    <option value="">All sources</option>
                                    <template x-for="source in negotiatorSources" :key="source.id">
                                        <option :value="source.id" x-text="source.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;" x-show="negotiatorSourceFilter === 'genius'">
                                <label class="form-label">Filter by Year <span class="text-muted">(optional)</span></label>
                                <select class="form-select" x-model="negotiatorGroupFilter" @change="filterNegotiators()">
                                    <option value="">All years</option>
                                    <option value="y2019">ANAC 2019</option>
                                    <option value="y2018">ANAC 2018</option>
                                    <option value="y2017">ANAC 2017</option>
                                    <option value="y2016">ANAC 2016</option>
                                    <option value="y2015">ANAC 2015</option>
                                    <option value="y2014">ANAC 2014</option>
                                    <option value="y2013">ANAC 2013</option>
                                    <option value="y2012">ANAC 2012</option>
                                    <option value="y2011">ANAC 2011</option>
                                    <option value="y2010">ANAC 2010</option>
                                    <option value="basic">Basic</option>
                                    <option value="others">Others</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Available Negotiators <span class="text-muted" x-text="'(' + filteredNegotiators.length + ' found)'"></span></label>
                            <div class="negotiator-grid" style="max-height: 250px; overflow-y: auto;">
                                <template x-for="neg in filteredNegotiators" :key="neg.type_name">
                                    <div class="negotiator-card" @click="selectNegotiatorForSlot(neg)">
                                        <div class="negotiator-card-name" x-text="neg.name"></div>
                                        <div class="negotiator-card-meta">
                                            <span class="badge" :class="getSourceBadgeClass(neg.source)" x-text="neg.source"></span>
                                        </div>
                                        <div class="negotiator-card-desc" x-text="neg.description" x-show="neg.description"></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sub-tab: BOA (Build Custom) Negotiators -->
                    <div x-show="negotiatorSubTab === 'boa'">
                        <div class="boa-builder" style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                            <div class="form-group">
                                <label class="form-label">Acceptance Policy <span class="text-danger">*</span></label>
                                <select class="form-select" x-model="boaConfig.acceptance_policy">
                                    <option value="">Select acceptance policy...</option>
                                    <template x-for="c in boaComponents.acceptance" :key="c.name">
                                        <option :value="c.name" x-text="c.name"></option>
                                    </template>
                                </select>
                                <div class="form-hint" x-text="getBoaComponentDescription('acceptance', boaConfig.acceptance_policy)"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Offering Policy <span class="text-danger">*</span></label>
                                <select class="form-select" x-model="boaConfig.offering_policy">
                                    <option value="">Select offering policy...</option>
                                    <template x-for="c in boaComponents.offering" :key="c.name">
                                        <option :value="c.name" x-text="c.name"></option>
                                    </template>
                                </select>
                                <div class="form-hint" x-text="getBoaComponentDescription('offering', boaConfig.offering_policy)"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Opponent Model <span class="text-muted">(optional)</span></label>
                                <select class="form-select" x-model="boaConfig.opponent_model">
                                    <option value="">None (no opponent modeling)</option>
                                    <template x-for="c in boaComponents.model" :key="c.name">
                                        <option :value="c.name" x-text="c.name"></option>
                                    </template>
                                </select>
                                <div class="form-hint" x-text="getBoaComponentDescription('model', boaConfig.opponent_model)"></div>
                            </div>
                            
                            <button class="btn btn-primary" 
                                    @click="applyBOAToSlot()" 
                                    :disabled="!boaConfig.acceptance_policy || !boaConfig.offering_policy">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                Apply to Selected Slot
                            </button>
                        </div>
                        
                        <div class="text-muted" style="font-size: 12px; margin-top: 12px;">
                            <strong>BOA Architecture:</strong> Build modular negotiators by combining acceptance, offering, and opponent modeling components.
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Parameters -->
                <div x-show="negotiationTab === 'parameters'">
                    <!-- Mechanism Type Selector -->
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label class="form-label">Mechanism Protocol</label>
                        <div class="card-selector">
                            <template x-for="mech in mechanisms" :key="mech.class_name">
                                <button type="button" class="card-selector-option" 
                                        :class="{ selected: newNeg.mechanism_type === mech.class_name }"
                                        @click="selectMechanism(mech.class_name)">
                                    <div class="card-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <template x-if="mech.class_name === 'SAOMechanism'">
                                                <g>
                                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                                    <circle cx="9" cy="7" r="4"></circle>
                                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                                </g>
                                            </template>
                                            <template x-if="mech.class_name === 'TAUMechanism'">
                                                <g>
                                                    <line x1="8" y1="6" x2="21" y2="6"></line>
                                                    <line x1="8" y1="12" x2="21" y2="12"></line>
                                                    <line x1="8" y1="18" x2="21" y2="18"></line>
                                                    <line x1="3" y1="6" x2="3.01" y2="6"></line>
                                                    <line x1="3" y1="12" x2="3.01" y2="12"></line>
                                                    <line x1="3" y1="18" x2="3.01" y2="18"></line>
                                                </g>
                                            </template>
                                            <template x-if="mech.class_name === 'GBMechanism'">
                                                <g>
                                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                    <line x1="3" y1="9" x2="21" y2="9"></line>
                                                    <line x1="9" y1="21" x2="9" y2="9"></line>
                                                </g>
                                            </template>
                                            <template x-if="mech.class_name.includes('ST')">
                                                <g>
                                                    <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                                    <path d="M2 17l10 5 10-5"></path>
                                                    <path d="M2 12l10 5 10-5"></path>
                                                </g>
                                            </template>
                                        </svg>
                                    </div>
                                    <span class="card-title" x-text="mech.class_name.replace('Mechanism', '')"></span>
                                    <span class="card-desc" x-text="mech.name.split('(')[0].trim()"></span>
                                </button>
                            </template>
                        </div>
                        <div class="form-hint mt-2" x-text="selectedMechanism?.description || ''"></div>
                    </div>
                    
                    <!-- Information Sharing -->
                    <div class="form-group">
                        <label class="form-checkbox"><input type="checkbox" x-model="newNeg.share_ufuns"><span>Share utility functions</span></label>
                        <div class="form-inline-hint">Give each negotiator access to opponent's utility function</div>
                    </div>
                    
                    <!-- Dynamic Parameter Groups -->
                    <template x-if="selectedMechanism">
                        <div>
                            <template x-for="group in selectedMechanism.param_groups" :key="group.id">
                                <div class="param-group" x-data="{ collapsed: group.order > 2 }">
                                    <div class="param-group-header" @click="collapsed = !collapsed">
                                        <span class="param-group-title" x-text="group.label"></span>
                                        <svg class="param-group-chevron" :class="{ collapsed }" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                    </div>
                                    <div class="param-group-content" x-show="!collapsed" x-collapse>
                                        <template x-for="param in group.params" :key="param.name">
                                            <div class="form-group">
                                                <!-- Boolean parameters -->
                                                <template x-if="param.type === 'bool'">
                                                    <div>
                                                        <label class="form-checkbox">
                                                            <input type="checkbox" 
                                                                   :checked="newNeg.mechanism_params[param.name]"
                                                                   @change="newNeg.mechanism_params[param.name] = $event.target.checked">
                                                            <span x-text="param.name.replace(/_/g, ' ')"></span>
                                                        </label>
                                                        <div class="form-inline-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- Integer parameters -->
                                                <template x-if="param.type === 'int'">
                                                    <div>
                                                        <label class="form-label" x-text="param.name.replace(/_/g, ' ')"></label>
                                                        <input type="number" class="form-input" style="max-width: 150px;"
                                                               :value="newNeg.mechanism_params[param.name]"
                                                               @input="newNeg.mechanism_params[param.name] = $event.target.value ? parseInt($event.target.value) : null"
                                                               :min="param.min_value"
                                                               :max="param.max_value"
                                                               :placeholder="param.default ?? 'None'">
                                                        <div class="form-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- Optional integer parameters -->
                                                <template x-if="param.type === 'optional_int'">
                                                    <div>
                                                        <label class="form-label" x-text="param.name.replace(/_/g, ' ')"></label>
                                                        <input type="number" class="form-input" style="max-width: 150px;"
                                                               :value="newNeg.mechanism_params[param.name]"
                                                               @input="newNeg.mechanism_params[param.name] = $event.target.value ? parseInt($event.target.value) : null"
                                                               :min="param.min_value"
                                                               :max="param.max_value"
                                                               placeholder="None">
                                                        <div class="form-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- Float parameters -->
                                                <template x-if="param.type === 'float'">
                                                    <div>
                                                        <label class="form-label" x-text="param.name.replace(/_/g, ' ')"></label>
                                                        <input type="number" class="form-input" style="max-width: 150px;" step="0.01"
                                                               :value="newNeg.mechanism_params[param.name]"
                                                               @input="newNeg.mechanism_params[param.name] = $event.target.value ? parseFloat($event.target.value) : null"
                                                               :min="param.min_value"
                                                               :max="param.max_value"
                                                               :placeholder="param.default ?? 'None'">
                                                        <div class="form-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- Optional float parameters -->
                                                <template x-if="param.type === 'optional_float'">
                                                    <div>
                                                        <label class="form-label" x-text="param.name.replace(/_/g, ' ')"></label>
                                                        <input type="number" class="form-input" style="max-width: 150px;" step="0.1"
                                                               :value="newNeg.mechanism_params[param.name]"
                                                               @input="newNeg.mechanism_params[param.name] = $event.target.value ? parseFloat($event.target.value) : null"
                                                               :min="param.min_value"
                                                               :max="param.max_value"
                                                               placeholder="None">
                                                        <div class="form-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- String parameters -->
                                                <template x-if="param.type === 'string' || param.type === 'optional_string'">
                                                    <div>
                                                        <label class="form-label" x-text="param.name.replace(/_/g, ' ')"></label>
                                                        <input type="text" class="form-input" style="max-width: 300px;"
                                                               :value="newNeg.mechanism_params[param.name]"
                                                               @input="newNeg.mechanism_params[param.name] = $event.target.value || null"
                                                               placeholder="None">
                                                        <div class="form-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- Choice parameters -->
                                                <template x-if="param.type === 'choice'">
                                                    <div>
                                                        <label class="form-label" x-text="param.name.replace(/_/g, ' ')"></label>
                                                        <select class="form-select" style="max-width: 200px;"
                                                                :value="newNeg.mechanism_params[param.name]"
                                                                @change="newNeg.mechanism_params[param.name] = $event.target.value">
                                                            <template x-for="choice in param.choices" :key="choice">
                                                                <option :value="choice" x-text="choice"></option>
                                                            </template>
                                                        </select>
                                                        <div class="form-hint" x-text="param.description"></div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
                
                <!-- Tab: Panels -->
                <div x-show="negotiationTab === 'panels'">
                    <div class="form-group">
                        <label class="form-label">Panel Configuration</label>
                        <div class="form-hint">Configure which panels to display during the negotiation</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-checkbox">
                            <input type="checkbox" x-model="newNeg.panels.adjustable">
                            <span>Adjustable panels</span>
                        </label>
                        <div class="form-inline-hint">Allow resizing panels during negotiation</div>
                    </div>
                    
                    <div class="param-group">
                        <div class="param-group-header">
                            <span class="param-group-title">Utility Space View</span>
                        </div>
                        <div class="param-group-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">X-Axis (Negotiator)</label>
                                    <select class="form-select" x-model.number="newNeg.panels.utilityView.xAxis">
                                        <template x-for="(neg, idx) in newNeg.negotiators" :key="idx">
                                            <option :value="idx" x-text="neg.name || ('Agent ' + (idx + 1))"></option>
                                        </template>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Y-Axis (Negotiator)</label>
                                    <select class="form-select" x-model.number="newNeg.panels.utilityView.yAxis">
                                        <template x-for="(neg, idx) in newNeg.negotiators" :key="idx">
                                            <option :value="idx" x-text="neg.name || ('Agent ' + (idx + 1))"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="param-group">
                        <div class="param-group-header">
                            <span class="param-group-title">Timeline View</span>
                        </div>
                        <div class="param-group-content">
                            <div class="form-group">
                                <label class="form-label">X-Axis</label>
                                <select class="form-select" x-model="newNeg.panels.timeline.xAxis" style="max-width: 200px;">
                                    <option value="step">Step</option>
                                    <option value="time">Time</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Display & Run -->
                <div x-show="negotiationTab === 'display'">
                    <div class="form-group">
                        <label class="form-label">Summary</label>
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                            <div><strong>Scenario:</strong> <span x-text="newNeg.scenario?.name || 'Not selected'"></span></div>
                            <div><strong>Negotiators:</strong> <span x-text="newNeg.negotiators.map(n => getNegotiatorDisplayName(n.type_name)).join(' vs ')"></span></div>
                            <div><strong>Mechanism:</strong> <span x-text="newNeg.mechanism_type.replace('Mechanism', '')"></span></div>
                            <div><strong>Deadline:</strong> <span x-text="getDeadlineSummary()"></span></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Run Mode</label>
                        <div class="card-selector compact">
                            <button type="button" class="card-selector-option" :class="{ selected: newNeg.mode === 'realtime' }" @click="newNeg.mode = 'realtime'">
                                <div class="card-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                    </svg>
                                </div>
                                <div class="card-content">
                                    <span class="card-title">Real-time</span>
                                    <span class="card-desc">Watch step-by-step with live updates</span>
                                </div>
                            </button>
                            <button type="button" class="card-selector-option" :class="{ selected: newNeg.mode === 'batch' }" @click="newNeg.mode = 'batch'">
                                <div class="card-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="13 17 18 12 13 7"></polyline>
                                        <polyline points="6 17 11 12 6 7"></polyline>
                                    </svg>
                                </div>
                                <div class="card-content">
                                    <span class="card-title">Batch</span>
                                    <span class="card-desc">Run instantly and show results</span>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group" x-show="newNeg.mode === 'realtime'">
                        <label class="form-label">Step Delay: <span x-text="newNeg.step_delay + 'ms'"></span></label>
                        <input type="range" class="form-range" x-model.number="newNeg.step_delay" min="0" max="1000" step="50">
                        <div class="form-hint">Delay between steps for visualization</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-checkbox"><input type="checkbox" x-model="newNeg.show_plot"><span>Show live utility plot</span></label>
                        </div>
                        <div class="form-group">
                            <label class="form-checkbox"><input type="checkbox" x-model="newNeg.show_offers"><span>Show offer history</span></label>
                        </div>
                    </div>
                </div>
                    </div><!-- end wizard-content -->
                </div><!-- end wizard-layout -->
            </div><!-- end modal-body -->
            
            <div class="modal-footer">
                <button class="btn btn-secondary" @click="showNewNegotiation = false">Cancel</button>
                <template x-if="negotiationTab !== 'scenario'">
                    <button class="btn btn-secondary" @click="prevNegotiationTab()">Back</button>
                </template>
                <template x-if="negotiationTab !== 'display'">
                    <button class="btn btn-primary" @click="nextNegotiationTab()" :disabled="!canProceed">
                        Next
                    </button>
                </template>
                <template x-if="negotiationTab === 'display'">
                    <button class="btn btn-primary" @click="startNegotiation()" :disabled="!canStart">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        <span x-text="newNeg.auto_start ? 'Start Negotiation' : 'Open Negotiation'"></span>
                    </button>
                </template>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-overlay" :class="{ active: showSettings }" @click.self="showSettings = false">
        <div class="modal large">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="modal-close" @click="showSettings = false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body" style="padding: 0;">
                <div class="settings-layout">
                    <div class="settings-sidebar">
                        <div class="settings-nav">
                            <button class="settings-nav-item" :class="{ active: settingsTab === 'general' }" @click="settingsTab = 'general'">General</button>
                            <button class="settings-nav-item" :class="{ active: settingsTab === 'negotiation' }" @click="settingsTab = 'negotiation'">Negotiation</button>
                            <button class="settings-nav-item" :class="{ active: settingsTab === 'sources' }" @click="settingsTab = 'sources'; loadSourceSettings()">Negotiator Sources</button>
                            <button class="settings-nav-item" :class="{ active: settingsTab === 'genius' }" @click="settingsTab = 'genius'">Genius Bridge</button>
                            <button class="settings-nav-item" :class="{ active: settingsTab === 'paths' }" @click="settingsTab = 'paths'">Custom Paths</button>
                        </div>
                    </div>
                    
                    <div class="settings-content">
                        <div x-show="settingsTab === 'general'">
                            <h3 class="font-semibold mb-4">General Settings</h3>
                            
                            <!-- Theme Section -->
                            <div class="settings-section">
                                <h4 class="settings-section-title">Theme</h4>
                                <div class="form-group">
                                    <label class="form-checkbox">
                                        <input type="checkbox" x-model="settings.darkMode" @change="toggleDarkMode()">
                                        <span>Dark Mode</span>
                                    </label>
                                    <div class="form-hint">Use dark color scheme</div>
                                </div>
                            </div>
                            
                            <!-- Accessibility Section -->
                            <div class="settings-section">
                                <h4 class="settings-section-title">Accessibility</h4>
                                <div class="form-group">
                                    <label class="form-checkbox">
                                        <input type="checkbox" x-model="settings.colorBlindMode" @change="toggleColorBlindMode()">
                                        <span>Color Blind Mode</span>
                                    </label>
                                    <div class="form-hint">Use color-blind friendly palette with distinct line styles and markers</div>
                                </div>
                                <div class="color-palette-preview" x-show="settings.colorBlindMode">
                                    <div class="palette-label">Color-blind friendly palette:</div>
                                    <div class="palette-colors">
                                        <span class="color-swatch" style="background: #0072B2;" title="Blue"></span>
                                        <span class="color-swatch" style="background: #E69F00;" title="Orange"></span>
                                        <span class="color-swatch" style="background: #009E73;" title="Bluish Green"></span>
                                        <span class="color-swatch" style="background: #CC79A7;" title="Reddish Purple"></span>
                                        <span class="color-swatch" style="background: #F0E442;" title="Yellow"></span>
                                        <span class="color-swatch" style="background: #56B4E9;" title="Sky Blue"></span>
                                        <span class="color-swatch" style="background: #D55E00;" title="Vermillion"></span>
                                        <span class="color-swatch" style="background: #000000;" title="Black"></span>
                                    </div>
                                    <div class="palette-note">Charts will also use different line styles and markers</div>
                                </div>
                            </div>
                        </div>
                        
                        <div x-show="settingsTab === 'negotiation'">
                            <h3 class="font-semibold mb-4">Default Negotiation Settings</h3>
                            <div class="form-group">
                                <label class="form-label">Default Max Steps</label>
                                <input type="number" class="form-input" x-model.number="settings.defaultSteps">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default Step Delay (ms)</label>
                                <input type="number" class="form-input" x-model.number="settings.defaultDelay">
                            </div>
                        </div>
                        
                        <div x-show="settingsTab === 'sources'">
                            <h3 class="font-semibold mb-4">Negotiator Sources</h3>
                            <p class="text-secondary mb-4" style="font-size: 13px;">
                                Enable or disable negotiator sources. Disabled sources won't appear in the negotiator selection.
                            </p>
                            
                            <div class="source-toggle-list">
                                <template x-for="source in sourceSettingsList" :key="source.id">
                                    <div class="source-toggle-item">
                                        <div class="source-toggle-info">
                                            <div class="source-toggle-name" x-text="source.name"></div>
                                            <div class="source-toggle-desc" x-text="source.description"></div>
                                            <div class="source-toggle-status">
                                                <template x-if="source.available">
                                                    <span class="text-success" x-text="source.count + ' negotiators available'"></span>
                                                </template>
                                                <template x-if="!source.available">
                                                    <span class="text-muted" x-text="source.unavailable_reason || 'Not installed'"></span>
                                                </template>
                                            </div>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" 
                                                   :checked="!sourceSettings.disabled_sources.includes(source.id)" 
                                                   :disabled="!source.available"
                                                   @change="toggleSource(source.id)">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </template>
                            </div>
                            
                            <div class="mt-4">
                                <button class="btn btn-secondary" @click="refreshNegotiators()" :disabled="refreshingNegotiators">
                                    <template x-if="refreshingNegotiators">
                                        <span class="spinner" style="width: 14px; height: 14px;"></span>
                                    </template>
                                    <template x-if="!refreshingNegotiators">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <path d="M23 4v6h-6"></path>
                                            <path d="M1 20v-6h6"></path>
                                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                        </svg>
                                    </template>
                                    Refresh Sources
                                </button>
                                <span class="text-muted" style="margin-left: 12px; font-size: 12px;">Re-scan for available negotiators</span>
                            </div>
                        </div>
                        
                        <div x-show="settingsTab === 'genius'">
                            <h3 class="font-semibold mb-4">Genius Bridge</h3>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span class="badge" :class="geniusBridge.running ? 'badge-success' : 'badge-neutral'" x-text="geniusBridge.running ? 'Running' : 'Stopped'"></span>
                                    <button class="btn btn-secondary" @click="toggleGeniusBridge()" x-text="geniusBridge.running ? 'Stop' : 'Start'"></button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" x-model="settings.autoStartGenius">
                                    <span>Auto-start when needed</span>
                                </label>
                            </div>
                        </div>
                        
                        <div x-show="settingsTab === 'paths'">
                            <h3 class="font-semibold mb-4">Custom Paths</h3>
                            <div class="form-group">
                                <label class="form-label">Additional Scenario Paths</label>
                                <textarea class="form-textarea" placeholder="One path per line..." x-model="settings.scenarioPaths"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Additional Negotiator Paths</label>
                                <textarea class="form-textarea" placeholder="One path per line..." x-model="settings.negotiatorPaths"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" @click="showSettings = false">Close</button>
                <button class="btn btn-primary" @click="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Save Session Preset Modal -->
    <div class="modal-overlay" :class="{ active: showSaveSessionModal }" @click.self="showSaveSessionModal = false">
        <div class="modal small">
            <div class="modal-header">
                <h2 class="modal-title">Save Session</h2>
                <button class="modal-close" @click="showSaveSessionModal = false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Preset Name</label>
                    <input type="text" class="form-input" placeholder="My Negotiation Setup" x-model="savePresetName" @keyup.enter="saveFullSession()">
                    <div class="form-hint">Give this configuration a memorable name</div>
                </div>
                <div class="form-group" x-show="newNeg.scenario">
                    <label class="form-label">Configuration Summary</label>
                    <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; font-size: 13px;">
                        <div><strong>Scenario:</strong> <span x-text="newNeg.scenario?.name"></span></div>
                        <div><strong>Negotiators:</strong> <span x-text="newNeg.negotiators.map(n => getNegotiatorDisplayName(n.type_name)).join(' vs ')"></span></div>
                        <div><strong>Steps:</strong> <span x-text="newNeg.n_steps || 'No limit'"></span></div>
                        <div><strong>Mode:</strong> <span x-text="newNeg.mode === 'realtime' ? 'Real-time' : 'Batch'"></span></div>
                    </div>
                </div>
                    </div><!-- end wizard-content -->
                </div><!-- end wizard-layout -->
            
            <div class="modal-footer">
                <button class="btn btn-secondary" @click="showSaveSessionModal = false">Cancel</button>
                <button class="btn btn-primary" @click="saveFullSession()" :disabled="!savePresetName.trim()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save
                </button>
            </div>
        </div>
    </div>
    
    <script>
    function app() {
        return {
            // Connection status
            connected: true,
            
            // Sidebar state
            sidebarCollapsed: localStorage.getItem('sidebarCollapsed') === 'true',
            
            // Modal states
            showNewNegotiation: false,
            showSettings: false,
            
            // Page state (negotiations, scenarios)
            currentPage: 'negotiations',
            
            // Tabs
            negotiationTab: 'scenario',
            settingsTab: 'general',
            paramSubTab: 'deadline',
            negotiatorSubTab: 'preset',
            
            // Parameter group collapse states
            showAdvancedDeadline: false,
            showCommonParams: false,
            showSAOResponse: true,
            showSAOOffers: false,
            showSAOSemantics: false,
            showSAOAdvanced: false,
            showTAUBasic: true,
            showTAUAdvanced: false,
            showGBBasic: true,
            showGBOffers: false,
            
            // Data
            sources: [],
            scenarios: [],
            scenarioSearch: '',
            negotiatorTypes: [],
            negotiatorSources: [],
            negotiatorSearch: '',
            negotiatorSourceFilter: '',
            negotiatorGroupFilter: '',
            selectedNegotiatorSlot: 0,
            
            // Mechanism data (loaded from API)
            mechanisms: [],
            selectedMechanism: null,
            
            // BOA (Build Custom) negotiator config
            boaComponents: {
                acceptance: [],
                offering: [],
                model: []
            },
            boaConfig: {
                acceptance_policy: '',
                offering_policy: '',
                opponent_model: ''
            },
            
            // Scenario Explorer state
            explorerScenarios: [],
            explorerSearch: '',
            explorerSourceFilter: '',
            selectedScenario: null,
            explorerLoading: false,
            
            // Running/completed negotiations
            runningNegotiations: [],
            completedNegotiations: [],
            currentNegotiation: null,
            
            // New negotiation form
            newNeg: {
                source: '',
                scenario: null,
                negotiators: [
                    { type_name: 'AspirationNegotiator', name: 'Agent1' },
                    { type_name: 'BoulwareTBNegotiator', name: 'Agent2' }
                ],
                // Scenario loading options
                ignore_discount: false,
                ignore_reserved: false,
                // Mechanism type (class name)
                mechanism_type: 'SAOMechanism',
                // Dynamic mechanism params (populated from API)
                mechanism_params: {},
                // Information sharing
                share_ufuns: false,
                // Display params
                mode: 'realtime',
                step_delay: 100,
                show_plot: true,
                show_offers: true
            },
            
            // Settings
            settings: {
                darkMode: localStorage.getItem('darkMode') === 'true',
                colorBlindMode: localStorage.getItem('colorBlindMode') === 'true',
                defaultSteps: 100,
                defaultDelay: 100,
                autoStartGenius: true,
                scenarioPaths: '',
                negotiatorPaths: ''
            },
            
            // Genius bridge
            geniusBridge: {
                installed: false,
                running: false,
                loading: false,
                port: 25337
            },
            
            // Negotiator source settings
            sourceSettings: {
                disabled_sources: [],
                custom_sources: []
            },
            sourceSettingsList: [],
            refreshingNegotiators: false,
            
            // Preset management
            recentSessions: [],
            sessionPresets: [],
            showSaveSessionModal: false,
            savePresetName: '',
            
            // Computed
            get filteredScenarios() {
                let results = this.scenarios;
                
                // Filter by source if selected
                if (this.newNeg.source) {
                    results = results.filter(s => s.source === this.newNeg.source);
                }
                
                // Filter by search term
                if (this.scenarioSearch) {
                    const search = this.scenarioSearch.toLowerCase();
                    results = results.filter(s => 
                        s.name.toLowerCase().includes(search) ||
                        s.source.toLowerCase().includes(search)
                    );
                }
                
                return results;
            },
            
            get filteredNegotiators() {
                let results = this.negotiatorTypes;
                
                // Filter by source if selected
                if (this.negotiatorSourceFilter) {
                    results = results.filter(n => n.source === this.negotiatorSourceFilter);
                }
                
                // Filter by group if selected (for genius)
                if (this.negotiatorGroupFilter) {
                    results = results.filter(n => n.group === this.negotiatorGroupFilter);
                }
                
                // Filter by search term
                if (this.negotiatorSearch) {
                    const search = this.negotiatorSearch.toLowerCase();
                    results = results.filter(n => 
                        n.name.toLowerCase().includes(search) ||
                        n.type_name.toLowerCase().includes(search) ||
                        (n.description && n.description.toLowerCase().includes(search))
                    );
                }
                
                return results;
            },
            
            get filteredExplorerScenarios() {
                let results = this.explorerScenarios;
                
                // Filter by source if selected
                if (this.explorerSourceFilter) {
                    results = results.filter(s => s.source === this.explorerSourceFilter);
                }
                
                // Filter by search term
                if (this.explorerSearch) {
                    const search = this.explorerSearch.toLowerCase();
                    results = results.filter(s => 
                        s.name.toLowerCase().includes(search) ||
                        s.source.toLowerCase().includes(search)
                    );
                }
                
                return results;
            },
            
            get canProceed() {
                if (this.negotiationTab === 'scenario') {
                    return this.newNeg.scenario !== null;
                }
                if (this.negotiationTab === 'negotiators') {
                    return this.newNeg.negotiators.length >= (this.newNeg.scenario?.n_negotiators || 2);
                }
                return true;
            },
            
            get canStart() {
                if (this.newNeg.scenario === null) return false;
                if (this.newNeg.negotiators.length < (this.newNeg.scenario?.n_negotiators || 2)) return false;
                // Check deadline requirement - most mechanisms need some form of limit
                if (!this.hasDeadline()) return false;
                return true;
            },
            
            // Helper methods
            hasDeadline() {
                const params = this.newNeg.mechanism_params || {};
                return (params.n_steps && params.n_steps > 0) ||
                       (params.time_limit && params.time_limit > 0) ||
                       (params.pend && params.pend > 0) ||
                       (params.pend_per_second && params.pend_per_second > 0) ||
                       (params.hidden_time_limit && params.hidden_time_limit > 0 && params.hidden_time_limit !== 'inf');
            },
            
            getDeadlineSummary() {
                const params = this.newNeg.mechanism_params || {};
                const parts = [];
                if (params.n_steps && params.n_steps > 0) {
                    parts.push(params.n_steps + ' steps');
                }
                if (params.time_limit && params.time_limit > 0) {
                    parts.push(params.time_limit + 's time');
                }
                if (params.pend && params.pend > 0) {
                    parts.push('pend=' + params.pend);
                }
                if (params.pend_per_second && params.pend_per_second > 0) {
                    parts.push('pend/s=' + params.pend_per_second);
                }
                if (params.hidden_time_limit && params.hidden_time_limit > 0 && params.hidden_time_limit !== 'inf') {
                    parts.push('hidden=' + params.hidden_time_limit + 's');
                }
                return parts.length > 0 ? parts.join(', ') : 'None';
            },
            
            getMechanismDescription(type) {
                const descriptions = {
                    sao: 'Sequential offers with acceptance/rejection. Most common protocol.',
                    tau: 'Parallel offers in multiple threads. Can run without deadline.',
                    gb: 'General game-based mechanism with configurable evaluators.'
                };
                return descriptions[type] || '';
            },
            
            // Init
            async init() {
                // Watch sidebar state
                this.$watch('sidebarCollapsed', (val) => {
                    localStorage.setItem('sidebarCollapsed', val);
                });
                
                // Load settings from backend first
                await this.loadSettings();
                
                // Apply dark mode to body (html already has it from inline script)
                if (this.settings.darkMode) {
                    document.body.classList.add('dark-mode');
                }
                await this.loadSources();
                await this.loadNegotiatorSources();
                await this.loadNegotiatorTypes();
                await this.loadMechanisms();
                // Pre-load all scenarios so search is instant
                await this.loadAllScenarios();
                this.initSortable();
                
                // Check Genius Bridge status
                await this.checkGeniusBridgeStatus();
                // Periodically check status
                setInterval(() => this.checkGeniusBridgeStatus(), 10000);
            },
            
            initSortable() {
                this.$watch('showNewNegotiation', (show) => {
                    if (show) {
                        this.$nextTick(() => {
                            const list = this.$refs.negotiatorList;
                            if (list && !list._sortable) {
                                list._sortable = new Sortable(list, {
                                    handle: '.drag-handle',
                                    animation: 150,
                                    onEnd: (evt) => {
                                        const item = this.newNeg.negotiators.splice(evt.oldIndex, 1)[0];
                                        this.newNeg.negotiators.splice(evt.newIndex, 0, item);
                                    }
                                });
                            }
                        });
                    }
                });
            },
            
            // API calls
            async loadSources() {
                try {
                    const res = await fetch('/api/scenarios/sources');
                    const data = await res.json();
                    this.sources = data.sources;
                } catch (e) {
                    console.error('Failed to load sources:', e);
                }
            },
            
            async loadAllScenarios() {
                if (this.scenarios.length > 0) return; // Already loaded
                try {
                    const res = await fetch('/api/scenarios');
                    const data = await res.json();
                    this.scenarios = data.scenarios;
                } catch (e) {
                    console.error('Failed to load scenarios:', e);
                }
            },
            
            async searchScenarios() {
                // Load all scenarios on first search
                await this.loadAllScenarios();
            },
            
            async filterBySource() {
                // Load all scenarios when filtering
                await this.loadAllScenarios();
            },
            
            // Scenario Explorer methods
            async loadScenariosForExplorer() {
                if (this.explorerScenarios.length > 0) return; // Already loaded
                this.explorerLoading = true;
                try {
                    const res = await fetch('/api/scenarios');
                    const data = await res.json();
                    this.explorerScenarios = data.scenarios;
                } catch (e) {
                    console.error('Failed to load scenarios for explorer:', e);
                } finally {
                    this.explorerLoading = false;
                }
            },
            
            selectScenarioForExplorer(scenario) {
                this.selectedScenario = scenario;
            },
            
            useScenarioInNegotiation(scenario) {
                this.currentPage = 'negotiations';
                this.openNewNegotiation();
                this.newNeg.scenario = scenario;
                this.newNeg.source = scenario.source;
                this.negotiationTab = 'negotiators';
            },
            
            filterExplorerScenarios() {
                // Reactivity handles filtering via computed property
            },
            
            async loadNegotiatorTypes() {
                try {
                    const res = await fetch('/api/negotiators');
                    const data = await res.json();
                    this.negotiatorTypes = data.negotiators;
                } catch (e) {
                    console.error('Failed to load negotiator types:', e);
                }
            },
            
            async loadNegotiatorSources() {
                try {
                    const res = await fetch('/api/negotiators/sources');
                    const data = await res.json();
                    this.negotiatorSources = data.sources;
                } catch (e) {
                    console.error('Failed to load negotiator sources:', e);
                }
            },
            
            async loadMechanisms() {
                try {
                    const res = await fetch('/api/mechanisms');
                    const data = await res.json();
                    this.mechanisms = data.mechanisms;
                    // Select SAOMechanism by default
                    this.selectMechanism('SAOMechanism');
                } catch (e) {
                    console.error('Failed to load mechanisms:', e);
                }
            },
            
            selectMechanism(className) {
                this.selectedMechanism = this.mechanisms.find(m => m.class_name === className);
                if (this.selectedMechanism) {
                    this.newNeg.mechanism_type = className;
                    // Initialize mechanism params with defaults
                    this.initMechanismParams();
                }
            },
            
            initMechanismParams() {
                if (!this.selectedMechanism) return;
                
                // Reset mechanism_params to defaults
                this.newNeg.mechanism_params = {};
                
                for (const group of this.selectedMechanism.param_groups) {
                    for (const param of group.params) {
                        // Set default value
                        let defaultVal = param.default;
                        if (defaultVal === 'inf') defaultVal = null;
                        if (defaultVal === '-inf') defaultVal = null;
                        this.newNeg.mechanism_params[param.name] = defaultVal;
                    }
                }
            },
            
            getMechanismParamValue(paramName) {
                return this.newNeg.mechanism_params?.[paramName];
            },
            
            setMechanismParamValue(paramName, value) {
                if (!this.newNeg.mechanism_params) {
                    this.newNeg.mechanism_params = {};
                }
                this.newNeg.mechanism_params[paramName] = value;
            },
            
            async loadSourceSettings() {
                try {
                    // Load source settings from backend
                    const res = await fetch('/api/settings/negotiator_sources');
                    if (res.ok) {
                        const data = await res.json();
                        this.sourceSettings = data;
                    }
                    
                    // Build the list with availability info from negotiatorSources
                    this.sourceSettingsList = this.negotiatorSources.map(source => {
                        const count = this.negotiatorTypes.filter(n => n.source === source.id).length;
                        return {
                            ...source,
                            count: count,
                            available: source.available !== false,
                            unavailable_reason: source.unavailable_reason
                        };
                    });
                } catch (e) {
                    console.error('Failed to load source settings:', e);
                }
            },
            
            // Genius Bridge methods
            async checkGeniusBridgeStatus() {
                try {
                    const res = await fetch('/api/genius/status');
                    if (res.ok) {
                        const data = await res.json();
                        this.geniusBridge.installed = data.installed;
                        this.geniusBridge.running = data.running;
                        this.geniusBridge.port = data.port;
                    }
                } catch (e) {
                    console.error('Failed to check Genius Bridge status:', e);
                }
            },
            
            async startGeniusBridge() {
                if (this.geniusBridge.loading) return;
                this.geniusBridge.loading = true;
                try {
                    const res = await fetch('/api/genius/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ port: this.geniusBridge.port })
                    });
                    if (res.ok) {
                        const data = await res.json();
                        if (data.success) {
                            this.geniusBridge.running = true;
                            this.geniusBridge.port = data.port;
                        } else {
                            console.error('Failed to start Genius Bridge:', data.message);
                            alert('Failed to start Genius Bridge: ' + data.message);
                        }
                    }
                } catch (e) {
                    console.error('Failed to start Genius Bridge:', e);
                } finally {
                    this.geniusBridge.loading = false;
                }
            },
            
            async stopGeniusBridge() {
                if (this.geniusBridge.loading) return;
                this.geniusBridge.loading = true;
                try {
                    const res = await fetch('/api/genius/stop?port=' + this.geniusBridge.port, {
                        method: 'POST'
                    });
                    if (res.ok) {
                        const data = await res.json();
                        if (data.success) {
                            this.geniusBridge.running = false;
                        }
                    }
                } catch (e) {
                    console.error('Failed to stop Genius Bridge:', e);
                } finally {
                    this.geniusBridge.loading = false;
                }
            },
            
            async toggleGeniusBridge() {
                if (this.geniusBridge.running) {
                    await this.stopGeniusBridge();
                } else {
                    await this.startGeniusBridge();
                }
            },
            
            async ensureGeniusBridgeRunning() {
                if (!this.geniusBridge.running) {
                    await this.startGeniusBridge();
                }
                return this.geniusBridge.running;
            },
            
            toggleSource(sourceId) {
                const idx = this.sourceSettings.disabled_sources.indexOf(sourceId);
                if (idx >= 0) {
                    this.sourceSettings.disabled_sources.splice(idx, 1);
                } else {
                    this.sourceSettings.disabled_sources.push(sourceId);
                }
            },
            
            async refreshNegotiators() {
                this.refreshingNegotiators = true;
                try {
                    await fetch('/api/negotiators/refresh', { method: 'POST' });
                    await this.loadNegotiatorTypes();
                    await this.loadNegotiatorSources();
                    await this.loadSourceSettings();
                } catch (e) {
                    console.error('Failed to refresh negotiators:', e);
                } finally {
                    this.refreshingNegotiators = false;
                }
            },
            
            async searchNegotiators() {
                // Negotiators already loaded at init, just triggers reactivity
            },
            
            async filterNegotiators() {
                // Reset group filter if source changed
                if (this.negotiatorSourceFilter !== 'genius') {
                    this.negotiatorGroupFilter = '';
                }
            },
            
            // Modal actions
            openNewNegotiation() {
                this.showNewNegotiation = true;
                this.negotiationTab = 'scenario';
                this.paramSubTab = 'deadline';
                this.scenarioSearch = '';
                this.negotiatorSearch = '';
                this.negotiatorSourceFilter = '';
                this.negotiatorGroupFilter = '';
                this.showAdvancedDeadline = false;
                this.showSAOResponse = true;
                this.showSAOOffers = false;
                this.showSAOSemantics = false;
                this.showInfoSharing = true;
                this.newNeg = {
                    source: '',
                    scenario: null,
                    negotiators: [
                        { type_name: 'negmas.sao.AspirationNegotiator', name: 'Aspiration1', source: 'native' },
                        { type_name: 'negmas.sao.BoulwareTBNegotiator', name: 'Boulware2', source: 'native' }
                    ],
                    mechanism_type: 'SAOMechanism',
                    mechanism_params: {},
                    share_ufuns: false,
                    mode: 'realtime',
                    step_delay: this.settings.defaultDelay,
                    show_plot: true,
                    show_offers: true,
                    auto_start: true,
                    panels: {
                        adjustable: true,
                        utilityView: {
                            xAxis: 0,
                            yAxis: 1
                        },
                        timeline: {
                            xAxis: 'step'
                        }
                    }
                };
                // Initialize mechanism params with defaults
                this.selectMechanism('SAOMechanism');
            },
            
            selectScenario(scenario) {
                this.newNeg.scenario = scenario;
                // Adjust negotiator count if needed
                while (this.newNeg.negotiators.length < scenario.n_negotiators) {
                    this.addNegotiator();
                }
                while (this.newNeg.negotiators.length > scenario.n_negotiators) {
                    this.newNeg.negotiators.pop();
                }
            },
            
            nextNegotiationTab() {
                if (this.negotiationTab === 'scenario') this.negotiationTab = 'negotiators';
                else if (this.negotiationTab === 'negotiators') this.negotiationTab = 'parameters';
                else if (this.negotiationTab === 'parameters') this.negotiationTab = 'panels';
                else if (this.negotiationTab === 'panels') this.negotiationTab = 'display';
            },
            
            prevNegotiationTab() {
                if (this.negotiationTab === 'display') this.negotiationTab = 'panels';
                else if (this.negotiationTab === 'panels') this.negotiationTab = 'parameters';
                else if (this.negotiationTab === 'parameters') this.negotiationTab = 'negotiators';
                else if (this.negotiationTab === 'negotiators') this.negotiationTab = 'scenario';
            },
            
            // Negotiator management
            addNegotiator() {
                const idx = this.newNeg.negotiators.length;
                this.newNeg.negotiators.push({
                    type_name: 'negmas.sao.AspirationNegotiator',
                    name: `Aspiration${idx + 1}`,
                    source: 'native'
                });
            },
            
            removeNegotiator(index) {
                if (this.newNeg.negotiators.length > 2) {
                    this.newNeg.negotiators.splice(index, 1);
                }
            },
            
            selectNegotiatorForSlot(negInfo) {
                // Use the currently selected slot
                const slotIndex = this.selectedNegotiatorSlot;
                const existingName = this.newNeg.negotiators[slotIndex]?.name;
                
                // Generate default name from type name + index if user hasn't set a custom name
                // Check if existing name is a generic "AgentN" or empty
                const isGenericName = !existingName || /^Agent\d+$/.test(existingName);
                const shortTypeName = negInfo.name || negInfo.type_name.split('.').pop();
                const defaultName = isGenericName ? `${shortTypeName}${slotIndex + 1}` : existingName;
                
                const newNeg = {
                    type_name: negInfo.type_name,
                    name: defaultName,
                    source: negInfo.source,
                    requires_bridge: negInfo.requires_bridge
                };
                
                if (slotIndex < this.newNeg.negotiators.length) {
                    this.newNeg.negotiators[slotIndex] = newNeg;
                } else {
                    this.newNeg.negotiators.push(newNeg);
                }
                
                // Auto-start Genius Bridge if needed
                if (negInfo.requires_bridge && this.settings.autoStartGenius && !this.geniusBridge.running) {
                    this.startGeniusBridge();
                }
                
                // Auto-advance to next slot if there's room
                const requiredCount = this.newNeg.scenario?.n_negotiators || 2;
                if (slotIndex + 1 < requiredCount && slotIndex + 1 < this.newNeg.negotiators.length) {
                    this.selectedNegotiatorSlot = slotIndex + 1;
                }
            },
            
            getNegotiatorDisplayName(typeName) {
                // Handle BOA negotiators (type_name format: "BOA:AcceptPolicy/OfferPolicy")
                if (typeName && typeName.startsWith('BOA:')) {
                    const parts = typeName.substring(4).split('/');
                    if (parts.length >= 2) {
                        const acc = parts[0].replace(/Policy$|^G|^AC/, '');
                        const off = parts[1].replace(/Policy$|Offering$|^G/, '');
                        return `${acc}+${off}`;
                    }
                    return 'Custom BOA';
                }
                const neg = this.negotiatorTypes.find(n => n.type_name === typeName);
                return neg?.name || typeName.split('.').pop();
            },
            
            getNegotiatorDescription(typeName) {
                const neg = this.negotiatorTypes.find(n => n.type_name === typeName);
                return neg?.description || '';
            },
            
            getSourceBadgeClass(source) {
                const classes = {
                    'native': 'badge-primary',
                    'genius': 'badge-warning',
                    'genius-reimplemented': 'badge-success',
                    'llm': 'badge-info',
                    'rl': 'badge-info',
                    'negolog': 'badge-secondary',
                    'boa': 'badge-info'
                };
                return classes[source] || 'badge-neutral';
            },
            
            // BOA Component methods
            async loadBOAComponents() {
                if (this.boaComponents.acceptance.length > 0) return; // Already loaded
                try {
                    const res = await fetch('/api/negotiators/boa/components');
                    const data = await res.json();
                    this.boaComponents = data.components;
                } catch (e) {
                    console.error('Failed to load BOA components:', e);
                }
            },
            
            getBoaComponentDescription(type, name) {
                if (!name) return '';
                const components = this.boaComponents[type] || [];
                const c = components.find(c => c.name === name);
                return c?.description || '';
            },
            
            applyBOAToSlot() {
                if (!this.boaConfig.acceptance_policy || !this.boaConfig.offering_policy) return;
                
                const slotIndex = this.selectedNegotiatorSlot;
                const existingName = this.newNeg.negotiators[slotIndex]?.name;
                
                // Create a display name based on selected components
                const displayParts = [];
                displayParts.push(this.boaConfig.acceptance_policy.replace(/Policy$|^G/, ''));
                displayParts.push(this.boaConfig.offering_policy.replace(/Policy$|Offering$|^G/, ''));
                const displayName = displayParts.join('+');
                
                const boaNeg = {
                    type_name: `BOA:${this.boaConfig.acceptance_policy}/${this.boaConfig.offering_policy}`,
                    name: existingName || `Agent${slotIndex + 1}`,
                    source: 'boa',
                    is_boa: true,
                    boa_config: {
                        acceptance_policy: this.boaConfig.acceptance_policy,
                        offering_policy: this.boaConfig.offering_policy,
                        opponent_model: this.boaConfig.opponent_model || null
                    }
                };
                
                if (slotIndex < this.newNeg.negotiators.length) {
                    this.newNeg.negotiators[slotIndex] = boaNeg;
                } else {
                    this.newNeg.negotiators.push(boaNeg);
                }
                
                // Auto-advance to next slot if there's room
                const requiredCount = this.newNeg.scenario?.n_negotiators || 2;
                if (slotIndex + 1 < requiredCount && slotIndex + 1 < this.newNeg.negotiators.length) {
                    this.selectedNegotiatorSlot = slotIndex + 1;
                }
            },
            
            // Start negotiation
            async startNegotiation() {
                if (!this.canStart) return;
                
                // Check if any negotiator requires the Genius Bridge
                const needsBridge = this.newNeg.negotiators.some(n => n.requires_bridge);
                if (needsBridge && !this.geniusBridge.running) {
                    // Try to start the bridge
                    await this.startGeniusBridge();
                    if (!this.geniusBridge.running) {
                        alert('Cannot start negotiation: Genius Bridge is required but failed to start.');
                        return;
                    }
                }
                
                // Save to recent sessions
                await this.addToRecentSessions();
                
                // Build request with new mechanism params structure
                const params = this.newNeg.mechanism_params || {};
                
                try {
                    const res = await fetch('/api/negotiation/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            scenario_path: this.newNeg.scenario.path,
                            negotiators: this.newNeg.negotiators,
                            mechanism_type: this.newNeg.mechanism_type,
                            mechanism_params: params,
                            n_steps: params.n_steps || 100,
                            time_limit: params.time_limit || null,
                            step_delay: this.newNeg.step_delay / 1000,
                            share_ufuns: this.newNeg.share_ufuns
                        })
                    });
                    
                    const data = await res.json();
                    
                    // Add to running negotiations
                    this.runningNegotiations.push({
                        id: data.session_id,
                        scenario: this.newNeg.scenario.name,
                        step: 0,
                        stream_url: data.stream_url
                    });
                    
                    this.showNewNegotiation = false;
                    
                    // Start streaming
                    this.connectToStream(data.session_id, data.stream_url);
                    
                } catch (e) {
                    console.error('Failed to start negotiation:', e);
                }
            },
            
            connectToStream(sessionId, url) {
                const eventSource = new EventSource(url);
                
                eventSource.addEventListener('offer', (event) => {
                    const offer = JSON.parse(event.data);
                    const neg = this.runningNegotiations.find(n => n.id === sessionId);
                    if (neg) {
                        neg.step = offer.step;
                        neg.lastOffer = offer;
                    }
                });
                
                eventSource.addEventListener('complete', (event) => {
                    const result = JSON.parse(event.data);
                    const idx = this.runningNegotiations.findIndex(n => n.id === sessionId);
                    if (idx >= 0) {
                        const neg = this.runningNegotiations.splice(idx, 1)[0];
                        neg.agreement = result.agreement;
                        neg.final_utilities = result.final_utilities;
                        neg.end_reason = result.end_reason;
                        this.completedNegotiations.unshift(neg);
                    }
                    eventSource.close();
                });
                
                eventSource.addEventListener('error', () => {
                    eventSource.close();
                });
            },
            
            selectNegotiation(neg) {
                this.currentNegotiation = neg;
            },
            
            // Settings
            async loadSettings() {
                try {
                    const res = await fetch('/api/settings');
                    const data = await res.json();
                    
                    // Map backend settings to frontend model
                    this.settings.darkMode = data.general?.dark_mode ?? false;
                    this.settings.colorBlindMode = data.general?.color_blind_mode ?? false;
                    this.settings.defaultSteps = data.negotiation?.default_max_steps ?? 100;
                    this.settings.defaultDelay = data.negotiation?.default_step_delay_ms ?? 100;
                    this.settings.autoStartGenius = data.genius_bridge?.auto_start ?? true;
                    this.settings.scenarioPaths = (data.paths?.scenario_paths ?? []).join('\n');
                    this.settings.negotiatorPaths = (data.paths?.negotiator_paths ?? []).join('\n');
                    
                    // Sync localStorage with backend
                    localStorage.setItem('darkMode', this.settings.darkMode.toString());
                    localStorage.setItem('colorBlindMode', this.settings.colorBlindMode.toString());
                    
                    // Apply dark mode based on loaded settings
                    document.documentElement.classList.toggle('dark-mode', this.settings.darkMode);
                    document.body.classList.toggle('dark-mode', this.settings.darkMode);
                    
                    // Apply color-blind mode based on loaded settings
                    document.documentElement.classList.toggle('color-blind-mode', this.settings.colorBlindMode);
                    document.body.classList.toggle('color-blind-mode', this.settings.colorBlindMode);
                } catch (e) {
                    console.error('Failed to load settings:', e);
                }
            },
            
            toggleDarkMode() {
                localStorage.setItem('darkMode', this.settings.darkMode);
                document.documentElement.classList.toggle('dark-mode', this.settings.darkMode);
                document.body.classList.toggle('dark-mode', this.settings.darkMode);
                // Also save to backend immediately for dark mode
                this.saveGeneralSettings();
                // Trigger chart redraws if any
                window.dispatchEvent(new CustomEvent('dark-mode-changed', { 
                    detail: { enabled: this.settings.darkMode } 
                }));
            },
            
            toggleColorBlindMode() {
                localStorage.setItem('colorBlindMode', this.settings.colorBlindMode);
                document.documentElement.classList.toggle('color-blind-mode', this.settings.colorBlindMode);
                document.body.classList.toggle('color-blind-mode', this.settings.colorBlindMode);
                // Save to backend immediately
                this.saveGeneralSettings();
                // Trigger chart redraws if any
                window.dispatchEvent(new CustomEvent('colorblind-mode-changed', { 
                    detail: { enabled: this.settings.colorBlindMode } 
                }));
            },
            
            async saveGeneralSettings() {
                try {
                    await fetch('/api/settings/general', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            dark_mode: this.settings.darkMode,
                            color_blind_mode: this.settings.colorBlindMode 
                        })
                    });
                } catch (e) {
                    console.error('Failed to save general settings:', e);
                }
            },
            
            toggleGeniusBridge() {
                // TODO: Implement
                this.geniusBridge.running = !this.geniusBridge.running;
            },
            
            async saveSettings() {
                try {
                    const settings = {
                        general: {
                            dark_mode: this.settings.darkMode,
                            color_blind_mode: this.settings.colorBlindMode
                        },
                        negotiation: {
                            default_max_steps: this.settings.defaultSteps,
                            default_step_delay_ms: this.settings.defaultDelay,
                            default_time_limit: null
                        },
                        genius_bridge: {
                            auto_start: this.settings.autoStartGenius,
                            java_path: null,
                            port: 25337
                        },
                        paths: {
                            scenario_paths: this.settings.scenarioPaths.split('\n').filter(p => p.trim()),
                            negotiator_paths: this.settings.negotiatorPaths.split('\n').filter(p => p.trim())
                        }
                    };
                    
                    await fetch('/api/settings', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    });
                    
                    // Also save source settings if modified
                    if (this.sourceSettings.disabled_sources.length > 0 || this.sourceSettings.custom_sources.length > 0) {
                        await fetch('/api/settings/negotiator_sources', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.sourceSettings)
                        });
                        // Refresh negotiator list after changing sources
                        await this.refreshNegotiators();
                    }
                    
                    this.showSettings = false;
                } catch (e) {
                    console.error('Failed to save settings:', e);
                }
            },
            
            // Preset management
            async loadRecentSessions() {
                try {
                    const res = await fetch('/api/settings/presets/recent');
                    if (res.ok) {
                        const data = await res.json();
                        this.recentSessions = data.presets || [];
                    }
                } catch (e) {
                    console.error('Failed to load recent sessions:', e);
                }
            },
            
            async loadSessionPresets() {
                try {
                    const res = await fetch('/api/settings/presets/sessions');
                    if (res.ok) {
                        const data = await res.json();
                        this.sessionPresets = data.presets || [];
                    }
                } catch (e) {
                    console.error('Failed to load session presets:', e);
                }
            },
            
            loadFullSession(session) {
                // Find the scenario in the loaded scenarios
                const scenario = this.scenarios.find(s => s.path === session.scenario_path);
                
                // Convert old format to new mechanism_params if needed
                let mechanismParams = session.mechanism_params || {};
                
                // Handle old format where params were at top level
                if (!session.mechanism_params) {
                    mechanismParams = {
                        n_steps: session.n_steps ?? null,
                        time_limit: session.time_limit ?? null,
                        pend: session.pend ?? 0,
                        pend_per_second: session.pend_per_second ?? 0,
                        step_time_limit: session.step_time_limit ?? null,
                        negotiator_time_limit: session.negotiator_time_limit ?? null,
                        hidden_time_limit: session.hidden_time_limit ?? null,
                    };
                    
                    // Merge mechanism-specific params from old format
                    const mechType = session.mechanism_type || 'SAOMechanism';
                    if (mechType === 'SAOMechanism' || mechType === 'sao') {
                        Object.assign(mechanismParams, session.sao || {});
                    } else if (mechType === 'TAUMechanism' || mechType === 'tau') {
                        Object.assign(mechanismParams, session.tau || {});
                    } else if (mechType === 'GBMechanism' || mechType === 'gb') {
                        Object.assign(mechanismParams, session.gb || {});
                    }
                }
                
                // Normalize mechanism_type to class name format
                let mechType = session.mechanism_type || 'SAOMechanism';
                if (mechType === 'sao') mechType = 'SAOMechanism';
                else if (mechType === 'tau') mechType = 'TAUMechanism';
                else if (mechType === 'gb') mechType = 'GBMechanism';
                
                this.newNeg = {
                    source: '',
                    scenario: scenario || { path: session.scenario_path, name: session.scenario_name },
                    negotiators: session.negotiators.map((n, i) => ({
                        type_name: n.type_name,
                        name: n.name || `Agent${i + 1}`,
                        source: n.source || 'native',
                        requires_bridge: n.requires_bridge || false
                    })),
                    mechanism_type: mechType,
                    mechanism_params: mechanismParams,
                    share_ufuns: session.share_ufuns ?? false,
                    mode: session.mode || 'realtime',
                    step_delay: session.step_delay ?? 100,
                    show_plot: session.show_plot ?? true,
                    show_offers: session.show_offers ?? true,
                    auto_start: true,
                    panels: session.panels || {
                        adjustable: true,
                        utilityView: { xAxis: 0, yAxis: 1 },
                        timeline: { xAxis: 'step' }
                    }
                };
                
                // Update selectedMechanism to match
                this.selectMechanism(mechType);
                
                // Jump directly to display tab when loading a full session
                this.negotiationTab = 'display';
            },
            
            buildSessionPreset(name) {
                return {
                    name: name,
                    scenario_path: this.newNeg.scenario?.path,
                    scenario_name: this.newNeg.scenario?.name,
                    negotiators: this.newNeg.negotiators.map(n => ({
                        type_name: n.type_name,
                        name: n.name,
                        source: n.source,
                        requires_bridge: n.requires_bridge
                    })),
                    mechanism_type: this.newNeg.mechanism_type,
                    mechanism_params: this.newNeg.mechanism_params,
                    share_ufuns: this.newNeg.share_ufuns,
                    mode: this.newNeg.mode,
                    step_delay: this.newNeg.step_delay,
                    show_plot: this.newNeg.show_plot,
                    show_offers: this.newNeg.show_offers,
                    panels: this.newNeg.panels
                };
            },
            
            async saveFullSession() {
                if (!this.savePresetName.trim() || !this.newNeg.scenario) return;
                
                try {
                    const preset = this.buildSessionPreset(this.savePresetName.trim());
                    const res = await fetch('/api/settings/presets/sessions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(preset)
                    });
                    
                    if (res.ok) {
                        this.showSaveSessionModal = false;
                        this.savePresetName = '';
                        // Refresh the list
                        await this.loadSessionPresets();
                    }
                } catch (e) {
                    console.error('Failed to save session preset:', e);
                }
            },
            
            async deleteSessionPreset(name) {
                try {
                    const res = await fetch(`/api/settings/presets/sessions/${encodeURIComponent(name)}`, {
                        method: 'DELETE'
                    });
                    if (res.ok) {
                        await this.loadSessionPresets();
                    }
                } catch (e) {
                    console.error('Failed to delete session preset:', e);
                }
            },
            
            async addToRecentSessions() {
                if (!this.newNeg.scenario) return;
                
                try {
                    const preset = this.buildSessionPreset(this.newNeg.scenario.name);
                    await fetch('/api/settings/presets/recent', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(preset)
                    });
                } catch (e) {
                    console.error('Failed to add to recent sessions:', e);
                }
            }
        };
    }
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
