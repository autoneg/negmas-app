{% extends "base.html" %}

{% block title %}NegMAS App - Negotiations{% endblock %}

{% block content %}
<!-- Empty state when no negotiation selected -->
<div x-show="!currentNegotiation" class="empty-state" style="height: 100%;">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
    </svg>
    <div class="empty-state-title">No Negotiation Selected</div>
    <div class="empty-state-text">
        Start a new negotiation or select one from the sidebar to view its progress.
    </div>
    <button class="btn btn-primary mt-4" @click="openNewNegotiation()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Start Negotiation
    </button>
</div>

<!-- Zoomed panel overlay -->
<div class="panel-zoom-overlay" x-show="zoomedPanel" @click.self="zoomedPanel = null" 
     style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;">
    <div class="panel" style="width: 90vw; height: 90vh; max-width: none;" x-show="zoomedPanel">
        <div class="panel-header">
            <span class="panel-title" x-text="zoomedPanel"></span>
            <div class="panel-actions">
                <button class="panel-btn" title="Close" @click="zoomedPanel = null">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>
        <div class="panel-content" style="padding: 0; position: relative; height: calc(100% - 48px);">
            <div :id="'zoomed-' + zoomedPanel?.replace(/\s+/g, '-').toLowerCase()" style="width: 100%; height: 100%;"></div>
        </div>
    </div>
</div>

<!-- Negotiation view when one is selected -->
<div x-show="currentNegotiation" class="panels-container" style="grid-template-columns: 1fr 1fr; grid-template-rows: auto auto auto; gap: 12px;">
    <!-- Row 1: Negotiation Info + 2D Utility View -->
    <!-- Negotiation Info Panel -->
    <div class="panel">
        <div class="panel-header">
            <span class="panel-title">Negotiation Info</span>
            <!-- Start button for non-auto-start -->
            <div class="panel-actions">
                <template x-if="currentNegotiation?.pendingStart">
                    <button class="btn btn-primary btn-sm" @click="actuallyStartNegotiation()">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        Start
                    </button>
                </template>
                <template x-if="currentNegotiation && !currentNegotiation?.pendingStart && !currentNegotiation?.agreement && !currentNegotiation?.end_reason">
                    <div style="display: flex; gap: 4px;">
                        <button class="panel-btn" 
                                :title="currentNegotiation?.paused ? 'Resume' : 'Pause'"
                                @click="togglePause()">
                            <svg x-show="!currentNegotiation?.paused" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="6" y="4" width="4" height="16"></rect>
                                <rect x="14" y="4" width="4" height="16"></rect>
                            </svg>
                            <svg x-show="currentNegotiation?.paused" viewBox="0 0 24 24" fill="currentColor">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                        </button>
                        <button class="panel-btn" title="Cancel" @click="stopNegotiation()">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <rect x="4" y="4" width="16" height="16" rx="2"></rect>
                            </svg>
                        </button>
                    </div>
                </template>
            </div>
        </div>
        <div class="panel-content">
            <div x-show="currentNegotiation">
                <!-- Progress bar -->
                <div class="mb-4" x-show="!currentNegotiation?.pendingStart && !currentNegotiation?.agreement && !currentNegotiation?.end_reason">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span class="text-secondary" style="font-size: 12px;">Progress</span>
                        <span class="text-secondary" style="font-size: 12px;" 
                              x-text="currentNegotiation?.n_steps ? ((currentNegotiation?.step || 0) + ' / ' + currentNegotiation.n_steps) : (Math.round((currentNegotiation?.relative_time || 0) * 100) + '%')"></span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" 
                             :style="'width: ' + Math.min(100, (currentNegotiation?.relative_time || 0) * 100) + '%'">
                        </div>
                    </div>
                </div>
                
                <!-- Pending start message -->
                <div class="mb-4" x-show="currentNegotiation?.pendingStart" style="background: var(--warning-light); border: 1px solid var(--warning); padding: 12px; border-radius: 8px;">
                    <span style="color: var(--warning); font-size: 13px;">Ready to start. Adjust panel settings if needed, then click Start.</span>
                </div>
                
                <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="stat-card">
                        <div class="stat-value" x-text="currentNegotiation?.step || 0"></div>
                        <div class="stat-label">Current Step</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" x-text="currentNegotiation?.offers?.length || 0"></div>
                        <div class="stat-label">Total Offers</div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <div class="form-label">Scenario</div>
                    <div class="text-secondary" x-text="currentNegotiation?.scenario"></div>
                </div>
                
                <div class="mt-4">
                    <div class="form-label">Negotiators</div>
                    <div class="negotiator-badges">
                        <template x-for="(name, idx) in (currentNegotiation?.negotiator_names || [])" :key="idx">
                            <span class="badge" 
                                  :style="'background: ' + (currentNegotiation?.negotiator_colors?.[idx] || 'var(--primary)') + '; color: white;'" 
                                  x-text="name"></span>
                        </template>
                    </div>
                </div>
                
                <div class="mt-4">
                    <div class="form-label">Status</div>
                    <span class="badge" 
                          :class="{
                              'badge-warning': currentNegotiation?.pendingStart,
                              'badge-primary': !currentNegotiation?.pendingStart && !currentNegotiation?.agreement && !currentNegotiation?.end_reason && !currentNegotiation?.paused,
                              'badge-info': currentNegotiation?.paused,
                              'badge-success': currentNegotiation?.agreement,
                              'badge-neutral': currentNegotiation?.end_reason && !currentNegotiation?.agreement
                          }"
                          x-text="currentNegotiation?.pendingStart ? 'Pending Start' : (currentNegotiation?.agreement ? 'Agreement Reached' : (currentNegotiation?.end_reason ? 'Ended: ' + currentNegotiation.end_reason : (currentNegotiation?.paused ? 'Paused' : 'Running')))">
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 2D Utility View Panel -->
    <div class="panel" style="grid-row: span 2;">
        <div class="panel-header">
            <span class="panel-title">2D Utility View</span>
            <div class="panel-actions">
                <button class="panel-btn" title="Save as Image" @click="savePlot('outcome-space-plot', '2d-utility-view')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </button>
                <button class="panel-btn" title="Zoom" @click="zoomPanel('2D Utility View', 'outcome-space-plot')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 3 21 3 21 9"/>
                        <polyline points="9 21 3 21 3 15"/>
                        <line x1="21" y1="3" x2="14" y2="10"/>
                        <line x1="3" y1="21" x2="10" y2="14"/>
                    </svg>
                </button>
                <button class="panel-btn" title="Reset View" @click="resetPlotView()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                        <path d="M3 3v5h5"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="panel-content" style="padding: 0; position: relative; display: flex; flex-direction: column;">
            <!-- Axis controls - shown if adjustable -->
            <div class="panel-controls" x-show="currentNegotiation?.panelSettings?.adjustable" style="padding: 8px; border-bottom: 1px solid var(--border-color); display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;">
                    X:
                    <select class="form-select" style="padding: 2px 6px; font-size: 11px; min-width: 80px;" x-model.number="panelState.utilityView.xAxis">
                        <template x-for="(name, idx) in (currentNegotiation?.negotiator_names || [])" :key="idx">
                            <option :value="idx" x-text="name"></option>
                        </template>
                    </select>
                </label>
                <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;">
                    Y:
                    <select class="form-select" style="padding: 2px 6px; font-size: 11px; min-width: 80px;" x-model.number="panelState.utilityView.yAxis">
                        <template x-for="(name, idx) in (currentNegotiation?.negotiator_names || [])" :key="idx">
                            <option :value="idx" x-text="name"></option>
                        </template>
                    </select>
                </label>
                <button class="btn btn-sm btn-primary" style="padding: 2px 8px; font-size: 11px;" @click="applyUtilityViewAxes()">Set</button>
            </div>
            <div id="outcome-space-plot" style="flex: 1; min-height: 0;"></div>
            <div x-show="!currentNegotiation?.outcome_space_data" 
                 class="empty-state" style="position: absolute; inset: 0; background: var(--bg-secondary);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M8 12h8M12 8v8"/>
                </svg>
                <div class="empty-state-title">2D Utility View</div>
                <div class="empty-state-text">Loading outcome space data...</div>
            </div>
        </div>
    </div>
    
    <!-- Row 2: Offer History + (2D Utility View continues) -->
    <!-- Offer History Panel -->
    <div class="panel">
        <div class="panel-header">
            <span class="panel-title">Offer History</span>
            <div class="panel-actions">
                <span class="text-muted" style="font-size: 12px;" x-text="(currentNegotiation?.offers?.length || 0) + ' offers'"></span>
                <button class="panel-btn" title="Save as JSON" @click="saveOffersAsJson()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </button>
                <button class="panel-btn" title="Zoom" @click="zoomPanel('Offer History', null)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 3 21 3 21 9"/>
                        <polyline points="9 21 3 21 3 15"/>
                        <line x1="21" y1="3" x2="14" y2="10"/>
                        <line x1="3" y1="21" x2="10" y2="14"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="panel-content" style="padding: 8px;">
            <div class="offer-log" x-ref="offerLog">
                <template x-if="!currentNegotiation?.offers || currentNegotiation.offers.length === 0">
                    <div class="empty-state" style="padding: 20px;">
                        <div class="text-muted">Waiting for offers...</div>
                    </div>
                </template>
                <template x-for="(offer, idx) in (currentNegotiation?.offers || []).slice(-50)" :key="idx">
                    <div class="offer-item animate-slide-up" 
                         :style="'border-left: 3px solid ' + (currentNegotiation?.negotiator_colors?.[offer.proposer_index] || 'var(--border-color)') + '; background: ' + (currentNegotiation?.negotiator_colors?.[offer.proposer_index] ? currentNegotiation.negotiator_colors[offer.proposer_index] + '15' : 'transparent')">
                        <div class="offer-header">
                            <span class="offer-agent" 
                                  :style="'color: ' + (currentNegotiation?.negotiator_colors?.[offer.proposer_index] || 'inherit')"
                                  x-text="offer.proposer"></span>
                            <span class="offer-step" x-text="'Step ' + offer.step"></span>
                        </div>
                        <div class="offer-values">
                            <template x-for="(value, key) in offer.offer" :key="key">
                                <span class="offer-value">
                                    <span class="offer-value-key" x-text="key + ':'"></span>
                                    <span x-text="value"></span>
                                </span>
                            </template>
                        </div>
                        <div class="offer-utilities">
                            <template x-for="(util, uidx) in offer.utilities" :key="uidx">
                                <div class="offer-utility">
                                    <span x-text="(currentNegotiation?.negotiator_names?.[uidx] || 'U' + (uidx + 1)) + ': ' + util.toFixed(3)"></span>
                                    <div class="utility-bar">
                                        <div class="utility-fill" 
                                             :style="'width: ' + (util * 100) + '%; background: ' + (currentNegotiation?.negotiator_colors?.[uidx] || 'var(--primary)')"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
    
    <!-- Row 3: Utility Timeline + Result -->
    <!-- Utility Timeline Panel -->
    <div class="panel">
        <div class="panel-header">
            <span class="panel-title">Utility Timeline</span>
            <div class="panel-actions">
                <button class="panel-btn" title="Save as Image" @click="savePlot('utility-timeline-container', 'utility-timeline')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </button>
                <button class="panel-btn" title="Zoom" @click="zoomPanel('Utility Timeline', 'utility-timeline-container')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 3 21 3 21 9"/>
                        <polyline points="9 21 3 21 3 15"/>
                        <line x1="21" y1="3" x2="14" y2="10"/>
                        <line x1="3" y1="21" x2="10" y2="14"/>
                    </svg>
                </button>
                <button class="panel-btn" title="Reset View" @click="resetTimelinePlotView()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                        <path d="M3 3v5h5"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="panel-content" style="padding: 0; position: relative; display: flex; flex-direction: column;">
            <!-- X-axis control - shown if adjustable -->
            <div class="panel-controls" x-show="currentNegotiation?.panelSettings?.adjustable" style="padding: 8px; border-bottom: 1px solid var(--border-color); display: flex; gap: 8px; align-items: center;">
                <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;">
                    X-Axis:
                    <select class="form-select" style="padding: 2px 6px; font-size: 11px;" x-model="panelState.timeline.xAxis" @change="initUtilityTimelinePlots()">
                        <option value="step">Step</option>
                        <option value="time">Time (s)</option>
                        <option value="relative_time">Relative Time</option>
                    </select>
                </label>
            </div>
            <div id="utility-timeline-container" style="flex: 1; min-height: 0; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding: 8px;"></div>
            <div x-show="!currentNegotiation?.offers || currentNegotiation.offers.length === 0" 
                 class="empty-state" style="position: absolute; inset: 0; background: var(--bg-secondary);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
                <div class="empty-state-title">Utility Timeline</div>
                <div class="empty-state-text">Utilities will be plotted as offers are made...</div>
            </div>
        </div>
    </div>
    
    <!-- Result Panel -->
    <div class="panel">
        <div class="panel-header">
            <span class="panel-title">Result</span>
            <div class="panel-actions">
                <button class="panel-btn" title="Save Results" @click="saveResults()" x-show="currentNegotiation?.agreement || currentNegotiation?.end_reason">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="panel-content">
            <template x-if="currentNegotiation?.agreement">
                <div>
                    <div class="result-summary">
                        <div class="result-title">Agreement Reached</div>
                        <div class="result-subtitle" x-text="'After ' + currentNegotiation.step + ' steps'"></div>
                    </div>
                    
                    <div class="mt-4">
                        <div class="form-label">Agreement Values</div>
                        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px;">
                            <template x-for="(value, key) in currentNegotiation.agreement" :key="key">
                                <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                                    <span class="text-secondary" x-text="key"></span>
                                    <span class="font-medium" x-text="value"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <div class="mt-4" x-show="currentNegotiation.final_utilities">
                        <div class="form-label">Final Utilities</div>
                        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));">
                            <template x-for="(util, idx) in (currentNegotiation.final_utilities || [])" :key="idx">
                                <div class="stat-card">
                                    <div class="stat-value" 
                                         :style="'color: ' + (currentNegotiation?.negotiator_colors?.[idx] || 'var(--primary)')" 
                                         x-text="util.toFixed(3)"></div>
                                    <div class="stat-label" x-text="currentNegotiation.negotiator_names?.[idx] || ('Agent ' + (idx + 1))"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </template>
            
            <template x-if="currentNegotiation?.end_reason && !currentNegotiation?.agreement">
                <div>
                    <div class="result-summary no-agreement" :class="{'error': currentNegotiation.error}">
                        <div class="result-title" x-text="currentNegotiation.error ? 'Error' : 'No Agreement'"></div>
                        <div class="result-subtitle" x-text="currentNegotiation.error || ('Reason: ' + currentNegotiation.end_reason)"></div>
                    </div>
                    <div class="mt-4" x-show="currentNegotiation.error" style="background: var(--danger-light, #fef2f2); border: 1px solid var(--danger, #ef4444); padding: 12px; border-radius: 8px;">
                        <div class="form-label" style="color: var(--danger, #ef4444);">Error Details</div>
                        <div class="text-secondary" style="font-size: 12px; font-family: monospace; word-break: break-word;" x-text="currentNegotiation.error"></div>
                    </div>
                </div>
            </template>
            
            <template x-if="!currentNegotiation?.end_reason && !currentNegotiation?.agreement && !currentNegotiation?.pendingStart">
                <div class="empty-state">
                    <div class="spinner"></div>
                    <div class="empty-state-title mt-4">Negotiation in Progress</div>
                    <div class="empty-state-text">Results will appear when the negotiation completes.</div>
                </div>
            </template>
            
            <template x-if="currentNegotiation?.pendingStart">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; opacity: 0.5;">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <div class="empty-state-title mt-4">Waiting to Start</div>
                    <div class="empty-state-text">Click Start when ready.</div>
                </div>
            </template>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Extend the Alpine app with plotting functionality
document.addEventListener('alpine:init', () => {
    window.outcomeSpacePlotInitialized = false;
    window.timelinePlotsInitialized = false;
});

// Override/extend app functions for plotting
const originalApp = app;
app = function() {
    const base = originalApp();
    
    // Create extended object that properly inherits from base
    const extended = Object.create(base);
    
    // Color-blind friendly palette (Okabe-Ito)
    const COLORBLIND_COLORS = [
        '#0072B2',  // Blue
        '#E69F00',  // Orange
        '#009E73',  // Bluish Green
        '#CC79A7',  // Reddish Purple
        '#F0E442',  // Yellow
        '#56B4E9',  // Sky Blue
        '#D55E00',  // Vermillion
        '#000000',  // Black
    ];
    
    // Dark mode color-blind colors (brighter)
    const COLORBLIND_COLORS_DARK = [
        '#56B4E9',  // Sky Blue
        '#E69F00',  // Orange
        '#009E73',  // Bluish Green
        '#CC79A7',  // Reddish Purple
        '#F0E442',  // Yellow
        '#0072B2',  // Blue
        '#D55E00',  // Vermillion
        '#FFFFFF',  // White
    ];
    
    // Line dash patterns
    const LINE_DASHES = ['solid', 'dash', 'dot', 'dashdot', 'longdash', 'longdashdot'];
    
    // Marker symbols
    const MARKER_SYMBOLS = ['circle', 'square', 'diamond', 'cross', 'x', 'triangle-up', 'triangle-down', 'star'];
    
    // Add our custom properties/methods
    Object.assign(extended, {
        // Panel state for controls
        zoomedPanel: null,
        panelState: {
            utilityView: { xAxis: 0, yAxis: 1 },
            timeline: { xAxis: 'step' }
        },
        
        // Override init
        async init() {
            await base.init.call(this);
            
            // Listen for theme changes to redraw charts
            window.addEventListener('colorblind-mode-changed', () => {
                if (this.currentNegotiation) {
                    this.$nextTick(() => {
                        this.initOutcomeSpacePlot();
                        this.initUtilityTimelinePlots();
                    });
                }
            });
            
            window.addEventListener('dark-mode-changed', () => {
                if (this.currentNegotiation) {
                    this.$nextTick(() => {
                        this.initOutcomeSpacePlot();
                        this.initUtilityTimelinePlots();
                    });
                }
            });
        },
        
        // Get colors based on theme
        getPlotColors() {
            const isDark = document.documentElement.classList.contains('dark-mode') || 
                           document.body.classList.contains('dark-mode');
            return {
                textColor: isDark ? '#b6c2cf' : '#172b4d',
                gridColor: isDark ? '#38414a' : '#dfe1e6',
                bgColor: 'transparent',
                outcomeColor: isDark ? 'rgba(100, 120, 140, 0.3)' : 'rgba(100, 120, 140, 0.4)',
                paretoColor: isDark ? '#f5cd47' : '#d97706',
                nashColor: '#22c55e',
                kalaiColor: '#8b5cf6',
                welfareColor: '#ef4444',
                agreementColor: '#10b981'
            };
        },
        
        // Get negotiator colors
        getNegotiatorColors() {
            const neg = this.currentNegotiation;
            const defaultColors = neg?.negotiator_colors || ['#4a6fa5', '#22a06b', '#e65100', '#7b1fa2', '#00695c'];
            const isColorBlind = document.documentElement.classList.contains('color-blind-mode');
            const isDark = document.documentElement.classList.contains('dark-mode');
            return isColorBlind ? (isDark ? COLORBLIND_COLORS_DARK : COLORBLIND_COLORS) : defaultColors;
        },
        
        // Apply utility view axis changes
        applyUtilityViewAxes() {
            window.outcomeSpacePlotInitialized = false;
            this.initOutcomeSpacePlot();
        },
        
        // Initialize outcome space plot (2D Utility View)
        async initOutcomeSpacePlot() {
            const plotDiv = document.getElementById('outcome-space-plot');
            if (!plotDiv) return;
            
            const neg = this.currentNegotiation;
            if (!neg || !neg.outcome_space_data) {
                window.outcomeSpacePlotInitialized = false;
                return;
            }
            
            const colors = this.getPlotColors();
            const osd = neg.outcome_space_data;
            const negColors = this.getNegotiatorColors();
            const isColorBlind = document.documentElement.classList.contains('color-blind-mode');
            
            // Get axis indices from panel state
            const xIdx = this.panelState.utilityView.xAxis;
            const yIdx = this.panelState.utilityView.yAxis;
            
            const traces = [];
            
            // 1. All outcomes
            if (osd.outcome_utilities && osd.outcome_utilities.length > 0) {
                traces.push({
                    x: osd.outcome_utilities.map(u => u[xIdx] || 0),
                    y: osd.outcome_utilities.map(u => u[yIdx] || 0),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Outcomes',
                    marker: { color: colors.outcomeColor, size: 3, opacity: 0.5 },
                    hoverinfo: 'skip'
                });
            }
            
            // 2. Pareto frontier
            if (osd.pareto_utilities && osd.pareto_utilities.length > 0) {
                traces.push({
                    x: osd.pareto_utilities.map(u => u[xIdx] || 0),
                    y: osd.pareto_utilities.map(u => u[yIdx] || 0),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Pareto Frontier',
                    line: { color: colors.paretoColor, width: 2 },
                    marker: { color: colors.paretoColor, size: 5 }
                });
            }
            
            // 3. Nash point
            if (osd.nash_point && osd.nash_point.length > Math.max(xIdx, yIdx)) {
                traces.push({
                    x: [osd.nash_point[xIdx]],
                    y: [osd.nash_point[yIdx]],
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Nash',
                    marker: { color: colors.nashColor, size: 12, symbol: 'diamond' }
                });
            }
            
            // 4. Kalai point
            if (osd.kalai_point && osd.kalai_point.length > Math.max(xIdx, yIdx)) {
                traces.push({
                    x: [osd.kalai_point[xIdx]],
                    y: [osd.kalai_point[yIdx]],
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Kalai',
                    marker: { color: colors.kalaiColor, size: 12, symbol: 'square' }
                });
            }
            
            // 5. Max welfare point
            if (osd.max_welfare_point && osd.max_welfare_point.length > Math.max(xIdx, yIdx)) {
                traces.push({
                    x: [osd.max_welfare_point[xIdx]],
                    y: [osd.max_welfare_point[yIdx]],
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Max Welfare',
                    marker: { color: colors.welfareColor, size: 14, symbol: 'star' }
                });
            }
            
            // 6. Offer traces per negotiator
            const offers = neg.offers || [];
            if (offers.length > 0) {
                const numAgents = neg.negotiator_names?.length || 2;
                for (let i = 0; i < numAgents; i++) {
                    const agentOffers = offers.filter(o => o.proposer_index === i);
                    if (agentOffers.length > 0) {
                        traces.push({
                            x: agentOffers.map(o => o.utilities[xIdx] || 0),
                            y: agentOffers.map(o => o.utilities[yIdx] || 0),
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: neg.negotiator_names?.[i] || `Agent ${i + 1}`,
                            line: { 
                                color: negColors[i % negColors.length], 
                                width: 2,
                                dash: isColorBlind ? LINE_DASHES[i % LINE_DASHES.length] : 'solid'
                            },
                            marker: { 
                                color: negColors[i % negColors.length], 
                                size: isColorBlind ? 8 : 6,
                                symbol: isColorBlind ? MARKER_SYMBOLS[i % MARKER_SYMBOLS.length] : 'circle'
                            }
                        });
                    }
                }
            }
            
            // 7. Agreement point
            if (neg.agreement && neg.final_utilities && neg.final_utilities.length > Math.max(xIdx, yIdx)) {
                traces.push({
                    x: [neg.final_utilities[xIdx]],
                    y: [neg.final_utilities[yIdx]],
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Agreement',
                    marker: { color: colors.agreementColor, size: 16, symbol: 'star', line: { color: '#fff', width: 2 } }
                });
            }
            
            const layout = {
                xaxis: { 
                    title: { text: neg.negotiator_names?.[xIdx] || `Agent ${xIdx + 1}`, font: { color: colors.textColor } },
                    tickfont: { color: colors.textColor },
                    gridcolor: colors.gridColor,
                    linecolor: colors.gridColor,
                    zerolinecolor: colors.gridColor
                },
                yaxis: { 
                    title: { text: neg.negotiator_names?.[yIdx] || `Agent ${yIdx + 1}`, font: { color: colors.textColor } },
                    tickfont: { color: colors.textColor },
                    gridcolor: colors.gridColor,
                    linecolor: colors.gridColor,
                    zerolinecolor: colors.gridColor
                },
                margin: { t: 30, r: 30, b: 50, l: 50 },
                legend: { orientation: 'h', y: -0.15, font: { color: colors.textColor, size: 10 } },
                paper_bgcolor: colors.bgColor,
                plot_bgcolor: colors.bgColor,
                font: { family: '-apple-system, BlinkMacSystemFont, sans-serif', size: 11, color: colors.textColor }
            };
            
            const config = {
                responsive: true,
                displayModeBar: 'hover',
                modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                toImageButtonOptions: { format: 'png', filename: '2d-utility-view', scale: 2 }
            };
            
            await Plotly.react(plotDiv, traces, layout, config);
            window.outcomeSpacePlotInitialized = true;
        },
        
        // Update 2D plot with new offer
        async updateOutcomeSpacePlot(offer) {
            if (!window.outcomeSpacePlotInitialized) {
                await this.initOutcomeSpacePlot();
                return;
            }
            await this.initOutcomeSpacePlot();
        },
        
        resetPlotView() {
            const plotDiv = document.getElementById('outcome-space-plot');
            if (plotDiv) {
                Plotly.relayout(plotDiv, { 'xaxis.autorange': true, 'yaxis.autorange': true });
            }
        },
        
        // Initialize utility timeline plots - N plots for N negotiators
        async initUtilityTimelinePlots() {
            const container = document.getElementById('utility-timeline-container');
            if (!container) return;
            
            const neg = this.currentNegotiation;
            if (!neg || !neg.offers || neg.offers.length === 0) {
                container.innerHTML = '';
                window.timelinePlotsInitialized = false;
                return;
            }
            
            const colors = this.getPlotColors();
            const negColors = this.getNegotiatorColors();
            const numAgents = neg.negotiator_names?.length || 2;
            const isColorBlind = document.documentElement.classList.contains('color-blind-mode');
            const xAxisType = this.panelState.timeline.xAxis;
            
            // Get X values based on selected axis type
            const getXValue = (offer) => {
                switch (xAxisType) {
                    case 'time': return offer.time || 0;
                    case 'relative_time': return offer.relative_time || 0;
                    default: return offer.step;
                }
            };
            
            const xAxisTitle = xAxisType === 'time' ? 'Time (s)' : (xAxisType === 'relative_time' ? 'Relative Time' : 'Step');
            
            // Clear and rebuild container
            container.innerHTML = '';
            
            // Create N plots, one per negotiator
            for (let agentIdx = 0; agentIdx < numAgents; agentIdx++) {
                const plotId = `timeline-plot-${agentIdx}`;
                const plotWrapper = document.createElement('div');
                plotWrapper.style.cssText = 'flex: 1; min-height: 150px;';
                plotWrapper.innerHTML = `<div id="${plotId}" style="width: 100%; height: 100%;"></div>`;
                container.appendChild(plotWrapper);
                
                const traces = [];
                
                // Create N series per plot - each series j shows utility of offers from agent j for agent agentIdx
                for (let proposerIdx = 0; proposerIdx < numAgents; proposerIdx++) {
                    const proposerOffers = neg.offers.filter(o => o.proposer_index === proposerIdx);
                    if (proposerOffers.length === 0) continue;
                    
                    const xValues = proposerOffers.map(getXValue);
                    const yValues = proposerOffers.map(o => o.utilities[agentIdx] || 0);
                    
                    // Own offers get thick solid line, others get dashed
                    const isOwnOffers = proposerIdx === agentIdx;
                    
                    traces.push({
                        x: xValues,
                        y: yValues,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: neg.negotiator_names?.[proposerIdx] || `Agent ${proposerIdx + 1}`,
                        line: { 
                            color: negColors[proposerIdx % negColors.length], 
                            width: isOwnOffers ? 3 : 1.5,
                            dash: isOwnOffers ? 'solid' : LINE_DASHES[(proposerIdx + 1) % LINE_DASHES.length]
                        },
                        marker: { 
                            color: negColors[proposerIdx % negColors.length], 
                            size: isOwnOffers ? 8 : 5,
                            symbol: isColorBlind ? MARKER_SYMBOLS[proposerIdx % MARKER_SYMBOLS.length] : 'circle'
                        }
                    });
                }
                
                // Add agreement marker if exists
                if (neg.agreement && neg.final_utilities && neg.final_utilities.length > agentIdx) {
                    const lastOffer = neg.offers[neg.offers.length - 1];
                    traces.push({
                        x: [getXValue(lastOffer)],
                        y: [neg.final_utilities[agentIdx]],
                        type: 'scatter',
                        mode: 'markers',
                        name: 'Agreement',
                        showlegend: agentIdx === 0,
                        marker: { color: colors.agreementColor, size: 12, symbol: 'star', line: { color: '#fff', width: 1 } }
                    });
                }
                
                const layout = {
                    title: { 
                        text: `${neg.negotiator_names?.[agentIdx] || 'Agent ' + (agentIdx + 1)}'s Utility`,
                        font: { size: 12, color: colors.textColor }
                    },
                    xaxis: { 
                        title: { text: xAxisTitle, font: { color: colors.textColor, size: 10 } },
                        tickfont: { color: colors.textColor, size: 9 },
                        gridcolor: colors.gridColor,
                        linecolor: colors.gridColor
                    },
                    yaxis: { 
                        title: { text: 'Utility', font: { color: colors.textColor, size: 10 } },
                        tickfont: { color: colors.textColor, size: 9 },
                        gridcolor: colors.gridColor,
                        linecolor: colors.gridColor
                    },
                    margin: { t: 35, r: 20, b: 35, l: 40 },
                    legend: { orientation: 'h', y: -0.3, font: { color: colors.textColor, size: 9 } },
                    paper_bgcolor: colors.bgColor,
                    plot_bgcolor: colors.bgColor,
                    font: { family: '-apple-system, BlinkMacSystemFont, sans-serif', size: 10, color: colors.textColor }
                };
                
                const config = {
                    responsive: true,
                    displayModeBar: 'hover',
                    modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                    toImageButtonOptions: { format: 'png', filename: `utility-timeline-${agentIdx}`, scale: 2 }
                };
                
                await Plotly.newPlot(plotId, traces, layout, config);
            }
            
            window.timelinePlotsInitialized = true;
        },
        
        async updateUtilityTimelinePlots(offer) {
            if (!window.timelinePlotsInitialized) {
                await this.initUtilityTimelinePlots();
                return;
            }
            await this.initUtilityTimelinePlots();
        },
        
        resetTimelinePlotView() {
            const neg = this.currentNegotiation;
            if (!neg) return;
            const numAgents = neg.negotiator_names?.length || 2;
            for (let i = 0; i < numAgents; i++) {
                const plotDiv = document.getElementById(`timeline-plot-${i}`);
                if (plotDiv) {
                    Plotly.relayout(plotDiv, { 'xaxis.autorange': true, 'yaxis.autorange': true });
                }
            }
        },
        
        // Zoom panel
        zoomPanel(panelName, plotId) {
            this.zoomedPanel = panelName;
            if (plotId) {
                this.$nextTick(() => {
                    // Clone the plot to zoomed view
                    const zoomedContainer = document.getElementById('zoomed-' + panelName.replace(/\s+/g, '-').toLowerCase());
                    if (zoomedContainer && plotId === 'outcome-space-plot') {
                        this.initOutcomeSpacePlot();
                    } else if (zoomedContainer && plotId === 'utility-timeline-container') {
                        this.initUtilityTimelinePlots();
                    }
                });
            }
        },
        
        // Save plot as image
        savePlot(plotId, filename) {
            const plotDiv = document.getElementById(plotId);
            if (plotDiv) {
                Plotly.downloadImage(plotDiv, { format: 'png', filename: filename, scale: 2 });
            }
        },
        
        // Save offers as JSON
        saveOffersAsJson() {
            const neg = this.currentNegotiation;
            if (!neg || !neg.offers) return;
            
            const data = {
                scenario: neg.scenario,
                negotiators: neg.negotiator_names,
                offers: neg.offers,
                agreement: neg.agreement,
                final_utilities: neg.final_utilities
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `negotiation-${neg.id}.json`;
            a.click();
            URL.revokeObjectURL(url);
        },
        
        // Save results
        saveResults() {
            this.saveOffersAsJson();
        },
        
        // Override connectToStream to handle init event and plotting
        connectToStream(sessionId, url, autoStart = true) {
            const eventSource = new EventSource(url);
            
            const neg = this.runningNegotiations.find(n => n.id === sessionId);
            if (neg) {
                neg.offers = [];
                neg.pendingStart = !autoStart;
                neg.panelSettings = neg.panelSettings || { adjustable: true };
            }
            
            eventSource.addEventListener('init', (event) => {
                const initData = JSON.parse(event.data);
                const neg = this.runningNegotiations.find(n => n.id === sessionId);
                if (neg) {
                    neg.negotiator_names = initData.negotiator_names;
                    neg.negotiator_types = initData.negotiator_types;
                    neg.negotiator_colors = initData.negotiator_colors;
                    neg.issue_names = initData.issue_names;
                    neg.n_steps = initData.n_steps;
                    neg.time_limit = initData.time_limit;
                    neg.outcome_space_data = initData.outcome_space_data;
                    neg.scenario = initData.scenario_name;
                    
                    // Initialize panel state for this negotiation
                    const numAgents = neg.negotiator_names?.length || 2;
                    this.panelState.utilityView.xAxis = neg.panelSettings?.utilityView?.xAxis ?? 0;
                    this.panelState.utilityView.yAxis = neg.panelSettings?.utilityView?.yAxis ?? Math.min(1, numAgents - 1);
                    this.panelState.timeline.xAxis = neg.panelSettings?.timeline?.xAxis ?? 'step';
                    
                    if (this.currentNegotiation?.id === sessionId) {
                        this.currentNegotiation = neg;
                        this.$nextTick(() => {
                            this.initOutcomeSpacePlot();
                        });
                    }
                }
            });
            
            eventSource.addEventListener('offer', (event) => {
                const offer = JSON.parse(event.data);
                const neg = this.runningNegotiations.find(n => n.id === sessionId);
                if (neg) {
                    neg.step = offer.step;
                    neg.relative_time = offer.relative_time;
                    neg.lastOffer = offer;
                    neg.offers = neg.offers || [];
                    neg.offers.push(offer);
                    neg.pendingStart = false;
                    
                    // Force reactivity by updating currentNegotiation properties directly
                    if (this.currentNegotiation?.id === sessionId) {
                        this.currentNegotiation.step = neg.step;
                        this.currentNegotiation.relative_time = neg.relative_time;
                        this.currentNegotiation.lastOffer = neg.lastOffer;
                        this.currentNegotiation.offers = [...neg.offers];  // New array reference
                        this.currentNegotiation.pendingStart = false;
                        
                        this.updateOutcomeSpacePlot(offer);
                        this.updateUtilityTimelinePlots(offer);
                        
                        this.$nextTick(() => {
                            const log = this.$refs.offerLog;
                            if (log) log.scrollTop = log.scrollHeight;
                        });
                    }
                }
            });
            
            eventSource.addEventListener('complete', (event) => {
                const result = JSON.parse(event.data);
                const idx = this.runningNegotiations.findIndex(n => n.id === sessionId);
                if (idx >= 0) {
                    const neg = this.runningNegotiations.splice(idx, 1)[0];
                    neg.agreement = result.agreement;
                    neg.final_utilities = result.final_utilities;
                    neg.end_reason = result.end_reason || (result.error ? 'error' : null);
                    neg.error = result.error;
                    neg.step = result.n_steps;
                    neg.pendingStart = false;
                    this.completedNegotiations.unshift(neg);
                    
                    if (this.currentNegotiation?.id === sessionId) {
                        this.currentNegotiation = neg;
                        this.$nextTick(() => {
                            this.initOutcomeSpacePlot();
                            this.initUtilityTimelinePlots();
                        });
                    }
                }
                eventSource.close();
            });
            
            eventSource.addEventListener('error', () => {
                eventSource.close();
            });
            
            if (neg) {
                this.currentNegotiation = neg;
            }
            
            // Store eventSource reference for manual start
            if (neg) {
                neg._eventSource = eventSource;
            }
        },
        
        // Actually start a pending negotiation
        async actuallyStartNegotiation() {
            const neg = this.currentNegotiation;
            if (!neg || !neg.pendingStart) return;
            
            try {
                await fetch(`/api/negotiation/${neg.id}/start`, { method: 'POST' });
                neg.pendingStart = false;
            } catch (e) {
                console.error('Failed to start negotiation:', e);
            }
        },
        
        // Override selectNegotiation to init plots
        selectNegotiation(neg) {
            this.currentNegotiation = neg;
            
            // Update panel state from negotiation settings
            const numAgents = neg.negotiator_names?.length || 2;
            this.panelState.utilityView.xAxis = neg.panelSettings?.utilityView?.xAxis ?? 0;
            this.panelState.utilityView.yAxis = neg.panelSettings?.utilityView?.yAxis ?? Math.min(1, numAgents - 1);
            this.panelState.timeline.xAxis = neg.panelSettings?.timeline?.xAxis ?? 'step';
            
            window.outcomeSpacePlotInitialized = false;
            window.timelinePlotsInitialized = false;
            this.$nextTick(() => {
                this.initOutcomeSpacePlot();
                this.initUtilityTimelinePlots();
            });
        },
        
        // Toggle pause state
        async togglePause() {
            if (!this.currentNegotiation) return;
            const sessionId = this.currentNegotiation.id;
            const isPaused = this.currentNegotiation.paused;
            
            try {
                const endpoint = isPaused ? 'resume' : 'pause';
                await fetch(`/api/negotiation/${sessionId}/${endpoint}`, { method: 'POST' });
                this.currentNegotiation.paused = !isPaused;
            } catch (e) {
                console.error('Failed to toggle pause:', e);
            }
        },
        
        // Cancel the current negotiation
        async stopNegotiation() {
            if (!this.currentNegotiation) return;
            const sessionId = this.currentNegotiation.id;
            try {
                await fetch(`/api/negotiation/${sessionId}/cancel`, { method: 'POST' });
            } catch (e) {
                console.error('Failed to cancel negotiation:', e);
            }
        }
    });
    
    return extended;
};
</script>
{% endblock %}
