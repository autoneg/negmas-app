<!-- Single Negotiation View - Shown when a negotiation is selected -->
<div class="negotiation-single-view" x-show="currentNegotiation">
    <!-- Compact Header -->
    <div class="table-header" style="margin-bottom: 8px;">
        <div style="display: flex; align-items: center; gap: 12px;">
            <h2 style="font-size: 16px;">Negotiation</h2>
            <span class="badge badge-primary" style="font-size: 12px;" x-text="currentNegotiation?.scenario"></span>
        </div>
        <div style="display: flex; gap: 8px; align-items: center;">
            <!-- Back to tournament button for negotiations from tournaments -->
            <button class="btn btn-ghost btn-sm" x-show="currentNegotiation?.isFromTournament || (currentNegotiation?.isSaved && currentNegotiation?.id?.startsWith('saved-'))" 
                    @click="returnToTournament()" 
                    title="Back to tournament view">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                <span>Back to Tournament</span>
            </button>
            <!-- Close button -->
            <button class="btn btn-ghost btn-sm" x-show="!currentNegotiation?.isFromTournament && !(currentNegotiation?.isSaved && currentNegotiation?.id?.startsWith('saved-'))" @click="currentNegotiation = null" title="Close negotiation view">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                <span>Close</span>
            </button>
            <!-- Scenario Stats button -->
            <button class="btn btn-ghost btn-sm" @click="openScenarioStatsModal()" title="View scenario statistics">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                    <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                </svg>
                <span>Stats</span>
            </button>
            <button class="btn btn-primary btn-sm" @click="openNewNegotiation()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                <span>New</span>
            </button>
        </div>
    </div>
    
    <!-- Panels Container -->
    <div class="panels-container panels-layout-compact">
        <!-- LEFT COLUMN: Info, Offer History, Histogram, Result -->
        <div class="panels-column panels-column-left" x-ref="leftColumn">
            {% include 'components/panels/negotiation_info_panel.html' %}
            
            <!-- Resize handle between Info and History -->
            <div class="resize-handle-horizontal" @mousedown="startPanelResize($event, 'info-history')"></div>
            
            {% include 'components/panels/offer_history_panel.html' %}
            
            <!-- Resize handle between History and Histogram -->
            <div class="resize-handle-horizontal" @mousedown="startPanelResize($event, 'history-histogram')"></div>
            
            {% include 'components/panels/histogram_panel.html' %}
            
            <!-- Resize handle between Histogram and Result -->
            <div class="resize-handle-horizontal" @mousedown="startPanelResize($event, 'histogram-result')"></div>
            
            {% include 'components/panels/result_panel.html' %}
        </div>
        
        <!-- Resize handle between columns -->
        <div class="resize-handle-vertical" @mousedown="startColumnResize($event)" x-ref="columnResizer"></div>
        
        <!-- RIGHT COLUMN: 2D Utility View, Utility Timeline -->
        <div class="panels-column panels-column-right" x-ref="rightColumn">
            {% include 'components/panels/utility_2d_panel.html' %}
            
            <!-- Resize handle between 2D Utility and Timeline -->
            <div class="resize-handle-horizontal" @mousedown="startPanelResize($event, 'utility2d-timeline')"></div>
            
            {% include 'components/panels/timeline_panel.html' %}
        </div>
    </div>
</div>

<!-- Zoomed panel overlay -->
<div class="panel-zoom-overlay" x-show="zoomedPanel" @click.self="zoomedPanel = null" 
     style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;">
    <div class="panel" style="width: 90vw; height: 90vh; max-width: none;" x-show="zoomedPanel">
        <div class="panel-header">
            <span class="panel-title" x-text="zoomedPanel"></span>
            <div class="panel-actions">
                <button class="panel-btn" title="Close" @click="zoomedPanel = null">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>
        <div class="panel-content" style="padding: 0; position: relative; height: calc(100% - 48px);">
            <div :id="'zoomed-' + zoomedPanel?.replace(/\s+/g, '-').toLowerCase()" style="width: 100%; height: 100%;"></div>
        </div>
    </div>
</div>

<!-- Scenario Stats Modal -->
<div class="panel-zoom-overlay" x-show="showScenarioStatsModal" @click.self="showScenarioStatsModal = false" 
     style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;">
    <div class="panel" style="width: 600px; max-width: 90vw; max-height: 90vh; overflow: auto;" x-show="showScenarioStatsModal">
        <div class="panel-header">
            <span class="panel-title">Scenario Statistics</span>
            <div class="panel-actions">
                <button class="panel-btn" title="Close" @click="showScenarioStatsModal = false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>
        <div class="panel-content" style="padding: 16px;">
            <!-- Loading state -->
            <div x-show="currentNegotiationStatsLoading" class="text-muted" style="padding: 20px; text-align: center;">
                Loading statistics...
            </div>
            
            <!-- Error state -->
            <div x-show="currentNegotiationStatsError" class="text-muted" style="padding: 20px; text-align: center; color: var(--danger);">
                <span x-text="currentNegotiationStatsError"></span>
            </div>
            
            <!-- Stats content -->
            <div x-show="currentNegotiationStats && currentNegotiationStats.has_stats && !currentNegotiationStatsLoading">
                <!-- Scenario name -->
                <div style="margin-bottom: 16px;">
                    <span class="text-muted" style="font-size: 12px;">Scenario:</span>
                    <span style="font-weight: 500;" x-text="currentNegotiation?.scenario || 'Unknown'"></span>
                </div>
                
                <!-- Opposition & Pareto count -->
                <div class="scenario-detail-grid" style="margin-bottom: 16px;">
                    <div class="scenario-detail-stat">
                        <span class="stat-label">Opposition</span>
                        <span class="stat-value" x-text="currentNegotiationStats?.opposition?.toFixed(3) ?? 'N/A'"></span>
                    </div>
                    <div class="scenario-detail-stat">
                        <span class="stat-label">Pareto Outcomes</span>
                        <span class="stat-value" x-text="currentNegotiationStats?.n_pareto_outcomes ?? 'N/A'"></span>
                    </div>
                </div>
                
                <!-- Utility Ranges -->
                <template x-if="currentNegotiationStats?.utility_ranges && currentNegotiationStats.utility_ranges.length > 0">
                    <div style="margin-bottom: 16px;">
                        <div class="text-muted" style="font-size: 12px; margin-bottom: 8px;">Utility Ranges</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <template x-for="(range, idx) in currentNegotiationStats.utility_ranges" :key="idx">
                                <span class="badge badge-neutral" 
                                      x-text="(currentNegotiationStats.negotiator_names?.[idx] || ('Party ' + (idx+1))) + ': [' + range[0].toFixed(3) + ', ' + range[1].toFixed(3) + ']'">
                                </span>
                            </template>
                        </div>
                    </div>
                </template>
                
                <!-- Special Points Table -->
                <div style="margin-bottom: 16px;">
                    <div class="text-muted" style="font-size: 12px; margin-bottom: 8px;">Special Points</div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <th style="text-align: left; padding: 8px 12px; font-weight: 500;">Point</th>
                                <template x-for="(name, idx) in (currentNegotiationStats?.negotiator_names || [])" :key="idx">
                                    <th style="text-align: right; padding: 8px 12px; font-weight: 500;" x-text="name"></th>
                                </template>
                            </tr>
                        </thead>
                        <tbody>
                            <tr x-show="currentNegotiationStats?.nash_utils?.length > 0" style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 8px 12px;">Nash</td>
                                <template x-for="(u, idx) in (currentNegotiationStats?.nash_utils?.[0] || [])" :key="idx">
                                    <td style="text-align: right; padding: 8px 12px; font-family: var(--font-mono);" x-text="u.toFixed(4)"></td>
                                </template>
                            </tr>
                            <tr x-show="currentNegotiationStats?.kalai_utils?.length > 0" style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 8px 12px;">Kalai</td>
                                <template x-for="(u, idx) in (currentNegotiationStats?.kalai_utils?.[0] || [])" :key="idx">
                                    <td style="text-align: right; padding: 8px 12px; font-family: var(--font-mono);" x-text="u.toFixed(4)"></td>
                                </template>
                            </tr>
                            <tr x-show="currentNegotiationStats?.ks_utils?.length > 0" style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 8px 12px;">Kalai-Smorodinsky</td>
                                <template x-for="(u, idx) in (currentNegotiationStats?.ks_utils?.[0] || [])" :key="idx">
                                    <td style="text-align: right; padding: 8px 12px; font-family: var(--font-mono);" x-text="u.toFixed(4)"></td>
                                </template>
                            </tr>
                            <tr x-show="currentNegotiationStats?.max_welfare_utils?.length > 0">
                                <td style="padding: 8px 12px;">Max Welfare</td>
                                <template x-for="(u, idx) in (currentNegotiationStats?.max_welfare_utils?.[0] || [])" :key="idx">
                                    <td style="text-align: right; padding: 8px 12px; font-family: var(--font-mono);" x-text="u.toFixed(4)"></td>
                                </template>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                    <button class="btn btn-secondary btn-sm" @click="calculateCurrentNegotiationStats(true)" :disabled="currentNegotiationStatsLoading">
                        Recalculate
                    </button>
                </div>
            </div>
            
            <!-- No stats state -->
            <div x-show="!currentNegotiationStatsLoading && !currentNegotiationStatsError && (!currentNegotiationStats || !currentNegotiationStats.has_stats)" 
                 style="padding: 20px; text-align: center;">
                <p class="text-muted" style="margin-bottom: 16px;">No statistics available for this scenario.</p>
                <button class="btn btn-primary btn-sm" @click="calculateCurrentNegotiationStats(false)" :disabled="currentNegotiationStatsLoading">
                    Calculate Stats
                </button>
            </div>
        </div>
    </div>
</div>
