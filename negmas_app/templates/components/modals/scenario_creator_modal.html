<!-- Scenario Creator Modal -->
<div class="modal-overlay" :class="{ active: showScenarioCreator }" @click.self="showScenarioCreator = false">
    <div class="modal large" style="max-width: 900px; max-height: 90vh;">
        <div class="modal-header">
            <h2 class="modal-title">Create New Scenario</h2>
            <button class="modal-close" @click="showScenarioCreator = false">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body" style="overflow-y: auto; max-height: calc(90vh - 140px);">
            <!-- Scenario Name -->
            <div class="form-group">
                <label class="form-label">Scenario Name *</label>
                <input type="text" class="form-input" placeholder="MyScenario" x-model="scenarioCreator.name">
            </div>

            <!-- Issues Section -->
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label class="form-label" style="margin-bottom: 0;">Issues *</label>
                    <button class="btn btn-secondary btn-xs" @click="addIssue()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add Issue
                    </button>
                </div>
                
                <template x-if="scenarioCreator.issues.length === 0">
                    <div class="empty-state" style="padding: 20px; text-align: center; color: var(--text-muted);">
                        Add at least one issue to define the negotiation domain.
                    </div>
                </template>
                
                <div class="issues-list" style="display: flex; flex-direction: column; gap: 12px;">
                    <template x-for="(issue, idx) in scenarioCreator.issues" :key="idx">
                        <div class="issue-card" style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px; border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: 500;">Issue <span x-text="idx + 1"></span></span>
                                <button class="btn btn-ghost btn-xs" @click="removeIssue(idx)" title="Remove issue">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label form-label-sm">Name</label>
                                    <input type="text" class="form-input form-input-sm" placeholder="Price" x-model="issue.name">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label form-label-sm">Type</label>
                                    <select class="form-input form-input-sm" x-model="issue.type" @change="onIssueTypeChange(idx)">
                                        <option value="categorical">Categorical</option>
                                        <option value="integer">Integer Range</option>
                                        <option value="continuous">Continuous Range</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Categorical Values -->
                            <div x-show="issue.type === 'categorical'" style="margin-top: 8px;">
                                <label class="form-label form-label-sm">Values (comma-separated)</label>
                                <input type="text" class="form-input form-input-sm" placeholder="$10, $20, $30" 
                                       x-model="issue.valuesText" 
                                       @input="issue.values = issue.valuesText.split(',').map(v => v.trim()).filter(v => v)">
                            </div>
                            
                            <!-- Integer/Continuous Range -->
                            <div x-show="issue.type === 'integer' || issue.type === 'continuous'" style="margin-top: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label form-label-sm">Min Value</label>
                                    <input type="number" class="form-input form-input-sm" x-model.number="issue.min_value">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label form-label-sm">Max Value</label>
                                    <input type="number" class="form-input form-input-sm" x-model.number="issue.max_value">
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Utility Functions Section -->
            <div class="form-group" style="margin-top: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label class="form-label" style="margin-bottom: 0;">Negotiator Preferences *</label>
                    <button class="btn btn-secondary btn-xs" @click="addUfun()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add Negotiator
                    </button>
                </div>
                
                <template x-if="scenarioCreator.ufuns.length === 0">
                    <div class="empty-state" style="padding: 20px; text-align: center; color: var(--text-muted);">
                        Add at least two negotiators with their preference functions.
                    </div>
                </template>
                
                <div class="ufuns-list" style="display: flex; flex-direction: column; gap: 12px;">
                    <template x-for="(ufun, uidx) in scenarioCreator.ufuns" :key="uidx">
                        <div class="ufun-card" style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px; border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: 500;">Negotiator <span x-text="uidx + 1"></span></span>
                                <button class="btn btn-ghost btn-xs" @click="removeUfun(uidx)" title="Remove negotiator">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label form-label-sm">Name</label>
                                    <input type="text" class="form-input form-input-sm" placeholder="Buyer" x-model="ufun.name">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label form-label-sm">Reserved Value</label>
                                    <input type="number" step="0.1" class="form-input form-input-sm" x-model.number="ufun.reserved_value">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label form-label-sm">Mode</label>
                                    <select class="form-input form-input-sm" x-model="ufun.mode">
                                        <option value="weights">Weights Only</option>
                                        <option value="detailed">Detailed Values</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Weights per Issue -->
                            <div style="margin-top: 12px;" x-show="scenarioCreator.issues.length > 0">
                                <label class="form-label form-label-sm">Issue Weights</label>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px;">
                                    <template x-for="(issue, iidx) in scenarioCreator.issues" :key="iidx">
                                        <div style="display: flex; flex-direction: column; gap: 2px;">
                                            <span style="font-size: 11px; color: var(--text-muted);" x-text="issue.name || 'Issue ' + (iidx + 1)"></span>
                                            <input type="number" step="0.1" min="0" max="1" class="form-input form-input-sm" 
                                                   :value="ufun.weights?.[iidx] || (1 / scenarioCreator.issues.length).toFixed(2)"
                                                   @input="setUfunWeight(uidx, iidx, $event.target.value)">
                                        </div>
                                    </template>
                                </div>
                                <div class="form-hint" style="margin-top: 4px;">
                                    Weights should sum to 1. Current sum: <span x-text="(ufun.weights?.reduce((a, b) => a + b, 0) || 0).toFixed(2)"></span>
                                </div>
                            </div>
                            
                            <!-- Detailed Value Functions (for categorical issues) -->
                            <div x-show="ufun.mode === 'detailed' && scenarioCreator.issues.some(i => i.type === 'categorical')" style="margin-top: 12px;">
                                <label class="form-label form-label-sm">Value Mappings for Categorical Issues</label>
                                <template x-for="(issue, iidx) in scenarioCreator.issues.filter(i => i.type === 'categorical')" :key="iidx">
                                    <div style="margin-top: 8px; padding: 8px; background: var(--bg-primary); border-radius: 4px;">
                                        <span style="font-size: 12px; font-weight: 500;" x-text="issue.name || 'Issue'"></span>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 4px; margin-top: 4px;">
                                            <template x-for="(val, vidx) in (issue.values || [])" :key="vidx">
                                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                                    <span style="font-size: 10px; color: var(--text-muted);" x-text="val"></span>
                                                    <input type="number" step="0.1" class="form-input form-input-sm" 
                                                           placeholder="0.0"
                                                           @input="setUfunValueMapping(uidx, iidx, val, $event.target.value)">
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Preview Section -->
            <div class="form-group" style="margin-top: 16px;" x-show="scenarioCreator.issues.length > 0 && scenarioCreator.ufuns.length >= 2">
                <label class="form-label">Preview</label>
                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; font-size: 13px;">
                    <div><strong>Name:</strong> <span x-text="scenarioCreator.name || '(unnamed)'"></span></div>
                    <div><strong>Issues:</strong> <span x-text="scenarioCreator.issues.length"></span></div>
                    <div><strong>Negotiators:</strong> <span x-text="scenarioCreator.ufuns.length"></span></div>
                    <div x-show="scenarioCreator.issues.every(i => i.type === 'categorical')">
                        <strong>Estimated Outcomes:</strong> 
                        <span x-text="scenarioCreator.issues.reduce((acc, i) => acc * (i.values?.length || 1), 1)"></span>
                    </div>
                </div>
            </div>

            <!-- Error Display -->
            <div class="form-group" x-show="scenarioCreator.error" style="margin-top: 16px;">
                <div class="alert alert-danger" style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--error); padding: 12px; border-radius: 8px; color: var(--error);">
                    <span x-text="scenarioCreator.error"></span>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" @click="showScenarioCreator = false">Cancel</button>
            <button class="btn btn-primary" @click="createScenario()" 
                    :disabled="!scenarioCreator.name || scenarioCreator.issues.length === 0 || scenarioCreator.ufuns.length < 2 || scenarioCreator.creating">
                <template x-if="scenarioCreator.creating">
                    <span>Creating...</span>
                </template>
                <template x-if="!scenarioCreator.creating">
                    <span>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                        Create Scenario
                    </span>
                </template>
            </button>
        </div>
    </div>
</div>
