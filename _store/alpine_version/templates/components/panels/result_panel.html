<!-- Result Panel - Shows agreement/result with optimality stats -->
<div class="panel panel-compact panel-result" x-ref="panelResult" 
     :class="{
         'collapsed': panelCollapsed.result,
         'panel-result-agreement': currentNegotiation?.agreement,
         'panel-result-disagreement': currentNegotiation?.end_reason && !currentNegotiation?.agreement && !currentNegotiation?.error,
         'panel-result-error': currentNegotiation?.error
     }"
     :style="currentNegotiation?.agreement || currentNegotiation?.optimality_stats ? 'max-height: 160px; flex: 0 0 auto;' : ''">
    <span class="panel-collapsed-label" x-show="panelCollapsed.result">RESULT</span>
    <div class="panel-floating-actions">
        <button class="panel-btn" title="Save Results" @click="saveResults()" x-show="currentNegotiation?.agreement || currentNegotiation?.end_reason">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        </button>
        <button class="panel-btn panel-collapse-btn" title="Toggle panel" @click="panelCollapsed.result = !panelCollapsed.result">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
        </button>
    </div>
    <div class="panel-content-ultra-compact" x-show="!panelCollapsed.result" style="overflow-y: auto;">
        <!-- Agreement Display -->
        <template x-if="currentNegotiation?.agreement">
            <div class="result-row result-agreement-display">
                <span class="result-state-badge agreement">Agreement</span>
                <template x-for="(value, key) in currentNegotiation.agreement" :key="key">
                    <span class="result-item"><span class="text-muted" x-text="key"></span>=<strong x-text="value"></strong></span>
                </template>
                <span class="result-separator">â†’</span>
                <template x-for="(util, idx) in (currentNegotiation.final_utilities || [])" :key="idx">
                    <span class="result-utility-labeled" :style="'color: ' + (currentNegotiation?.negotiator_colors?.[idx] || 'var(--primary)')">
                        <span class="utility-name" x-text="(currentNegotiation?.negotiator_names?.[idx] || '').substring(0, 3)"></span>
                        <span x-text="util.toFixed(3)"></span>
                    </span>
                </template>
            </div>
        </template>
        
        <!-- Optimality Statistics - More prominent display -->
        <template x-if="currentNegotiation?.optimality_stats && (currentNegotiation.optimality_stats.pareto_optimality != null || currentNegotiation.optimality_stats.nash_optimality != null)">
            <div class="result-optimality-section" style="padding: 8px; background: var(--bg-tertiary); border-top: 1px solid var(--border-color); margin-top: 4px;">
                <div style="font-size: 10px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">Agreement Quality</div>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; font-size: 11px;">
                    <!-- Pareto -->
                    <div class="optimality-stat-card" style="text-align: center; padding: 4px; background: var(--bg-secondary); border-radius: 4px; border: 1px solid var(--border-color);">
                        <div class="text-muted" style="font-size: 9px; margin-bottom: 2px;">Pareto</div>
                        <div style="font-weight: 600; font-size: 13px;"
                             :class="{
                                 'text-success': currentNegotiation.optimality_stats.pareto_optimality >= 0.95,
                                 'text-warning': currentNegotiation.optimality_stats.pareto_optimality >= 0.7 && currentNegotiation.optimality_stats.pareto_optimality < 0.95,
                                 'text-danger': currentNegotiation.optimality_stats.pareto_optimality < 0.7
                             }"
                             x-text="currentNegotiation.optimality_stats.pareto_optimality != null ? (currentNegotiation.optimality_stats.pareto_optimality * 100).toFixed(0) + '%' : 'N/A'"></div>
                    </div>
                    <!-- Nash -->
                    <div class="optimality-stat-card" style="text-align: center; padding: 4px; background: var(--bg-secondary); border-radius: 4px; border: 1px solid var(--border-color);">
                        <div class="text-muted" style="font-size: 9px; margin-bottom: 2px;">Nash</div>
                        <div style="font-weight: 600; font-size: 13px;"
                             :class="{
                                 'text-success': currentNegotiation.optimality_stats.nash_optimality >= 0.95,
                                 'text-warning': currentNegotiation.optimality_stats.nash_optimality >= 0.7 && currentNegotiation.optimality_stats.nash_optimality < 0.95
                             }"
                             x-text="currentNegotiation.optimality_stats.nash_optimality != null ? (currentNegotiation.optimality_stats.nash_optimality * 100).toFixed(0) + '%' : 'N/A'"></div>
                    </div>
                    <!-- Kalai -->
                    <div class="optimality-stat-card" style="text-align: center; padding: 4px; background: var(--bg-secondary); border-radius: 4px; border: 1px solid var(--border-color);">
                        <div class="text-muted" style="font-size: 9px; margin-bottom: 2px;">Kalai</div>
                        <div style="font-weight: 600; font-size: 13px;"
                             :class="{
                                 'text-success': currentNegotiation.optimality_stats.kalai_optimality >= 0.95,
                                 'text-warning': currentNegotiation.optimality_stats.kalai_optimality >= 0.7 && currentNegotiation.optimality_stats.kalai_optimality < 0.95
                             }"
                             x-text="currentNegotiation.optimality_stats.kalai_optimality != null ? (currentNegotiation.optimality_stats.kalai_optimality * 100).toFixed(0) + '%' : 'N/A'"></div>
                    </div>
                    <!-- Max Welfare -->
                    <div class="optimality-stat-card" style="text-align: center; padding: 4px; background: var(--bg-secondary); border-radius: 4px; border: 1px solid var(--border-color);">
                        <div class="text-muted" style="font-size: 9px; margin-bottom: 2px;">Welfare</div>
                        <div style="font-weight: 600; font-size: 13px;"
                             :class="{
                                 'text-success': currentNegotiation.optimality_stats.max_welfare_optimality >= 0.95,
                                 'text-warning': currentNegotiation.optimality_stats.max_welfare_optimality >= 0.7 && currentNegotiation.optimality_stats.max_welfare_optimality < 0.95
                             }"
                             x-text="currentNegotiation.optimality_stats.max_welfare_optimality != null ? (currentNegotiation.optimality_stats.max_welfare_optimality * 100).toFixed(0) + '%' : 'N/A'"></div>
                    </div>
                    <!-- KS -->
                    <div class="optimality-stat-card" style="text-align: center; padding: 4px; background: var(--bg-secondary); border-radius: 4px; border: 1px solid var(--border-color);">
                        <div class="text-muted" style="font-size: 9px; margin-bottom: 2px;">KS</div>
                        <div style="font-weight: 600; font-size: 13px;"
                             :class="{
                                 'text-success': currentNegotiation.optimality_stats.ks_optimality >= 0.95,
                                 'text-warning': currentNegotiation.optimality_stats.ks_optimality >= 0.7 && currentNegotiation.optimality_stats.ks_optimality < 0.95
                             }"
                             x-text="currentNegotiation.optimality_stats.ks_optimality != null && !isNaN(currentNegotiation.optimality_stats.ks_optimality) ? (currentNegotiation.optimality_stats.ks_optimality * 100).toFixed(0) + '%' : 'N/A'"></div>
                    </div>
                </div>
            </div>
        </template>
        
        <!-- No Agreement Display -->
        <template x-if="currentNegotiation?.end_reason && !currentNegotiation?.agreement">
            <div class="result-row result-final-state">
                <span class="result-state-badge" 
                      :class="{
                          'timeout': currentNegotiation.end_reason === 'timeout' || currentNegotiation.end_reason === 'no_agreement',
                          'error': currentNegotiation.error,
                          'ended': !currentNegotiation.error && currentNegotiation.end_reason !== 'timeout' && currentNegotiation.end_reason !== 'no_agreement'
                      }"
                      x-text="currentNegotiation.error ? 'Error' : (currentNegotiation.end_reason === 'timeout' || currentNegotiation.end_reason === 'no_agreement' ? 'No Agreement' : 'Ended')"></span>
                <template x-if="currentNegotiation.error">
                    <span class="result-error-scrollable" x-text="currentNegotiation.error"></span>
                </template>
                <template x-if="!currentNegotiation.error">
                    <span class="text-muted result-reason" x-text="currentNegotiation.end_reason"></span>
                </template>
            </div>
        </template>
        
        <!-- Progress (running) -->
        <template x-if="!currentNegotiation?.end_reason && !currentNegotiation?.agreement && !currentNegotiation?.pendingStart">
            <div class="result-row result-row-progress">
                <div class="progress-container" style="flex: 1; display: flex; align-items: center; gap: 8px;">
                    <div class="progress-bar-container" style="flex: 1; height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
                        <div class="progress-bar" 
                             :style="'width: ' + Math.min(100, getNegotiationProgress(currentNegotiation) * 100) + '%'">
                        </div>
                    </div>
                    <span class="text-muted" style="font-size: 11px; min-width: 40px;" 
                          x-text="Math.round(getNegotiationProgress(currentNegotiation) * 100) + '%'"></span>
                </div>
                <span class="text-muted" style="font-size: 10px; margin-left: 8px;" 
                      x-text="'Step ' + (currentNegotiation?.step || 0) + (currentNegotiation?.n_steps ? '/' + currentNegotiation.n_steps : '')"></span>
            </div>
        </template>
        
        <!-- Pending -->
        <template x-if="currentNegotiation?.pendingStart">
            <div class="result-row result-row-center"><span class="text-muted">Ready</span></div>
        </template>
    </div>
</div>
